<html xmlns="http://www.w3.org/1999/xhtml"><head profile="http://gmpg.org/xfn/11">
	
	

<title>An Introduction to Asynchronous Programming and Twisted (by krondo)</title>
	
	
	

	<!-- style START -->
	<style type="text/css" media="screen">@import url( http://krondo.com/wp-content/themes/blocks2/style.css );</style>
		<!--[if IE]>
		<link rel="stylesheet" href="http://krondo.com/wp-content/themes/blocks2/ie.css" type="text/css" media="screen" />
	<![endif]-->
	<!-- style END -->

	<!-- script START -->
	
	
	<!-- script END -->

		





 








<!-- call Thickbox for Joliprint use -->



<!-- End Thickbox for Joliprint use -->

<!-- begin Joliprint code (version 1.1.5) -->












<!-- end Joliprint code -->
	
<!-- START: Syntax Highlighter ComPress -->


<link type="text/css" rel="stylesheet" href="css/shCoreDefault.css">
<!-- END: Syntax Highlighter ComPress -->

  </head>


<body>
	<div id="wrap">
		<div id="container">

<!-- header START -->

<!-- header END -->

<!-- content START -->
<div id="content">

	<!-- menubar START -->
	
	<!-- menubar END -->

	<!-- main START -->
	<div id="main">



<div class="post" id="post-1209">
<h2 class="title">An Introduction to Asynchronous Programming and Twisted</h2>	
<h2 class="info">Dave Peticolas</h2>	
	

	<div class="content">
		<h2>Part 1: In Which We Begin at the Beginning</h2>
<h3>Preface</h3>
<p>Someone recently <a href="http://twistedmatrix.com/pipermail/twisted-python/2009-May/019706.html">posted</a> to the <a href="http://twistedmatrix.com">Twisted</a> <a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">mailing list</a> asking for something like the "Twisted introduction for people on a deadline". Full disclosure: this isn't it. On the spectrum of introductions to Twisted and asynchronous programming in Python, it may be on the exact opposite end. So if you don't have any time, or any patience, this isn't the introduction you are looking for.</p>
<p>However, I also believe that if you are new to asynchronous programming, a quick introduction is simply not possible, at least if you are not a genius. I've used Twisted successfully for a number of years and having thought about how I initially learned it (slowly), and what I found difficult, I've come to the conclusion that much of the challenge does not stem from Twisted per se, but rather in the acquisition of the "mental model" required to write and understand asynchronous code. Most of the Twisted source code is clear and well written, and the online documentation is good, at least by the standards of most free software. But without that mental model, reading the Twisted codebase, or code that uses Twisted, or even much of the documentation, will result in confusion and headache.</p>
<p>So the first parts of this introduction are designed to help you acquire that model and only later on will we introduce the features of Twisted. In fact, we will start without using Twisted at all, instead using simple Python programs to illustrate how an asynchronous system works. And once we get into Twisted, we will begin with very low-level aspects that you would not normally use in day-to-day programming. Twisted is a highly abstracted system and this gives you tremendous leverage when you use it to solve problems. But when you are learning Twisted, and particularly when you are trying to understand how Twisted actually works, the many levels of abstraction can cause troubles. So we will go from the inside-out, starting with the basics.</p>
<p>And once you have the mental model in place, I think you will find reading the <a href="http://twistedmatrix.com/trac/wiki/Documentation">Twisted documentation</a>, or just <a href="http://twistedmatrix.com/trac/browser">browsing the source code</a>, to be much easier. So let's begin.</p>
<h3>The Models</h3>
<p>We will start by reviewing two (hopefully) familiar models in order to contrast them with the asynchronous model. By way of illustration we will imagine a program that consists of three conceptually distinct tasks which must be performed to complete the program. We will make these tasks more concrete later on, but for now we won't say anything about them except the program must perform them. Note I am using "task" in the non-technical sense of "something that needs to be done".</p>
<p>The first model we will look at is the single-threaded synchronous model, in Figure 1 below:<a name="figure1"></a></p>
<div id="attachment_2026" class="wp-caption aligncenter" style="width: 146px"><a href="img/sync.png"><img width="136" height="361" class="size-full wp-image-2026" title="Figure 1: the synchronous model" src="img/sync.png" alt="Figure 1: the synchronous model"></a><p class="wp-caption-text">Figure 1: the synchronous model</p></div>
<p>This is the simplest style of programming. Each task is perfomed one at a time, with one finishing completely before another is started. And if the tasks are always performed in a definite order, the implementation of a later task can assume that all earlier tasks have finished without errors, with all their output available for use&nbsp;&mdash; a definite simplification in logic.</p>
<p>We can contrast the synchronous model with another one, the threaded model illustrated in Figure 2:</p>
<div id="attachment_2028" class="wp-caption aligncenter" style="width: 388px"><a href="img/threaded.png"><img width="378" height="120" class="size-full wp-image-2028" title="Figure 2: the threaded model" src="img/threaded.png" alt="Figure 2: the threaded model"></a><p class="wp-caption-text">Figure 2: the threaded model</p></div>
<p>In this model, each task is performed in a separate thread of control. The threads are managed by the operating system and may, on a system with multiple processors or multiple cores, run truly concurrently, or may be interleaved together on a single processor. The point is, in the threaded model the details of execution are handled by the OS and the programmer simply thinks in terms of independent instruction streams which may run simultaneously. Although the diagram is simple, in practice threaded programs can be quite complex because of the need for threads to coordinate with one another. Thread communication and coordination is an advanced programming topic and can be difficult to get right.</p>
<p>Some programs implement parallelism using multiple processes instead of multiple threads. Although the programming details are different, for our purposes it is the same model as in Figure 2.</p>
<p>Now we can introduce the asynchronous model in Figure 3:<a name="figure3"></a></p>
<div id="attachment_2030" class="wp-caption aligncenter" style="width: 186px"><a href="img/async.png"><img width="176" height="361" class="size-full wp-image-2030" title="Figure 3: the asynchronous model" src="img/async.png" alt="Figure 3: the asynchronous model"></a><p class="wp-caption-text">Figure 3: the asynchronous model</p></div>
<p>In this model, the tasks are interleaved with one another, but in a single thread of control. This is simpler than the threaded case because the programmer always knows that when one task is executing, another task is not. Although in a single-processor system a threaded program will also execute in an interleaved pattern, a programmer using threads should still think in terms of Figure 2, not Figure 3, lest the program work incorrectly when moved to a multi-processor system. But a single-threaded asynchronous system will always execute with interleaving, even on a multi-processor system.</p>
<p>There is another difference between the asynchronous and threaded models. In a threaded system the decision to suspend one thread and execute another is largely outside of the programmer's control. Rather, it is under the control of the operating system, and the programmer must assume that a thread may be suspended and replaced with another at almost any time. In contrast, under the asynchronous model a task will continue to run until it explicitly relinquishes control to other tasks. This is a further simplification from the threaded case.</p>
<p style="padding-left: 30px;">Note that it is possible to mix the asynchronous and threaded models and use both in the same system. But for most of this introduction, we will stick to "plain vanilla" asynchronous systems with one thread of control.</p>
<h3>The Motivation</h3>
<p>We've seen that the asynchronous model is simpler than the threaded one because there is a single instruction stream and tasks explicitly relinquish control instead of being suspended arbitrarily. But the asynchronous model is clearly more complex than the synchronous case. The programmer must organize each task as a sequence of smaller steps that execute intermittently. And if one task uses the output of another, the dependent task must be written to accept its input as a series of bits and pieces instead of all together. Since there is no actual parallelism, it appears from our diagrams that an asynchronous program will take just as long to execute as a synchronous one, perhaps longer as the asynchronous program might exhibit poorer <a href="http://en.wikipedia.org/wiki/Locality_of_reference">locality of reference</a>.</p>
<p>So why would you choose to use the asynchronous model? There are at least two reasons. First, if one or more of the tasks are responsible for implementing an interface for a human being, then by interleaving the tasks together the system can remain responsive to user input while still performing other work in the "background". So while the background tasks may not execute any faster, the system will be more pleasant for the person using it.</p>
<p>However, there is a condition under which an asynchronous system will simply outperform a synchronous one, sometimes dramatically so, in the sense of performing all of its tasks in an overall shorter time. This condition holds when tasks are forced to wait, or <em>block</em>, as illustrated in Figure 4:<a name="figure4"></a></p>
<div id="attachment_2032" class="wp-caption aligncenter" style="width: 267px"><a href="img/block.png"><img width="257" height="361" class="size-full wp-image-2032" title="Figure 4: blocking in a synchronous program" src="img/block.png" alt="Figure 4: blocking in a synchronous program"></a><p class="wp-caption-text">Figure 4: blocking in a synchronous program</p></div>
<p>In the figure, the gray sections represent periods of time when a particular task is waiting (blocking) and thus cannot make any progress. Why would a task be blocked? A frequent reason is that it is waiting to perform I/O, to transfer data to or from an external device. A typical CPU can handle data transfer rates that are orders of magnitude faster than a disk or a network link is capable of sustaining. Thus, a synchronous program that is doing lots of I/O will spend much of its time blocked while a disk or network catches up. Such a synchronous program is also called a blocking program for that reason.</p>
<p>Notice that Figure 4, a blocking program, looks a bit like Figure 3, an asynchronous program. This is not a coincidence. The fundamental idea behind the asynchronous model is that an asynchronous program, when faced with a task that would normally block in a synchronous program, will instead execute some other task that can still make progress. So an asynchronous program only "blocks" when no task can make progress and is thus called a non-blocking program. And each switch from one task to another corresponds to the first task either finishing, or coming to a point where it would have to block. With a large number of potentially blocking tasks, an asynchronous program can outperform a synchronous one by spending less overall time waiting, while devoting a roughly equal amount of time to real work on the individual tasks.</p>
<p>Compared to the synchronous model, the asynchronous model performs best when:</p>
<ol>
<li>There are a large number of tasks so there is likely always at least one task that can make progress.</li>
<li>The tasks perform lots of I/O, causing a synchronous program to waste lots of time blocking when other tasks could be running.</li>
<li>The tasks are largely independent from one another so there is little need for inter-task communication (and thus for one task to wait upon another).</li>
</ol>
<p>These conditions almost perfectly characterize a typical busy network server (like a web server) in a client-server environment. Each task represents one client request with I/O in the form of receiving the request and sending the reply. And client requests (being mostly reads) are largely independent. So a network server implementation is a prime candidate for the asynchronous model and this is why Twisted is first and foremost a networking library.</p>
<h3>Onward and Upward</h3>
<p>This is the end of Part 1. In <a href="http://krondo.com/blog/?p=1247">Part 2</a>, we will write some network programs, both blocking and non-blocking, as simply as possible (without using Twisted), to get a feel for how an asynchronous Python program actually works.</p>
<!-- JOLIPRINT BUTTON BEGINS --><script type="text/javascript">
&amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;lt;!--
try{
$joliprint().set('format','json').set('callback','joliprint_getPdf').set('service','wp-plugin').set('url','http://krondo.com/?p=1209').set('title','Print with Joliprint').set('urloptions','ver=1.1.5').set( 'label', 'joliprint' ).set( 'labelposition', 'after' ).set( 'button', 'joliprint-icon' ).write();
}catch(e){

}
--&amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;gt;</script><!-- JOLIPRINT BUTTON ENDS -->		<div class="fixed"></div>
			</div>
</div>




<div id="post-1247" class="post">
	
	

	<div class="content">
		<h2>Part 2: Slow Poetry and the Apocalypse</h2>
<p>This continues the introduction started <a href="http://krondo.com/blog/?p=1209">here</a>. And if you read it, welcome back. Now we're going to get our hands dirty and write some code. But first, let's get some assumptions out of the way.</p>
<h3>My Assumptions About You</h3>
<p>I will proceed as if you have a basic working knowledge of writing synchronous programs in Python, and know at least a little bit about Python socket programming. If you have never used sockets before, you might read the <a href="http://docs.python.org/library/socket.html#module-socket">socket module documentation</a> now, especially the example code towards the end. If you've never used Python before, then the rest of this introduction is probably going to be rather opaque.</p>
<h3>My Assumptions About Your Computer</h3>
<p>My experience with Twisted is mainly on Linux systems, and it is a Linux system on which I developed the examples. And while I won't intentionally make the code Linux-dependent, some of it, and some of what I say, may only apply to Linux and other UNIX-like systems (like Mac OSX or FreeBSD). Windows is a strange, murky place and, if you are hacking in it, I can't offer you much more beyond my heartfelt sympathies.</p>
<p>I will assume you have installed relatively recent versions of <a href="http://python.org/download">Python</a> and <a href="http://twistedmatrix.com/trac/wiki/Downloads">Twisted</a>. The examples were developed with Python 2.5 and Twisted 8.2.0.</p>
<p>Also, you can run all the examples on a single computer, although you can configure them to run on a network of systems as well. But for learning the basic mechanics of asynchronous programming, a single computer will do fine.</p>
<h3>Getting the example code</h3>
<p>The example code is available as a <a href="http://github.com/jdavisp3/twisted-intro/zipball/master">zip</a> or <a href="http://github.com/jdavisp3/twisted-intro/tarball/master">tar</a> file or as a <a href="git://github.com/jdavisp3/twisted-intro.git">clone</a> of my <a href="http://github.com/jdavisp3/twisted-intro/tree/master">public git repository</a>. If you can use <a href="http://git-scm.com/">git</a> or another version control system that can read git repositories, then I recommend using that method as I will update the examples over time and it will be easier for you to stay current. As a bonus, it includes the SVG source files used to generate the figures. Here is the git command to clone the repository:</p>
<pre>git clone git://github.com/jdavisp3/twisted-intro.git</pre>
<p>The rest of this tutorial will assume you have the latest copy of the example code and you have multiple shells open in its top-level directory (the one with the README file).</p>
<h3>Slow Poetry</h3>
<p>Although CPUs are much faster than networks, most networks are still a lot faster than your brain, or at least faster than your eyeballs. So it can be challenging to get the "cpu's-eye-view" of network latency, especially when there's only one machine and the bytes are whizzing past at full speed on the <a href="http://en.wikipedia.org/wiki/Loopback">loopback interface</a>. What we need is a slow server, one with artificial delays we can vary to see the effect. And since servers have to serve something, ours will serve poetry. The example code includes a sub-directory called <tt>poetry</tt> with one poem each by <a href="http://en.wikipedia.org/wiki/Donne">John Donne</a>, <a href="http://en.wikipedia.org/wiki/Yeats">W.B. Yeats</a>, and <a href="http://en.wikipedia.org/wiki/Poe">Edgar Allen Poe</a>. Of course, you are free to substitute your own poems for the server to dish up.</p>
<p>The basic slow poetry server is implemented in <a href="http://github.com/jdavisp3/twisted-intro/blob/master/blocking-server/slowpoetry.py">blocking-server/slowpoetry.py</a>. You can run one instance of the server like this:</p>
<pre>python blocking-server/slowpoetry.py poetry/ecstasy.txt</pre>
<p>That command will start up the blocking server with John Donne's poem "Ecstasy" as the poem to serve. Go ahead and look at the source code to the blocking server now. As you can see, it does not use Twisted, only basic Python socket operations. It also sends a limited number of bytes at a time, with a fixed time delay between them. By default, it sends 10 bytes every 0.1 seconds, but you can change these parameters with the &ndash;num-bytes and &ndash;delay command line options. For example, to send 50 bytes every 5 seconds:</p>
<pre>python blocking-server/slowpoetry.py --num-bytes 50 --delay 5 poetry/ecstasy.txt</pre>
<p>When the server starts up it prints out the port number it is listening on. By default, this is a random port that happens to be available on your machine. When you start varying the settings, you will probably want to use the same port number over again so you don't have to adjust the client command. You can specify a particular port like this:</p>
<pre>python blocking-server/slowpoetry.py --port 10000 poetry/ecstasy.txt</pre>
<p>If you have the <a href="http://netcat.sourceforge.net/">netcat</a> program available, you could test the above command like this:</p>
<pre>netcat localhost 10000</pre>
<p>If the server is working, you will see the poem slowly crawl its way down your screen. Ecstasy! You will also notice the server prints out a line each time it sends some bytes. Once the complete poem has been sent, the server closes the connection.</p>
<p>By default, the server only listens on the local "loopback" interface. If you want to access the server from another machine, you can specify the interface to listen on with the &ndash;iface option.</p>
<p>Not only does the server send each poem slowly, if you read the code you will find that while the server is sending poetry to one client, all other clients must wait for it to finish before getting even the first line. It is truly a slow server, and not much use except as a learning device.</p>
<h5 style="padding-left: 30px;">Or is it?</h5>
<p style="padding-left: 30px;">On the other hand, if the more pessimistic of the <a href="http://www.peakoil.net/">Peak Oil</a> folks are right and our world is heading for a global energy crisis and planet-wide societal meltdown, then perhaps one day soon a low-bandwidth, low-power poetry server could be just what we need. Imagine, after a long day of tending your self-sufficient gardens, making your own clothing, serving on your commune's Central Organizing Committee, and fighting off the radioactive zombies that roam the post-apocalyptic wastelands, you could crank up your generator and download a few lines of high culture from a vanished civilization. That's when our little server will really come into its own.</p>
<h3>The Blocking Client</h3>
<p>Also in the example code is a blocking client which can download poems from multiple servers, one after another. Let's give our client three tasks to perform, as in <a href="http://dpeticol.webfactional.com/blog/?p=1209#figure1">Figure 1</a> from Part 1. First we'll start three servers, serving three different poems. Run these commands in three different terminal windows:</p>
<pre>python blocking-server/slowpoetry.py --port 10000 poetry/ecstasy.txt --num-bytes 30
python blocking-server/slowpoetry.py --port 10001 poetry/fascination.txt
python blocking-server/slowpoetry.py --port 10002 poetry/science.txt</pre>
<p>You can choose different port numbers if one or more of the ones I chose above are already being used on your system. Note I told the first server to use chunks of 30 bytes instead of the default 10 since that poem is about three times as long as the others. That way they all finish around the same time.</p>
<p>Now we can use the blocking client in <a href="http://github.com/jdavisp3/twisted-intro/blob/master/blocking-client/get-poetry.py"><tt>blocking-client/get-poetry.py</tt></a> to grab some poetry. Run the client like this:</p>
<pre>python blocking-client/get-poetry.py 10000 10001 10002</pre>
<p>Change the port numbers here, too, if you used different ones for your servers. Since this is the blocking client, it will download one poem from each port number in turn, waiting until a complete poem is received until starting the next. Instead of printing out the poems, the blocking client produces output like this:</p>
<pre>Task 1: get poetry from: 127.0.0.1:10000
Task 1: got 3003 bytes of poetry from 127.0.0.1:10000 in 0:00:10.126361
Task 2: get poetry from: 127.0.0.1:10001
Task 2: got 623 bytes of poetry from 127.0.0.1:10001 in 0:00:06.321777
Task 3: get poetry from: 127.0.0.1:10002
Task 3: got 653 bytes of poetry from 127.0.0.1:10002 in 0:00:06.617523
Got 3 poems in 0:00:23.065661</pre>
<p>This is basically a text version of <a href="http://dpeticol.webfactional.com/blog/?p=1209#figure1">Figure 1</a>, where each task is downloading a single poem. Your times may be a little different, and will vary as you change the timing parameters of the servers. Try changing those parameters to see the effect on the download times.</p>
<p>You might take a look at the source code to the blocking server and client now, and locate the points in the code where each blocks while sending or receiving network data.</p>
<h3>The Asynchronous Client</h3>
<p>Now let's take a look at a simple asynchronous client written without Twisted. First let's run it. Get a set of three servers going on the same ports like we did above. If the ones you ran earlier are still going, you can just use them again. Now we can run the asynchronous client, located in <a href="http://github.com/jdavisp3/twisted-intro/blob/master/async-client/get-poetry.py"><tt>async-client/get-poetry.py</tt></a>, like this:</p>
<pre>python async-client/get-poetry.py 10000 10001 10002</pre>
<p>And you should get some output like this:</p>
<pre>Task 1: got 30 bytes of poetry from 127.0.0.1:10000
Task 2: got 10 bytes of poetry from 127.0.0.1:10001
Task 3: got 10 bytes of poetry from 127.0.0.1:10002
Task 1: got 30 bytes of poetry from 127.0.0.1:10000
Task 2: got 10 bytes of poetry from 127.0.0.1:10001
...
Task 1: 3003 bytes of poetry
Task 2: 623 bytes of poetry
Task 3: 653 bytes of poetry
Got 3 poems in 0:00:10.133169</pre>
<p>This time the output is much longer because the asynchronous client prints a line each time it downloads some bytes from any server, and these slow poetry servers just dribble out the bytes little by little. Notice that the individual tasks are mixed together just like in <a href="http://dpeticol.webfactional.com/blog/?p=1209#figure3">Figure 3</a> from Part 1.</p>
<p>Try varying the delay settings for the servers (e.g., by making one server slower than the others) to see how the asynchronous client automatically "adjusts" to the speed of the slower servers while still keeping up with the faster ones. That's asynchronicity in action.</p>
<p>Also notice that, for the server settings we chose above, the asynchronous client finishes in about 10 seconds while the synchronous client needs around 23 seconds to get all the poems. Now recall the differences between <a href="http://krondo.com/blog/?p=1209#figure3">Figure 3</a> and <a href="http://krondo.com/blog/?p=1209#figure4">Figure 4</a> in Part 1. By spending less time blocking, our asynchronous client can download all the poems in a shorter overall time. Now, our asynchronous client does block some of the time. Our slow server is <em>slow</em>.&nbsp; It's just that the asynchronous client spends a lot less time blocking than the "blocking" client does, because it can switch back and forth between all the servers.</p>
<p style="padding-left: 30px;">Technically, our asynchronous client <em>is</em> performing a blocking operation: it's writing to the standard output file descriptor with those <code>print</code> statements! This isn't a problem for our examples. On a local machine with a terminal shell that's always willing to accept more output the <code>print</code> statements won't really block, and execute quickly relative to our slow servers. But if we wanted our program to be part of a process pipeline and still execute asynchronously, we would need to use asynchronous I/O for standard input and output, too. Twisted includes support for doing just that, but to keep things simple we're just going to use <code>print</code> statements, even in our Twisted programs.</p>
<h3>A Closer Look</h3>
<p>Now take a look at the source code for the asynchronous client. Notice the main differences between it and the synchronous client:</p>
<ol>
<li>Instead of connecting to one server at a time, the asynchronous client connects to all the servers at once.</li>
<li>The socket objects used for communication are placed in non-blocking mode with the call to <code>setblocking(0)</code>.</li>
<li>The <code>select</code> method in the <a href="http://docs.python.org/library/select.html#module-select">select</a> module is used to wait (block) until any of the sockets are ready to give us some data.</li>
<li>When reading data from the servers, we read only as much as we can until the socket would block, and then move on to the next socket with data to read (if any). This means we have to keep track of the poetry we've received from each server so far.</li>
</ol>
<p>The core of the asynchronous client is the top-level loop in the <code>get_poetry</code> function. This loop can be broken down into steps:</p>
<ol>
<li>Wait (block) on all open sockets using <code>select</code> until one (or more) sockets has data to be read.</li>
<li>For each socket with data to be read, read it, but only as much as is available now. <a href="http://en.wikipedia.org/wiki/Asynchronous_I/O">Don't block</a>.</li>
<li>Repeat, until all sockets have been closed.</li>
</ol>
<p>The synchronous client had a loop as well (in the <code>main</code> function), but each iteration of the synchronous loop downloaded one complete poem. In one iteration of the asynchronous client we might download pieces of all the poems we are working on, or just some of them. And we don't know which ones we will work on in a given iteration, or how much data we will get from each one. That all depends on the relative speeds of the servers and the state of the network. We just let <code>select</code> tell us which ones are ready to go, and then read as much data as we can from each socket without blocking.</p>
<p>If the synchronous client always contacted a fixed number of servers (say 3), it wouldn't need an outer loop at all, it could just call its blocking <code>get_poetry</code> function three times in succession. But the asynchronous client can't do without an outer loop &mdash; to gain the benefits of asynchronicity, we need to wait on <em>all</em> of our sockets at once, and only process as much data as each is capable of delivering in any given iteration.</p>
<p style="text-align: left;">This use of a loop which waits for events to happen, and then handles them, is so common that it has achieved the status of a design pattern: the <a href="http://en.wikipedia.org/wiki/Reactor_pattern">reactor pattern</a>. It is visualized in Figure 5 below:</p>
<p><a name="figure5"></a></p>
<div style="width: 310px" class="wp-caption aligncenter" id="attachment_1301"><a href="img/reactor-1.png"><img width="300" height="366" alt="Figure 5: the reactor loop" src="img/reactor-1.png" title="Figure 5: the reactor loop" class="size-full wp-image-1301"></a><p class="wp-caption-text">Figure 5: the reactor loop</p></div>
<p style="text-align: center;">
</p><p style="text-align: left;">The loop is a "reactor" because it waits for and then reacts to events. For that reason it is also known as an <em>event loop</em>. And since reactive systems are often waiting on I/O, these loops are also sometimes called <a href="http://en.wikipedia.org/wiki/Asynchronous_I/O#Select.28.2Fpoll.29_loops"><em>select loops</em></a>, since the select call is used to wait for I/O. So in a <code>select</code> loop, an "event" is when a socket becomes available for reading or writing. Note that <code>select</code> is not the only way to wait for I/O, it is just one of the oldest methods (and thus widely available). There are several newer APIs, available on different operating systems, that do the same thing as <code>select</code> but offer (hopefully) better performance. But leaving aside performance, they all do the same thing: take a set of sockets (really file descriptors) and block until one or more of them is ready to do I/O.</p>
<p style="text-align: left; padding-left: 30px;">Note that it's possible to use <code>select</code> and its brethren to simply check whether a set of file descriptors is ready for I/O without blocking. This feature permits a reactive system to perform non-I/O work inside the loop. But in reactive systems it is often the case that all work is I/O-bound, and thus blocking on all file descriptors conserves CPU resources.</p>
<p style="text-align: left;">Strictly speaking, the loop in our asynchronous client is not the reactor pattern because the loop logic is not implemented separately from the "business logic" that is specific to the poetry servers. They are all just mixed together. A real implementation of the reactor pattern would implement the loop as a separate abstraction with the ability to:</p>
<ol>
<li>Accept a set of file descriptors you are interested in performing I/O with.</li>
<li>Tell you, repeatedly, when any file descriptors are ready for I/O.</li>
</ol>
<p>And a really good implementation of the reactor pattern would also:</p>
<ol>
<li>Handle all the weird corner cases that crop up on different systems.</li>
<li>Provide lots of nice abstractions to help you use the reactor with the least amount of effort.</li>
<li>Provide implementations of public protocols that you can use out of the box.</li>
</ol>
<p>Well that's just what Twisted is &mdash; a robust, cross-platform implementation of the Reactor Pattern with lots of extras. And in <a href="http://krondo.com/blog/?p=1333">Part 3</a> we will start writing some simple Twisted programs as we move towards a Twisted version of Get Poetry Now!.</p>
<h3>Suggested Exercises</h3>
<ol>
<li>Do some timing experiments with the blocking and asynchronous clients by varying the number and settings of the poetry servers.</li>
<li>Could the asynchronous client provide a <code>get_poetry</code> function that returned the text of the poem? Why not?</li>
<li>If you wanted a <code>get_poetry</code> function in the asynchronous client that was analogous to the synchronous version of <code>get_poetry</code>, how could it work? What arguments and return values might it have?</li>
</ol>
<!-- JOLIPRINT BUTTON BEGINS --><script type="text/javascript">
&amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;lt;!--
try{
$joliprint().set('format','json').set('callback','joliprint_getPdf').set('service','wp-plugin').set('url','http://krondo.com/?p=1247').set('title','Print with Joliprint').set('urloptions','ver=1.1.5').set( 'label', 'joliprint' ).set( 'labelposition', 'after' ).set( 'button', 'joliprint-icon' ).write();
}catch(e){

}
--&amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;gt;</script><!-- JOLIPRINT BUTTON ENDS -->		<div class="fixed"></div>
			</div>
</div>




	

	<div class="post" id="post-1333">
	
	

	<div class="content">
		<h2>Part 3: Our Eye-beams Begin to Twist</h2>
<p>This continues the introduction started <a href="http://krondo.com/blog/?p=1209">here</a>. You can find an index to the entire series <a href="http://krondo.com/blog/?page_id=1327">here</a>.</p>
<h3>Doing Nothing, the Twisted Way</h3>
<p>Eventually we are going to re-implement our asynchronous poetry client using Twisted. But first let's write a few really simple Twisted programs just to get the flavor of things. As I mentioned in Part 2, I developed these examples using Twisted 8.2.0. Twisted APIs do change, but the core APIs we are going to use will likely change slowly, if at all, so I expect these examples to work for many future releases. If you don't have Twisted installed you can obtain it <a href="http://twistedmatrix.com/trac/wiki/Downloads">here</a>.</p>
<p>The absolute simplest Twisted program is listed below, and is also available in <a href="http://github.com/jdavisp3/twisted-intro/blob/master/basic-twisted/simple.py"><tt>basic-twisted/simple.py</tt></a> in the base directory of the <tt>twisted-intro</tt> example code.</p>
<div><div id="highlighter_797623" class="syntaxhighlighter  py"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py keyword">from</code> <code class="py plain">twisted.internet </code><code class="py keyword">import</code> <code class="py plain">reactor</code></div><div class="line number2 index1 alt1"><code class="py plain">reactor.run()</code></div></div></td></tr></tbody></table></div></div>
<p>You can run it like this:</p>
<div><div id="highlighter_814222" class="syntaxhighlighter  py"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py plain">python basic</code><code class="py keyword">-</code><code class="py plain">twisted</code><code class="py keyword">/</code><code class="py plain">simple.py</code></div></div></td></tr></tbody></table></div></div>
<p>As we saw in <a href="http://krondo.com/blog/?p=1247">Part 2</a>, Twisted is an implementation of the <a href="http://en.wikipedia.org/wiki/Reactor_pattern">Reactor Pattern</a> and thus contains an object that represents the reactor, or event loop, that is the heart of any Twisted program. The first line of our program imports the reactor object so we can use it, and the second line tells the reactor to start running the loop.</p>
<p>This program just sits there doing nothing. You'll have to stop it by pressing <tt>Control-C</tt>, otherwise it will just sit there forever. Normally we would have given the loop one or more file descriptors (connected to, say, a poetry server) that we want to monitor for I/O. We'll see how to do that later, but for now our reactor loop is&nbsp;stuck. Note that this is not a <a href="http://en.wikipedia.org/wiki/Busy_waiting">busy loop</a> which keeps cycling over and over. If you happen to have a CPU meter on your screen, you won't see any spikes caused by this technically infinite loop. In fact, our program isn't using any CPU at all. Instead, the reactor is stuck at the top cycle of <a href="http://krondo.com/blog/?p=1247#figure5">Figure 5</a>, waiting for an event that will never come (to be specific, waiting on a <code>select</code> call with no file descriptors).</p>
<p>That might make for a compelling metaphor of Hamletian inaction, but it's still a pretty boring program. We're about to make it more interesting, but we can already draw a few conclusions:</p>
<ol>
<li>Twisted's reactor loop doesn't start until told to. You start it by calling <code>reactor.run()</code>.</li>
<li>The reactor loop runs in the same thread it was started in. In this case, it runs in the main (and only) thread.</li>
<li>Once the loop starts up, it just keeps going. The reactor is now "in control" of the program (or the specific thread it was started in).</li>
<li>If it doesn't have anything to do, the reactor loop does not consume CPU.</li>
<li>The reactor isn't created explicitly, just imported.</li>
</ol>
<p>That last point is worth elaborating on. In Twisted, the reactor is basically a <a href="http://en.wikipedia.org/wiki/Singleton_pattern">Singleton</a>. There is only one reactor object and it is created implicitly when you import it. If you open the <a href="http://twistedmatrix.com/trac/browser/tags/releases/twisted-8.2.0/twisted/internet/reactor.py"><code>reactor</code></a> module in the <code>twisted.internet</code> package you will find very little code. The actual implementation resides in other files (starting with <a href="http://twistedmatrix.com/trac/browser/tags/releases/twisted-8.2.0/twisted/internet/selectreactor.py"><code>twisted.internet.selectreactor</code></a>).</p>
<p>Twisted actually contains multiple reactor implementations. As mentioned in Part 2, the <code>select</code> call is just one method of waiting on file descriptors. It is the default method that Twisted uses, but Twisted does include other reactors that use other methods. For example, <a href="http://twistedmatrix.com/trac/browser/tags/releases/twisted-8.2.0/twisted/internet/pollreactor.py"><code>twisted.internet.pollreactor</code></a> uses the <a href="http://www.makelinux.net/ldd3/chp-6-sect-3.shtml"><code>poll</code></a> system call instead of <code>select</code>.</p>
<p>To use an alternate reactor, you must <code>install</code> it <em>before</em> importing <code>twisted.internet.reactor</code>. Here is how you install the <code>pollreactor</code>:</p>
<div><div id="highlighter_799742" class="syntaxhighlighter  py"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py keyword">from</code> <code class="py plain">twisted.internet </code><code class="py keyword">import</code> <code class="py plain">pollreactor</code></div><div class="line number2 index1 alt1"><code class="py plain">pollreactor.install()</code></div></div></td></tr></tbody></table></div></div>
<p>If you import <code>twisted.internet.reactor</code> without first installing a specific reactor implementation, then Twisted will install the <code>selectreactor</code> for you. For that reason, it is general practice not to import the reactor at the top level of modules to avoid accidentally installing the default reactor. Instead, import the reactor in the same scope in which you use it.</p>
<p style="padding-left: 30px;">Note: as of this writing, Twisted has been moving gradually towards an architecture which would allow multiple reactors to co-exist. In this scheme, a reactor object would be passed around as a reference rather than imported from a module.</p>
<p style="padding-left: 30px;">Note: not all operating systems support the <code>poll</code> call. If that is the case for your system, this example will not work.</p>
<p>Now we can re-implement our first Twisted program using the <code>pollreactor</code>, as found in <a href="http://github.com/jdavisp3/twisted-intro/blob/master/basic-twisted/simple-poll.py"><tt>basic-twisted/simple-poll.py</tt></a>:</p>
<div><div id="highlighter_423421" class="syntaxhighlighter  py"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py keyword">from</code> <code class="py plain">twisted.internet </code><code class="py keyword">import</code> <code class="py plain">pollreactor</code></div><div class="line number2 index1 alt1"><code class="py plain">pollreactor.install()</code></div><div class="line number3 index2 alt2">&nbsp;</div><div class="line number4 index3 alt1"><code class="py keyword">from</code> <code class="py plain">twisted.internet </code><code class="py keyword">import</code> <code class="py plain">reactor</code></div><div class="line number5 index4 alt2"><code class="py plain">reactor.run()</code></div></div></td></tr></tbody></table></div></div>
<p>And we have a poll loop that does nothing at all instead of a select loop that does nothing at all. Neato.</p>
<p>We're going to stick with the default reactor for the rest of this introduction. For the purposes of learning Twisted, all the reactors do the same thing.</p>
<h3>Hello, Twisted</h3>
<p>Let's make a Twisted program that at least does <em>something</em>. Here's one that prints a message to the terminal window, after the reactor loop starts up:</p>
<div><div id="highlighter_183392" class="syntaxhighlighter  py"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py keyword">def</code> <code class="py plain">hello():</code></div><div class="line number2 index1 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py functions">print</code> <code class="py string">'Hello from the reactor loop!'</code></div><div class="line number3 index2 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py functions">print</code> <code class="py string">'Lately I feel like I\'m stuck in a rut.'</code></div><div class="line number4 index3 alt1">&nbsp;</div><div class="line number5 index4 alt2"><code class="py keyword">from</code> <code class="py plain">twisted.internet </code><code class="py keyword">import</code> <code class="py plain">reactor</code></div><div class="line number6 index5 alt1">&nbsp;</div><div class="line number7 index6 alt2"><code class="py plain">reactor.callWhenRunning(hello)</code></div><div class="line number8 index7 alt1">&nbsp;</div><div class="line number9 index8 alt2"><code class="py functions">print</code> <code class="py string">'Starting the reactor.'</code></div><div class="line number10 index9 alt1"><code class="py plain">reactor.run()</code></div></div></td></tr></tbody></table></div></div>
<p>This program is in <a href="http://github.com/jdavisp3/twisted-intro/blob/master/basic-twisted/hello.py"><tt>basic-twisted/hello.py</tt></a>. If you run it, you will see this output:</p>
<pre>Starting the reactor.
Hello from the reactor loop!
Lately I feel like I'm stuck in a rut.</pre>
<p>You'll still have to kill the program yourself, since it gets stuck again after printing those lines.</p>
<p>Notice the <code>hello</code> function is called after the reactor starts running. That means it is called by the reactor itself, so Twisted code must be calling our function. We arrange for this to happen by invoking the reactor method <code>callWhenRunning</code> with a reference to the function we want Twisted to call. And, of course, we have to do that before we start the reactor.</p>
<p>We use the term <em>callback</em> to describe the reference to the <code>hello</code> function. A callback is a function reference that we give to Twisted (or any other framework) that Twisted will use to "call us back" at the appropriate time, in this case right after the reactor loop starts up. Since Twisted's loop is separate from our code, most interactions between the reactor core and our business logic will begin with a callback to a function we gave to Twisted using various APIs.</p>
<p>We can see how Twisted is calling our code using this program:</p>
<div><div id="highlighter_474532" class="syntaxhighlighter  py"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py keyword">import</code> <code class="py plain">traceback</code></div><div class="line number2 index1 alt1">&nbsp;</div><div class="line number3 index2 alt2"><code class="py keyword">def</code> <code class="py plain">stack():</code></div><div class="line number4 index3 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py functions">print</code> <code class="py string">'The python stack:'</code></div><div class="line number5 index4 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">traceback.print_stack()</code></div><div class="line number6 index5 alt1">&nbsp;</div><div class="line number7 index6 alt2"><code class="py keyword">from</code> <code class="py plain">twisted.internet </code><code class="py keyword">import</code> <code class="py plain">reactor</code></div><div class="line number8 index7 alt1"><code class="py plain">reactor.callWhenRunning(stack)</code></div><div class="line number9 index8 alt2"><code class="py plain">reactor.run()</code></div></div></td></tr></tbody></table></div></div>
<p>You can find it in <a href="http://github.com/jdavisp3/twisted-intro/blob/master/basic-twisted/stack.py"><tt>basic-twisted/stack.py</tt></a> and it prints out something like this:</p>
<pre>The python stack:
...
  reactor.run() &lt;-- This is where we called the reactor
...
...  &lt;-- A bunch of Twisted function calls
...
  traceback.print_stack() &lt;-- The second line in the stack function</pre>
<p>Don't worry about all the Twisted calls in between. Just notice the relationship between the <code>reactor.run()</code> call and our callback.</p>
<h5 style="padding-left: 30px;">What's the deal with callbacks?</h5>
<p style="padding-left: 30px;">Twisted is not the only reactor framework that uses callbacks. The older asynchronous Python frameworks <a href="http://www.nightmare.com/medusa/">Medusa</a> and <a href="http://docs.python.org/library/asyncore.html#module-asyncore">asyncore</a> also use them. As do the GUI toolkits <a href="http://gtk.org">GTK</a> and <a href="http://qt.nokia.com/">QT</a>, both based, like many GUI frameworks, on a reactor loop.</p>
<p style="padding-left: 30px;">The developers of reactive systems sure love callbacks. Maybe they should just marry them. Maybe they already did. But consider this:</p>
<ol style="padding-left: 30px;">
<li>The reactor pattern is single-threaded.</li>
<li>A reactive framework like Twisted implements the reactor loop so our code doesn't have to.</li>
<li>Our code still needs to get called to implement our business logic.</li>
<li>Since it is "in control" of the single thread, the reactor loop will have to call our code.</li>
<li>The reactor can't know in advance which part of our code needs to be called.</li>
</ol>
<p style="padding-left: 30px;">In this situation callbacks are not just one option &mdash; they are the only real game in town.</p>
<p>Figure 6 shows what happens during a callback:<a name="figure6"></a></p>
<div id="attachment_1421" class="wp-caption aligncenter" style="width: 227px"><a href="img/reactor-callback.png"><img width="217" height="254" class="size-full wp-image-1421" title="Figure 6: the reactor making a callback" src="img/reactor-callback.png" alt="Figure 6: the reactor making a callback"></a><p class="wp-caption-text">Figure 6: the reactor making a callback</p></div>
<p>Figure 6 illustrates some important properties of callbacks:</p>
<ol>
<li>Our callback code runs in the same thread as the Twisted loop.</li>
<li>When our callbacks are running, the Twisted loop is not running.</li>
<li>And vice versa.</li>
<li>The reactor loop resumes when our callback returns.</li>
</ol>
<p>During a callback, the Twisted loop is effectively "blocked" on our code. So we should make sure our callback code doesn't waste any time. In particular, we should avoid making blocking I/O calls in our callbacks. Otherwise, we would be defeating the whole point of using the reactor pattern in the first place. Twisted will not take any special precautions to prevent our code from blocking, we just have to make sure not to do it. As we will eventually see, for the common case of network I/O we don't have to worry about it as we let Twisted do the asynchronous communication for us.</p>
<p>Other examples of potentially blocking operations include reading or writing from a non-socket file descriptor (like a pipe) or waiting for a subprocess to finish. Exactly how you switch from blocking to non-blocking operations is specific to what you are doing, but there is often a Twisted API that will help you do it. Note that many standard Python functions have no way to switch to a non-blocking mode. For example, the <code>os.system</code> function will always block until the subprocess is finished. That's just how it works. So when using Twisted, you will have to eschew <code>os.system</code> in favor of the Twisted API for launching subprocesses.</p>
<h3>Goodbye, Twisted</h3>
<p>It turns out you can tell the Twisted reactor to stop running by using the reactor's <code>stop</code> method. But once stopped the reactor cannot be restarted, so it's generally something you do only when your program needs to exit.</p>
<p style="padding-left: 30px;">Note: there has been past discussion on the Twisted mailing list about making the reactor "restartable" so it could be started and stopped as you like. But as of version 8.2.0, you can only start (and thus stop) the reactor once.</p>
<p>Here's a program, listed in <a href="http://github.com/jdavisp3/twisted-intro/blob/master/basic-twisted/countdown.py"><tt>basic-twisted/countdown.py</tt></a>, which stops the reactor after a 5 second countdown:</p>
<div><div id="highlighter_627671" class="syntaxhighlighter  py"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py keyword">class</code> <code class="py plain">Countdown(</code><code class="py functions">object</code><code class="py plain">):</code></div><div class="line number2 index1 alt1">&nbsp;</div><div class="line number3 index2 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">counter </code><code class="py keyword">=</code> <code class="py value">5</code></div><div class="line number4 index3 alt1">&nbsp;</div><div class="line number5 index4 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">def</code> <code class="py plain">count(</code><code class="py color1">self</code><code class="py plain">):</code></div><div class="line number6 index5 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">if</code> <code class="py color1">self</code><code class="py plain">.counter </code><code class="py keyword">=</code><code class="py keyword">=</code> <code class="py value">0</code><code class="py plain">:</code></div><div class="line number7 index6 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">reactor.stop()</code></div><div class="line number8 index7 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">else</code><code class="py plain">:</code></div><div class="line number9 index8 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py functions">print</code> <code class="py color1">self</code><code class="py plain">.counter, </code><code class="py string">'...'</code></div><div class="line number10 index9 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py color1">self</code><code class="py plain">.counter </code><code class="py keyword">-</code><code class="py keyword">=</code> <code class="py value">1</code></div><div class="line number11 index10 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">reactor.callLater(</code><code class="py value">1</code><code class="py plain">, </code><code class="py color1">self</code><code class="py plain">.count)</code></div><div class="line number12 index11 alt1">&nbsp;</div><div class="line number13 index12 alt2"><code class="py keyword">from</code> <code class="py plain">twisted.internet </code><code class="py keyword">import</code> <code class="py plain">reactor</code></div><div class="line number14 index13 alt1">&nbsp;</div><div class="line number15 index14 alt2"><code class="py plain">reactor.callWhenRunning(Countdown().count)</code></div><div class="line number16 index15 alt1">&nbsp;</div><div class="line number17 index16 alt2"><code class="py functions">print</code> <code class="py string">'Start!'</code></div><div class="line number18 index17 alt1"><code class="py plain">reactor.run()</code></div><div class="line number19 index18 alt2"><code class="py functions">print</code> <code class="py string">'Stop!'</code></div></div></td></tr></tbody></table></div></div>
<p>This program uses the <code>callLater</code> API to register a callback with Twisted. With <code>callLater</code> the callback is the second argument and the first argument is the number of seconds in the future you would like your callback to run. You can use a floating point number to specify a fractional number of seconds, too.</p>
<p>So how does Twisted arrange to execute the callback at the right time? Since this program doesn't listen on any file descriptors, why doesn't it get stuck in the <code>select</code> loop like the others? The <code>select</code> call, and the others like it, also accepts an optional <em>timeout</em> value. If a timeout value is supplied and no file descriptors have become ready for I/O within the specified time then the <code>select</code> call will return anyway. Incidentally, by passing a timeout value of zero you can quickly check (or "poll") a set of file descriptors without blocking at all.</p>
<p>You can think of a timeout as another kind of event the event loop of <a href="http://krondo.com/blog/?p=1247#figure5">Figure 5</a> is waiting for. And Twisted uses timeouts to make sure any "timed callbacks" registered with <code>callLater</code> get called at the right time. Or rather, at approximately the right time. If another callback takes a really long time to execute, a timed callback may be delayed past its schedule. Twisted's <code>callLater</code> mechanism cannot provide the sort of guarantees required in a <a href="http://en.wikipedia.org/wiki/Real-time_computing#Hard_and_soft_real-time_systems">hard real-time</a> system.</p>
<p>Here is the output of our countdown program:</p>
<pre>Start!
5 ...
4 ...
3 ...
2 ...
1 ...
Stop!</pre>
<p>Note the "Stop!" line at the ends shows us that when the reactor exits, the <code>reactor.run</code> call returns. And we have a program that stops all by itself.</p>
<h3>Take That, Twisted</h3>
<p>Since Twisted often ends up calling our code in the form of callbacks, you might wonder what happens when a callback raises an exception. Let's try it out. The program in <a href="http://github.com/jdavisp3/twisted-intro/blob/master/basic-twisted/exception.py"><tt>basic-twisted/exception.py</tt></a> raises an exception in one callback, but behaves normally in another:</p>
<div><div id="highlighter_111157" class="syntaxhighlighter  py"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py keyword">def</code> <code class="py plain">falldown():</code></div><div class="line number2 index1 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">raise</code> <code class="py plain">Exception(</code><code class="py string">'I fall down.'</code><code class="py plain">)</code></div><div class="line number3 index2 alt2">&nbsp;</div><div class="line number4 index3 alt1"><code class="py keyword">def</code> <code class="py plain">upagain():</code></div><div class="line number5 index4 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py functions">print</code> <code class="py string">'But I get up again.'</code></div><div class="line number6 index5 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">reactor.stop()</code></div><div class="line number7 index6 alt2">&nbsp;</div><div class="line number8 index7 alt1"><code class="py keyword">from</code> <code class="py plain">twisted.internet </code><code class="py keyword">import</code> <code class="py plain">reactor</code></div><div class="line number9 index8 alt2">&nbsp;</div><div class="line number10 index9 alt1"><code class="py plain">reactor.callWhenRunning(falldown)</code></div><div class="line number11 index10 alt2"><code class="py plain">reactor.callWhenRunning(upagain)</code></div><div class="line number12 index11 alt1">&nbsp;</div><div class="line number13 index12 alt2"><code class="py functions">print</code> <code class="py string">'Starting the reactor.'</code></div><div class="line number14 index13 alt1"><code class="py plain">reactor.run()</code></div></div></td></tr></tbody></table></div></div>
<p>When you run it at the command line, you will see this output:</p>
<pre>Starting the reactor.
Traceback (most recent call last):
  ... # I removed most of the traceback
exceptions.Exception: I fall down.
But I get up again.</pre>
<p>Notice the second callback runs after the first, even though we see the traceback from the exception the first raised. And if you comment out the <code>reactor.stop()</code> call, the program will just keep running forever. So the reactor will keep going even when our callbacks fail (though it will report the exception).</p>
<p>Network servers generally need to be pretty robust pieces of software. They're not supposed to crash whenever any random bug shows its head. That's not to say we should be lackadaisical when it comes to handling our own errors, but it's nice to know Twisted has our back.</p>
<h3>Poetry, Please</h3>
<p>Now we're ready to grab some poetry with Twisted. In <a href="http://krondo.com/blog/?p=1445">Part 4</a>, we will implement a Twisted version of our asynchronous poetry client.</p>
<h3>Suggested Exercises</h3>
<ol>
<li>Update the <tt>countdown.py</tt> program to have three independently running counters going at different rates. Stop the reactor when all counters have finished.</li>
<li>Consider the <code>LoopingCall</code> class in <a href="http://twistedmatrix.com/trac/browser/tags/releases/twisted-8.2.0/twisted/internet/task.py"><tt>twisted.internet.task</tt></a>. Rewrite the countdown program above to use <a href="http://twistedmatrix.com/trac/browser/tags/releases/twisted-8.2.0/twisted/internet/task.py#L23"><code>LoopingCall</code></a>. You only need the <code>start</code> and <code>stop</code> methods and you don't need to use the "deferred" return value in any way. We'll learn what a "deferred" value is in a later Part.</li>
</ol>
<!-- JOLIPRINT BUTTON BEGINS --><!-- JOLIPRINT BUTTON ENDS -->		<div class="fixed"></div>
			</div>
</div>

<!-- related posts -->







	
<div class="post" id="post-1445">
	
	

	<div class="content">
		<h2>Part 4: Twisted Poetry</h2>
<p>This continues the introduction started <a href="http://krondo.com/blog/?p=1209">here</a>. You can find an index to the entire series <a href="http://krondo.com/blog/?page_id=1327">here</a>.</p>
<h3>Our First Twisted Client</h3>
<p>Although Twisted is probably more often used to write servers, clients are simpler than servers and we're starting out as simply as possible. Let's try out our first poetry client written with Twisted. The source code is in <a href="http://github.com/jdavisp3/twisted-intro/blob/master/twisted-client-1/get-poetry.py"><tt>twisted-client-1/get-poetry.py</tt></a>. Start up some poetry servers as before:</p>
<pre>python blocking-server/slowpoetry.py --port 10000 poetry/ecstasy.txt --num-bytes 30
python blocking-server/slowpoetry.py --port 10001 poetry/fascination.txt
python blocking-server/slowpoetry.py --port 10002 poetry/science.txt</pre>
<p>And then run the client like this:</p>
<pre>python twisted-client-1/get-poetry.py 10000 10001 10002</pre>
<p>And you should get some output like this:</p>
<pre>Task 1: got 60 bytes of poetry from 127.0.0.1:10000
Task 2: got 10 bytes of poetry from 127.0.0.1:10001
Task 3: got 10 bytes of poetry from 127.0.0.1:10002
Task 1: got 30 bytes of poetry from 127.0.0.1:10000
Task 3: got 10 bytes of poetry from 127.0.0.1:10002
Task 2: got 10 bytes of poetry from 127.0.0.1:10001
...
Task 1: 3003 bytes of poetry
Task 2: 623 bytes of poetry
Task 3: 653 bytes of poetry
Got 3 poems in 0:00:10.134220</pre>
<p>Just like we did with our non-Twisted asynchronous client. Which isn't surprising as they are doing essentially the same thing. Let's take a look at the source code to see how it works. Open up the client in your editor so you can examine the code we are discussing.</p>
<p style="padding-left: 30px;"><strong>Note</strong>: As I mentioned in Part 1, we will begin our use of Twisted by using some very low-level APIs. By doing this we bypass some of the layers of Twisted's abstractions so we can learn Twisted from the "inside out". But this means a lot of the APIs we will learn in the beginning are not often used when writing real code. Just keep in mind that these early programs are learning exercises, not examples of how to write production software.</p>
<p>The Twisted client starts up by creating a set of <a href="http://github.com/jdavisp3/twisted-intro/blob/master/twisted-client-1/get-poetry.py#L53"><code>PoetrySocket</code></a> objects. A <code>PoetrySocket</code> initializes itself by creating a real network socket, connecting to a server, and switching to non-blocking mode:</p>
<div><div id="highlighter_137676" class="syntaxhighlighter  py"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py color1">self</code><code class="py plain">.sock </code><code class="py keyword">=</code> <code class="py plain">socket.socket(socket.AF_INET, socket.SOCK_STREAM)</code></div><div class="line number2 index1 alt1"><code class="py color1">self</code><code class="py plain">.sock.connect(address)</code></div><div class="line number3 index2 alt2"><code class="py color1">self</code><code class="py plain">.sock.setblocking(</code><code class="py value">0</code><code class="py plain">)</code></div></div></td></tr></tbody></table></div></div>
<p>Eventually we'll get to a level of abstraction where we aren't working with sockets at all, but for now we still need to. After creating the network connection, a <code>PoetrySocket</code> passes <em>itself</em> to the <code>reactor</code> via the <code>addReader</code> method:</p>
<div><div id="highlighter_667833" class="syntaxhighlighter  py"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py comments"># tell the Twisted reactor to monitor this socket for reading</code></div><div class="line number2 index1 alt1"><code class="py keyword">from</code> <code class="py plain">twisted.internet </code><code class="py keyword">import</code> <code class="py plain">reactor</code></div><div class="line number3 index2 alt2"><code class="py plain">reactor.addReader(</code><code class="py color1">self</code><code class="py plain">)</code></div></div></td></tr></tbody></table></div></div>
<p>This method gives Twisted a file descriptor you want to monitor for incoming data. Why are we passing Twisted an object instead of a file descriptor and a callback? And how will Twisted know what to do with our object since Twisted certainly doesn't contain any poetry-specific code? Trust me, I've looked. Open up the <tt><a href="http://twistedmatrix.com/trac/browser/tags/releases/twisted-8.2.0/twisted/internet/interfaces.py">twisted.internet.interfaces</a></tt> module and follow along with me.</p>
<h3>Twisted Interfaces</h3>
<p>There are a number of sub-modules in Twisted called <code>interfaces</code>. Each one defines a set of <code>Interface</code> classes. As of version 8.0, Twisted uses <code><a href="http://www.zope.org/Products/ZopeInterface">zope.interface</a></code> as the basis for those classes, but the details of that package aren't so important for us. We're just concerned with the Interface sub-classes in Twisted itself, like the ones you are looking at now.</p>
<p>One of the principle purposes of Interfaces is documentation. As a Python programmer you are doubtless familiar with <a href="http://en.wikipedia.org/wiki/Duck_typing">Duck Typing</a>, the notion that the type of an object is principally defined not by its position in a class hierarchy but by the public interface it presents to the world. Thus two objects which present the same public interface (i.e., walk like a duck, quack like a ...) are, as far as duck typing is concerned, the same sort of thing (a duck!). Well an Interface is a somewhat formalized way of specifying just what it means to walk like a duck.</p>
<p>Skip down the <tt>twisted.internet.interfaces</tt> source code until you come to the definition of the <a href="http://twistedmatrix.com/trac/browser/tags/releases/twisted-8.2.0/twisted/internet/interfaces.py#L810"><code>addReader</code></a> method. It is declared in the <a href="http://twistedmatrix.com/trac/browser/tags/releases/twisted-8.2.0/twisted/internet/interfaces.py#L801"><code>IReactorFDSet</code></a> Interface and should look something like this:</p>
<div><div id="highlighter_516295" class="syntaxhighlighter  py"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py keyword">def</code> <code class="py plain">addReader(reader):</code></div><div class="line number2 index1 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py comments">"""</code></div><div class="line number3 index2 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py comments">I add reader to the set of file descriptors to get read events for.</code></div><div class="line number4 index3 alt1">&nbsp;</div><div class="line number5 index4 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py comments">@param reader: An L{IReadDescriptor} provider that will be checked for</code></div><div class="line number6 index5 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py comments">read events until it is removed from the reactor with</code></div><div class="line number7 index6 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py comments">L{removeReader}.</code></div><div class="line number8 index7 alt1">&nbsp;</div><div class="line number9 index8 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py comments">@return: C{None}.</code></div><div class="line number10 index9 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py comments">"""</code></div></div></td></tr></tbody></table></div></div>
<p><code>IReactorFDSet</code> is one of the Interfaces that Twisted reactors implement. Thus, any Twisted reactor has a method called <code>addReader</code> that works as described by the docstring above. The method declaration does not have a <code>self</code> argument because it is solely concerned with defining a public interface, and the <code>self</code> argument is part of the implementation (i.e., the caller does not have to pass <code>self</code> explicitly). Interface objects are never instantiated or used as base classes for real implementations.</p>
<p style="padding-left: 30px;"><strong>Note 1:</strong> Technically, <code>IReactorFDSet</code> would only be implemented by reactors that support waiting on file descriptors. As far as I know, that currently includes all available reactor implementations.</p>
<p style="padding-left: 30px;"><strong>Note 2</strong>: It is possible to use Interfaces for more than documentation. The <code>zope.interface</code> module allows you to explicitly declare that a class implements one or more interfaces, and provides mechanisms to examine these declarations at run-time. Also supported is the concept of adaptation, the ability to dynamically provide a given interface for an object that might not support that interface directly. But we're not going to delve into these more advanced use cases.</p>
<p style="padding-left: 30px;"><strong>Note 3:</strong> You might notice a similarity between Interfaces and <a href="http://www.python.org/dev/peps/pep-3119/">Abstract Base Classes</a>, a recent addition to the Python language. We will not be exploring their similarities and differences here, but you might be interested in reading an <a href="http://glyph.twistedmatrix.com/2009/02/explaining-why-interfaces-are-great.html">essay</a> by Glyph, the Twisted project founder, that touches on that subject.</p>
<p>According to the docstring above, the <code>reader</code> argument of <code>addReader</code> should implement the <a href="http://twistedmatrix.com/trac/browser/tags/releases/twisted-8.2.0/twisted/internet/interfaces.py#L947"><code>IReadDescriptor</code></a> interface. And that means our <code>PoetrySocket</code> objects have to do just that.</p>
<p>Scrolling through the module to find this new interface, we see:</p>
<div><div id="highlighter_371106" class="syntaxhighlighter  py"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py keyword">class</code> <code class="py plain">IReadDescriptor(IFileDescriptor):</code></div><div class="line number2 index1 alt1">&nbsp;</div><div class="line number3 index2 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">def</code> <code class="py plain">doRead():</code></div><div class="line number4 index3 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py comments">"""</code></div><div class="line number5 index4 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py comments">Some data is available for reading on your descriptor.</code></div><div class="line number6 index5 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py comments">"""</code></div></div></td></tr></tbody></table></div></div>
<p>And you will find an implementation of <a href="http://github.com/jdavisp3/twisted-intro/blob/master/twisted-client-1/get-poetry.py#L88"><code>doRead</code></a> on our <code>PoetrySocket</code> objects. It reads data from the socket asynchronously, whenever it is called by the Twisted reactor. So <code>doRead</code> is really a callback, but instead of passing it directly to Twisted, we pass in an object with a <code>doRead</code> method. This is a common idiom in the Twisted framework &mdash; instead of passing a function you pass an object that must implement a given Interface. This allows us to pass a set of related callbacks (the methods defined by the Interface) with a single argument. It also lets the callbacks communicate with each other through shared state stored on the object.</p>
<p>So what other callbacks are implemented on <code>PoetrySocket</code> objects? Notice that <code>IReadDescriptor</code> is a sub-class of <a href="http://twistedmatrix.com/trac/browser/tags/releases/twisted-8.2.0/twisted/internet/interfaces.py#L918"><code>IFileDescriptor</code></a>. That means any object that implements <code>IReadDescriptor</code> must also implement <code>IFileDescriptor</code>. And if you do some more scrolling, you will find:</p>
<div><div id="highlighter_297939" class="syntaxhighlighter  py"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py keyword">class</code> <code class="py plain">IFileDescriptor(ILoggingContext):</code></div><div class="line number2 index1 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py comments">"""</code></div><div class="line number3 index2 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py comments">A file descriptor.</code></div><div class="line number4 index3 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py comments">"""</code></div><div class="line number5 index4 alt2">&nbsp;</div><div class="line number6 index5 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">def</code> <code class="py plain">fileno():</code></div><div class="line number7 index6 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">...</code></div><div class="line number8 index7 alt1">&nbsp;</div><div class="line number9 index8 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">def</code> <code class="py plain">connectionLost(reason):</code></div><div class="line number10 index9 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">...</code></div></div></td></tr></tbody></table></div></div>
<p>I left out the docstrings above, but the purpose of these callbacks is fairly clear from the names: <code>fileno</code> should return the file descriptor we want to monitor, and <code>connectionLost</code> is called when the connection is closed. And you can see our <code>PoetrySocket</code> objects implement those methods as well.</p>
<p>Finally, <code>IFileDescriptor</code> inherits from <a href="http://twistedmatrix.com/trac/browser/tags/releases/twisted-8.2.0/twisted/internet/interfaces.py#L905"><code>ILoggingContext</code></a>. I won't bother to show it here, but that's why we need to implement the <a href="http://github.com/jdavisp3/twisted-intro/blob/master/twisted-client-1/get-poetry.py#L110"><code>logPrefix</code></a> callback. You can find the details in the <a href="http://twistedmatrix.com/trac/browser/tags/releases/twisted-8.2.0/twisted/internet/interfaces.py"><code>interfaces</code></a> module.</p>
<p style="padding-left: 30px;"><strong>Note</strong>: You might notice that <code>doRead</code> is returning special values to indicate when the socket is closed. How did I know to do that? Basically, it didn't work without it and I peeked at Twisted's implementation of the same interface to see what to do. You may wish to sit down for this: sometimes software documentation is wrong or incomplete. Perhaps when you have recovered from the shock, I'll have finished Part 5.</p>
<h3>More on Callbacks</h3>
<p>Our new Twisted client is really quite similar to our original asynchronous client. Both clients connect their own sockets, and read data from those sockets (asynchronously). The main difference is the Twisted client doesn't need its own <code>select</code> loop &mdash; it uses the Twisted reactor instead.</p>
<p>The <code>doRead</code> callback is the most important one. Twisted calls it to tell us there is some data ready to read from our socket. We can visualize the process in Figure 7:</p>
<div id="attachment_1479" class="wp-caption aligncenter" style="width: 356px"><a href="img/reactor-doread.png"><img width="346" height="276" class="size-full wp-image-1479" title="Figure 7: the doRead callback" src="img/reactor-doread.png" alt="Figure 7: the doRead callback"></a><p class="wp-caption-text">Figure 7: the doRead callback</p></div>
<p>Each time the callback is invoked it's up to us to read all the data we can and then stop without blocking. And as we said in Part 3, Twisted can't stop our code from misbehaving (from blocking needlessly). We can do just that and see what happens. In the same directory as our Twisted client is a broken client called <a href="http://github.com/jdavisp3/twisted-intro/blob/master/twisted-client-1/get-poetry-broken.py"><tt>twisted-client-1/get-poetry-broken.py</tt></a>. This client is identical to the one you've been looking at, with two exceptions:</p>
<ol>
<li>The broken client doesn't bother to make the socket non-blocking.</li>
<li>The <code>doRead</code> callback just keeps reading bytes (and possibly blocking) until the socket is closed.</li>
</ol>
<p>Now try running the broken client like this:</p>
<pre>python twisted-client-1/get-poetry-broken.py 10000 10001 10002</pre>
<p>You'll get some output that looks something like this:</p>
<pre>Task 1: got 3003 bytes of poetry from 127.0.0.1:10000
Task 3: got 653 bytes of poetry from 127.0.0.1:10002
Task 2: got 623 bytes of poetry from 127.0.0.1:10001
Task 1: 3003 bytes of poetry
Task 2: 623 bytes of poetry
Task 3: 653 bytes of poetry
Got 3 poems in 0:00:10.132753</pre>
<p>Aside from a slightly different task order this looks like our original blocking client. But that's because the broken client <em>is</em> a blocking client. By using a blocking <code>recv</code> call in our callback, we've turned our nominally asynchronous Twisted program into a synchronous one. So we've got the complexity of a <code>select</code> loop without any of the benefits of asynchronicity.</p>
<p>The sort of multi-tasking capability that an event loop like Twisted provides is <a href="http://en.wikipedia.org/wiki/Computer_multitasking#Cooperative_multitasking.2Ftime-sharing">cooperative</a>. Twisted will tell us when it's OK to read or write to a file descriptor, but we have to play nice by only transferring as much data as we can without blocking. And we must avoid making other kinds of blocking calls, like <code>os.system</code>. Furthermore, if we have a long-running computational (CPU-bound) task, it's up to us to split it up into smaller chunks so that I/O tasks can still make progress if possible.</p>
<p>Note that there is a sense in which our broken client still works: it does manage to download all the poetry we asked it to. It's just that it can't take advantage of the efficiencies of asynchronous I/O. Now you might notice the broken client still runs a lot faster than the original blocking client. That's because the broken client connects to all the servers at the start of the program. Since the servers start sending data immediately, and since the OS will buffer some of the incoming data for us even if we don't read it (up to a limit), our blocking client is effectively receiving data from the other servers even though it is only reading from one at a time.</p>
<p>But this "trick" only works for small amounts of data, like our short poems. If we were downloading, say, the three 20 million-word epic sagas that chronicle one hacker's attempt to win his true love by writing the world's greatest <a href="http://en.wikipedia.org/wiki/Lisp_(programming_language)">Lisp</a> interpreter, the operating system buffers would quickly fill up and our broken client would be scarcely more efficient than our original blocking one.</p>
<h3>Wrapping Up</h3>
<p>I don't have much more to say about our first Twisted poetry client. You might note the <a href="http://github.com/jdavisp3/twisted-intro/blob/master/twisted-client-1/get-poetry.py#L74"><code>connectionLost</code></a> callback shuts down the reactor after there are no more <code>PoetrySocket</code>s waiting for poems. That's not such a great technique since it assumes we aren't doing anything else in the program other than download poetry, but it does illustrate a couple more low-level reactor APIs, <code>removeReader</code> and <code>getReaders</code>.</p>
<p>There are <code>Writer</code> equivalents to the <code>Reader</code> APIs we used in this client, and they work in analogous ways for file descriptors we want to monitor for sending data to. Consult the <a href="http://twistedmatrix.com/trac/browser/tags/releases/twisted-8.2.0/twisted/internet/interfaces.py"><code>interfaces</code></a> file for more details. The reason reading and writing have separate APIs is because the <code>select</code> call distinguishes between those two kinds of events (a file descriptor becoming available for reading or writing, respectively). It is, of course, possible to wait for both events on the same file descriptor.</p>
<p>In <a href="http://krondo.com/blog/?p=1522">Part 5</a>, we will write a second version of our Twisted poetry client using some higher-level abstractions, and learn some more Twisted Interfaces and APIs along the way.</p>
<h3>Suggested Exercises</h3>
<ol>
<li>Fix the client so that a failure to connect to a server does not crash the program.</li>
<li>Use <code>callLater</code> to make the client timeout if a poem hasn't finished after a given interval. Read about the return value of <code>callLater</code> so you can cancel the timeout if the poem finishes on time.</li>
</ol>
<!-- JOLIPRINT BUTTON BEGINS --><script type="text/javascript">
&amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;lt;!--
try{
$joliprint().set('format','json').set('callback','joliprint_getPdf').set('service','wp-plugin').set('url','http://krondo.com/?p=1445').set('title','Print with Joliprint').set('urloptions','ver=1.1.5').set( 'label', 'joliprint' ).set( 'labelposition', 'after' ).set( 'button', 'joliprint-icon' ).write();
}catch(e){

}
--&amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;gt;</script><!-- JOLIPRINT BUTTON ENDS -->		<div class="fixed"></div>
			</div>
</div>



<div id="post-1522" class="post">
	
	

	<div class="content">
		<h2>Part 5: Twistier Poetry</h2>
<p>This continues the introduction started <a href="http://krondo.com/blog/?p=1209">here</a>. You can find an index to the entire series <a href="http://krondo.com/blog/?page_id=1327">here</a>.</p>
<h3>Abstract Expressionism</h3>
<p>In <a href="http://krondo.com/wp-content/uploads/2009/08/twisted-intro.html?p=1445">Part 4</a> we made our first poetry client that uses Twisted. It works pretty well, but there is definitely room for improvement.</p>
<p>First of all, the client includes code for mundane details like creating network sockets and receiving data from those sockets. Twisted provides support for these sorts of things so we don't have to implement them ourselves every time we write a new program. This is especially helpful because asynchronous I/O requires a few tricky bits involving exception handling as you can see in the <a href="http://github.com/jdavisp3/twisted-intro/blob/master/twisted-client-1/get-poetry.py">client code</a>. And there are even more tricky bits if you want your code to work on multiple platforms. If you have a free afternoon, search the Twisted sources for "win32" to see how many corner cases that platform introduces.</p>
<p>Another problem with the current client is error handling. Try running version 1.0 of the Twisted client and tell it to download from a port with no server. It just crashes. We could fix the current client, but error handling is easier with the Twisted APIs we'll be using today.</p>
<p>Finally, the client isn't particularly re-usable. How would another module get a poem with our client? How would the "calling" module know when the poem had finished downloading? We can't write a function that simply returns the text of the poem as that would require blocking until the entire poem is read. This is a real problem but we're not going to fix it today &mdash; we'll save that for future Parts.</p>
<p>We're going to fix the first and second problems using a higher-level set of APIs and Interfaces. The Twisted framework is loosely composed of layers of abstractions and learning Twisted means learning what those layers provide, i.e, what APIs, Interfaces, and implementations are available for use in each one. Since this is an introduction we're not going to study each abstraction in complete detail or do an exhaustive survey of every abstraction that Twisted offers. We're just going to look at the most important pieces to get a better feel for how Twisted is put together. Once you become familiar with the overall style of Twisted's architecture, learning new parts on your own will be much easier.</p>
<p>In general, each Twisted abstraction is concerned with one particular concept. For example, the 1.0 client from Part 4 uses <code>IReadDescriptor</code>, the abstraction of a "file descriptor you can read bytes from". A Twisted abstraction is usually defined by an Interface specifying how an object embodying that abstraction should behave. The most important thing to keep in mind when learning a new Twisted abstraction is this:</p>
<p style="padding-left: 30px;">Most higher-level abstractions in Twisted are built by <em>using</em> lower-level ones, <em>not</em> by replacing them.</p>
<p>So when you are learning a new Twisted abstraction, keep in mind both what it does and what it does not do. In particular, if some earlier abstraction <em>A</em> implements feature <em>F</em>, then <em>F</em> is probably not implemented by any other abstraction. Rather, if another abstraction <em>B</em> needs feature <em>F</em>, it will use <em>A</em> rather than implement <em>F</em> itself.&nbsp; (In general, an implementation of <em>B</em> will either sub-class an implementation of <em>A</em> or refer to another object that implements <em>A</em>).</p>
<p>Networking is a complex subject, and thus Twisted contains lots of abstractions. By starting with lower levels first, we are hopefully getting a clearer picture of how they all get put together in a working Twisted program.</p>
<h3>Loopiness in the Brain</h3>
<p>The most important abstraction we have learned so far, indeed the most important abstraction in Twisted, is the reactor. At the center of every program built with Twisted, no matter how many layers that program might have, there is a reactor loop spinning around and making the whole thing go. Nothing else in Twisted provides the functionality the reactor offers. Much of the rest of Twisted, in fact, can be thought of as "stuff that makes it easier to do X using the reactor" where X might be "serve a web page" or "make a database query" or some other specific feature. Although it's possible to stick with the lower-level APIs, like the client 1.0 does, we have to implement more things ourselves if we do. Moving to higher-level abstractions generally means writing less code (and letting Twisted handle the platform-dependent corner cases).</p>
<p>But when we're working at the outer layers of Twisted it can be easy to forget the reactor is there. In any Twisted program of reasonable size, relatively few parts of our code will actually use the reactor APIs directly. The same is true for some of the other low-level abstractions. The file descriptor abstractions we used in client 1.0 are so thoroughly subsumed by higher-level concepts that they basically disappear in real Twisted programs (they are still used on the inside, we just don't see them as such).</p>
<p>As far as the file descriptor abstractions go, that's not really a problem. Letting Twisted handle the mechanics of asynchronous I/O frees us to concentrate on whatever problem we are trying to solve. But the reactor is different. It never really disappears. When you choose to use Twisted you are also choosing to use the Reactor Pattern, and that means programming in the "reactive style" using callbacks and cooperative multi-tasking. If you want to use Twisted correctly, you have to keep the reactor's existence (and the way it works) in mind. We'll have more to say about this in Part 6, but for now our message is this:</p>
<p style="padding-left: 30px;"><a href="http://krondo.com/blog/?p=1247#figure5">Figure 5</a> and <a href="http://krondo.com/blog/?p=1333#figure6">Figure 6</a> are the most important diagrams in this introduction.</p>
<p>We'll keep using diagrams to illustrate new concepts, but those two Figures are the ones that you need to burn into your brain, so to speak. Those are the pictures I constantly have in mind while writing programs with Twisted.</p>
<p>Before we dive into the code, there are three new abstractions to introduce: Transports, Protocols, and Protocol Factories.</p>
<h4>Transports</h4>
<p>The Transport abstraction is defined by <a href="http://twistedmatrix.com/trac/browser/tags/releases/twisted-8.2.0/twisted/internet/interfaces.py#L1289"><code>ITransport</code></a> in the main Twisted <a href="http://twistedmatrix.com/trac/browser/tags/releases/twisted-8.2.0/twisted/internet/interfaces.py"><code>interfaces</code></a> module. A Twisted Transport represents a single connection that can send and/or receive bytes. For our poetry clients, the Transports are abstracting <a href="http://en.wikipedia.org/wiki/Transmission_Control_Protocol">TCP</a> connections like the ones we have been making ourselves in earlier versions. But Twisted also supports I/O over <a href="http://en.wikipedia.org/wiki/Unix_pipe#Network_pipes">UNIX Pipes</a> and <a href="http://en.wikipedia.org/wiki/Udp">UDP</a> sockets among other things. The Transport abstraction represents any such connection and handles the details of asynchronous I/O for whatever sort of connection it represents.</p>
<p>If you scan the methods defined for <code>ITransport</code>, you won't find any for receiving data. That's because Transports always handle the low-level details of reading data asynchronously from their connections, and give the data to us via callbacks. Along similar lines, the write-related methods of Transport objects may choose not to write the data immediately to avoid blocking. Telling a Transport to write some data means "send this data as soon as you can do so,&nbsp; subject to the requirement to avoid blocking". The data will be written in the order we provide it, of course.</p>
<p>We generally don't implement our own Transport objects or create them in our code. Rather, we use the implementations that Twisted already provides and which are created for us when we tell the reactor to make a connection.</p>
<h4>Protocols</h4>
<p>Twisted Protocols are defined by <a href="http://twistedmatrix.com/trac/browser/tags/releases/twisted-8.2.0/twisted/internet/interfaces.py#L1111"><code>IProtocol</code></a> in the same <a href="http://twistedmatrix.com/trac/browser/tags/releases/twisted-8.2.0/twisted/internet/interfaces.py"><code>interfaces</code></a> module. As you might expect, Protocol objects implement <a href="http://en.wikipedia.org/wiki/Protocol_(computing)">protocols</a>. That is to say, a particular implementation of a Twisted Protocol should implement one specific networking protocol, like <a href="http://en.wikipedia.org/wiki/File_Transfer_Protocol">FTP</a> or <a href="http://en.wikipedia.org/wiki/Internet_Message_Access_Protocol">IMAP</a> or some nameless protocol we invent for our own purposes. Our poetry protocol, such as it is, simply sends all the bytes of the poem as soon as a connection is established, while the close of the connection signifies the end of the poem.</p>
<p>Strictly speaking, each instance of a Twisted Protocol object implements a protocol for one <em>specific</em> connection. So each connection our program makes (or, in the case of servers, accepts) will require one instance of a Protocol. This makes Protocol instances the natural place to store both the state of "stateful" protocols and the accumulated data of partially received messages (since we receive the bytes in arbitrary-sized chunks with asynchronous I/O).</p>
<p>So how do Protocol instances know what connection they are responsible for? If you look at the <code>IProtocol</code> definition, you will find a method called <code>makeConnection</code>. This method is a callback and Twisted code calls it with a Transport instance as the only argument. The Transport is the connection the Protocol is going to use.</p>
<p>Twisted includes a large number of ready-built Protocol implementations for various common protocols. You can find a few simpler ones in <a href="http://twistedmatrix.com/trac/browser/tags/releases/twisted-8.2.0/twisted/protocols/basic.py"><code>twisted.protocols.basic</code></a>. It's a good idea to check the Twisted sources before you write a new Protocol to see if there's already an implementation you can use. But if there isn't, it's perfectly OK to implement your own, as we will do for our poetry clients.</p>
<h4>Protocol Factories</h4>
<p>So each connection needs its own Protocol and that Protocol might be an instance of a class we implement ourselves. Since we will let Twisted handle creating the connections, Twisted needs a way to make the appropriate Protocol "on demand" whenever a new connection is made. Making Protocol instances is the job of Protocol Factories.</p>
<p>As you've probably guessed, the Protocol Factory API is defined by <a href="http://twistedmatrix.com/trac/browser/tags/releases/twisted-8.2.0/twisted/internet/interfaces.py#L1259">IProtocolFactory</a>, also in the <a href="http://twistedmatrix.com/trac/browser/tags/releases/twisted-8.2.0/twisted/internet/interfaces.py"><code>interfaces</code></a> module. Protocol Factories are an example of the <a href="http://en.wikipedia.org/wiki/Factory_pattern">Factory</a> design pattern and they work in a straightforward way. The <code>buildProtocol</code> method is supposed to return a new Protocol instance each time it is called. This is the method that Twisted uses to make a new Protocol for each new connection.</p>
<h3>Get Poetry 2.0: First Blood.0</h3>
<p>Alright, let's take a look at version 2.0 of the Twisted poetry client. The code is in <a href="http://github.com/jdavisp3/twisted-intro/blob/master/twisted-client-2/get-poetry.py"><code>twisted-client-2/get-poetry.py</code></a>. You can run it just like the others and get similar output so I won't bother posting output here. This is also the last version of the client that prints out task numbers as it receives bytes. By now it should be clear that all Twisted programs work by interleaving tasks and processing relatively small chunks of data at a time. We'll still use <code>print</code> statements to show what is going on at key moments, but the clients won't be quite as verbose in the future.</p>
<p>In client 2.0, sockets have disappeared. We don't even import the <code>socket</code> module and we never refer to a socket object, or a file descriptor, in any way. Instead, we tell the reactor to make the connections to the poetry servers on our behalf like <a href="http://github.com/jdavisp3/twisted-intro/blob/master/twisted-client-2/get-poetry.py#L110">this</a>:</p>
<div><div class="syntaxhighlighter  py" id="highlighter_38728"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py plain">factory </code><code class="py keyword">=</code> <code class="py plain">PoetryClientFactory(</code><code class="py functions">len</code><code class="py plain">(addresses))</code></div><div class="line number2 index1 alt1">&nbsp;</div><div class="line number3 index2 alt2"><code class="py keyword">from</code> <code class="py plain">twisted.internet </code><code class="py keyword">import</code> <code class="py plain">reactor</code></div><div class="line number4 index3 alt1">&nbsp;</div><div class="line number5 index4 alt2"><code class="py keyword">for</code> <code class="py plain">address </code><code class="py keyword">in</code> <code class="py plain">addresses:</code></div><div class="line number6 index5 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">host, port </code><code class="py keyword">=</code> <code class="py plain">address</code></div><div class="line number7 index6 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">reactor.connectTCP(host, port, factory)</code></div></div></td></tr></tbody></table></div></div>
<p>The <code>connectTCP</code> method is the one to focus on. The first two arguments should be self-explanatory. The third is an instance of our <a href="http://github.com/jdavisp3/twisted-intro/blob/master/twisted-client-2/get-poetry.py#L69"><code>PoetryClientFactory</code></a> class. This is the Protocol Factory for poetry clients and passing it to the reactor allows Twisted to create instances of our <a href="http://github.com/jdavisp3/twisted-intro/blob/master/twisted-client-2/get-poetry.py#L52"><code>PoetryProtocol</code></a> on demand.</p>
<p>Notice that we are not implementing either the Factory or the Protocol from scratch, unlike the <code>PoetrySocket</code> objects in our previous client. Instead, we are sub-classing the base implementations that Twisted provides in <a href="http://twistedmatrix.com/trac/browser/tags/releases/twisted-8.2.0/twisted/internet/protocol.py"><code>twisted.internet.protocol</code></a>. The primary Factory base class is <a href="http://twistedmatrix.com/trac/browser/tags/releases/twisted-8.2.0/twisted/internet/protocol.py#L24"><code>twisted.internet.protocol.Factory</code></a>, but we are using the <a href="http://twistedmatrix.com/trac/browser/tags/releases/twisted-8.2.0/twisted/internet/protocol.py#L103"><code>ClientFactory</code></a> sub-class which is specialized for clients (processes that make connections instead of listening for connections like a server).</p>
<p>We are also taking advantage of the fact that the Twisted <code>Factory</code> class implements <code>buildProtocol</code> for us. We call the base class implementation in our <a href="http://github.com/jdavisp3/twisted-intro/blob/master/twisted-client-2/get-poetry.py#L79">sub-class</a>:</p>
<div><div class="syntaxhighlighter  py" id="highlighter_302049"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py keyword">def</code> <code class="py plain">buildProtocol(</code><code class="py color1">self</code><code class="py plain">, address):</code></div><div class="line number2 index1 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">proto </code><code class="py keyword">=</code> <code class="py plain">ClientFactory.buildProtocol(</code><code class="py color1">self</code><code class="py plain">, address)</code></div><div class="line number3 index2 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">proto.task_num </code><code class="py keyword">=</code> <code class="py color1">self</code><code class="py plain">.task_num</code></div><div class="line number4 index3 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py color1">self</code><code class="py plain">.task_num </code><code class="py keyword">+</code><code class="py keyword">=</code> <code class="py value">1</code></div><div class="line number5 index4 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">return</code> <code class="py plain">proto</code></div></div></td></tr></tbody></table></div></div>
<p>How does the base class know what Protocol to build? Notice we are also setting the class attribute <code>protocol</code> on <code>PoetryClientFactory</code>:</p>
<div><div class="syntaxhighlighter  py" id="highlighter_420422"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py keyword">class</code> <code class="py plain">PoetryClientFactory(ClientFactory):</code></div><div class="line number2 index1 alt1">&nbsp;</div><div class="line number3 index2 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">task_num </code><code class="py keyword">=</code> <code class="py value">1</code></div><div class="line number4 index3 alt1">&nbsp;</div><div class="line number5 index4 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">protocol </code><code class="py keyword">=</code> <code class="py plain">PoetryProtocol </code><code class="py comments"># tell base class what proto to build</code></div></div></td></tr></tbody></table></div></div>
<p>The base <code>Factory</code> class implements <code>buildProtocol</code> by instantiating the class we set on <code>protocol</code> (<code>i.e., PoetryProtocol</code>) and setting the <code>factory</code> attribute on that new instance to be a reference to its "parent" Factory. This is illustrated in Figure 8:<a name="figure8"></a></p>
<div style="width: 492px" class="wp-caption aligncenter" id="attachment_1558"><a href="img/protocols-1.png"><img width="482" height="358" alt="Figure 8: a Protocol is born" src="img/protocols-1.png" title="Figure 8: a Protocol is born" class="size-full wp-image-1558"></a><p class="wp-caption-text">Figure 8: a Protocol is born</p></div>
<p>As we mentioned above, the <code>factory</code> attribute on Protocol objects allows Protocols created with the same Factory to share state. And since Factories are created by "user code", that same attribute allows Protocol objects to communicate results back to the code that initiated the request in the first place, as we will see in Part 6.</p>
<p>Note that while the <code>factory</code> attribute on Protocols refers to an instance of a Protocol Factory, the <code>protocol</code> attribute on the Factory refers to the <em>class</em> of the Protocol. In general, a single Factory might create many Protocol instances.</p>
<p>The second stage of Protocol construction connects a Protocol with a Transport, using the <code>makeConnection</code> method. We don't have to implement this method ourselves since the Twisted base class provides a default implementation. By default, <code>makeConnection</code> stores a reference to the Transport on the <code>transport</code> attribute and sets the <code>connected</code> attribute to a True value, as depicted in Figure 9:<a name="figure9"></a></p>
<div style="width: 501px" class="wp-caption aligncenter" id="attachment_1564"><a href="img/protocols-2.png"><img width="491" height="428" alt="Figure 9: a Protocol meets its Transport" src="img/protocols-2.png" title="Figure 9: a Protocol meets its Transport" class="size-full wp-image-1564"></a><p class="wp-caption-text">Figure 9: a Protocol meets its Transport</p></div>
<p>Once initialized in this way, the Protocol can start performing its real job &mdash; translating a lower-level stream of data into a higher-level stream of protocol messages (and vice-versa for 2-way connections). The key method for processing incoming data is <code>dataReceived</code>, which our client implements like <a href="http://github.com/jdavisp3/twisted-intro/blob/master/twisted-client-2/get-poetry.py#L57">this</a>:</p>
<div><div class="syntaxhighlighter  py" id="highlighter_139487"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py keyword">def</code> <code class="py plain">dataReceived(</code><code class="py color1">self</code><code class="py plain">, data):</code></div><div class="line number2 index1 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py color1">self</code><code class="py plain">.poem </code><code class="py keyword">+</code><code class="py keyword">=</code> <code class="py plain">data</code></div><div class="line number3 index2 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">msg </code><code class="py keyword">=</code> <code class="py string">'Task %d: got %d bytes of poetry from %s'</code></div><div class="line number4 index3 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py functions">print</code>&nbsp; <code class="py plain">msg </code><code class="py keyword">%</code> <code class="py plain">(</code><code class="py color1">self</code><code class="py plain">.task_num, </code><code class="py functions">len</code><code class="py plain">(data), </code><code class="py color1">self</code><code class="py plain">.transport.getHost())</code></div></div></td></tr></tbody></table></div></div>
<p>Each time <code>dataReceived</code> is called we get a new sequence of bytes (<code>data</code>) in the form of a string. As always with asynchronous I/O, we don't know how much data we are going to get so we have to buffer it until we receive a complete protocol message. In our case, the poem isn't finished until the connection is closed, so we just keep adding the bytes to our <code>.poem</code> attribute.</p>
<p>Note we are using the <a href="http://twistedmatrix.com/trac/browser/tags/releases/twisted-8.2.0/twisted/internet/interfaces.py#L1341"><code>getHost</code></a> method on our Transport to identify which server the data is coming from. We are only doing this to be consistent with earlier clients. Otherwise our code wouldn't need to use the Transport explicitly at all, since we never send any data to the servers.</p>
<p>Let's take a quick look at what's going on when the <code>dataReceived</code> method is called. In the same directory as our 2.0 client, there is another client called <tt>twisted-client-2/get-poetry-stack.py</tt>. This is just like the 2.0 client except the <code>dataReceived</code> method has been changed like this:</p>
<div><div class="syntaxhighlighter  py" id="highlighter_531338"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py keyword">def</code> <code class="py plain">dataReceived(</code><code class="py color1">self</code><code class="py plain">, data):</code></div><div class="line number2 index1 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">traceback.print_stack()</code></div><div class="line number3 index2 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">os._exit(</code><code class="py value">0</code><code class="py plain">)</code></div></div></td></tr></tbody></table></div></div>
<p>With this change the program will print a stack trace and then quit the first time it receives some data. You could run this version like so:</p>
<pre>python twisted-client-2/get-poetry-stack.py 10000</pre>
<p>And you will get a stack trace like this:</p>
<pre>File "twisted-client-2/get-poetry-stack.py", line 125, in
    poetry_main()

... # I removed a bunch of lines here

File ".../twisted/internet/tcp.py", line 463, in doRead  # Note the doRead callback
    return self.protocol.dataReceived(data)
File "twisted-client-2/get-poetry-stack.py", line 58, in dataReceived
    traceback.print_stack()</pre>
<p>There's the <code>doRead</code> callback we used in client 1.0! As we noted before, Twisted builds new abstractions by using the old ones, not by replacing them. So there is still an <code>IReadDescriptor</code> implementation hard at work, it's just implemented by Twisted instead of our code. If you are curious, Twisted's implementation is in <tt>twisted.internet.tcp</tt>. If you follow the code, you'll find that the same object implements <code>IWriteDescriptor</code> and <code>ITransport</code> too. So the <code>IReadDescriptor</code> is actually the Transport object in disguise. We can visualize a <code>dataReceived</code> callback with Figure 10:</p>
<div style="width: 349px" class="wp-caption aligncenter" id="attachment_1578"><a href="img/reactor-data-received.png"><img width="339" height="335" alt="Figure 10: the dataReceived callback" src="img/reactor-data-received.png" title="Figure 10: the dataReceived callback" class="size-full wp-image-1578"></a><p class="wp-caption-text">Figure 10: the dataReceived callback</p></div>
<p>Once a poem has finished downloading, the <code>PoetryProtocol</code> object notifies its <code>PoetryClientFactory</code>:</p>
<div><div class="syntaxhighlighter  py" id="highlighter_959669"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py keyword">def</code> <code class="py plain">connectionLost(</code><code class="py color1">self</code><code class="py plain">, reason):</code></div><div class="line number2 index1 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py color1">self</code><code class="py plain">.poemReceived(</code><code class="py color1">self</code><code class="py plain">.poem)</code></div><div class="line number3 index2 alt2">&nbsp;</div><div class="line number4 index3 alt1"><code class="py keyword">def</code> <code class="py plain">poemReceived(</code><code class="py color1">self</code><code class="py plain">, poem):</code></div><div class="line number5 index4 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py color1">self</code><code class="py plain">.factory.poem_finished(</code><code class="py color1">self</code><code class="py plain">.task_num, poem)</code></div></div></td></tr></tbody></table></div></div>
<p>The <code>connectionLost</code> callback is invoked when the transport's connection is closed. The <code>reason</code> argument is a <a href="http://twistedmatrix.com/trac/browser/tags/releases/twisted-8.2.0/twisted/python/failure.py"><code>twisted.python.failure.Failure</code></a> object with additional information on whether the connection was closed cleanly or due to an error. Our client just ignores this value and assumes we received the entire poem.</p>
<p>The factory shuts down the reactor after all the poems are done. Once again we assume the only thing our program is doing is downloading poems, which makes <code>PoetryClientFactory</code> objects less reusable. We'll fix that in the next Part, but notice how the <code>poem_finished</code> callback keeps track of the number of poems left to go:</p>
<div><div class="syntaxhighlighter  py" id="highlighter_198827"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py plain">...</code></div><div class="line number2 index1 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py color1">self</code><code class="py plain">.poetry_count </code><code class="py keyword">-</code><code class="py keyword">=</code> <code class="py value">1</code></div><div class="line number3 index2 alt2">&nbsp;</div><div class="line number4 index3 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">if</code> <code class="py color1">self</code><code class="py plain">.poetry_count </code><code class="py keyword">=</code><code class="py keyword">=</code> <code class="py value">0</code><code class="py plain">:</code></div><div class="line number5 index4 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">...</code></div></div></td></tr></tbody></table></div></div>
<p>If we were writing a multi-threaded program where each poem was downloaded in a separate thread we would need to protect this section of code with a lock in case two or more threads invoked <code>poem_finished</code> at the same time. Otherwise we might end up shutting down the reactor twice (and getting a traceback for our troubles). But with a reactive system we needn't bother. The reactor can only make one callback at a time, so this problem just can't happen.</p>
<p>Our new client also handles a failure to connect with more grace than the 1.0 client. Here's the callback on the <code>PoetryClientFactory</code> class which does the job:</p>
<div><div class="syntaxhighlighter  py" id="highlighter_706123"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py keyword">def</code> <code class="py plain">clientConnectionFailed(</code><code class="py color1">self</code><code class="py plain">, connector, reason):</code></div><div class="line number2 index1 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py functions">print</code> <code class="py string">'Failed to connect to:'</code><code class="py plain">, connector.getDestination()</code></div><div class="line number3 index2 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py color1">self</code><code class="py plain">.poem_finished()</code></div></div></td></tr></tbody></table></div></div>
<p>Note the callback is on the factory, not on the protocol. Since a protocol is only created after a connection is made, the factory gets the news when a connection cannot be established.</p>
<h4>A simpler client</h4>
<p>Although our new client is pretty simple already, we can make it simpler if we dispense with the task numbers. The client should really be about the poetry, after all. There is a simplified 2.1 version in <a href="http://github.com/jdavisp3/twisted-intro/blob/master/twisted-client-2/get-poetry-simple.py"><tt>twisted-client-2/get-poetry-simple.py</tt></a>.</p>
<h3>Wrapping Up</h3>
<p>Client 2.0 uses Twisted abstractions that should be familiar to any Twisted hacker. And if all we wanted was a command-line client that printed out some poetry and then quit, we could even stop here and call our program done. But if we wanted some re-usable code, some code that we could embed in a larger program that needs to download some poetry but also do other things, then we still have some work to do. In <a href="http://krondo.com/blog/?p=1595">Part 6</a> we'll take a first stab at it.</p>
<h3>Suggested Exercises</h3>
<ol>
<li>Use <code>callLater</code> to make the client timeout if a poem hasn't finished after a given interval. Use the <a href="http://twistedmatrix.com/trac/browser/tags/releases/twisted-8.2.0/twisted/internet/interfaces.py#L1321"><code>loseConnection</code></a> method on the transport to close the connection on a timeout, and don't forget to cancel the timeout if the poem finishes on time.</li>
<li>Use the stacktrace method to analyze the callback sequence that occurs when <code>connectionLost</code> is invoked.</li>
</ol>
<!-- JOLIPRINT BUTTON BEGINS --><script type="text/javascript">
&amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;lt;!--
try{
$joliprint().set('format','json').set('callback','joliprint_getPdf').set('service','wp-plugin').set('url','http://krondo.com/?p=1522').set('title','Print with Joliprint').set('urloptions','ver=1.1.5').set( 'label', 'joliprint' ).set( 'labelposition', 'after' ).set( 'button', 'joliprint-icon' ).write();
}catch(e){

}
--&amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;gt;</script><!-- JOLIPRINT BUTTON ENDS -->		<div class="fixed"></div>
			</div>
</div>

	

<div class="post" id="post-1595">
	
	

	<div class="content">
		<h2>Part 6: And Then We Took It Higher</h2>
<p>This continues the introduction started <a href="http://krondo.com/wp-content/uploads/2009/08/twisted-intro.html?p=1209">here</a>. You can find an index to the entire series <a href="http://krondo.com/wp-content/uploads/2009/08/twisted-intro.html?page_id=1327">here</a>.</p>
<h3>Poetry for Everyone</h3>
<p>We've made a lot of progress with our poetry client. Our last version (2.0) is using Transports, Protocols, and Protocol Factories, the workhorses of Twisted networking. But there are more improvements to make. Client 2.0 (and also 2.1) can only be used for downloading poetry at the command line. This is because the <code>PoetryClientFactory</code> is not only in charge of getting poetry, but also in charge of shutting down the program when it's finished. That's an odd job for something called "<code>PoetryClientFactory</code>", it really ought to do nothing beyond making <code>PoetryProtocol</code>s and collecting finished poems.</p>
<p>We need a way to send a poem to the code that requested the poem in the first place. In a synchronous program we might make an API like this:</p>
<div><div id="highlighter_231547" class="syntaxhighlighter  py"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py keyword">def</code> <code class="py plain">get_poetry(host, post):</code></div><div class="line number2 index1 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py comments">"""Return a poem from the poetry server at the given host and port."""</code></div></div></td></tr></tbody></table></div></div>
<p>But of course, we can't do that here. The above function necessarily blocks until the poem is received in entirety, otherwise it couldn't work the way the documentation claims. But this is a reactive program so blocking on a network socket is out of the question. We need a way to tell the calling code when the poem is ready, without blocking while the poem is in transit. But this is the same sort of problem that Twisted itself has. Twisted needs to tell our code when a socket is ready for I/O, or when some data has been received, or when a timeout has occurred, etc. We've seen that Twisted solves this problem using callbacks, so we can use callbacks too:</p>
<div><div id="highlighter_264125" class="syntaxhighlighter  py"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py keyword">def</code> <code class="py plain">get_poetry(host, port, callback):</code></div><div class="line number2 index1 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py comments">"""</code></div><div class="line number3 index2 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py comments">Download a poem from the given host and port and invoke</code></div><div class="line number4 index3 alt1">&nbsp;</div><div class="line number5 index4 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py comments">callback(poem)</code></div><div class="line number6 index5 alt1">&nbsp;</div><div class="line number7 index6 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py comments">when the poem is complete.</code></div><div class="line number8 index7 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py comments">"""</code></div></div></td></tr></tbody></table></div></div>
<p>Now we have an asynchronous API we can use with Twisted, so let's go ahead and implement it.</p>
<p style="padding-left: 30px;">As I said before, we will at times be writing code in ways a typical Twisted programmer wouldn't. This is one of those times and one of those ways. We'll see in Parts 7 and 8 how to do this the "Twisted way" (surprise, it uses an abstraction!) but starting out simply will give us more insight into the finished version.</p>
<h3>Client 3.0</h3>
<p>You can find version 3.0 of our poetry client in <a href="http://github.com/jdavisp3/twisted-intro/blob/master/twisted-client-3/get-poetry.py"><tt>twisted-client-3/get-poetry.py</tt></a>. This version has an implementation of the <code>get_poetry</code> <a href="http://github.com/jdavisp3/twisted-intro/blob/master/twisted-client-3/get-poetry.py#L77">function</a>:</p>
<div><div id="highlighter_276506" class="syntaxhighlighter  py"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py keyword">def</code> <code class="py plain">get_poetry(host, port, callback):</code></div><div class="line number2 index1 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">from</code> <code class="py plain">twisted.internet </code><code class="py keyword">import</code> <code class="py plain">reactor</code></div><div class="line number3 index2 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">factory </code><code class="py keyword">=</code> <code class="py plain">PoetryClientFactory(callback)</code></div><div class="line number4 index3 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">reactor.connectTCP(host, port, factory)</code></div></div></td></tr></tbody></table></div></div>
<p>The only new wrinkle here is passing the callback function to the <code>PoetryClientFactory</code>. The <a href="http://github.com/jdavisp3/twisted-intro/blob/master/twisted-client-3/get-poetry.py#L66">factory</a> uses the callback to deliver the poem:</p>
<div><div id="highlighter_118275" class="syntaxhighlighter  py"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py keyword">class</code> <code class="py plain">PoetryClientFactory(ClientFactory):</code></div><div class="line number2 index1 alt1">&nbsp;</div><div class="line number3 index2 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">protocol </code><code class="py keyword">=</code> <code class="py plain">PoetryProtocol</code></div><div class="line number4 index3 alt1">&nbsp;</div><div class="line number5 index4 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">def</code> <code class="py plain">__init__(</code><code class="py color1">self</code><code class="py plain">, callback):</code></div><div class="line number6 index5 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py color1">self</code><code class="py plain">.callback </code><code class="py keyword">=</code> <code class="py plain">callback</code></div><div class="line number7 index6 alt2">&nbsp;</div><div class="line number8 index7 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">def</code> <code class="py plain">poem_finished(</code><code class="py color1">self</code><code class="py plain">, poem):</code></div><div class="line number9 index8 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py color1">self</code><code class="py plain">.callback(poem)</code></div></div></td></tr></tbody></table></div></div>
<p>Notice the factory is much simpler than in version 2.1 since it's no longer in charge of shutting the reactor down. It's also missing the code for detecting failures to connect, but we'll fix that in a little bit. The <code>PoetryProtocol</code> itself doesn't need to change at all so we just re-use the one from client 2.1:</p>
<div><div id="highlighter_78999" class="syntaxhighlighter  py"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py keyword">class</code> <code class="py plain">PoetryProtocol(Protocol):</code></div><div class="line number2 index1 alt1">&nbsp;</div><div class="line number3 index2 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">poem </code><code class="py keyword">=</code> <code class="py plain">''</code></div><div class="line number4 index3 alt1">&nbsp;</div><div class="line number5 index4 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">def</code> <code class="py plain">dataReceived(</code><code class="py color1">self</code><code class="py plain">, data):</code></div><div class="line number6 index5 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py color1">self</code><code class="py plain">.poem </code><code class="py keyword">+</code><code class="py keyword">=</code> <code class="py plain">data</code></div><div class="line number7 index6 alt2">&nbsp;</div><div class="line number8 index7 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">def</code> <code class="py plain">connectionLost(</code><code class="py color1">self</code><code class="py plain">, reason):</code></div><div class="line number9 index8 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py color1">self</code><code class="py plain">.poemReceived(</code><code class="py color1">self</code><code class="py plain">.poem)</code></div><div class="line number10 index9 alt1">&nbsp;</div><div class="line number11 index10 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">def</code> <code class="py plain">poemReceived(</code><code class="py color1">self</code><code class="py plain">, poem):</code></div><div class="line number12 index11 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py color1">self</code><code class="py plain">.factory.poem_finished(poem)</code></div></div></td></tr></tbody></table></div></div>
<p>With this change, the <code>get_poetry</code> function, and the <code>PoetryClientFactory</code> and <code>PoetryProtocol</code> classes, are now completely re-usable. They are all about downloading poetry and nothing else. All the logic for starting up and shutting down the reactor is in the <a href="http://github.com/jdavisp3/twisted-intro/blob/master/twisted-client-3/get-poetry.py#L90">main function</a> of our script:</p>
<div><div id="highlighter_99071" class="syntaxhighlighter  py"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div><div class="line number20 index19 alt1">20</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py keyword">def</code> <code class="py plain">poetry_main():</code></div><div class="line number2 index1 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">addresses </code><code class="py keyword">=</code> <code class="py plain">parse_args()</code></div><div class="line number3 index2 alt2">&nbsp;</div><div class="line number4 index3 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">from</code> <code class="py plain">twisted.internet </code><code class="py keyword">import</code> <code class="py plain">reactor</code></div><div class="line number5 index4 alt2">&nbsp;</div><div class="line number6 index5 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">poems </code><code class="py keyword">=</code> <code class="py plain">[]</code></div><div class="line number7 index6 alt2">&nbsp;</div><div class="line number8 index7 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">def</code> <code class="py plain">got_poem(poem):</code></div><div class="line number9 index8 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">poems.append(poem)</code></div><div class="line number10 index9 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">if</code> <code class="py functions">len</code><code class="py plain">(poems) </code><code class="py keyword">=</code><code class="py keyword">=</code> <code class="py functions">len</code><code class="py plain">(addresses):</code></div><div class="line number11 index10 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">reactor.stop()</code></div><div class="line number12 index11 alt1">&nbsp;</div><div class="line number13 index12 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">for</code> <code class="py plain">address </code><code class="py keyword">in</code> <code class="py plain">addresses:</code></div><div class="line number14 index13 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">host, port </code><code class="py keyword">=</code> <code class="py plain">address</code></div><div class="line number15 index14 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">get_poetry(host, port, got_poem)</code></div><div class="line number16 index15 alt1">&nbsp;</div><div class="line number17 index16 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">reactor.run()</code></div><div class="line number18 index17 alt1">&nbsp;</div><div class="line number19 index18 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">for</code> <code class="py plain">poem </code><code class="py keyword">in</code> <code class="py plain">poems:</code></div><div class="line number20 index19 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py functions">print</code> <code class="py plain">poem</code></div></div></td></tr></tbody></table></div></div>
<p>So if we wanted, we could take the re-usable parts and put them in a shared module that anyone could use to get their poetry (as long as they were using Twisted, of course).</p>
<p>By the way, when you're actually testing client 3.0 you might re-configure the poetry servers to send the poetry faster or in bigger chunks. Now that the client is less chatty in terms of output it's not as interesting to watch while it downloads the poems.</p>
<h3>Discussion</h3>
<p>We can visualize the callback chain at the point when a poem is delivered in Figure 11:<a name="figure11"></a></p>
<div id="attachment_1618" class="wp-caption aligncenter" style="width: 374px"><a href="img/reactor-poem-callback.png"><img width="364" height="385" class="size-full wp-image-1618" title="Figure 11: the poem callbacks" src="img/reactor-poem-callback.png" alt="Figure 11: the poem callbacks"></a><p class="wp-caption-text">Figure 11: the poem callbacks</p></div>
<p>Figure 11 is worth contemplating. Up until now we have depicted callback chains that terminate with a single call to "our code". But when you are programming with Twisted, or any single-threaded reactive system, these callback chains might well include bits of our code making callbacks to other bits of our code. In other words, the reactive style of programming doesn't stop when it reaches code we write ourselves. In a reactor-based system, it's callbacks all the way down.</p>
<p>Keep that fact in mind when choosing Twisted for a project. When you make this decision:</p>
<blockquote><p>I'm going to use Twisted!</p></blockquote>
<p>You are also making this decision:</p>
<blockquote><p>I'm going to structure my program as a series of asynchronous callback chain invocations powered by a reactor loop!</p></blockquote>
<p>Now maybe you won't exclaim it out loud the way I do, but it is nevertheless the case. That's how Twisted works.</p>
<p>It's likely that most Python programs are synchronous and most Python modules are synchronous too. If we were writing a synchronous program and suddenly realized it needed some poetry, we might use the synchronous version of our <code>get_poetry</code> function by adding a few lines of code to our script like these:</p>
<div><div id="highlighter_660317" class="syntaxhighlighter  py"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py plain">...</code></div><div class="line number2 index1 alt1"><code class="py keyword">import</code> <code class="py plain">poetrylib </code><code class="py comments"># I just made this module name up</code></div><div class="line number3 index2 alt2"><code class="py plain">poem </code><code class="py keyword">=</code> <code class="py plain">poetrylib.get_poetry(host, port)</code></div><div class="line number4 index3 alt1"><code class="py plain">...</code></div></div></td></tr></tbody></table></div></div>
<p>And continue on our way. If, later on, we decided we didn't really want that poem after all then we'd just snip out those lines and no one would be the wiser. But if we were writing a synchronous program and then decided to use the Twisted version of <code>get_poetry</code>, we would need to re-architect our program in the asynchronous style using callbacks. We would probably have to make significant changes to the code. Now, I'm not saying it would necessarily be a mistake to rewrite the program. It might very well make sense to do so given our requirements. But it won't be as simple as adding an <code>import</code> line and an extra function call. Simply put, synchronous and asynchronous code do not mix.</p>
<p>If you are new to Twisted and asynchronous programming, I might recommend writing a few Twisted programs from scratch before you attempt to port an existing codebase. That way you will get a feel for using Twisted without the extra complexity of trying to think in both modes at once as you port from one to the other.</p>
<p style="padding-left: 30px;">If, however, your program is already asynchronous then using Twisted might be much easier. Twisted integrates relatively smoothly with <a href="http://pygtk.org">pyGTK</a> and <a href="http://wiki.python.org/moin/PyQt">pyQT</a>, the Python APIs for two reactor-based GUI toolkits.</p>
<h3>When Things Go Wrong</h3>
<p>In client 3.0 we no longer detect a failure to connect to a poetry server, an omission which causes even more problems than it did in client 1.0. If we tell client 3.0 to download a poem from a non-existent server then instead of crashing it just waits there forever. The <code>clientConnectionFailed</code> callback still gets called, but the default implementation in the <a href="http://twistedmatrix.com/trac/browser/tags/releases/twisted-8.2.0/twisted/internet/protocol.py#L103"><code>ClientFactory</code></a> base class doesn't do anything at all. So the <code>got_poem</code> callback is never called, the reactor is never stopped, and we've got another do-nothing program like the ones we made in <a href="http://krondo.com/blog/?p=1247">Part 2</a>.</p>
<p>Clearly we need to handle this error, but where? The information about the failure to connect is delivered to the factory object via <code>clientConnectionFailed</code> so we'll have to start there. But this factory is supposed to be re-usable, and the proper way to handle an error will depend on the context in which the factory is being used. In some applications, missing poetry might be a disaster (No poetry?? Might as well just crash). In others, maybe we just keep on going and try to get another poem from somewhere else.</p>
<p>In other words, the users of <code>get_poetry</code> need to know when things go wrong, not just when they go right. In a synchronous program, <code>get_poetry</code> would raise an <code>Exception</code> and the calling code could handle it with a <code>try</code>/<code>except</code> statement. But in a reactive program, error conditions have to be delivered asynchronously, too. After all, we won't even find out the connection failed until after <code>get_poetry</code> returns. Here's one possibility:</p>
<div><div id="highlighter_109870" class="syntaxhighlighter  py"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py keyword">def</code> <code class="py plain">get_poetry(host, port, callback):</code></div><div class="line number2 index1 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py comments">"""</code></div><div class="line number3 index2 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py comments">Download a poem from the given host and port and invoke</code></div><div class="line number4 index3 alt1">&nbsp;</div><div class="line number5 index4 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py comments">callback(poem)</code></div><div class="line number6 index5 alt1">&nbsp;</div><div class="line number7 index6 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py comments">when the poem is complete. If there is a failure, invoke:</code></div><div class="line number8 index7 alt1">&nbsp;</div><div class="line number9 index8 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py comments">callback(None)</code></div><div class="line number10 index9 alt1">&nbsp;</div><div class="line number11 index10 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py comments">instead.</code></div><div class="line number12 index11 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py comments">"""</code></div></div></td></tr></tbody></table></div></div>
<p>By testing the callback argument (i.e., <code>if poem is None</code>) the client can determine whether we actually got a poem or not. This would suffice for our client to avoid running forever, but that approach still has some problems. First of all, using <code>None</code> to indicate failure is somewhat ad-hoc. Some asynchronous APIs might want to use <code>None</code> as a default return value instead of an error condition. Second, a <code>None</code> value carries a very limited amount of information. It can't tell us what went wrong, or include a traceback object we can use in debugging. Ok, second try:</p>
<div><div id="highlighter_815990" class="syntaxhighlighter  py"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py keyword">def</code> <code class="py plain">get_poetry(host, port, callback):</code></div><div class="line number2 index1 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py comments">"""</code></div><div class="line number3 index2 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py comments">Download a poem from the given host and port and invoke</code></div><div class="line number4 index3 alt1">&nbsp;</div><div class="line number5 index4 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py comments">callback(poem)</code></div><div class="line number6 index5 alt1">&nbsp;</div><div class="line number7 index6 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py comments">when the poem is complete. If there is a failure, invoke:</code></div><div class="line number8 index7 alt1">&nbsp;</div><div class="line number9 index8 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py comments">callback(err)</code></div><div class="line number10 index9 alt1">&nbsp;</div><div class="line number11 index10 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py comments">instead, where err is an Exception instance.</code></div><div class="line number12 index11 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py comments">"""</code></div></div></td></tr></tbody></table></div></div>
<p>Using an <code>Exception</code> is closer to what we are used to with synchronous programming. Now we can look at the exception to get more information about what went wrong and <code>None</code> is free for use as a regular value. Normally, though, when we encounter an exception in Python we also get a traceback we can analyze or print to a log for debugging at some later date. Tracebacks are extremely useful so we shouldn't give them up just because we are using asynchronous programming.</p>
<p>Keep in mind we don't want a traceback object for the point where our callback is invoked, that's not where the problem happened. What we really want is both the <code>Exception</code> instance and the traceback from the point where that exception was raised (assuming it was raised and not simply created).</p>
<p>Twisted includes an abstraction called a <a href="http://twistedmatrix.com/trac/browser/tags/releases/twisted-8.2.0/twisted/python/failure.py#L121"><code>Failure</code></a> that wraps up both an <code>Exception</code> and the traceback, if any, that went with it. The <code>Failure</code> <a href="http://twistedmatrix.com/trac/browser/tags/releases/twisted-8.2.0/twisted/python/failure.py#L141">docstring</a> explains how to create one. By passing <code>Failure</code> objects to callbacks we can preserve the traceback information that's so handy for debugging.</p>
<p>There is some example code that uses <code>Failure</code> objects in <a href="http://github.com/jdavisp3/twisted-intro/blob/master/twisted-failure/failure-examples.py"><tt>twisted-failure/failure-examples.py</tt></a>. It shows how <code>Failure</code>s can preserve the traceback information from a raised exception, even outside the context of an <code>except</code> block. We won't dwell too much on making <code>Failure</code> instances. In Part 7 we'll see that Twisted generally ends up making them for us.</p>
<p>Alright, third try:</p>
<div><div id="highlighter_367738" class="syntaxhighlighter  py"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py keyword">def</code> <code class="py plain">get_poetry(host, port, callback):</code></div><div class="line number2 index1 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py comments">"""</code></div><div class="line number3 index2 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py comments">Download a poem from the given host and port and invoke</code></div><div class="line number4 index3 alt1">&nbsp;</div><div class="line number5 index4 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py comments">callback(poem)</code></div><div class="line number6 index5 alt1">&nbsp;</div><div class="line number7 index6 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py comments">when the poem is complete. If there is a failure, invoke:</code></div><div class="line number8 index7 alt1">&nbsp;</div><div class="line number9 index8 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py comments">callback(err)</code></div><div class="line number10 index9 alt1">&nbsp;</div><div class="line number11 index10 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py comments">instead, where err is a twisted.python.failure.Failure instance.</code></div><div class="line number12 index11 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py comments">"""</code></div></div></td></tr></tbody></table></div></div>
<p>With this version we get both an <code>Exception</code> and possibly a traceback record when things go wrong. Nice.</p>
<p>We're almost there, but we've got one more problem. Using the same callback for both normal results and failures is kind of odd. In general, we need to do quite different things on failure than on success. In a synchronous Python program we generally handle success and failure with two different code paths in a <code>try</code>/<code>except</code> statement like this:</p>
<div><div id="highlighter_566203" class="syntaxhighlighter  py"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py keyword">try</code><code class="py plain">:</code></div><div class="line number2 index1 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">attempt_to_do_something_with_poetry()</code></div><div class="line number3 index2 alt2"><code class="py keyword">except</code> <code class="py plain">RhymeSchemeViolation:</code></div><div class="line number4 index3 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py comments"># the code path when things go wrong</code></div><div class="line number5 index4 alt2"><code class="py keyword">else</code><code class="py plain">:</code></div><div class="line number6 index5 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py comments"># the code path when things go so, so right baby</code></div></div></td></tr></tbody></table></div></div>
<p>If we want to preserve this style of error-handling, then we need to use a separate code path for failures. In asynchronous programming a separate code path means a separate callback:</p>
<div><div id="highlighter_756533" class="syntaxhighlighter  py"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py keyword">def</code> <code class="py plain">get_poetry(host, port, callback, errback):</code></div><div class="line number2 index1 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py comments">"""</code></div><div class="line number3 index2 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py comments">Download a poem from the given host and port and invoke</code></div><div class="line number4 index3 alt1">&nbsp;</div><div class="line number5 index4 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py comments">callback(poem)</code></div><div class="line number6 index5 alt1">&nbsp;</div><div class="line number7 index6 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py comments">when the poem is complete. If there is a failure, invoke:</code></div><div class="line number8 index7 alt1">&nbsp;</div><div class="line number9 index8 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py comments">errback(err)</code></div><div class="line number10 index9 alt1">&nbsp;</div><div class="line number11 index10 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py comments">instead, where err is a twisted.python.failure.Failure instance.</code></div><div class="line number12 index11 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py comments">"""</code></div></div></td></tr></tbody></table></div></div>
<h3>Client 3.1</h3>
<p>Now that we have an API with reasonable error-handling semantics we can implement it. Client 3.1 is located in <a href="http://github.com/jdavisp3/twisted-intro/blob/master/twisted-client-3/get-poetry-1.py"><code>twisted-client-3/get-poetry-1.py</code></a>. The changes are pretty straightforward. The <a href="http://github.com/jdavisp3/twisted-intro/blob/master/twisted-client-3/get-poetry-1.py#L66"><code>PoetryClientFactory</code></a> gets both a <code>callback</code> and an <code>errback</code>, and now it implements <code>clientConnectionFailed</code>:</p>
<div><div id="highlighter_914400" class="syntaxhighlighter  py"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py keyword">class</code> <code class="py plain">PoetryClientFactory(ClientFactory):</code></div><div class="line number2 index1 alt1">&nbsp;</div><div class="line number3 index2 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">protocol </code><code class="py keyword">=</code> <code class="py plain">PoetryProtocol</code></div><div class="line number4 index3 alt1">&nbsp;</div><div class="line number5 index4 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">def</code> <code class="py plain">__init__(</code><code class="py color1">self</code><code class="py plain">, callback, errback):</code></div><div class="line number6 index5 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py color1">self</code><code class="py plain">.callback </code><code class="py keyword">=</code> <code class="py plain">callback</code></div><div class="line number7 index6 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py color1">self</code><code class="py plain">.errback </code><code class="py keyword">=</code> <code class="py plain">errback</code></div><div class="line number8 index7 alt1">&nbsp;</div><div class="line number9 index8 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">def</code> <code class="py plain">poem_finished(</code><code class="py color1">self</code><code class="py plain">, poem):</code></div><div class="line number10 index9 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py color1">self</code><code class="py plain">.callback(poem)</code></div><div class="line number11 index10 alt2">&nbsp;</div><div class="line number12 index11 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">def</code> <code class="py plain">clientConnectionFailed(</code><code class="py color1">self</code><code class="py plain">, connector, reason):</code></div><div class="line number13 index12 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py color1">self</code><code class="py plain">.errback(reason)</code></div></div></td></tr></tbody></table></div></div>
<p>Since <a href="http://twistedmatrix.com/trac/browser/tags/releases/twisted-8.2.0/twisted/internet/protocol.py#L118"><code>clientConnectionFailed</code></a> already receives a <code>Failure</code> object (the <code>reason</code> argument) that explains why the connection failed, we just pass that along to the <code>errback</code>.</p>
<p>The other changes are all of a piece so I won't bother posting them here. You can test client 3.1 by using a port with no server like this:</p>
<pre>python twisted-client-3/get-poetry-1.py 10004</pre>
<p>And you'll get some output like this:</p>
<pre>Poem failed: [Failure instance: Traceback (failure with no frames): : Connection was refused by other side: 111: Connection refused.
]</pre>
<p>That's from the <code>print</code> statement in our <a href="http://github.com/jdavisp3/twisted-intro/blob/master/twisted-client-3/get-poetry-1.py#L110"><code>poem_failed</code></a> errback. In this case, Twisted has simply passed us an <code>Exception</code> rather than raising it, so we don't get a traceback here. But a traceback isn't really needed since this isn't a bug, it's just Twisted informing us, correctly, that we can't connect to that address.</p>
<h3>Summary</h3>
<p>Here's what we've learned in Part 6:</p>
<ul>
<li>The APIs we write for Twisted programs will have to be asynchronous.</li>
<li>We can't mix synchronous code with asynchronous code.</li>
<li>Thus, we have to use callbacks in our own code, just like Twisted does.</li>
<li>And we have to handle errors with callbacks, too.</li>
</ul>
<p>Does that mean every API we write with Twisted has to include two extra arguments, a callback and an errback? That doesn't sound so nice. Fortunately, Twisted has an abstraction we can use to eliminate both those arguments and pick up a few extra features in the bargain. We'll learn about it in <a href="http://krondo.com/blog/?p=1682">Part 7</a>.</p>
<h3>Suggested Exercises</h3>
<ol>
<li>Update client 3.1 to timeout if the poem isn't received after a given period of time. Invoke the errback with a custom exception in that case. Don't forget to close the connection when you do.</li>
<li>Study the <a href="http://twistedmatrix.com/trac/browser/tags/releases/twisted-8.2.0/twisted/python/failure.py#L278"><code>trap</code></a> method on <code>Failure</code> objects. Compare it to the <code>except</code> clause in the <code>try</code>/<code>except</code> statement.</li>
<li>Use <code>print</code> statements to verify that <code>clientConnectionFailed</code> is called after <code>get_poetry</code> returns.</li>
</ol>
<!-- JOLIPRINT BUTTON BEGINS --><script type="text/javascript">
&amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;lt;!--
try{
$joliprint().set('format','json').set('callback','joliprint_getPdf').set('service','wp-plugin').set('url','http://krondo.com/?p=1595').set('title','Print with Joliprint').set('urloptions','ver=1.1.5').set( 'label', 'joliprint' ).set( 'labelposition', 'after' ).set( 'button', 'joliprint-icon' ).write();
}catch(e){

}
--&amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;gt;</script><!-- JOLIPRINT BUTTON ENDS -->		<div class="fixed"></div>
			</div>
</div>	


<div id="post-1682" class="post">
	
	

	<div class="content">
		<h2>Part 7: An Interlude,&nbsp; Deferred</h2>
<p>This continues the introduction started <a href="http://krondo.com/wp-content/uploads/2009/08/twisted-intro.html?p=1209">here</a>. You can find an index to the entire series <a href="http://krondo.com/wp-content/uploads/2009/08/twisted-intro.html?page_id=1327">here</a>.</p>
<h3>Callbacks and Their Consequences</h3>
<p>In <a href="http://krondo.com/blog/?p=1595">Part 6</a> we came face-to-face with this fact: callbacks are a fundamental aspect of asynchronous programming with Twisted. Rather than just a way of interfacing with the reactor, callbacks will be woven into the structure of any Twisted program we write. So using Twisted, or any reactor-based asynchronous system, means organizing our code in a particular way, as a series of "callback chains" invoked by a reactor loop.</p>
<p>Even an API as simple as our <a href="http://github.com/jdavisp3/twisted-intro/blob/master/twisted-client-3/get-poetry-1.py#L81"><code>get_poetry</code></a> function required callbacks, two of them in fact: one for normal results and one for errors. Since, as Twisted programmers, we're going to have to make so much use of them, we should spend a little bit of time thinking about the best ways to use callbacks, and what sort of pitfalls we might encounter.</p>
<p>Consider this piece of code that uses the Twisted version of <code>get_poetry</code> from client 3.1:</p>
<div><div class="syntaxhighlighter  py" id="highlighter_253997"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py plain">...</code></div><div class="line number2 index1 alt1"><code class="py keyword">def</code> <code class="py plain">got_poem(poem):</code></div><div class="line number3 index2 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py functions">print</code> <code class="py plain">poem</code></div><div class="line number4 index3 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">reactor.stop()</code></div><div class="line number5 index4 alt2">&nbsp;</div><div class="line number6 index5 alt1"><code class="py keyword">def</code> <code class="py plain">poem_failed(err):</code></div><div class="line number7 index6 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py functions">print</code> <code class="py plain">&gt;&gt;sys.stderr, </code><code class="py string">'poem download failed'</code></div><div class="line number8 index7 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py functions">print</code> <code class="py plain">&gt;&gt;sys.stderr, </code><code class="py string">'I am terribly sorry'</code></div><div class="line number9 index8 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py functions">print</code> <code class="py plain">&gt;&gt;sys.stderr, </code><code class="py string">'try again later?'</code></div><div class="line number10 index9 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">reactor.stop()</code></div><div class="line number11 index10 alt2">&nbsp;</div><div class="line number12 index11 alt1"><code class="py plain">get_poetry(host, port, got_poem, poem_failed)</code></div><div class="line number13 index12 alt2">&nbsp;</div><div class="line number14 index13 alt1"><code class="py plain">reactor.run()</code></div></div></td></tr></tbody></table></div></div>
<p>The basic plan here is clear:</p>
<ol>
<li>If we get the poem, print it out.</li>
<li>If we don't get the poem, print out an Error Haiku.</li>
<li>In either case, end the program.</li>
</ol>
<p>The 'synchronous analogue' to the above code might look something like this:</p>
<div><div class="syntaxhighlighter  py" id="highlighter_399739"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py plain">...</code></div><div class="line number2 index1 alt1"><code class="py keyword">try</code><code class="py plain">:</code></div><div class="line number3 index2 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">poem </code><code class="py keyword">=</code> <code class="py plain">get_poetry(host, port) </code><code class="py comments"># the synchronous version of get_poetry</code></div><div class="line number4 index3 alt1"><code class="py keyword">except</code> <code class="py plain">Exception, err:</code></div><div class="line number5 index4 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py functions">print</code> <code class="py plain">&gt;&gt;sys.stderr, </code><code class="py string">'poem download failed'</code></div><div class="line number6 index5 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py functions">print</code> <code class="py plain">&gt;&gt;sys.stderr, </code><code class="py string">'I am terribly sorry'</code></div><div class="line number7 index6 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py functions">print</code> <code class="py plain">&gt;&gt;sys.stderr, </code><code class="py string">'try again later?'</code></div><div class="line number8 index7 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">sys.exit()</code></div><div class="line number9 index8 alt2"><code class="py keyword">else</code><code class="py plain">:</code></div><div class="line number10 index9 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py functions">print</code> <code class="py plain">poem</code></div><div class="line number11 index10 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">sys.exit()</code></div></div></td></tr></tbody></table></div></div>
<p>So the callback is like the <code>else</code> block and the errback is like the <code>except</code>. That means invoking the errback is the asynchronous analogue to raising an exception and invoking the callback corresponds to the normal program flow.</p>
<p>What are some of the differences between the two versions? For one thing, in the synchronous version the Python interpreter will ensure that, as long as <code>get_poetry</code> raises any kind of exception at all, for any reason, the <code>except</code> block will run. If we trust the interpreter to run Python code correctly we can trust that error block to run at the right time.</p>
<p>Contrast that with the asynchronous version: the <code>poem_failed</code> errback is invoked by <em>our</em> code, the <a href="http://github.com/jdavisp3/twisted-intro/blob/master/twisted-client-3/get-poetry-1.py#L77"><code>clientConnectionFailed</code></a> method of the <a href="http://github.com/jdavisp3/twisted-intro/blob/master/twisted-client-3/get-poetry-1.py#L66"><code>PoetryClientFactory</code></a>. We, not Python, are in charge of making sure the error code runs if something goes wrong. So we have to make sure to handle every possible error case by invoking the errback with a <code>Failure</code> object. Otherwise, our program will become "stuck" waiting for a callback that never comes.</p>
<p>That shows another difference between the synchronous and asynchronous versions. If we didn't bother catching the exception in the synchronous version (by not using a <code>try</code>/<code>except</code>), the Python interpreter would "catch" it for us and crash to show us the error of our ways. But if we forget to "raise" our asynchronous exception (by calling the errback function in <code>PoetryClientFactory</code>), our program will just run forever, blissfully unaware that anything is amiss.</p>
<p>Clearly, handling errors in an asynchronous program is important, and also somewhat tricky. You might say that handling errors in asynchronous code is actually more important than handling the normal case, as things can go wrong in far more ways than they can go right. Forgetting to handle the error case is a common mistake when programming with Twisted.</p>
<p>Here's another fact about the synchronous code above: either the <code>else</code> block runs exactly once, or the <code>except</code> block runs exactly once (assuming the synchronous version of <code>get_poetry</code> doesn't enter an infinite loop). The Python interpreter won't suddenly decide to run them both or, on a whim, run the <code>else</code> block twenty-seven times. And it would be basically impossible to program in Python if it did!</p>
<p>But again, in the asynchronous case <em>we</em> are in charge of running the callback or the errback. Knowing us, we might make some mistakes. We could call both the callback and the errback, or invoke the callback twenty-seven times. That would be unfortunate for the users of <code>get_poetry</code>. Although the docstring doesn't explicitly say so, it really goes without saying that, like the <code>else</code> and <code>except</code> blocks in a <code>try</code>/<code>except</code> statement, either the callback will run exactly once or the errback will run exactly once, for each specific call to <code>get_poetry</code>. Either we get the poem or we don't.</p>
<p>Imagine trying to debug a program that makes three poetry requests and gets seven callback invocations and two errback invocations. Where would you even start? You'd probably end up writing your callbacks and errbacks to detect when they got invoked a second time for the same <code>get_poetry</code> call and throw an exception right back. Take that, <code>get_poetry</code>.</p>
<p>One more observation: both versions have some duplicate code. The asynchronous version has two calls to <code>reactor.stop</code> and the synchronous version has two calls to <code>sys.exit</code>. We might refactor the synchronous version like this:</p>
<div><div class="syntaxhighlighter  py" id="highlighter_32413"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py plain">...</code></div><div class="line number2 index1 alt1"><code class="py keyword">try</code><code class="py plain">:</code></div><div class="line number3 index2 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">poem </code><code class="py keyword">=</code> <code class="py plain">get_poetry(host, port) </code><code class="py comments"># the synchronous version of get_poetry</code></div><div class="line number4 index3 alt1"><code class="py keyword">except</code> <code class="py plain">Exception, err:</code></div><div class="line number5 index4 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py functions">print</code> <code class="py plain">&gt;&gt;sys.stderr, </code><code class="py string">'poem download failed'</code></div><div class="line number6 index5 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py functions">print</code> <code class="py plain">&gt;&gt;sys.stderr, </code><code class="py string">'I am terribly sorry'</code></div><div class="line number7 index6 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py functions">print</code> <code class="py plain">&gt;&gt;sys.stderr, </code><code class="py string">'try again later?'</code></div><div class="line number8 index7 alt1"><code class="py keyword">else</code><code class="py plain">:</code></div><div class="line number9 index8 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py functions">print</code> <code class="py plain">poem</code></div><div class="line number10 index9 alt1">&nbsp;</div><div class="line number11 index10 alt2"><code class="py plain">sys.exit()</code></div></div></td></tr></tbody></table></div></div>
<p>Can we refactor the asynchronous version in a similar way? It's not really clear that we can, since the callback and errback are two different functions. Do we have to go back to a single callback to make this possible?</p>
<p>Ok, here are some of the insights we've discovered about programming with callbacks:</p>
<ol>
<li>Calling errbacks is very important. Since errbacks take the place of <code>except</code> blocks, users need to be able to count on them. They aren't an optional feature of our APIs.</li>
<li><em>Not</em> invoking callbacks at the wrong time is just as important as calling them at the right time. For a typical use case, the callback and errback are mutually exclusive and invoked exactly once.</li>
<li>Refactoring common code might be harder when using callbacks.</li>
</ol>
<p>We'll have more to say about callbacks in future Parts, but for now this is enough to see why Twisted might have an abstraction devoted to managing them.</p>
<h3>The Deferred</h3>
<p>Since callbacks are used so much in asynchronous programming, and since using them correctly can, as we have discovered, be a bit tricky, the Twisted developers created an abstraction called a <code>Deferred</code> to make programming with callbacks easier. The <code>Deferred</code> class is defined in <a href="http://twistedmatrix.com/trac/browser/tags/releases/twisted-8.2.0/twisted/internet/defer.py#L132"><code>twisted.internet.defer</code></a>.</p>
<p style="padding-left: 30px;">The word "deferred" is either a verb or an adjective in everyday English, so it might sound a little strange used as a noun. Just know that, from now on, when I use the phrase "the deferred" or "a deferred", I'm referring to an instance of the <code>Deferred</code> class. We'll talk about why it is called <code>Deferred</code> in a future Part. It might help to mentally add the word "result" to each phrase, as in "the deferred result". As we will eventually see, that's really what it is.</p>
<p>A deferred contains a pair of callback chains, one for normal results and one for errors. A newly-created deferred has two empty chains. We can populate the chains by adding callbacks and errbacks and then <em>fire</em> the deferred with either a normal result (here's your poem!) or an exception (I couldn't get the poem, and here's why). Firing the deferred will invoke the appropriate callbacks or errbacks in the order they were added. Figure 12 illustrates a deferred instance with its callback/errback chains:<a name="figure12"></a></p>
<div style="width: 646px" class="wp-caption aligncenter" id="attachment_1763"><a href="img/deferred-1.png"><img width="636" height="325" alt="Figure 12: A Deferred" src="img/deferred-1.png" title="Figure 12: A Deferred" class="size-full wp-image-1763"></a><p class="wp-caption-text">Figure 12: A Deferred</p></div>
<p>Let's try this out. Since deferreds don't use the reactor, we can test them out without starting up the loop.</p>
<p style="padding-left: 30px;">You might have noticed a method on <code>Deferred</code> called <code>setTimeout</code> that does use the reactor. It is deprecated and will cease to exist in a future release. Pretend it's not there and don't use it.</p>
<p>Our first example is in <a href="http://github.com/jdavisp3/twisted-intro/blob/master/twisted-deferred/defer-1.py"><tt>twisted-deferred/defer-1.py</tt></a>:</p>
<div><div class="syntaxhighlighter  py" id="highlighter_380315"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py keyword">from</code> <code class="py plain">twisted.internet.defer </code><code class="py keyword">import</code> <code class="py plain">Deferred</code></div><div class="line number2 index1 alt1">&nbsp;</div><div class="line number3 index2 alt2"><code class="py keyword">def</code> <code class="py plain">got_poem(res):</code></div><div class="line number4 index3 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py functions">print</code> <code class="py string">'Your poem is served:'</code></div><div class="line number5 index4 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py functions">print</code> <code class="py plain">res</code></div><div class="line number6 index5 alt1">&nbsp;</div><div class="line number7 index6 alt2"><code class="py keyword">def</code> <code class="py plain">poem_failed(err):</code></div><div class="line number8 index7 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py functions">print</code> <code class="py string">'No poetry for you.'</code></div><div class="line number9 index8 alt2">&nbsp;</div><div class="line number10 index9 alt1"><code class="py plain">d </code><code class="py keyword">=</code> <code class="py plain">Deferred()</code></div><div class="line number11 index10 alt2">&nbsp;</div><div class="line number12 index11 alt1"><code class="py comments"># add a callback/errback pair to the chain</code></div><div class="line number13 index12 alt2"><code class="py plain">d.addCallbacks(got_poem, poem_failed)</code></div><div class="line number14 index13 alt1">&nbsp;</div><div class="line number15 index14 alt2"><code class="py comments"># fire the chain with a normal result</code></div><div class="line number16 index15 alt1"><code class="py plain">d.callback(</code><code class="py string">'This poem is short.'</code><code class="py plain">)</code></div><div class="line number17 index16 alt2">&nbsp;</div><div class="line number18 index17 alt1"><code class="py functions">print</code> <code class="py string">"Finished"</code></div></div></td></tr></tbody></table></div></div>
<p>This code makes a new deferred, adds a callback/errback pair with the <code>addCallbacks</code> method, and then fires the "normal result" chain with the <code>callback</code> method. Of course, it's not much of a chain since it only has a single callback, but no matter. Run the code and it produces this output:</p>
<pre>Your poem is served:
This poem is short.
Finished</pre>
<p>That's pretty simple. Here are some things to notice:</p>
<ol>
<li>Just like the callback/errback pairs we used in client 3.1, the callbacks we add to this deferred each take one argument, either a normal result or an error result. It turns out that deferreds support callbacks and errbacks with multiple arguments, but they always have at least one, and the first argument is always either a normal result or an error result.</li>
<li>We add callbacks and errbacks to the deferred in pairs.</li>
<li>The <code>callback</code> method fires the deferred with a normal result, the method's only argument.</li>
<li>Looking at the order of the <code>print</code> output, we can see that firing the deferred invokes the callbacks immediately. There's nothing asynchronous going on at all. There can't be, since no reactor is running. It really boils down to an ordinary Python function call.</li>
</ol>
<p>Ok, let's push the other button. The example in <a href="http://github.com/jdavisp3/twisted-intro/blob/master/twisted-deferred/defer-2.py"><tt>twisted-deferred/defer-2.py</tt></a> fires the deferred's errback chain:</p>
<div><div class="syntaxhighlighter  py" id="highlighter_180239"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py keyword">from</code> <code class="py plain">twisted.internet.defer </code><code class="py keyword">import</code> <code class="py plain">Deferred</code></div><div class="line number2 index1 alt1"><code class="py keyword">from</code> <code class="py plain">twisted.python.failure </code><code class="py keyword">import</code> <code class="py plain">Failure</code></div><div class="line number3 index2 alt2">&nbsp;</div><div class="line number4 index3 alt1"><code class="py keyword">def</code> <code class="py plain">got_poem(res):</code></div><div class="line number5 index4 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py functions">print</code> <code class="py string">'Your poem is served:'</code></div><div class="line number6 index5 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py functions">print</code> <code class="py plain">res</code></div><div class="line number7 index6 alt2">&nbsp;</div><div class="line number8 index7 alt1"><code class="py keyword">def</code> <code class="py plain">poem_failed(err):</code></div><div class="line number9 index8 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py functions">print</code> <code class="py string">'No poetry for you.'</code></div><div class="line number10 index9 alt1">&nbsp;</div><div class="line number11 index10 alt2"><code class="py plain">d </code><code class="py keyword">=</code> <code class="py plain">Deferred()</code></div><div class="line number12 index11 alt1">&nbsp;</div><div class="line number13 index12 alt2"><code class="py comments"># add a callback/errback pair to the chain</code></div><div class="line number14 index13 alt1"><code class="py plain">d.addCallbacks(got_poem, poem_failed)</code></div><div class="line number15 index14 alt2">&nbsp;</div><div class="line number16 index15 alt1"><code class="py comments"># fire the chain with an error result</code></div><div class="line number17 index16 alt2"><code class="py plain">d.errback(Failure(Exception(</code><code class="py string">'I have failed.'</code><code class="py plain">)))</code></div><div class="line number18 index17 alt1">&nbsp;</div><div class="line number19 index18 alt2"><code class="py functions">print</code> <code class="py string">"Finished"</code></div></div></td></tr></tbody></table></div></div>
<p>And after running that script we get this output:</p>
<pre>No poetry for you.
Finished</pre>
<p>So firing the errback chain is just a matter of calling the <code>errback</code> method instead of the <code>callback</code> method, and the method argument is the error result. And just as with callbacks, the errbacks are invoked immediately upon firing.</p>
<p>In the previous example we are passing a <code>Failure</code> object to the <code>errback</code> method like we did in client 3.1. That's just fine, but a deferred will turn ordinary <code>Exception</code>s into <code>Failure</code>s for us. We can see that with <a href="http://github.com/jdavisp3/twisted-intro/blob/master/twisted-deferred/defer-3.py"><tt>twisted-deferred/defer-3.py</tt></a>:</p>
<div><div class="syntaxhighlighter  py" id="highlighter_412810"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py keyword">from</code> <code class="py plain">twisted.internet.defer </code><code class="py keyword">import</code> <code class="py plain">Deferred</code></div><div class="line number2 index1 alt1">&nbsp;</div><div class="line number3 index2 alt2"><code class="py keyword">def</code> <code class="py plain">got_poem(res):</code></div><div class="line number4 index3 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py functions">print</code> <code class="py string">'Your poem is served:'</code></div><div class="line number5 index4 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py functions">print</code> <code class="py plain">res</code></div><div class="line number6 index5 alt1">&nbsp;</div><div class="line number7 index6 alt2"><code class="py keyword">def</code> <code class="py plain">poem_failed(err):</code></div><div class="line number8 index7 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py functions">print</code> <code class="py plain">err.__class__</code></div><div class="line number9 index8 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py functions">print</code> <code class="py plain">err</code></div><div class="line number10 index9 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py functions">print</code> <code class="py string">'No poetry for you.'</code></div><div class="line number11 index10 alt2">&nbsp;</div><div class="line number12 index11 alt1"><code class="py plain">d </code><code class="py keyword">=</code> <code class="py plain">Deferred()</code></div><div class="line number13 index12 alt2">&nbsp;</div><div class="line number14 index13 alt1"><code class="py comments"># add a callback/errback pair to the chain</code></div><div class="line number15 index14 alt2"><code class="py plain">d.addCallbacks(got_poem, poem_failed)</code></div><div class="line number16 index15 alt1">&nbsp;</div><div class="line number17 index16 alt2"><code class="py comments"># fire the chain with an error result</code></div><div class="line number18 index17 alt1"><code class="py plain">d.errback(Exception(</code><code class="py string">'I have failed.'</code><code class="py plain">))</code></div></div></td></tr></tbody></table></div></div>
<p>Here we are passing a regular <code>Exception</code> to the <code>errback</code> method. In the errback, we are printing out the class and the error result itself. We get this output:</p>
<pre>twisted.python.failure.Failure
[Failure instance: Traceback (failure with no frames): : I have failed.
]
No poetry for you.</pre>
<p>This means when we use deferreds we can go back to working with ordinary <code>Exception</code>s and the <code>Failure</code>s will get created for us automatically. A deferred will guarantee that each errback is invoked with an actual <code>Failure</code> instance.</p>
<p>We tried pressing the <code>callback</code> button and we tried pressing the <code>errback</code> button. Like any good engineer, you probably want to start pressing them over and over. To make the code shorter, we'll use the same function for both the callback and the errback. Just remember they get different return values; one is a result and the other is a failure. Check out <a href="http://github.com/jdavisp3/twisted-intro/blob/master/twisted-deferred/defer-4.py"><tt>twisted-deferred/defer-4.py</tt></a>:</p>
<div><div class="syntaxhighlighter  py" id="highlighter_710045"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py keyword">from</code> <code class="py plain">twisted.internet.defer </code><code class="py keyword">import</code> <code class="py plain">Deferred</code></div><div class="line number2 index1 alt1"><code class="py keyword">def</code> <code class="py plain">out(s): </code><code class="py functions">print</code> <code class="py plain">s</code></div><div class="line number3 index2 alt2"><code class="py plain">d </code><code class="py keyword">=</code> <code class="py plain">Deferred()</code></div><div class="line number4 index3 alt1"><code class="py plain">d.addCallbacks(out, out)</code></div><div class="line number5 index4 alt2"><code class="py plain">d.callback(</code><code class="py string">'First result'</code><code class="py plain">)</code></div><div class="line number6 index5 alt1"><code class="py plain">d.callback(</code><code class="py string">'Second result'</code><code class="py plain">)</code></div><div class="line number7 index6 alt2"><code class="py functions">print</code> <code class="py string">'Finished'</code></div></div></td></tr></tbody></table></div></div>
<p>Now we get this output:</p>
<pre>First result
Traceback (most recent call last):
  ...
twisted.internet.defer.AlreadyCalledError</pre>
<p>This is interesting! A deferred will not let us fire the normal result callbacks a second time. In fact, a deferred cannot be fired a second time no matter what, as demonstrated by these examples:</p>
<ul>
<li><a href="http://github.com/jdavisp3/twisted-intro/blob/master/twisted-deferred/defer-4.py"><tt>twisted-deferred/defer-4.py</tt></a></li>
<li><a href="http://github.com/jdavisp3/twisted-intro/blob/master/twisted-deferred/defer-5.py"><tt>twisted-deferred/defer-5.py</tt></a></li>
<li><a href="http://github.com/jdavisp3/twisted-intro/blob/master/twisted-deferred/defer-6.py"><tt>twisted-deferred/defer-6.py</tt></a></li>
<li><a href="http://github.com/jdavisp3/twisted-intro/blob/master/twisted-deferred/defer-7.py"><tt>twisted-deferred/defer-7.py</tt></a></li>
</ul>
<p>Notice those final <code>print</code> statements are never called. The <code>callback</code> and <code>errback</code> methods are raising genuine <code>Exception</code>s to let us know we've already fired that deferred. Deferreds help us avoid one of the pitfalls we identified with callback programming. When we use a deferred to manage our callbacks, we simply can't make the mistake of calling both the callback and the errback, or invoking the callback twenty-seven times. We can try, but the deferred will raise an exception right back at us, instead of passing our mistake onto the callbacks themselves.</p>
<p>Can deferreds help us to refactor asynchronous code? Consider the example in <a href="http://github.com/jdavisp3/twisted-intro/blob/master/twisted-deferred/defer-8.py"><tt>twisted-deferred/defer-8.py</tt></a>:</p>
<div><div class="syntaxhighlighter  py" id="highlighter_257639"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div><div class="line number20 index19 alt1">20</div><div class="line number21 index20 alt2">21</div><div class="line number22 index21 alt1">22</div><div class="line number23 index22 alt2">23</div><div class="line number24 index23 alt1">24</div><div class="line number25 index24 alt2">25</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py keyword">import</code> <code class="py plain">sys</code></div><div class="line number2 index1 alt1">&nbsp;</div><div class="line number3 index2 alt2"><code class="py keyword">from</code> <code class="py plain">twisted.internet.defer </code><code class="py keyword">import</code> <code class="py plain">Deferred</code></div><div class="line number4 index3 alt1">&nbsp;</div><div class="line number5 index4 alt2"><code class="py keyword">def</code> <code class="py plain">got_poem(poem):</code></div><div class="line number6 index5 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py functions">print</code> <code class="py plain">poem</code></div><div class="line number7 index6 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">from</code> <code class="py plain">twisted.internet </code><code class="py keyword">import</code> <code class="py plain">reactor</code></div><div class="line number8 index7 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">reactor.stop()</code></div><div class="line number9 index8 alt2">&nbsp;</div><div class="line number10 index9 alt1"><code class="py keyword">def</code> <code class="py plain">poem_failed(err):</code></div><div class="line number11 index10 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py functions">print</code> <code class="py plain">&gt;&gt;sys.stderr, </code><code class="py string">'poem download failed'</code></div><div class="line number12 index11 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py functions">print</code> <code class="py plain">&gt;&gt;sys.stderr, </code><code class="py string">'I am terribly sorry'</code></div><div class="line number13 index12 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py functions">print</code> <code class="py plain">&gt;&gt;sys.stderr, </code><code class="py string">'try again later?'</code></div><div class="line number14 index13 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">from</code> <code class="py plain">twisted.internet </code><code class="py keyword">import</code> <code class="py plain">reactor</code></div><div class="line number15 index14 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">reactor.stop()</code></div><div class="line number16 index15 alt1">&nbsp;</div><div class="line number17 index16 alt2"><code class="py plain">d </code><code class="py keyword">=</code> <code class="py plain">Deferred()</code></div><div class="line number18 index17 alt1">&nbsp;</div><div class="line number19 index18 alt2"><code class="py plain">d.addCallbacks(got_poem, poem_failed)</code></div><div class="line number20 index19 alt1">&nbsp;</div><div class="line number21 index20 alt2"><code class="py keyword">from</code> <code class="py plain">twisted.internet </code><code class="py keyword">import</code> <code class="py plain">reactor</code></div><div class="line number22 index21 alt1">&nbsp;</div><div class="line number23 index22 alt2"><code class="py plain">reactor.callWhenRunning(d.callback, </code><code class="py string">'Another short poem.'</code><code class="py plain">)</code></div><div class="line number24 index23 alt1">&nbsp;</div><div class="line number25 index24 alt2"><code class="py plain">reactor.run()</code></div></div></td></tr></tbody></table></div></div>
<p>This is basically our original example above, with a little extra code to get the reactor going. Notice we are using <a href="http://twistedmatrix.com/trac/browser/tags/releases/twisted-8.2.0/twisted/internet/interfaces.py#L766"><code>callWhenRunning</code></a> to fire the deferred after the reactor starts up. We're taking advantage of the fact that <code>callWhenRunning</code> accepts additional positional- and keyword-arguments to pass to the callback when it is run. Many Twisted APIs that register callbacks follow this same convention, including the APIs to add callbacks to deferreds.</p>
<p>Both the callback and the errback stop the reactor. Since deferreds support chains of callbacks and errbacks, we can refactor the common code into a second link in the chains, a technique illustrated in <a href="http://github.com/jdavisp3/twisted-intro/blob/master/twisted-deferred/defer-9.py"><tt>twisted-deferred/defer-9.py</tt></a>:</p>
<div><div class="syntaxhighlighter  py" id="highlighter_685990"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div><div class="line number20 index19 alt1">20</div><div class="line number21 index20 alt2">21</div><div class="line number22 index21 alt1">22</div><div class="line number23 index22 alt2">23</div><div class="line number24 index23 alt1">24</div><div class="line number25 index24 alt2">25</div><div class="line number26 index25 alt1">26</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py keyword">import</code> <code class="py plain">sys</code></div><div class="line number2 index1 alt1">&nbsp;</div><div class="line number3 index2 alt2"><code class="py keyword">from</code> <code class="py plain">twisted.internet.defer </code><code class="py keyword">import</code> <code class="py plain">Deferred</code></div><div class="line number4 index3 alt1">&nbsp;</div><div class="line number5 index4 alt2"><code class="py keyword">def</code> <code class="py plain">got_poem(poem):</code></div><div class="line number6 index5 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py functions">print</code> <code class="py plain">poem</code></div><div class="line number7 index6 alt2">&nbsp;</div><div class="line number8 index7 alt1"><code class="py keyword">def</code> <code class="py plain">poem_failed(err):</code></div><div class="line number9 index8 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py functions">print</code> <code class="py plain">&gt;&gt;sys.stderr, </code><code class="py string">'poem download failed'</code></div><div class="line number10 index9 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py functions">print</code> <code class="py plain">&gt;&gt;sys.stderr, </code><code class="py string">'I am terribly sorry'</code></div><div class="line number11 index10 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py functions">print</code> <code class="py plain">&gt;&gt;sys.stderr, </code><code class="py string">'try again later?'</code></div><div class="line number12 index11 alt1">&nbsp;</div><div class="line number13 index12 alt2"><code class="py keyword">def</code> <code class="py plain">poem_done(_):</code></div><div class="line number14 index13 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">from</code> <code class="py plain">twisted.internet </code><code class="py keyword">import</code> <code class="py plain">reactor</code></div><div class="line number15 index14 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">reactor.stop()</code></div><div class="line number16 index15 alt1">&nbsp;</div><div class="line number17 index16 alt2"><code class="py plain">d </code><code class="py keyword">=</code> <code class="py plain">Deferred()</code></div><div class="line number18 index17 alt1">&nbsp;</div><div class="line number19 index18 alt2"><code class="py plain">d.addCallbacks(got_poem, poem_failed)</code></div><div class="line number20 index19 alt1"><code class="py plain">d.addBoth(poem_done)</code></div><div class="line number21 index20 alt2">&nbsp;</div><div class="line number22 index21 alt1"><code class="py keyword">from</code> <code class="py plain">twisted.internet </code><code class="py keyword">import</code> <code class="py plain">reactor</code></div><div class="line number23 index22 alt2">&nbsp;</div><div class="line number24 index23 alt1"><code class="py plain">reactor.callWhenRunning(d.callback, </code><code class="py string">'Another short poem.'</code><code class="py plain">)</code></div><div class="line number25 index24 alt2">&nbsp;</div><div class="line number26 index25 alt1"><code class="py plain">reactor.run()</code></div></div></td></tr></tbody></table></div></div>
<p>The <code>addBoth</code> method adds the same function to both the callback and errback chains. And we can refactor asynchronous code after all.</p>
<p style="padding-left: 30px;"><strong>Note:</strong> there is a subtlety in the way this deferred would actually execute its errback chain. We'll discuss it in a future Part, but keep in mind there is more to learn about deferreds.</p>
<h3>Summary</h3>
<p>In this Part we analyzed callback programming and identified some potential problems. We also saw how the <code>Deferred</code> class can help us out:</p>
<ol>
<li>We can't ignore errbacks, they are required for any asynchronous API. Deferreds have support for errbacks built in.</li>
<li>Invoking callbacks multiple times will likely result in subtle, hard-to-debug problems. Deferreds can only be fired once, making them similar to the familiar semantics of <code>try</code>/<code>except</code> statements.</li>
<li>Programming with plain callbacks can make refactoring tricky. With deferreds, we can refactor by adding links to the chain and moving code from one link to another.</li>
</ol>
<p>We're not done with the story of deferreds, there are more details of their rationale and behavior to explore. But we've got enough to start using them in our poetry client, so we'll do that in <a href="http://krondo.com/blog/?p=1778">Part 8</a>.</p>
<h3>Suggested Exercises</h3>
<ol>
<li>The last example ignores the argument to <code>poem_done</code>. Print it out instead. Make <code>got_poem</code> return a value and see how that changes the argument to <code>poem_done</code>.</li>
<li>Modify the last two deferred examples to fire the errback chains. Make sure to fire the errback with an <code>Exception</code>.</li>
<li>Read the docstrings for the <a href="http://twistedmatrix.com/trac/browser/tags/releases/twisted-8.2.0/twisted/internet/defer.py#L189"><code>addCallback</code></a> and <a href="http://twistedmatrix.com/trac/browser/tags/releases/twisted-8.2.0/twisted/internet/defer.py#L192"><code>addErrback</code></a> methods on <code>Deferred</code>.</li>
</ol>
<!-- JOLIPRINT BUTTON BEGINS --><script type="text/javascript">
&amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;lt;!--
try{
$joliprint().set('format','json').set('callback','joliprint_getPdf').set('service','wp-plugin').set('url','http://krondo.com/?p=1682').set('title','Print with Joliprint').set('urloptions','ver=1.1.5').set( 'label', 'joliprint' ).set( 'labelposition', 'after' ).set( 'button', 'joliprint-icon' ).write();
}catch(e){

}
--&amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;gt;</script><!-- JOLIPRINT BUTTON ENDS -->		<div class="fixed"></div>
			</div>
</div>


<div class="post" id="post-1778">
	
	

	<div class="content">
		<h2>Part 8: Deferred Poetry</h2>
<p>This continues the introduction started <a href="http://krondo.com/wp-content/uploads/2009/08/twisted-intro.html?p=1209">here</a>. You can find an index to the entire series <a href="http://krondo.com/wp-content/uploads/2009/08/twisted-intro.html?page_id=1327">here</a>.</p>
<h3>Client 4.0</h3>
<p>Now that we have know something about deferreds, we can rewrite our Twisted poetry client to use them. You can find client 4.0 in <a href="http://github.com/jdavisp3/twisted-intro/blob/master/twisted-client-4/get-poetry.py"><tt>twisted-client-4/get-poetry.py</tt></a>.</p>
<p>Our <a href="http://github.com/jdavisp3/twisted-intro/blob/master/twisted-client-4/get-poetry.py#L83"><code>get_poetry</code></a> function no longer needs <code>callback</code> or <code>errback</code> arguments. Instead, it returns a new deferred to which the user may attach callbacks and errbacks as needed.</p>
<div><div id="highlighter_408195" class="syntaxhighlighter  py"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py keyword">def</code> <code class="py plain">get_poetry(host, port):</code></div><div class="line number2 index1 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py comments">"""</code></div><div class="line number3 index2 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py comments">Download a poem from the given host and port. This function</code></div><div class="line number4 index3 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py comments">returns a Deferred which will be fired with the complete text of</code></div><div class="line number5 index4 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py comments">the poem or a Failure if the poem could not be downloaded.</code></div><div class="line number6 index5 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py comments">"""</code></div><div class="line number7 index6 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">d </code><code class="py keyword">=</code> <code class="py plain">defer.Deferred()</code></div><div class="line number8 index7 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">from</code> <code class="py plain">twisted.internet </code><code class="py keyword">import</code> <code class="py plain">reactor</code></div><div class="line number9 index8 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">factory </code><code class="py keyword">=</code> <code class="py plain">PoetryClientFactory(d)</code></div><div class="line number10 index9 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">reactor.connectTCP(host, port, factory)</code></div><div class="line number11 index10 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">return</code> <code class="py plain">d</code></div></div></td></tr></tbody></table></div></div>
<p>Our <a href="http://github.com/jdavisp3/twisted-intro/blob/master/twisted-client-4/get-poetry.py#L65">factory</a> object is initialized with a deferred instead of a callback/errback pair. Once we have the poem, or we find out we couldn't connect to the server, the deferred is fired with either a poem or a failure:</p>
<div><div id="highlighter_40592" class="syntaxhighlighter  py"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py keyword">class</code> <code class="py plain">PoetryClientFactory(ClientFactory):</code></div><div class="line number2 index1 alt1">&nbsp;</div><div class="line number3 index2 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">protocol </code><code class="py keyword">=</code> <code class="py plain">PoetryProtocol</code></div><div class="line number4 index3 alt1">&nbsp;</div><div class="line number5 index4 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">def</code> <code class="py plain">__init__(</code><code class="py color1">self</code><code class="py plain">, deferred):</code></div><div class="line number6 index5 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py color1">self</code><code class="py plain">.deferred </code><code class="py keyword">=</code> <code class="py plain">deferred</code></div><div class="line number7 index6 alt2">&nbsp;</div><div class="line number8 index7 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">def</code> <code class="py plain">poem_finished(</code><code class="py color1">self</code><code class="py plain">, poem):</code></div><div class="line number9 index8 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">if</code> <code class="py color1">self</code><code class="py plain">.deferred </code><code class="py keyword">is</code> <code class="py keyword">not</code> <code class="py color1">None</code><code class="py plain">:</code></div><div class="line number10 index9 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">d, </code><code class="py color1">self</code><code class="py plain">.deferred </code><code class="py keyword">=</code> <code class="py color1">self</code><code class="py plain">.deferred, </code><code class="py color1">None</code></div><div class="line number11 index10 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">d.callback(poem)</code></div><div class="line number12 index11 alt1">&nbsp;</div><div class="line number13 index12 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">def</code> <code class="py plain">clientConnectionFailed(</code><code class="py color1">self</code><code class="py plain">, connector, reason):</code></div><div class="line number14 index13 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">if</code> <code class="py color1">self</code><code class="py plain">.deferred </code><code class="py keyword">is</code> <code class="py keyword">not</code> <code class="py color1">None</code><code class="py plain">:</code></div><div class="line number15 index14 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">d, </code><code class="py color1">self</code><code class="py plain">.deferred </code><code class="py keyword">=</code> <code class="py color1">self</code><code class="py plain">.deferred, </code><code class="py color1">None</code></div><div class="line number16 index15 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">d.errback(reason)</code></div></div></td></tr></tbody></table></div></div>
<p>Notice the way we release our reference to the deferred after it is fired. This is a pattern found in several places in the Twisted source code and helps to ensure we do not fire the same deferred twice. It makes life a little easier for the Python garbage collector, too.</p>
<p>Once again, there is no need to change the <a href="http://github.com/jdavisp3/twisted-intro/blob/master/twisted-client-4/get-poetry.py#L51"><code>PoetryProtocol</code></a>, it's just fine as is. All that remains is to update the <a href="http://github.com/jdavisp3/twisted-intro/blob/master/twisted-client-4/get-poetry.py#L96"><code>poetry_main</code></a> function:</p>
<div><div id="highlighter_550415" class="syntaxhighlighter  py"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div><div class="line number20 index19 alt1">20</div><div class="line number21 index20 alt2">21</div><div class="line number22 index21 alt1">22</div><div class="line number23 index22 alt2">23</div><div class="line number24 index23 alt1">24</div><div class="line number25 index24 alt2">25</div><div class="line number26 index25 alt1">26</div><div class="line number27 index26 alt2">27</div><div class="line number28 index27 alt1">28</div><div class="line number29 index28 alt2">29</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py keyword">def</code> <code class="py plain">poetry_main():</code></div><div class="line number2 index1 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">addresses </code><code class="py keyword">=</code> <code class="py plain">parse_args()</code></div><div class="line number3 index2 alt2">&nbsp;</div><div class="line number4 index3 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">from</code> <code class="py plain">twisted.internet </code><code class="py keyword">import</code> <code class="py plain">reactor</code></div><div class="line number5 index4 alt2">&nbsp;</div><div class="line number6 index5 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">poems </code><code class="py keyword">=</code> <code class="py plain">[]</code></div><div class="line number7 index6 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">errors </code><code class="py keyword">=</code> <code class="py plain">[]</code></div><div class="line number8 index7 alt1">&nbsp;</div><div class="line number9 index8 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">def</code> <code class="py plain">got_poem(poem):</code></div><div class="line number10 index9 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">poems.append(poem)</code></div><div class="line number11 index10 alt2">&nbsp;</div><div class="line number12 index11 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">def</code> <code class="py plain">poem_failed(err):</code></div><div class="line number13 index12 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py functions">print</code> <code class="py plain">&gt;&gt;sys.stderr, </code><code class="py string">'Poem failed:'</code><code class="py plain">, err</code></div><div class="line number14 index13 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">errors.append(err)</code></div><div class="line number15 index14 alt2">&nbsp;</div><div class="line number16 index15 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">def</code> <code class="py plain">poem_done(_):</code></div><div class="line number17 index16 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">if</code> <code class="py functions">len</code><code class="py plain">(poems) </code><code class="py keyword">+</code> <code class="py functions">len</code><code class="py plain">(errors) </code><code class="py keyword">=</code><code class="py keyword">=</code> <code class="py functions">len</code><code class="py plain">(addresses):</code></div><div class="line number18 index17 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">reactor.stop()</code></div><div class="line number19 index18 alt2">&nbsp;</div><div class="line number20 index19 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">for</code> <code class="py plain">address </code><code class="py keyword">in</code> <code class="py plain">addresses:</code></div><div class="line number21 index20 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">host, port </code><code class="py keyword">=</code> <code class="py plain">address</code></div><div class="line number22 index21 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">d </code><code class="py keyword">=</code> <code class="py plain">get_poetry(host, port)</code></div><div class="line number23 index22 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">d.addCallbacks(got_poem, poem_failed)</code></div><div class="line number24 index23 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">d.addBoth(poem_done)</code></div><div class="line number25 index24 alt2">&nbsp;</div><div class="line number26 index25 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">reactor.run()</code></div><div class="line number27 index26 alt2">&nbsp;</div><div class="line number28 index27 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">for</code> <code class="py plain">poem </code><code class="py keyword">in</code> <code class="py plain">poems:</code></div><div class="line number29 index28 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py functions">print</code> <code class="py plain">poem</code></div></div></td></tr></tbody></table></div></div>
<p>Notice how we take advantage of the chaining capabilities of the deferred to refactor the <code>poem_done</code> invocation out of our primary callback and errback.</p>
<p>Because deferreds are used so much in Twisted code, it's common practice to use the single-letter local variable <code>d</code> to hold the deferred you are currently working on. For longer term storage, like object attributes, the name "<code>deferred</code>" is often used.</p>
<h3>Discussion</h3>
<p>With our new client the asynchronous version of <code>get_poetry</code> accepts the same information as our synchronous version, just the address of the poetry server. The synchronous version returns a poem, while the asynchronous version returns a deferred. Returning a deferred is typical of the asynchronous APIs in Twisted and programs written with Twisted, and this points to another way of conceptualizing deferreds:</p>
<blockquote><p>A <code>Deferred</code> object represents an "asynchronous result" or a "result that has not yet come".</p></blockquote>
<p>We can contrast these two styles of programming in Figure 13:</p>
<div id="attachment_1831" class="wp-caption aligncenter" style="width: 631px"><a href="img/sync-async.png"><img width="621" height="179" class="size-full wp-image-1831" title="Figure 13: sync versus async" src="img/sync-async.png" alt="Figure 13: sync versus async"></a><p class="wp-caption-text">Figure 13: sync versus async</p></div>
<p>By returning a deferred, an asynchronous API is giving this message to the user:</p>
<blockquote><p>I'm an asynchronous function. Whatever you want me to do might not be done yet. But when it is done, I'll fire the callback chain of this deferred with the result. On the other hand, if something goes wrong, I'll fire the errback chain of this deferred instead.</p></blockquote>
<p>Of course, that function itself won't literally fire the deferred, it has already returned. Rather, the function has set in motion a chain of events that will eventually result in the deferred being fired.</p>
<p>So deferreds are a way of "time-shifting" the results of functions to accommodate the needs of the asynchronous model. And a deferred returned by a function is a notice that the function is asynchronous, the embodiment of the future result, and a promise that the result will be delivered.</p>
<p style="padding-left: 30px;">It is possible for a synchronous function to return a deferred, so technically a deferred return value means the function is potentially asynchronous. We'll see examples of synchronous functions returning deferreds in future Parts.</p>
<p>Because the behavior of deferreds is well-defined and well-known (to folks with some experience programming with Twisted), by returning deferreds from your own APIs you are making it easier for other Twisted programmers to understand and use your code. Without deferreds, each Twisted program, or even each internal Twisted component, might have its own unique method for managing callbacks that you would have to learn in order to use it.</p>
<h3>When You're Using Deferreds, You're Still Using Callbacks, and They're Still Invoked by the Reactor</h3>
<p>When first learning Twisted, it is a common mistake to attribute more functionality to deferreds than they actually have. Specifically, it is often assumed that adding a function to a deferred's chain automatically makes that function asynchronous. This might lead you to think you could use, say, <code>os.system</code> with Twisted by adding it to a deferred with <code>addCallback</code>.</p>
<p>I think this mistake is caused by trying to learn Twisted without first learning the asynchronous model. Since typical Twisted code uses lots of deferreds and only occasionally refers to the reactor, it can appear that deferreds are doing all the work. If you have read this introduction from the beginning, it should be clear  this is far from the case. Although Twisted is composed of many parts that work together, the primary responsibility for implementing the asynchronous model falls to the reactor. Deferreds are a useful abstraction, but we wrote several versions of our Twisted client without using them in any way.</p>
<p>Let's look at a stack trace at the point when our first callback is invoked. Run the example program in <a href="http://github.com/jdavisp3/twisted-intro/blob/master/twisted-client-4/get-poetry-stack.py"><tt>twisted-client-4/get-poetry-stack.py</tt></a> with the address of a running poetry server. You should get some output like this:</p>
<pre>  File "twisted-client-4/get-poetry-stack.py", line 129, in
    poetry_main()
  File "twisted-client-4/get-poetry-stack.py", line 122, in poetry_main
    reactor.run()

  ... # some more Twisted function calls

    protocol.connectionLost(reason)
  File "twisted-client-4/get-poetry-stack.py", line 59, in connectionLost
    self.poemReceived(self.poem)
  File "twisted-client-4/get-poetry-stack.py", line 62, in poemReceived
    self.factory.poem_finished(poem)
  File "twisted-client-4/get-poetry-stack.py", line 75, in poem_finished
    d.callback(poem) # here's where we fire the deferred

  ... # some more methods on Deferreds

  File "twisted-client-4/get-poetry-stack.py", line 105, in got_poem
    traceback.print_stack()</pre>
<p>That's pretty similar to the stack trace we created for client 2.0. We can visualize the latest trace in Figure 14:</p>
<div id="attachment_1795" class="wp-caption aligncenter" style="width: 343px"><a href="img/reactor-deferred-callback.png"><img width="333" height="554" class="size-full wp-image-1795 " title="Figure 14: A callback with a deferred" src="img/reactor-deferred-callback.png" alt="Figure 13: A callback with a deferred"></a><p class="wp-caption-text">Figure 14: A callback with a deferred</p></div>
<p>Again, this is similar to our previous Twisted clients, though the visual representation is starting to become vaguely disturbing. We probably won't be showing any more of these, for the sake of the children. One wrinkle not reflected in the figure: the callback chain above doesn't return control to the reactor until the second callback in the deferred (<code>poem_done</code>) is invoked, which happens right after the first callback (<code>got_poem</code>) returns.</p>
<p style="padding-left: 30px;">There's one more difference with our new stack trace. The line separating "Twisted code" from "our code" is a little fuzzier, since the methods on deferreds are really Twisted code. This interleaving of Twisted and user code in a callback chain is common in larger Twisted programs which make extensive use of other Twisted abstractions.</p>
<p>By using a deferred we've added a few more steps in the callback chain that starts in the Twisted reactor, but we haven't changed the fundamental mechanics of the asynchronous model. Recall these facts about callback programming:</p>
<ol>
<li>Only one callback runs at a time.</li>
<li>When the reactor is running our callbacks are not.</li>
<li>And vice-versa.</li>
<li>If our callback blocks then the whole program blocks.</li>
</ol>
<p>Attaching a callback to a deferred doesn't change these facts in any way. In particular, a callback that blocks will still block if it's attached to a deferred. So that deferred will block when it is fired (<code>d.callback</code>), and thus Twisted will block. And we conclude:</p>
<blockquote><p>Deferreds are a solution (a particular one invented by the Twisted developers) to the problem of managing callbacks. They are neither a way of avoiding callbacks nor a way to turn blocking callbacks into non-blocking callbacks.</p></blockquote>
<p>We can confirm the last point by constructing a deferred with a blocking callback. Consider the example code in <a href="http://github.com/jdavisp3/twisted-intro/blob/master/twisted-deferred/defer-block.py"><tt>twisted-deferred/defer-block.py</tt></a>. The second callback blocks using the <code>time.sleep</code> function. If you run that script and examine the order of the <code>print</code> statements, it will be clear that a blocking callback also blocks inside a deferred.</p>
<h3>Summary</h3>
<p>By returning a <code>Deferred</code>, a function tells the user "I'm asynchronous" and provides a mechanism (add your callbacks and errbacks here!) to obtain the asynchronous result when it arrives. Deferreds are used extensively throughout the Twisted codebase and as you explore Twisted's APIs you are bound to keep encountering them. So it will pay to become familiar with deferreds and comfortable in their use.</p>
<p>Client 4.0 is the first version of our Twisted poetry client that's truly written in the "Twisted style", using a deferred as the return value of an asynchronous function call. There are a few more Twisted APIs we could use to make it a little cleaner, but I think it represents a pretty good example of how simple Twisted programs are written, at least on the client side. Eventually we'll re-write our poetry server using Twisted, too.</p>
<p>But we're not quite finished with deferreds. For a relatively short piece of code, the <code>Deferred</code> class provides a surprising number of features. We'll talk about some more of those features, and their motivation, in <a href="http://krondo.com/blog/?p=1825">Part 9</a>.</p>
<h3>Suggested Exercises</h3>
<ol>
<li>Update client 4.0 to timeout if the poem isn't received after a given period of time. Fire the deferred's errback with a custom exception in that case. Don't forget to close the connection when you do.</li>
<li>Update client 4.0 to print out the appropriate server address when a poem download fails, so the user can tell which server is the culprit. Don't <a href="http://twistedmatrix.com/trac/browser/tags/releases/twisted-8.2.0/twisted/internet/defer.py#L172">forget</a> you can add extra positional- and keyword-arguments when you attach callbacks and errbacks.</li>
</ol>
<!-- JOLIPRINT BUTTON BEGINS --><script type="text/javascript">
&amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;lt;!--
try{
$joliprint().set('format','json').set('callback','joliprint_getPdf').set('service','wp-plugin').set('url','http://krondo.com/?p=1778').set('title','Print with Joliprint').set('urloptions','ver=1.1.5').set( 'label', 'joliprint' ).set( 'labelposition', 'after' ).set( 'button', 'joliprint-icon' ).write();
}catch(e){

}
--&amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;gt;</script><!-- JOLIPRINT BUTTON ENDS -->		<div class="fixed"></div>
			</div>
</div>


<div id="post-1825" class="post">
	
	

	<div class="content">
		<h2>Part 9: A Second Interlude, Deferred</h2>
<p>This continues the introduction started <a href="http://krondo.com/wp-content/uploads/2009/08/twisted-intro.html?p=1209">here</a>. You can find an index to the entire series <a href="http://krondo.com/wp-content/uploads/2009/08/twisted-intro.html?page_id=1327">here</a>.</p>
<h3>More Consequence of Callbacks</h3>
<p>We're going to pause for a moment to think about callbacks again. Although we now know enough about deferreds to write simple asynchronous programs in the Twisted style, the <code>Deferred</code> class provides more features that only come into play in more complex settings. So we're going to think up some more complex settings and see what sort of challenges they pose when programming with callbacks. Then we'll investigate how deferreds address those challenges.</p>
<p>To motivate our discussion we're going to add a hypothetical feature to our poetry client. Suppose some hard-working Computer Science professor has invented a new poetry-related algorithm, the Byronification Engine. This nifty algorithm takes a single poem as input and produces a new poem like the original, but written in the style of <a href="http://en.wikipedia.org/wiki/George_Gordon_Byron,_6th_Baron_Byron">Lord Byron</a>. What's more, our professor has kindly provided a reference implementation in Python, with this interface:</p>
<div><div class="syntaxhighlighter  py" id="highlighter_516937"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py keyword">class</code> <code class="py plain">IByronificationEngine(Interface):</code></div><div class="line number2 index1 alt1">&nbsp;</div><div class="line number3 index2 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">def</code> <code class="py plain">byronificate(poem):</code></div><div class="line number4 index3 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py comments">"""</code></div><div class="line number5 index4 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py comments">Return a new poem like the original, but in the style of Lord Byron.</code></div><div class="line number6 index5 alt1">&nbsp;</div><div class="line number7 index6 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py comments">Raises GibberishError if the input is not a genuine poem.</code></div><div class="line number8 index7 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py comments">"""</code></div></div></td></tr></tbody></table></div></div>
<p>Like most bleeding-edge software, the implementation has some bugs. This means that in addition to the documented exception, the <code>byronificate</code> method sometimes throws random exceptions when it hits a corner-case the professor forgot to handle.</p>
<p>We'll also assume the engine runs fast enough that we can just call it in the main thread without worrying about tying up the reactor. This is how we want our program to work:</p>
<ol>
<li>Try to download the poem.</li>
<li>If the download fails, tell the user we couldn't get the poem.</li>
<li>If we do get the poem, transform it with the Byronification Engine.</li>
<li>If the engine throws a <code>GibberishError</code>, tell the user we couldn't get the poem.</li>
<li>If the engine throws another exception, just keep the original poem.</li>
<li>If we have a poem, print it out.</li>
<li>End the program.</li>
</ol>
<p>The idea here is that a <code>GibberishError</code> means we didn't get an actual poem after all, so we'll just tell the user the download failed. That's not so useful for debugging, but our users just want to know whether we got a poem or not. On the other hand, if the engine fails for some other reason then we'll use the poem we got from the server. After all, some poetry is better than none at all, even if it's not in the trademark Byron style.</p>
<p>Here's the synchronous version of our code:</p>
<div><div class="syntaxhighlighter  py" id="highlighter_356587"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py keyword">try</code><code class="py plain">:</code></div><div class="line number2 index1 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">poem </code><code class="py keyword">=</code> <code class="py plain">get_poetry(host, port) </code><code class="py comments"># synchronous get_poetry</code></div><div class="line number3 index2 alt2"><code class="py keyword">except</code><code class="py plain">:</code></div><div class="line number4 index3 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py functions">print</code> <code class="py plain">&gt;&gt;sys.stderr, </code><code class="py string">'The poem download failed.'</code></div><div class="line number5 index4 alt2"><code class="py keyword">else</code><code class="py plain">:</code></div><div class="line number6 index5 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">try</code><code class="py plain">:</code></div><div class="line number7 index6 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">poem </code><code class="py keyword">=</code> <code class="py plain">engine.byronificate(poem)</code></div><div class="line number8 index7 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">except</code> <code class="py plain">GibberishError:</code></div><div class="line number9 index8 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py functions">print</code> <code class="py plain">&gt;&gt;sys.stderr, </code><code class="py string">'The poem download failed.'</code></div><div class="line number10 index9 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">except</code><code class="py plain">:</code></div><div class="line number11 index10 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py functions">print</code> <code class="py plain">poem </code><code class="py comments"># handle other exceptions by using the original poem</code></div><div class="line number12 index11 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">else</code><code class="py plain">:</code></div><div class="line number13 index12 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py functions">print</code> <code class="py plain">poem</code></div><div class="line number14 index13 alt1">&nbsp;</div><div class="line number15 index14 alt2"><code class="py plain">sys.exit()</code></div></div></td></tr></tbody></table></div></div>
<p>This sketch of a program could be make simpler with some refactoring, but it illustrates the flow of logic pretty clearly. We want to update our most recent poetry client (which uses deferreds) to implement this same scheme. But we won't do that until Part 10. For now, instead, let's imagine how we might do this with <a href="http://github.com/jdavisp3/twisted-intro/blob/master/twisted-client-3/get-poetry-1.py">client 3.1</a>, our last client that didn't use deferreds at all. Suppose we didn't bother handling exceptions, but instead just changed the <a href="http://github.com/jdavisp3/twisted-intro/blob/master/twisted-client-3/get-poetry-1.py#L106"><code>got_poem</code></a> callback like this:</p>
<div><div class="syntaxhighlighter  py" id="highlighter_76021"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py keyword">def</code> <code class="py plain">got_poem(poem):</code></div><div class="line number2 index1 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">poems.append(byron_engine.byronificate(poem))</code></div><div class="line number3 index2 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">poem_done()</code></div></div></td></tr></tbody></table></div></div>
<p>What happens when the <code>byronificate</code> method raises a <code>GibberishError</code> or some other exception? Looking at <a href="http://krondo.com/blog/?p=1595#figure11">Figure 11</a> from Part 6, we can see that:</p>
<ol>
<li>The exception will propagate to the <code>poem_finished</code> callback in the factory, the method that actually invokes the callback.</li>
<li>Since <code>poem_finished</code> doesn't catch the exception, it will proceed to <code>poemReceived</code> on the protocol.</li>
<li>And then on to <code>connectionLost</code>, also on the protocol.</li>
<li>And then up into the core of Twisted itself, finally ending up at the reactor.</li>
</ol>
<p>As we have learned, the reactor will catch and log the exception instead of crashing. But what it certainly won't do is tell the user we couldn't download a poem. The reactor doesn't know anything about poems or <code>GibberishError</code>s, it's a general-purpose piece of code used for all kinds of networking, even non-poetry-related networking.</p>
<p>Notice how, at each step in the list above, the exception moves to a more general-purpose piece of code than the one before. And at no step after <code>got_poem</code> is the exception in a piece of code that could be expected to handle an error in the specific way we want for this client. This situation is basically the exact opposite of the way exceptions propagate in synchronous code.</p>
<p>Take a look at Figure 15, an illustration of  a call stack we might see with a synchronous poetry client <a name="figure15"></a>:</p>
<div style="width: 397px" class="wp-caption aligncenter" id="attachment_1863"><a href="img/sync-exceptions1.png"><img width="387" height="257" alt="Figure 15: exceptions in synchronous code" src="img/sync-exceptions1.png" title="Figure 15: synchronous code and exceptions" class="size-full wp-image-1863 "></a><p class="wp-caption-text">Figure 15: synchronous code and exceptions</p></div>
<p>The <code>main</code> function is "high-context", meaning it knows a lot about the whole program, why it exists, and how it's supposed to behave overall. Typically, <code>main</code> would have access to the command-line options that indicate just how the user wants the program to work (and perhaps what to do if something goes wrong). It also has a very specific purpose: running the show for a command-line poetry client.</p>
<p>The socket <code>connect</code> method, on the other hand, is "low-context". All it knows is that it's supposed to connect to some network address. It doesn't know what's on the other end or why we need to connect right now. But <code>connect</code> is quite general-purpose &mdash; you can use it no matter what sort of service you are connecting to.</p>
<p>And <code>get_poetry</code> is in the middle. It knows it's getting some poetry (and that's the only thing it's really good at), but not what should happen if it can't.</p>
<p>So an exception thrown by  <code>connect</code> will&nbsp; move up the stack, from low-context and general-purpose code to high-context and special-purpose code, until it reaches some code with enough context to know what to do when something goes wrong (or it hits the Python interpreter and the program crashes).</p>
<p>Of course the exception is really just moving up the stack no matter what rather than literally seeking out high-context code. It's just that in a typical synchronous program "up the stack" and "towards higher-context" are the same direction.</p>
<p>Now recall our hypothetical modification to client 3.1 above. The call stack we analyzed is pictured in Figure 16, abbreviated to just a few functions:</p>
<div style="width: 432px" class="wp-caption aligncenter" id="attachment_1883"><a href="img/async-exceptions4.png"><img width="422" height="245" alt="Figure 16: asynchronous callbacks and exceptions" src="img/async-exceptions4.png" title="Figure 16: asynchronous callbacks and exceptions" class="size-full wp-image-1883"></a><p class="wp-caption-text">Figure 16: asynchronous callbacks and exceptions</p></div>
<p>The problem is now clear: during a callback, low-context code (the reactor) is calling higher-context code which may in turn call even higher-context code, and so on. So if an exception occurs and it isn't handled immediately, close to the same stack frame where it occurred, it's unlikely to be handled at all. Because each time the exception moves up the stack it moves to a piece of lower-context code that's even less likely to know what to do.</p>
<p>Once an exception crosses over into the Twisted core the game is up. The exception will not be handled, it will only be noted (when the reactor finally catches it). So when we are programming with "plain old" callbacks (without using deferreds), we must be careful to catch every exception before it gets back into Twisted proper, at least if we want to have any chance of handling errors according to our own rules. And that includes exceptions caused by our own bugs!</p>
<p>Since a bug can exist anywhere in our code, we would need to wrap every callback we write in an extra "outer layer" of <code>try</code>/<code>except</code> statements so the exceptions from our fumble-fingered typos can be handled as well. And the same goes for our errbacks because code to handle errors can have bugs too.</p>
<p>Well that's not so nice.</p>
<h3>The Fine Structure of Deferreds</h3>
<p>It turns out the <code>Deferred</code> class helps us solve this problem. Whenever a deferred invokes a callback or errback, it catches any exception that might be raised. In other words, a deferred acts as the "outer layer" of <code>try</code>/<code>except</code> statements so we don't need to write that layer after all, as long as we use deferreds. But what does a deferred do with an exception it catches? Simple &mdash; it passes the exception (in the form of a <code>Failure</code>) to the next errback in the chain.</p>
<p>So the first errback we add to a deferred is there to handle whatever error condition is signaled when the deferred's <code>.errback(err)</code> method is called. But the second errback will handle any exception raised by either the first callback or the first errback, and so on down the line.</p>
<p>Recall <a href="http://krondo.com/blog/?p=1682#figure12">Figure 12</a>, a visual representation of a deferred with some callbacks and errbacks in the chain. Let's call the first callback/errback pair stage 0, the next pair stage 1, and so on.</p>
<p>At a given stage <strong>N</strong>,  if either the callback or the errback (whichever was executed) fails, then the errback in stage <strong>N+1</strong> is called with the appropriate <code>Failure</code> object and the callback in stage <strong>N+1</strong> is <em>not</em> called.</p>
<p>By passing exceptions raised by callbacks "down the chain", a deferred moves exceptions in the direction of "higher context". This also means that invoking the <code>callback</code> and <code>errback</code> methods of a deferred will never result in an exception for the caller (as long as you only fire the deferred once!), so lower-level code can safely fire a deferred without worrying about catching exceptions. Instead, higher-level code catches the exception by adding errbacks to the deferred (with <code>addErrback</code>, etc.).</p>
<p>Now in synchronous code, an exception stops propagating as soon as it is caught. So how does an errback signal the fact that it "caught" the error? Also simple &mdash; by <em>not</em> raising an exception. And in that case, the execution switches over to the callback line. So at a given stage <strong>N</strong>, if either the callback or errback succeeds (i.e., doesn't raise an exception) then the callback in stage <strong>N+1</strong> is called with the return value from stage <strong>N</strong>, and the errback in stage <strong>N+1</strong> is <em>not</em> called.</p>
<p>Let's summarize what we know about the deferred firing pattern:</p>
<ol>
<li>A deferred contains a chain of ordered callback/errback pairs (stages). The pairs are in the order they were added to the deferred.</li>
<li>Stage 0, the first callback/errback pair, is invoked when the deferred is fired. If the deferred is fired with the <code>callback</code> method, then the stage 0 callback is called. If the deferred is fired with the <code>errback</code> method, then the stage 0 errback is called.</li>
<li>If stage <strong>N</strong> fails, then the stage <strong>N+1</strong> errback is called with the exception (wrapped in a <code>Failure</code>) as the first argument.</li>
<li>If stage <strong>N</strong> succeeds, then the stage <strong>N+1</strong> callback is called with the stage <strong>N</strong> return value as the first argument.</li>
</ol>
<p>This pattern is illustrated in Figure 17:</p>
<div style="width: 336px" class="wp-caption aligncenter" id="attachment_1890"><a href="img/deferred-2.png"><img width="326" height="321" alt="Figure 17: control flow in a deferred" src="img/deferred-2.png" title="Figure 17: control flow in a deferred" class="size-full wp-image-1890"></a><p class="wp-caption-text">Figure 17: control flow in a deferred</p></div>
<p>The green lines indicate what happens when a callback or errback succeeds and the red lines are for failures. The lines show both the flow of control and the flow of exceptions and return values down the chain. Figure 17 shows all possible paths a deferred might take, but only one path will be taken in any particular case. Figure 18 shows one possible path for a "firing":</p>
<div style="width: 281px" class="wp-caption aligncenter" id="attachment_1893"><a href="img/deferred-31.png"><img width="271" height="349" alt="Figure 18: one possible deferred firing pattern" src="img/deferred-31.png" title="Figure 18: one possible deferred firing pattern" class="size-full wp-image-1893"></a><p class="wp-caption-text">Figure 18: one possible deferred firing pattern</p></div>
<p>In figure 18, the deferred's <code>callback</code> method is called, which invokes the callback in stage 0. That callback succeeds, so control (and the return value from stage 0) passes to the stage 1 callback. But that callback fails (raises an exception), so control switches to the errback in stage 2. The errback "handles" the error (it doesn't raise an exception) so control moves back to the callback chain and the callback in stage 3 is called with the result from the stage 2 errback.</p>
<p>Notice that any path you can make with Figure 17 will pass through every stage in the chain, but only one member of the callback/errback pair at any stage will be called.</p>
<p>In Figure 18, we've indicated that the stage 3 callback succeeds by drawing a green arrow out of it, but since there aren't any more stages in that deferred, the result of stage 3 doesn't really go anywhere. If the callback succeeds, that's not really a problem, but what if it had failed? If the last stage in a deferred fails, then we say the failure is <em>unhandled</em>, since there is no errback to "catch" it.</p>
<p>In synchronous code an unhandled exception will crash the interpreter, and in plain-old-callbacks asynchronous code an unhandled exception is caught by the reactor and logged. What happens to unhandled exceptions in deferreds? Let's try it out and see. Look at the sample code in <a href="http://github.com/jdavisp3/twisted-intro/blob/master/twisted-deferred/defer-unhandled.py#L1"><tt>twisted-deferred/defer-unhandled.py</tt></a>. That code is firing a deferred with a single callback that always raises an exception. Here's the output of the program:</p>
<pre>Finished
Unhandled error in Deferred:
Traceback (most recent call last):
  ...
--- &lt;exception caught here&gt; ---
  ...
exceptions.Exception: oops</pre>
<p>Some things to notice:</p>
<ol>
<li>The last <code>print</code> statement runs, so the program is not "crashed" by the exception.</li>
<li>That means the Traceback is just getting printed out, it's not crashing the interpreter.</li>
<li>The text of the traceback  tells us where the deferred itself caught the exception.</li>
<li>The "Unhandled" message gets printed out after "Finished".</li>
</ol>
<p>So when you use deferreds, unhandled exceptions in callbacks will still be noted, for debugging purposes, but as usual they won't crash the program (in fact they won't even make it to the reactor, the deferred will catch them first). By the way, the reason that "Finished" comes first is because the "Unhandled" message isn't actually printed until the deferred is garbage collected. We'll see the reason for that in a future Part.</p>
<p>Now, in synchronous code we can "re-raise" an exception using the <code>raise</code> keyword without any arguments. Doing so raises the original exception we were handling and allows us to take some action on an error without completely handling it. It turns out we can do the same thing in an errback. A deferred will consider a callback/errback to have failed if:</p>
<ul>
<li>The callback/errback raises any kind of exception, or</li>
<li>The callback/errback returns a <code>Failure</code> object.</li>
</ul>
<p>Since an errback's first argument is always a <code>Failure</code>, an errback can "re-raise" the exception by returning its first argument, after performing whatever action it wants to take.</p>
<h3>Callbacks and Errbacks, Two by Two</h3>
<p>One thing that should be clear from the above discussion is that the order you add callbacks and errbacks to a deferred makes a big difference in how the deferred will fire. What should also be clear is that, in a deferred,&nbsp;callbacks and errbacks always occur in pairs. There are four methods on the <a href="http://twistedmatrix.com/trac/browser/tags/releases/twisted-8.2.0/twisted/internet/defer.py#L172"><code>Deferred</code></a> class you can use to add pairs to the chain:</p>
<ol>
<li><code>addCallbacks</code></li>
<li><code>addCallback</code></li>
<li><code>addErrback</code></li>
<li><code>addBoth</code></li>
</ol>
<p>Obviously, the first and last methods add a pair to the chain. But the middle two methods also add a callback/errback pair. The <code>addCallback</code> method adds an explicit callback (the one you pass to the method) and an implicit "pass-through" errback. A pass-through function is a dummy function that just returns its first argument. Since the first argument to an errback is always a <code>Failure</code>, a pass-through errback will always "fail" and send its error to the next errback in the chain.</p>
<p>As you've no doubt guessed, the <code>addErrback</code> function adds an explicit errback and an implicit pass-through callback. And since the first argument to a callback is never a <code>Failure</code>, a pass-through callback sends its result to the next callback in the chain.</p>
<h3>The Deferred Simulator</h3>
<p>It's a good idea to become familiar with the way deferreds fire their callbacks and errbacks. The python script in <a href="http://github.com/jdavisp3/twisted-intro/blob/master/twisted-deferred/deferred-simulator.py#L1"><tt>twisted-deferred/deferred-simulator.py</tt></a> is a "deferred simulator", a little python program that lets you explore how deferreds fire. When you run the script it will ask you to enter list of callback and errback pairs, one per line. For each callback or errback, you specify that either:</p>
<ul>
<li>It returns a given value (succeds), or</li>
<li>It raises a given exception (fails), or</li>
<li>It returns its argument (passthru).</li>
</ul>
<p>After you've entered all the pairs you want to simulate, the script will print out, in high-resolution ASCII art, a diagram showing the contents of the chain and the firing patterns for the <code>callback</code> and <code>errback</code> methods. You will want to use a terminal window that is as wide as possible to see everything correctly. You can also use the <tt>--narrow</tt> option to print the diagrams one after the other, but it's easier to see their relationships when you print them side-by-side.</p>
<p>Of course, in real code a callback isn't going to return the same value every time, and a given function might sometimes succeed and other times fail. But the simulator can give you a picture of what will happen for a given combination of normal results and failures, in a given arrangement of callbacks and errbacks.</p>
<h3>Summary</h3>
<p>After thinking some more about callbacks, we realize that letting callback exceptions  bubble up the stack isn't going to work out so well, since callback programming inverts the usual relationship between low-context and high-context code. And  the Deferred class tackles this problem by catching exceptions and sending them down the chain instead of up into the reactor.</p>
<p>We've also learned that ordinary results (<code>return</code> values)  move down the chain as well. Combining both facts together results in a kind of criss-cross firing pattern as the deferred switches back and forth between the callback and errback lines, depending on the result of each stage.</p>
<p>Armed with this knowledge, in <a href="http://krondo.com/blog/?p=1956">Part 10</a> we will update our poetry client with some poetry transformation logic.</p>
<h3>Suggested Exercises</h3>
<ol>
<li>Inspect the implementation of each of the four methods on the <a href="http://twistedmatrix.com/trac/browser/tags/releases/twisted-8.2.0/twisted/internet/defer.py#L172"><code>Deferred</code></a> which add callbacks and errbacks. Verify that all methods add a callback/errback pair.</li>
<li>Use the deferred simulator to investigate the difference between this code:
<div><div class="syntaxhighlighter  py" id="highlighter_889793"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py plain">deferred.addCallbacks(my_callback, my_errback)</code></div></div></td></tr></tbody></table></div></div>
<p>and this code:</p>
<div><div class="syntaxhighlighter  py" id="highlighter_509687"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py plain">deferred.addCallback(my_callback)</code></div><div class="line number2 index1 alt1"><code class="py plain">deferred.addErrback(my_errback)</code></div></div></td></tr></tbody></table></div></div>
<p>Recall that the last two methods add implicit pass-through functions as one member of the pair.</p></li>
</ol>
<!-- JOLIPRINT BUTTON BEGINS --><script type="text/javascript">
&amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;lt;!--
try{
$joliprint().set('format','json').set('callback','joliprint_getPdf').set('service','wp-plugin').set('url','http://krondo.com/?p=1825').set('title','Print with Joliprint').set('urloptions','ver=1.1.5').set( 'label', 'joliprint' ).set( 'labelposition', 'after' ).set( 'button', 'joliprint-icon' ).write();
}catch(e){

}
--&amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;gt;</script><!-- JOLIPRINT BUTTON ENDS -->		<div class="fixed"></div>
			</div>
</div>


<div class="post" id="post-1956">
	
	

	<div class="content">
		<h2>Part 10: Poetry Transformed</h2>
<p>This continues the introduction started <a href="http://krondo.com/wp-content/uploads/2009/08/twisted-intro.html?p=1209">here</a>. You can find an index to the entire series <a href="http://krondo.com/wp-content/uploads/2009/08/twisted-intro.html?page_id=1327">here</a>.</p>
<h3>Client 5.0</h3>
<p>Now we're going to add some transformation logic to our poetry client, along the lines suggested in <a href="http://krondo.com/blog/?p=1825">Part 9</a>. But first, I have a shameful and humbling confession to make: I don't know how to write the Byronification Engine. It is beyond my programming abilities. So instead, I'm going to implement a simpler transformation, the Cummingsifier. The Cummingsifier is an algorithm that takes a poem and returns a new poem like the original but written in the style of <a href="http://en.wikipedia.org/wiki/E._E._Cummings">e.e. cummings</a>. Here is the Cummingsifier algorithm in its entirety:</p>
<div><div id="highlighter_812801" class="syntaxhighlighter  py"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py keyword">def</code> <code class="py plain">cummingsify(poem)</code></div><div class="line number2 index1 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">return</code> <code class="py plain">poem.lower()</code></div></div></td></tr></tbody></table></div></div>
<p>Unfortunately, this algorithm is so simple it never actually fails, so in client 5.0, located in <a href="http://github.com/jdavisp3/twisted-intro/blob/master/twisted-client-5/get-poetry.py#L1"><tt>twisted-client-5/get-poetry.py</tt></a>, we use a modified version of <code>cummingsify</code> that randomly does one of the following:</p>
<ol>
<li>Return a cummingsified version of the poem.</li>
<li>Raise a GibberishError.</li>
<li>Raise a ValueError.</li>
</ol>
<p>In this way we simulate a more complicated algorithm that sometimes fails in unexpected ways.</p>
<p>The only other changes in client 5.0 are in the <a href="http://github.com/jdavisp3/twisted-intro/blob/master/twisted-client-5/get-poetry.py#L119"><code>poetry_main</code></a> function:</p>
<div><div id="highlighter_3947" class="syntaxhighlighter  py"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div><div class="line number20 index19 alt1">20</div><div class="line number21 index20 alt2">21</div><div class="line number22 index21 alt1">22</div><div class="line number23 index22 alt2">23</div><div class="line number24 index23 alt1">24</div><div class="line number25 index24 alt2">25</div><div class="line number26 index25 alt1">26</div><div class="line number27 index26 alt2">27</div><div class="line number28 index27 alt1">28</div><div class="line number29 index28 alt2">29</div><div class="line number30 index29 alt1">30</div><div class="line number31 index30 alt2">31</div><div class="line number32 index31 alt1">32</div><div class="line number33 index32 alt2">33</div><div class="line number34 index33 alt1">34</div><div class="line number35 index34 alt2">35</div><div class="line number36 index35 alt1">36</div><div class="line number37 index36 alt2">37</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py keyword">def</code> <code class="py plain">poetry_main():</code></div><div class="line number2 index1 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">addresses </code><code class="py keyword">=</code> <code class="py plain">parse_args()</code></div><div class="line number3 index2 alt2">&nbsp;</div><div class="line number4 index3 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">from</code> <code class="py plain">twisted.internet </code><code class="py keyword">import</code> <code class="py plain">reactor</code></div><div class="line number5 index4 alt2">&nbsp;</div><div class="line number6 index5 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">poems </code><code class="py keyword">=</code> <code class="py plain">[]</code></div><div class="line number7 index6 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">errors </code><code class="py keyword">=</code> <code class="py plain">[]</code></div><div class="line number8 index7 alt1">&nbsp;</div><div class="line number9 index8 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">def</code> <code class="py plain">try_to_cummingsify(poem):</code></div><div class="line number10 index9 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">try</code><code class="py plain">:</code></div><div class="line number11 index10 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">return</code> <code class="py plain">cummingsify(poem)</code></div><div class="line number12 index11 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">except</code> <code class="py plain">GibberishError:</code></div><div class="line number13 index12 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">raise</code></div><div class="line number14 index13 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">except</code><code class="py plain">:</code></div><div class="line number15 index14 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py functions">print</code> <code class="py string">'Cummingsify failed!'</code></div><div class="line number16 index15 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">return</code> <code class="py plain">poem</code></div><div class="line number17 index16 alt2">&nbsp;</div><div class="line number18 index17 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">def</code> <code class="py plain">got_poem(poem):</code></div><div class="line number19 index18 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py functions">print</code> <code class="py plain">poem</code></div><div class="line number20 index19 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">poems.append(poem)</code></div><div class="line number21 index20 alt2">&nbsp;</div><div class="line number22 index21 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">def</code> <code class="py plain">poem_failed(err):</code></div><div class="line number23 index22 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py functions">print</code> <code class="py plain">&gt;&gt;sys.stderr, </code><code class="py string">'The poem download failed.'</code></div><div class="line number24 index23 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">errors.append(err)</code></div><div class="line number25 index24 alt2">&nbsp;</div><div class="line number26 index25 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">def</code> <code class="py plain">poem_done(_):</code></div><div class="line number27 index26 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">if</code> <code class="py functions">len</code><code class="py plain">(poems) </code><code class="py keyword">+</code> <code class="py functions">len</code><code class="py plain">(errors) </code><code class="py keyword">=</code><code class="py keyword">=</code> <code class="py functions">len</code><code class="py plain">(addresses):</code></div><div class="line number28 index27 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">reactor.stop()</code></div><div class="line number29 index28 alt2">&nbsp;</div><div class="line number30 index29 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">for</code> <code class="py plain">address </code><code class="py keyword">in</code> <code class="py plain">addresses:</code></div><div class="line number31 index30 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">host, port </code><code class="py keyword">=</code> <code class="py plain">address</code></div><div class="line number32 index31 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">d </code><code class="py keyword">=</code> <code class="py plain">get_poetry(host, port)</code></div><div class="line number33 index32 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">d.addCallback(try_to_cummingsify)</code></div><div class="line number34 index33 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">d.addCallbacks(got_poem, poem_failed)</code></div><div class="line number35 index34 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">d.addBoth(poem_done)</code></div><div class="line number36 index35 alt1">&nbsp;</div><div class="line number37 index36 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">reactor.run()</code></div></div></td></tr></tbody></table></div></div>
<p>So when the program downloads a poem from the server, it will either:</p>
<ol>
<li>Print the cummingsified (lower-cased) version of the poem.</li>
<li>Print "Cummingsify failed!" followed by the original poem.</li>
<li>Print "The poem download failed."</li>
</ol>
<p>Although we have retained the ability to download from multiple servers, when you are testing out client 5.0 it's easier to just use a single server and run the program multiple times, until you see all three different outcomes. Also try running the client on a port with no server.</p>
<p>Let's draw the callback/errback chain we create on each <code>Deferred</code> we get back from <code>get_poetry</code>:</p>
<div id="attachment_1987" class="wp-caption aligncenter" style="width: 589px"><a href="img/deferred-42.png"><img width="579" height="348" class="size-full wp-image-1987" title="Figure 19: the deferred chain in client 5.0" src="img/deferred-42.png" alt="Figure 19: the deferred chain in client 5.0"></a><p class="wp-caption-text">Figure 19: the deferred chain in client 5.0</p></div>
<p>Note the pass-through errback that gets added by <code>addCallback</code>. It passes whatever <code>Failure</code> it receives onto the next errback (<code>poem_failed</code>). Thus, <code>poem_failed</code> can handle failures from both <code>get_poetry</code> (i.e., the deferred is fired with the <code>errback</code> method) and the <code>cummingsify</code> function.</p>
<p>Also note the hauntingly beautiful drop-shadow around the border of the deferred in Figure 19. It doesn't signify anything other than me discovering how to do it in <a href="http://inkscape.org">Inkscape</a>. Expect more drop-shadows in the future.</p>
<p>Let's analyze the different ways our deferred can fire. The case where we get a poem and the <code>cummingsify</code> function works correctly is shown in Figure 20:</p>
<div id="attachment_1970" class="wp-caption aligncenter" style="width: 570px"><a href="img/deferred-5.png"><img width="560" height="348" class="size-full wp-image-1970" title="Figure 20: when we download a poem and transform it correctly" src="img/deferred-5.png" alt="Figure 20: when we download a poem and transform it correctly"></a><p class="wp-caption-text">Figure 20: when we download a poem and transform it correctly</p></div>
<p>In this case no callback fails, so control flows down the callback line. Note that <code>poem_done</code> receives <code>None</code> as its result, since <code>got_poem</code> doesn't actually <code>return</code> a value. If we wanted subsequent callbacks to have access to the poem, we would modify <code>got_poem</code> to return the poem explicitly.</p>
<p>Figure 21 shows the case where we get a poem, but <code>cummingsify</code> raises a GibberishError:</p>
<div id="attachment_1973" class="wp-caption aligncenter" style="width: 570px"><a href="img/deferred-6.png"><img width="560" height="348" class="size-full wp-image-1973" title="Figure 21: when we download a poem and get a GibberishError" src="img/deferred-6.png" alt="Figure 21: when we download a poem and get a GibberishError"></a><p class="wp-caption-text">Figure 21: when we download a poem and get a GibberishError</p></div>
<p>Since the <code>try_to_cummingsify</code> callback re-raises a <code>GibberishError</code>, control switches to the errback line and <code>poem_failed</code> is called with the exception as its argument (wrapped in a <code>Failure</code>, of course).</p>
<p>And since <code>poem_failed</code> doesn't raise an exception, or return a <code>Failure</code>, after it is done control switches back to the callback line. If we want <code>poem_failed</code> to handle the error completely, then returning <code>None</code> is a reasonable behavior. On the other hand, if we wanted <code>poem_failed</code> to take some action, but still propagate the error, we could change <code>poem_failed</code> to return its <code>err</code> argument and processing would continue down the errback line.</p>
<p>Note that in the current code neither <code>got_poem</code> nor <code>poem_failed</code> ever fail themselves, so the <code>poem_done</code> errback will never be called. But it's safe to add it in any case and doing so represents an instance of "defensive" programming, as either <code>got_poem</code> or <code>poem_failed</code> might have bugs we don't know about. Since the <code>addBoth</code> method ensures that a particular function will run no matter how the deferred fires, using <code>addBoth</code> is analogous to adding a <code>finally</code> clause to a <code>try</code>/<code>except</code> statement.</p>
<p>Now examine the case where we download a poem and the <code>cummingsify</code> function raises a <code>ValueError</code>, displayed in Figure 22:</p>
<div id="attachment_1980" class="wp-caption aligncenter" style="width: 570px"><a href="img/deferred-7.png"><img width="560" height="348" class="size-full wp-image-1980" title="Figure 22: when we download a poem and cummingsify fails" src="img/deferred-7.png" alt="Figure 22: when we download a poem and cummingsify fails"></a><p class="wp-caption-text">Figure 22: when we download a poem and cummingsify fails</p></div>
<p>This is the same as figure 20, except <code>got_poem</code> receives the original version of the poem instead of the transformed version. The switch happens entirely inside the <code>try_to_cummingsify</code> callback, which traps the <code>ValueError</code> with an ordinary <code>try</code>/<code>except</code> statement and returns the original poem instead. The deferred object never sees that error at all.</p>
<p>Lastly, we show the case where we try to download a poem from a non-existent server in Figure 23:</p>
<div id="attachment_1983" class="wp-caption aligncenter" style="width: 570px"><a href="img/deferred-8.png"><img width="560" height="348" class="size-full wp-image-1983" title="Figure 23: when we cannot connect to a server" src="img/deferred-8.png" alt="Figure 23: when we cannot connect to a server"></a><p class="wp-caption-text">Figure 23: when we cannot connect to a server</p></div>
<p>As before, <code>poem_failed</code> returns <code>None</code> so afterwards control switches to the callback line.</p>
<h3>Client 5.1</h3>
<p>In client 5.0 we are trapping exceptions from <code>cummingsify</code> in our <code>try_to_cummingsify</code> callback using an ordinary <code>try</code>/<code>except</code> statement, rather than letting the deferred catch them first. There isn't necessarily anything wrong with this strategy, but it's instructive to see how we might do this differently.</p>
<p>Let's suppose we wanted to let the deferred catch both <code>GibberishError</code> and <code>ValueError</code> exceptions and send them to the errback line. To preserve the current behavior our subsequent errback needs to check to see if the error is a <code>ValueError</code> and, if so, handle it by returning the original poem, so that control goes back to the callback line and the original poem gets printed out.</p>
<p>But there's a problem: the errback wouldn't get the original poem, it would get the <code>Failure</code>-wrapped <code>ValueError</code> raised by the <code>cummingsify</code> function. To let the errback handle the error, we need to arrange for it to receive the original poem.</p>
<p>One way to do that is to modify the <code>cummingsify</code> function so the original poem is included in the exception. That's what we've done in client 5.1, located in <a href="http://github.com/jdavisp3/twisted-intro/blob/master/twisted-client-5/get-poetry-1.py#L1"><tt>twisted-client-5/get-poetry-1.py</tt></a>. We changed the <code>ValueError</code> exception into a custom <code>CannotCummingsify</code> exception which takes the original poem as the first argument.</p>
<p>If <code>cummingsify</code> were a real function in an external module, then it would probably be best to wrap it with another function that trapped any exception that wasn't <code>GibberishError</code> and raise a <code>CannotCummingsify</code> exception instead. With this new setup, our <a href="http://github.com/jdavisp3/twisted-intro/blob/master/twisted-client-5/get-poetry-1.py#L122"><code>poetry_main</code></a> function looks like this:</p>
<div><div id="highlighter_55481" class="syntaxhighlighter  py"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div><div class="line number20 index19 alt1">20</div><div class="line number21 index20 alt2">21</div><div class="line number22 index21 alt1">22</div><div class="line number23 index22 alt2">23</div><div class="line number24 index23 alt1">24</div><div class="line number25 index24 alt2">25</div><div class="line number26 index25 alt1">26</div><div class="line number27 index26 alt2">27</div><div class="line number28 index27 alt1">28</div><div class="line number29 index28 alt2">29</div><div class="line number30 index29 alt1">30</div><div class="line number31 index30 alt2">31</div><div class="line number32 index31 alt1">32</div><div class="line number33 index32 alt2">33</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py keyword">def</code> <code class="py plain">poetry_main():</code></div><div class="line number2 index1 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">addresses </code><code class="py keyword">=</code> <code class="py plain">parse_args()</code></div><div class="line number3 index2 alt2">&nbsp;</div><div class="line number4 index3 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">from</code> <code class="py plain">twisted.internet </code><code class="py keyword">import</code> <code class="py plain">reactor</code></div><div class="line number5 index4 alt2">&nbsp;</div><div class="line number6 index5 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">poems </code><code class="py keyword">=</code> <code class="py plain">[]</code></div><div class="line number7 index6 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">errors </code><code class="py keyword">=</code> <code class="py plain">[]</code></div><div class="line number8 index7 alt1">&nbsp;</div><div class="line number9 index8 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">def</code> <code class="py plain">cummingsify_failed(err):</code></div><div class="line number10 index9 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">if</code> <code class="py plain">err.check(CannotCummingsify):</code></div><div class="line number11 index10 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py functions">print</code> <code class="py string">'Cummingsify failed!'</code></div><div class="line number12 index11 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">return</code> <code class="py plain">err.value.args[</code><code class="py value">0</code><code class="py plain">]</code></div><div class="line number13 index12 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">return</code> <code class="py plain">err</code></div><div class="line number14 index13 alt1">&nbsp;</div><div class="line number15 index14 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">def</code> <code class="py plain">got_poem(poem):</code></div><div class="line number16 index15 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py functions">print</code> <code class="py plain">poem</code></div><div class="line number17 index16 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">poems.append(poem)</code></div><div class="line number18 index17 alt1">&nbsp;</div><div class="line number19 index18 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">def</code> <code class="py plain">poem_failed(err):</code></div><div class="line number20 index19 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py functions">print</code> <code class="py plain">&gt;&gt;sys.stderr, </code><code class="py string">'The poem download failed.'</code></div><div class="line number21 index20 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">errors.append(err)</code></div><div class="line number22 index21 alt1">&nbsp;</div><div class="line number23 index22 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">def</code> <code class="py plain">poem_done(_):</code></div><div class="line number24 index23 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">if</code> <code class="py functions">len</code><code class="py plain">(poems) </code><code class="py keyword">+</code> <code class="py functions">len</code><code class="py plain">(errors) </code><code class="py keyword">=</code><code class="py keyword">=</code> <code class="py functions">len</code><code class="py plain">(addresses):</code></div><div class="line number25 index24 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">reactor.stop()</code></div><div class="line number26 index25 alt1">&nbsp;</div><div class="line number27 index26 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">for</code> <code class="py plain">address </code><code class="py keyword">in</code> <code class="py plain">addresses:</code></div><div class="line number28 index27 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">host, port </code><code class="py keyword">=</code> <code class="py plain">address</code></div><div class="line number29 index28 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">d </code><code class="py keyword">=</code> <code class="py plain">get_poetry(host, port)</code></div><div class="line number30 index29 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">d.addCallback(cummingsify)</code></div><div class="line number31 index30 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">d.addErrback(cummingsify_failed)</code></div><div class="line number32 index31 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">d.addCallbacks(got_poem, poem_failed)</code></div><div class="line number33 index32 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">d.addBoth(poem_done)</code></div></div></td></tr></tbody></table></div></div>
<p>And each deferred we create has the structure pictured in Figure 24:<a name="figure24"></a></p>
<div id="attachment_1992" class="wp-caption aligncenter" style="width: 485px"><a href="img/deferred-9.png"><img width="475" height="350" class="size-full wp-image-1992" title="Figure 24: the deferred chain in client 5.1" src="img/deferred-9.png" alt="Figure 24: the deferred chain in client 5.1"></a><p class="wp-caption-text">Figure 24: the deferred chain in client 5.1</p></div>
<p>Examine the <code>cummingsify_failed</code> errback:</p>
<div><div id="highlighter_634553" class="syntaxhighlighter  py"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py keyword">def</code> <code class="py plain">cummingsify_failed(err):</code></div><div class="line number2 index1 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">if</code> <code class="py plain">err.check(CannotCummingsify):</code></div><div class="line number3 index2 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py functions">print</code> <code class="py string">'Cummingsify failed!'</code></div><div class="line number4 index3 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">return</code> <code class="py plain">err.value.args[</code><code class="py value">0</code><code class="py plain">]</code></div><div class="line number5 index4 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">return</code> <code class="py plain">err</code></div></div></td></tr></tbody></table></div></div>
<p>We are using the <a href="http://twistedmatrix.com/trac/browser/tags/releases/twisted-8.2.0/twisted/python/failure.py#L305"><code>check</code></a> method on <code>Failure</code> objects to test whether the exception embedded in the <code>Failure</code> is an instance of <code>CannotCummingsify</code>. If so, we return the first argument to the exception (the original poem) and thus handle the error. Since the return value is not a <code>Failure</code>, control returns to the callback line. Otherwise, we return the <code>Failure</code> itself and send (re-raise) the error down the errback line. As you can see, the exception is available as the <code>value</code> attribute on the <code>Failure</code>.</p>
<p>Figure 25 shows what happens when we get a <code>CannotCummingsify</code> exception:</p>
<div id="attachment_2002" class="wp-caption aligncenter" style="width: 571px"><a href="img/deferred-10.png"><img width="561" height="452" class="size-full wp-image-2002" title="Figure 25: when we get a CannotCummingsify error" src="img/deferred-10.png" alt="Figure 25: when we get a CannotCummingsify error"></a><p class="wp-caption-text">Figure 25: when we get a CannotCummingsify error</p></div>
<p>So when we are using a deferred, we can sometimes choose whether we want to use <code>try</code>/<code>except</code> statements to handle exceptions, or let the deferred re-route errors to an errback.</p>
<h3>Summary</h3>
<p>In Part 10 we updated our poetry client to make use of the <code>Deferred</code>'s ability to route errors and results down the chain. Although the example was rather artificial, it did illustrate how control flow in a deferred switches back and forth between the callback and errback line depending on the result of each stage.</p>
<p>So now we know everything there is to know about deferreds, right? Not yet! We're going to explore some more features of deferreds in a future Part. But first we'll take a little detour and, in <a href="http://krondo.com/wp-content/uploads/2009/08/twisted-intro.html?p=2048">Part 11</a>, implement a Twisted version of our poetry server.</p>
<h3>Suggested Exercises</h3>
<ol>
<li>Figure 25 shows one of the four possible ways the deferreds in client 5.1 can fire. Draw the other three.</li>
<li>Use the <a href="http://github.com/jdavisp3/twisted-intro/blob/master/twisted-deferred/deferred-simulator.py#L1">deferred simulator</a> to simulate all possible firings for clients 5.0 and 5.1. To get you started, this simulator program can represent the case where the <code>try_to_cummingsify</code> function succeeds in client 5.0:
<pre>r poem p
r None r None
r None r None</pre>
</li>
</ol>
<!-- JOLIPRINT BUTTON BEGINS --><script type="text/javascript">
&amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;lt;!--
try{
$joliprint().set('format','json').set('callback','joliprint_getPdf').set('service','wp-plugin').set('url','http://krondo.com/?p=1956').set('title','Print with Joliprint').set('urloptions','ver=1.1.5').set( 'label', 'joliprint' ).set( 'labelposition', 'after' ).set( 'button', 'joliprint-icon' ).write();
}catch(e){

}
--&amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;gt;</script><!-- JOLIPRINT BUTTON ENDS -->		<div class="fixed"></div>
			</div>
</div>

<div id="post-2048" class="post">
	
	

	<div class="content">
		<h2>Part 11: Your Poetry is Served</h2>
<p>This continues the introduction started <a href="http://krondo.com/wp-content/uploads/2009/08/twisted-intro.html?p=1209">here</a>. You can find an index to the entire series <a href="http://krondo.com/wp-content/uploads/2009/08/twisted-intro.html?page_id=1327">here</a>.</p>
<h3>A Twisted Poetry Server</h3>
<p>Now that we've learned so much about writing clients with Twisted, let's turn around and re-implement our poetry server with Twisted too. And thanks to the generality of Twisted's abstractions, it turns out we've already learned almost everything we need to know. Take a look at our Twisted poetry server located in <a href="http://github.com/jdavisp3/twisted-intro/blob/master/twisted-server-1/fastpoetry.py#L1"><tt>twisted-server-1/fastpoetry.py</tt></a>. It's called <tt>fastpoetry</tt> because this server sends the poetry as fast as possible, without any delays at all. Note there's significantly less code than in the client!</p>
<p>Let's take the pieces of the server one at a time. First, the <code>PoetryProtocol</code>:</p>
<div><div class="syntaxhighlighter  py" id="highlighter_325081"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py keyword">class</code> <code class="py plain">PoetryProtocol(Protocol):</code></div><div class="line number2 index1 alt1">&nbsp;</div><div class="line number3 index2 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">def</code> <code class="py plain">connectionMade(</code><code class="py color1">self</code><code class="py plain">):</code></div><div class="line number4 index3 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py color1">self</code><code class="py plain">.transport.write(</code><code class="py color1">self</code><code class="py plain">.factory.poem)</code></div><div class="line number5 index4 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py color1">self</code><code class="py plain">.transport.loseConnection()</code></div></div></td></tr></tbody></table></div></div>
<p>Like the client, the server uses a <code>Protocol</code> instance to manage connections (in this case, connections that clients make to the server). Here the <code>Protocol</code> is implementing the server-side portion of our poetry protocol. Since our wire protocol is strictly one-way, the server's <code>Protocol</code> instance only needs to be concerned with sending data. If you recall, our wire protocol requires the server to start sending the poem immediately after the connection is made, so we implement the <a href="http://twistedmatrix.com/trac/browser/tags/releases/twisted-8.2.0/twisted/internet/protocol.py#L351"><code>connectionMade</code></a> method, a callback that is invoked after a <code>Protocol</code> instance is connected to a <code>Transport</code>.</p>
<p>Our method tells the <code>Transport</code> to do two things: send the entire text of the poem (<a href="http://twistedmatrix.com/trac/browser/tags/releases/twisted-8.2.0/twisted/internet/interfaces.py#L1302"><code>self.transport.write</code></a>) and close the connection (<a href="http://twistedmatrix.com/trac/browser/tags/releases/twisted-8.2.0/twisted/internet/interfaces.py#L1321"><code>self.transport.loseConnection</code></a>). Of course, both of those operations are asynchronous. So the call to <code>write()</code> really means "eventually send all this data to the client" and the call to <code>loseConnection()</code> really means "close this connection once all the data I've asked you to write has been written".</p>
<p>As you can see, the <code>Protocol</code> retrieves the text of the poem from the <code>Factory</code>, so let's look at that next:</p>
<div><div class="syntaxhighlighter  py" id="highlighter_228129"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py keyword">class</code> <code class="py plain">PoetryFactory(ServerFactory):</code></div><div class="line number2 index1 alt1">&nbsp;</div><div class="line number3 index2 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">protocol </code><code class="py keyword">=</code> <code class="py plain">PoetryProtocol</code></div><div class="line number4 index3 alt1">&nbsp;</div><div class="line number5 index4 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">def</code> <code class="py plain">__init__(</code><code class="py color1">self</code><code class="py plain">, poem):</code></div><div class="line number6 index5 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py color1">self</code><code class="py plain">.poem </code><code class="py keyword">=</code> <code class="py plain">poem</code></div></div></td></tr></tbody></table></div></div>
<p>Now that's pretty darn simple. Our factory's only real job, besides making <code>PoetryProtocol</code> instances on demand, is storing the poem that each <code>PoetryProtocol</code> sends to a client.</p>
<p>Notice that we are sub-classing <a href="http://twistedmatrix.com/trac/browser/tags/releases/twisted-8.2.0/twisted/internet/protocol.py#L317"><code>ServerFactory</code></a> instead of <code>ClientFactory</code>. Since our server is passively listening for connections instead of actively making them, we don't need the extra methods <a href="http://twistedmatrix.com/trac/browser/tags/releases/twisted-8.2.0/twisted/internet/protocol.py#L103"><code>ClientFactory</code></a> provides. How can we be sure of that? Because we are using the <a href="http://twistedmatrix.com/trac/browser/tags/releases/twisted-8.2.0/twisted/internet/interfaces.py#L224"><code>listenTCP</code></a> reactor method and the documentation for that method explains that the <code>factory</code> argument should be an instance of <code>ServerFactory</code>.</p>
<p>Here's the <code>main</code> function where we call <code>listenTCP</code>:</p>
<div><div class="syntaxhighlighter  py" id="highlighter_282389"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py keyword">def</code> <code class="py plain">main():</code></div><div class="line number2 index1 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">options, poetry_file </code><code class="py keyword">=</code> <code class="py plain">parse_args()</code></div><div class="line number3 index2 alt2">&nbsp;</div><div class="line number4 index3 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">poem </code><code class="py keyword">=</code> <code class="py functions">open</code><code class="py plain">(poetry_file).read()</code></div><div class="line number5 index4 alt2">&nbsp;</div><div class="line number6 index5 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">factory </code><code class="py keyword">=</code> <code class="py plain">PoetryFactory(poem)</code></div><div class="line number7 index6 alt2">&nbsp;</div><div class="line number8 index7 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">from</code> <code class="py plain">twisted.internet </code><code class="py keyword">import</code> <code class="py plain">reactor</code></div><div class="line number9 index8 alt2">&nbsp;</div><div class="line number10 index9 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">port </code><code class="py keyword">=</code> <code class="py plain">reactor.listenTCP(options.port </code><code class="py keyword">or</code> <code class="py value">0</code><code class="py plain">, factory,</code></div><div class="line number11 index10 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">interface</code><code class="py keyword">=</code><code class="py plain">options.iface)</code></div><div class="line number12 index11 alt1">&nbsp;</div><div class="line number13 index12 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py functions">print</code> <code class="py string">'Serving %s on %s.'</code> <code class="py keyword">%</code> <code class="py plain">(poetry_file, port.getHost())</code></div><div class="line number14 index13 alt1">&nbsp;</div><div class="line number15 index14 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">reactor.run()</code></div></div></td></tr></tbody></table></div></div>
<p>It basically does three things:</p>
<ol>
<li>Read the text of the poem we are going to serve.</li>
<li>Create a <code>PoetryFactory</code> with that poem.</li>
<li>Use <code>listenTCP</code> to tell Twisted to listen for connections on a port, and use our factory to make the protocol instances for each new connection.</li>
</ol>
<p>After that, the only thing left to do is tell the <code>reactor</code> to start running the loop. You can use any of our previous poetry clients (or just <tt>netcat</tt>) to test out the server.</p>
<h3>Discussion</h3>
<p>Recall <a href="http://krondo.com/wp-content/uploads/2009/08/twisted-intro.html?p=1522#figure8">Figure 8</a> and <a href="http://krondo.com/wp-content/uploads/2009/08/twisted-intro.html?p=1522#figure9">Figure 9</a> from Part 5. Those figures illustrated how a new <code>Protocol</code> instance is created and initialized after Twisted makes a new connection on our behalf. It turns out the same mechanism is used when Twisted accepts a new incoming connection on a port we are listening on. That's why both <code>connectTCP</code> and <code>listenTCP</code> require <code>factory</code> arguments.</p>
<p>One thing we didn't show in <a href="http://krondo.com/wp-content/uploads/2009/08/twisted-intro.html?p=1522#figure9">Figure 9</a> is that the <code>connectionMade</code> callback is also called as part of <code>Protocol</code> initialization. This happens no matter what, but we didn't need to use it in the client code. And the <code>Protocol</code> methods that we did use in the client aren't used in the server's implementation. So if we wanted to, we could make a shared library with a single <code>PoetryProtocol</code> that works for both clients and servers. That's actually the way things are typically done in Twisted itself. For example, the <a href="http://twistedmatrix.com/trac/browser/tags/releases/twisted-8.2.0/twisted/protocols/basic.py#L31"><code>NetstringReceiver</code></a> <code>Protocol</code> can both read and write <a href="http://en.wikipedia.org/wiki/Netstrings">netstrings</a> from and to a <code>Transport</code>.</p>
<p>We skipped writing a low-level version of our server, but let's think about what sort of things are going on under the hood. First, calling <code>listenTCP</code> tells Twisted to create a <a href="http://en.wikipedia.org/wiki/Berkeley_sockets#listen.28.29">listening socket</a> and add it to the event loop. An "event" on a listening socket doesn't mean there is data to read; instead it means there is a client waiting to connect to us.</p>
<p>Twisted will automatically <a href="http://en.wikipedia.org/wiki/Berkeley_sockets#accept.28.29">accept</a> incoming connection requests, thus creating a new client socket that links the server directly to an individual client. That client socket is also added to the event loop, and Twisted creates a new <code>Transport</code> and (via the <code>PoetryFactory</code>) a new <code>PoetryProtocol</code> instance to service that specific client. So the <code>Protocol</code> instances are always connected to client sockets, never to the listening socket.</p>
<p>We can visualize all of this in Figure 26:</p>
<div style="width: 610px" class="wp-caption aligncenter" id="attachment_2073"><a href="img/server-1.png"><img width="600" height="385" alt="" src="img/server-1.png" title="Figure 26: the poetry server in action" class="size-full wp-image-2073"></a><p class="wp-caption-text">Figure 26: the poetry server in action</p></div>
<p>In the figure there are three clients currently connected to the poetry server. Each <code>Transport</code> represents a single client socket, and the listening socket makes a total of four file descriptors for the select loop to monitor. When a client is disconnected the associated <code>Transport</code> and <code>PoetryProtocol</code> will be dereferenced and garbage-collected (assuming we haven't stashed a reference to one of them somewhere, a practice we should avoid to prevent memory leaks). The <code>PoetryFactory</code>, meanwhile, will stick around as long as we keep listening for new connections which, in our poetry server, is forever. Like the beauty of poetry. Or something. At any rate, Figure 26 certainly cuts a fine figure of a Figure, doesn't it?</p>
<p>The client sockets and their associated Python objects won't live very long if the poem we are serving is relatively short. But with a large poem and a really busy poetry server we could end up with hundreds or thousands of simultaneous clients. And that's OK &mdash; Twisted has no built-in limits on the number of connections it can handle. Of course, as you increase the load on any server, at some point you will find it cannot keep up or some internal OS limit is reached. For highly-loaded servers, careful measurement and testing is the order of the day.</p>
<p>Twisted also imposes no limit on the number of ports we can listen on. In fact, a single Twisted process could listen on dozens of ports and provide a different service on each one (by using a different factory class for each <code>listenTCP</code> call). And with careful design, whether you provide multiple services with a single Twisted process or several is a decision you could potentially even postpone to the deployment phase.</p>
<p>There's a couple things our server is missing. First of all, it doesn't generate any logs that might help us debug problems or analyze our network traffic. Furthermore, the server doesn't run as a daemon, making it vulnerable to death by accidental <tt>Ctrl-C</tt> (or just logging out). We'll fix both those problems in a future Part but first, in <a href="http://krondo.com/wp-content/uploads/2009/08/twisted-intro.html?p=2101">Part 12</a>, we'll write another server to perform poetry transformation.</p>
<h3>Suggested Exercises</h3>
<ol>
<li>Write an asynchronous poetry server without using Twisted, like we did for the client in <a href="http://krondo.com/wp-content/uploads/2009/08/twisted-intro.html?p=1247">Part 2</a>. Note that listening sockets need to be monitored for reading and a "readable" listening socket means we can <code>accept</code> a new client socket.</li>
<li>Write a low-level asynchronous poetry server using Twisted, but without using <code>listenTCP</code> or protocols, transports, and factories, like we did for the client in <a href="http://krondo.com/wp-content/uploads/2009/08/twisted-intro.html?p=1445">Part 4</a>. So you'll still be making your own sockets, but you can use the Twisted reactor instead of your own <code>select</code> loop.</li>
<li>Make the high-level version of the Twisted poetry server a "slow server" by using <code>callLater</code> or <code>LoopingCall</code> to make multiple calls to <code>transport.write()</code>. Add the <tt>--num-bytes</tt> and <tt>--delay</tt> command line options supported by the blocking server. Don't forget to handle the case where the client disconnects before receiving the whole poem.</li>
<li>Extend the high-level Twisted server so it can serve multiple poems (on different ports).</li>
<li>What are some reasons to serve multiple services from the same Twisted process? What are some reasons not to?</li>
</ol>
<!-- JOLIPRINT BUTTON BEGINS --><script type="text/javascript">
&amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;lt;!--
try{
$joliprint().set('format','json').set('callback','joliprint_getPdf').set('service','wp-plugin').set('url','http://krondo.com/?p=2048').set('title','Print with Joliprint').set('urloptions','ver=1.1.5').set( 'label', 'joliprint' ).set( 'labelposition', 'after' ).set( 'button', 'joliprint-icon' ).write();
}catch(e){

}
--&amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;gt;</script><!-- JOLIPRINT BUTTON ENDS -->		<div class="fixed"></div>
			</div>
</div>


<div id="post-2101" class="post">
	
	

	<div class="content">
		<h2>Part 12: A Poetry Transformation Server</h2>
<p>This continues the introduction started <a href="http://krondo.com/wp-content/uploads/2009/08/twisted-intro.html?p=1209">here</a>. You can find an index to the entire series <a href="http://krondo.com/wp-content/uploads/2009/08/twisted-intro.html?page_id=1327">here</a>.</p>
<h3>One More Server</h3>
<p>Alright, we've written one Twisted server so let's write another, and then we'll get back to learning some more about Deferreds.</p>
<p>In Parts <a href="http://krondo.com/wp-content/uploads/2009/08/twisted-intro.html?p=1825">9</a> and <a href="http://krondo.com/wp-content/uploads/2009/08/twisted-intro.html?p=1956">10</a> we introduced the idea of a poetry transformation engine. The one we eventually implemented, the cummingsifier, was so simple we had to add random exceptions to simulate a failure. But if the transformation engine was located on another server, providing a network "poetry transformation service", then there is a much more realistic failure mode: the transformation server is down.</p>
<p>So in Part 12 we're going to implement a poetry transformation server and then, in the next Part, we'll update our poetry client to use the external transformation service and learn a few new things about Deferreds in the process.</p>
<h3>Designing the Protocol</h3>
<p>Up till now the interactions between client and server have been strictly one-way. The server sends a poem to the client while the client never sends anything at all to the server. But a transformation service is two-way &mdash; the client sends a poem to the server and then the server sends a transformed poem back. So we'll need to use, or invent, a protocol to handle that interaction.</p>
<p>While we're at it, let's allow the server to support multiple kinds of transformations and allow the client to select which one to use. So the client will send two pieces of information: the name of the transformation and the complete text of the poem. And the server will return a single piece of information, namely the text of the transformed poem. So we've got a very simple sort of <a href="http://en.wikipedia.org/wiki/Remote_procedure_call">Remote Procedure Call</a>.</p>
<p>Twisted includes support for several protocols we could use to solve this problem, including <a href="http://twistedmatrix.com/trac/browser/tags/releases/twisted-8.2.0/twisted/web/xmlrpc.py">XML-RPC</a>, <a href="http://twistedmatrix.com/documents/current/core/howto/pb-intro.html">Perspective Broker</a>, and <a href="http://twistedmatrix.com/trac/browser/tags/releases/twisted-8.2.0/twisted/protocols/amp.py">AMP</a>.</p>
<p>But introducing any of these full-featured protocols would require us to go too far afield, so we'll roll our own humble protocol instead. Let's have the client send a string of the form (without the angle brackets):</p>
<p style="text-align: center;"><strong>&lt;transform-name&gt;.&lt;text of the poem&gt;</strong></p>
<p>That's just the name of the transform, followed by a period, followed by the complete text of the poem itself. And we'll encode the whole thing in the form of a <a href="http://en.wikipedia.org/wiki/Netstrings">netstring</a>. And the server will send back the text of the transformed poem, also in a netstring. Since netstrings use length-encoding, the client will be able to detect the case where the server fails to send back a complete result (maybe it crashed in the middle of the operation). If you recall, our original poetry protocol has trouble detecting aborted poetry deliveries.</p>
<p>So much for the protocol design. It's not going to win any awards, but it's good enough for our purposes.</p>
<h3>The Code</h3>
<p>Let's look at the code of our transformation server, located in <a href="http://github.com/jdavisp3/twisted-intro/blob/master/twisted-server-1/transformedpoetry.py#L1"><tt>twisted-server-1/transformedpoetry.py</tt></a>. First, we define a <a href="http://github.com/jdavisp3/twisted-intro/blob/master/twisted-server-1/transformedpoetry.py#L41"><code>TransformService</code></a> class:</p>
<div><div class="syntaxhighlighter  py" id="highlighter_507509"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py keyword">class</code> <code class="py plain">TransformService(</code><code class="py functions">object</code><code class="py plain">):</code></div><div class="line number2 index1 alt1">&nbsp;</div><div class="line number3 index2 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">def</code> <code class="py plain">cummingsify(</code><code class="py color1">self</code><code class="py plain">, poem):</code></div><div class="line number4 index3 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">return</code> <code class="py plain">poem.lower()</code></div></div></td></tr></tbody></table></div></div>
<p>The transform service currently implements one transformation, <code>cummingsify</code>, via a method of the same name. We could add additional algorithms by adding additional methods. Here's something important to notice: the transformation service is entirely independent of the particular details of the protocol we settled on earlier. Separating the protocol logic from the service logic is a common pattern in Twisted programming. Doing so makes it easy to provide the same service via multiple protocols without duplicating code.</p>
<p>Now let's look at the <a href="http://github.com/jdavisp3/twisted-intro/blob/master/twisted-server-1/transformedpoetry.py#L67">protocol factory</a> (we'll look at the protocol right after):</p>
<div><div class="syntaxhighlighter  py" id="highlighter_351800"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div><div class="line number20 index19 alt1">20</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py keyword">class</code> <code class="py plain">TransformFactory(ServerFactory):</code></div><div class="line number2 index1 alt1">&nbsp;</div><div class="line number3 index2 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">protocol </code><code class="py keyword">=</code> <code class="py plain">TransformProtocol</code></div><div class="line number4 index3 alt1">&nbsp;</div><div class="line number5 index4 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">def</code> <code class="py plain">__init__(</code><code class="py color1">self</code><code class="py plain">, service):</code></div><div class="line number6 index5 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py color1">self</code><code class="py plain">.service </code><code class="py keyword">=</code> <code class="py plain">service</code></div><div class="line number7 index6 alt2">&nbsp;</div><div class="line number8 index7 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">def</code> <code class="py plain">transform(</code><code class="py color1">self</code><code class="py plain">, xform_name, poem):</code></div><div class="line number9 index8 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">thunk </code><code class="py keyword">=</code> <code class="py functions">getattr</code><code class="py plain">(</code><code class="py color1">self</code><code class="py plain">, </code><code class="py string">'xform_%s'</code> <code class="py keyword">%</code> <code class="py plain">(xform_name,), </code><code class="py color1">None</code><code class="py plain">)</code></div><div class="line number10 index9 alt1">&nbsp;</div><div class="line number11 index10 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">if</code> <code class="py plain">thunk </code><code class="py keyword">is</code> <code class="py color1">None</code><code class="py plain">: </code><code class="py comments"># no such transform</code></div><div class="line number12 index11 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">return</code> <code class="py color1">None</code></div><div class="line number13 index12 alt2">&nbsp;</div><div class="line number14 index13 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">try</code><code class="py plain">:</code></div><div class="line number15 index14 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">return</code> <code class="py plain">thunk(poem)</code></div><div class="line number16 index15 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">except</code><code class="py plain">:</code></div><div class="line number17 index16 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">return</code> <code class="py color1">None</code> <code class="py comments"># transform failed</code></div><div class="line number18 index17 alt1">&nbsp;</div><div class="line number19 index18 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">def</code> <code class="py plain">xform_cummingsify(</code><code class="py color1">self</code><code class="py plain">, poem):</code></div><div class="line number20 index19 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">return</code> <code class="py color1">self</code><code class="py plain">.service.cummingsify(poem)</code></div></div></td></tr></tbody></table></div></div>
<p>This factory provides a <code>transform</code> method which a protocol instance can use to request a poetry transformation on behalf of a connected client. The method returns <code>None</code> if there is no such transformation or if the transformation fails. And like the <code>TransformService</code>, the protocol factory is independent of the wire-level protocol, the details of which are delegated to the protocol class itself.</p>
<p>One thing to notice is the way we guard access to the service though the <code>xform_</code>-prefixed methods. This is a pattern you will find in the Twisted sources, although the prefixes vary and they are usually on an object separate from the factory. It's one way of preventing client code from executing an arbitrary method on the service object, since the client can send any transform name they want. It also provides a place to perform protocol-specific adaptation to the API provided by the service object.</p>
<p>Now we'll take a look at the <a href="http://github.com/jdavisp3/twisted-intro/blob/master/twisted-server-1/transformedpoetry.py#L47">protocol implementation</a>:</p>
<div><div class="syntaxhighlighter  py" id="highlighter_413182"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py keyword">class</code> <code class="py plain">TransformProtocol(NetstringReceiver):</code></div><div class="line number2 index1 alt1">&nbsp;</div><div class="line number3 index2 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">def</code> <code class="py plain">stringReceived(</code><code class="py color1">self</code><code class="py plain">, request):</code></div><div class="line number4 index3 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">if</code> <code class="py string">'.'</code> <code class="py keyword">not</code> <code class="py keyword">in</code> <code class="py plain">request: </code><code class="py comments"># bad request</code></div><div class="line number5 index4 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py color1">self</code><code class="py plain">.transport.loseConnection()</code></div><div class="line number6 index5 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">return</code></div><div class="line number7 index6 alt2">&nbsp;</div><div class="line number8 index7 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">xform_name, poem </code><code class="py keyword">=</code> <code class="py plain">request.split(</code><code class="py string">'.'</code><code class="py plain">, </code><code class="py value">1</code><code class="py plain">)</code></div><div class="line number9 index8 alt2">&nbsp;</div><div class="line number10 index9 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py color1">self</code><code class="py plain">.xformRequestReceived(xform_name, poem)</code></div><div class="line number11 index10 alt2">&nbsp;</div><div class="line number12 index11 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">def</code> <code class="py plain">xformRequestReceived(</code><code class="py color1">self</code><code class="py plain">, xform_name, poem):</code></div><div class="line number13 index12 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">new_poem </code><code class="py keyword">=</code> <code class="py color1">self</code><code class="py plain">.factory.transform(xform_name, poem)</code></div><div class="line number14 index13 alt1">&nbsp;</div><div class="line number15 index14 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">if</code> <code class="py plain">new_poem </code><code class="py keyword">is</code> <code class="py keyword">not</code> <code class="py color1">None</code><code class="py plain">:</code></div><div class="line number16 index15 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py color1">self</code><code class="py plain">.sendString(new_poem)</code></div><div class="line number17 index16 alt2">&nbsp;</div><div class="line number18 index17 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py color1">self</code><code class="py plain">.transport.loseConnection()</code></div></div></td></tr></tbody></table></div></div>
<p>In the protocol implementation we take advantage of the fact that Twisted supports netstrings via the <a href="http://twistedmatrix.com/trac/browser/tags/releases/twisted-8.2.0/twisted/protocols/basic.py#L31"><code>NetstringReceiver</code></a> protocol. That base class takes care of decoding (and encoding) the netstrings and all we have to do is implement the <a href="http://twistedmatrix.com/trac/browser/tags/releases/twisted-8.2.0/twisted/protocols/basic.py#L49"><code>stringReceived</code></a> method. In other words, <code>stringReceived</code> is called with the <em>content</em> of a netstring sent by the client, without the extra bytes added by the netstring encoding. The base class also takes care of buffering the incoming bytes until we have enough to decode a complete string.</p>
<p>If everything goes ok (and if it doesn't we just close the connection) we send the transformed poem back to the client using the <code>sendString</code> method provided by <code>NetstringReceiver</code> (and which ultimately calls <code>transport.write()</code>). And that's all there is to it. We won't bother listing the <a href="http://github.com/jdavisp3/twisted-intro/blob/master/twisted-server-1/transformedpoetry.py#L89"><code>main</code></a> function since it's similar to the ones we've seen before.</p>
<p>Notice how we continue the Twisted pattern of translating the incoming byte stream to higher and higher levels of abstraction by defining the <code>xformRequestReceived</code> method, which is passed the name of the transform and the poem as two separate arguments.</p>
<h3>A Simple Client</h3>
<p>We'll implement a Twisted client for the transformation service in the next Part. For now we'll just make do with a simple script located  in <tt>twisted-server-1/transform-test</tt>. It uses the netcat program to send a poem to the server and then prints out the response (which will be encoded as a netstring). Let's say you run the transformation server on port 11000 like this:</p>
<pre>python twisted-server-1/transformedpoetry.py --port 11000</pre>
<p>Then you could run the test script against that server like this:</p>
<pre>./twisted-server-1/transform-test 11000</pre>
<p>And you should see some output like this:</p>
<pre>15:here is my poem,</pre>
<p>That's the netstring-encoded transformed poem (the original is in all upper case).</p>
<h3>Discussion</h3>
<p>We introduced a few new ideas in this Part:</p>
<ol>
<li>Two-way communication.</li>
<li>Building on an existing protocol implementation provided by Twisted.</li>
<li>Using a service object to separate functional logic from protocol logic.</li>
</ol>
<p>The basic mechanics of two-way communication are simple. We used the same techniques for reading and writing data in previous clients and servers; the only difference is we used them both together. Of course, a more complex protocol will require more complex code to process the byte stream and format outgoing messages. And that's a great reason to use an existing protocol implementation like we did today.</p>
<p>Once you start getting comfortable writing basic protocols, it's a good idea to take a look at the different protocol implementations provided by Twisted. You might start by perusing the <a href="http://twistedmatrix.com/trac/browser/tags/releases/twisted-8.2.0/twisted/protocols/basic.py"><code>twisted.protocols.basic</code></a> module and going from there. Writing simple protocols is a great way to familiarize yourself with the Twisted style of programming, but in a "real" program it's probably a lot more common to use a ready-made implementation, assuming there is one available for the protocol you want to use.</p>
<p>The last new idea we introduced, the use of a Service object to separate functional and protocol logic, is a really important design pattern in Twisted programming. Although the service object we made today is trivial, you can imagine a more realistic network service could be quite complex. And by making the Service independent of protocol-level details, we can quickly provide the same service on a new protocol without duplicating code.</p>
<p>Figure 27 shows a transformation server that is providing poetry transformations via two different protocols (the version of the server we presented above only has one protocol):</p>
<div style="width: 579px" class="wp-caption aligncenter" id="attachment_2128"><a href="img/server-21.png"><img width="569" height="464" alt="Figure 27: a transformation server with two protocols" src="img/server-21.png" title="Figure 27: a transformation server with two protocols" class="size-full wp-image-2128"></a><p class="wp-caption-text">Figure 27: a transformation server with two protocols</p></div>
<p>Although we need two separate protocol factories in Figure 27, they might differ only in their <code>protocol</code> class attribute and would be otherwise identical. The factories would share the same Service object and only the <code>Protocol</code>s themselves would require separate implementations. Now that's code re-use!</p>
<h3>Looking Ahead</h3>
<p>So much for our transformation server. In <a href="http://krondo.com/wp-content/uploads/2009/08/twisted-intro.html?p=2159">Part 13</a>, we'll update our poetry client to use the transform server instead of implementing transformations in the client itself.</p>
<h3>Suggested Exercises</h3>
<ol>
<li>Read the source code for the <a href="http://twistedmatrix.com/trac/browser/tags/releases/twisted-8.2.0/twisted/protocols/basic.py#L31"><code>NetstringReceiver</code></a> class. What happens if the client sends a malformed netstring? What happens if the client tries to send a huge netstring?</li>
<li>Invent another transformation algorithm and add it to the transformation service and the protocol factory. Test it out by modifying the netcat client.</li>
<li>Invent another protocol for requesting poetry transformations and modify the server to handle both protocols (on two different ports). Use the same instance of the <code>TransformService</code> for both.</li>
<li>How would the code need to change if the methods on the <code>TransformService</code> were asynchronous (i.e., they returned Deferreds)?</li>
<li>Write a synchronous client for the transformation server.</li>
<li>Update the original client and server to use netstrings when sending poetry.</li>
</ol>
<!-- JOLIPRINT BUTTON BEGINS --><script type="text/javascript">
&amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;lt;!--
try{
$joliprint().set('format','json').set('callback','joliprint_getPdf').set('service','wp-plugin').set('url','http://krondo.com/?p=2101').set('title','Print with Joliprint').set('urloptions','ver=1.1.5').set( 'label', 'joliprint' ).set( 'labelposition', 'after' ).set( 'button', 'joliprint-icon' ).write();
}catch(e){

}
--&amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;gt;</script><!-- JOLIPRINT BUTTON ENDS -->		<div class="fixed"></div>
			</div>
</div>


<div class="post" id="post-2159">
	
	

	<div class="content">
		<h2>Part 13: Deferred All The Way Down</h2>
<p>This continues the introduction started <a href="http://krondo.com/wp-content/uploads/2009/08/twisted-intro.html?p=1209">here</a>. You can find an index to the entire series <a href="http://krondo.com/wp-content/uploads/2009/08/twisted-intro.html?page_id=1327">here</a>.</p>
<h3>Introduction</h3>
<p>Recall poetry client 5.1 from <a href="http://krondo.com/wp-content/uploads/2009/08/twisted-intro.html?p=1956">Part 10</a>.The client used a Deferred to manage a <a href="http://krondo.com/wp-content/uploads/2009/08/twisted-intro.html?p=1956#figure24">callback chain</a> that included a call to a poetry transformation engine. In <a href="http://github.com/jdavisp3/twisted-intro/blob/master/twisted-client-5/get-poetry-1.py#L1">client 5.1</a>, the engine was implemented as a synchronous function call implemented in the client itself.</p>
<p>Now we want to make a new client that uses the networked poetry transformation service we wrote in <a href="http://krondo.com/wp-content/uploads/2009/08/twisted-intro.html?p=2101">Part 12</a>. But here's the wrinkle: since the transformation service is accessed over the network, we'll need to use asynchronous I/O. And that means our API for requesting a transformation will have to be asynchronous, too. In other words, the <code>try_to_cummingsify</code> callback is going to return a <code>Deferred</code> in our new client.</p>
<p>So what happens when a callback in a deferred's chain returns another deferred? Let's call the first deferred the 'outer' deferred and the second the 'inner' one. Suppose callback <strong>N</strong> in the outer deferred returns the inner deferred. That callback&nbsp; is saying "I'm asynchronous, my result isn't here yet". Since the outer deferred needs to call the next callback or errback in the chain with the result, the outer deferred needs to wait until the inner deferred is fired. Of course, the outer deferred can't block either, so instead the outer deferred suspends the execution of the callback chain and returns control to the reactor (or whatever fired the outer deferred).</p>
<p>And how does the outer deferred know when to resume? Simple &mdash; by adding a callback/errback pair to the inner deferred. Thus, when the inner deferred is fired the outer deferred will resume executing its chain. If the inner deferred succeeds (i.e., it calls the callback added by the outer deferred), then the outer deferred calls its <strong>N+1</strong> callback with the result. And if the inner deferred fails (calls the errback added by the outer deferred), the outer deferred calls the <strong>N+1</strong> errback with the failure.</p>
<p>That's a lot to digest, so let's illustrate the idea in Figure 28:<a name="figure28"></a></p>
<div id="attachment_2196" class="wp-caption aligncenter" style="width: 609px"><a href="img/deferred-111.png"><img width="599" height="511" class="size-full wp-image-2196" title="Figure 28: outer and inner deferred processing" src="img/deferred-111.png" alt="Figure 28: outer and inner deferred processing"></a><p class="wp-caption-text">Figure 28: outer and inner deferred processing</p></div>
<p>In this figure the outer deferred has 4 layers of callback/errback pairs. When the outer deferred fires, the first callback in the chain returns a deferred (the inner deferred). At that point, the outer deferred will stop firing its chain and return control to the reactor (after adding a callback/errback pair to the inner deferred). Then, some time later, the inner deferred fires and the outer deferred resumes processing its callback chain. Note the outer deferred does <em>not</em> fire the inner deferred itself. That would be impossible, since the outer deferred cannot know when the inner deferred's result is available, or what that result might be. Rather, the outer deferred simply waits (asynchronously) for the inner deferred to fire.</p>
<p>Notice how the line connecting the callback to the inner deferred in Figure 28 is black instead of green or red. That's because we don't know whether the callback succeeded or failed until the inner deferred is fired. Only then can the outer deferred decide whether to call the next callback or the next errback in its own chain.</p>
<p>Figure 29 shows the same outer/inner deferred firing sequence in Figure 28 from the point of view of the reactor:</p>
<div id="attachment_2179" class="wp-caption aligncenter" style="width: 664px"><a href="img/deferred-12.png"><img width="654" height="582" class="size-full wp-image-2179" title="Figure 29: the thread of control in Figure 28" src="img/deferred-12.png" alt="Figure 29: the thread of control in Figure 28"></a><p class="wp-caption-text">Figure 29: the thread of control in Figure 28</p></div>
<p>This is probably the most complicated feature of the <code>Deferred</code> class, so don't worry if you need some time to absorb it. We'll illustrate it one more way using the example code in <a href="http://github.com/jdavisp3/twisted-intro/blob/master/twisted-deferred/defer-10.py#L1"><tt>twisted-deferred/defer-10.py</tt></a>. That example creates two outer deferreds, one with plain callbacks, and one where a single callback returns an inner deferred. By studying the code and the output you can see how the second outer deferred stops running its chain when the inner deferred is returned, and then starts up again when the inner deferred is fired.</p>
<h3>Client 6.0</h3>
<p>Let's use our new knowledge of nested deferreds and re-implement our poetry client to use the network transformation service from Part 12. You can find the code in <a href="http://github.com/jdavisp3/twisted-intro/blob/master/twisted-client-6/get-poetry.py#L1"><tt>twisted-client-6/get-poetry.py</tt></a>. The poetry Protocol and Factory are unchanged from the previous version. But now we have a Protocol and Factory for making transformation requests. Here's the transform client <a href="http://github.com/jdavisp3/twisted-intro/blob/master/twisted-client-6/get-poetry.py#L85">Protocol</a>:</p>
<div><div id="highlighter_470978" class="syntaxhighlighter  py"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py keyword">class</code> <code class="py plain">TransformClientProtocol(NetstringReceiver):</code></div><div class="line number2 index1 alt1">&nbsp;</div><div class="line number3 index2 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">def</code> <code class="py plain">connectionMade(</code><code class="py color1">self</code><code class="py plain">):</code></div><div class="line number4 index3 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py color1">self</code><code class="py plain">.sendRequest(</code><code class="py color1">self</code><code class="py plain">.factory.xform_name, </code><code class="py color1">self</code><code class="py plain">.factory.poem)</code></div><div class="line number5 index4 alt2">&nbsp;</div><div class="line number6 index5 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">def</code> <code class="py plain">sendRequest(</code><code class="py color1">self</code><code class="py plain">, xform_name, poem):</code></div><div class="line number7 index6 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py color1">self</code><code class="py plain">.sendString(xform_name </code><code class="py keyword">+</code> <code class="py string">'.'</code> <code class="py keyword">+</code> <code class="py plain">poem)</code></div><div class="line number8 index7 alt1">&nbsp;</div><div class="line number9 index8 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">def</code> <code class="py plain">stringReceived(</code><code class="py color1">self</code><code class="py plain">, s):</code></div><div class="line number10 index9 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py color1">self</code><code class="py plain">.transport.loseConnection()</code></div><div class="line number11 index10 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py color1">self</code><code class="py plain">.poemReceived(s)</code></div><div class="line number12 index11 alt1">&nbsp;</div><div class="line number13 index12 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">def</code> <code class="py plain">poemReceived(</code><code class="py color1">self</code><code class="py plain">, poem):</code></div><div class="line number14 index13 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py color1">self</code><code class="py plain">.factory.handlePoem(poem)</code></div></div></td></tr></tbody></table></div></div>
<p>Using the NetstringReceiver as a base class makes this implementation pretty simple. As soon as the connection is established we send the transform request to the server, retrieving the name of the transform and the poem from our factory. And when we get the poem back, we pass it on to the factory for processing. Here's the code for the <a href="http://github.com/jdavisp3/twisted-intro/blob/master/twisted-client-6/get-poetry.py#L101">Factory</a>:</p>
<div><div id="highlighter_960852" class="syntaxhighlighter  py"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py keyword">class</code> <code class="py plain">TransformClientFactory(ClientFactory):</code></div><div class="line number2 index1 alt1">&nbsp;</div><div class="line number3 index2 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">protocol </code><code class="py keyword">=</code> <code class="py plain">TransformClientProtocol</code></div><div class="line number4 index3 alt1">&nbsp;</div><div class="line number5 index4 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">def</code> <code class="py plain">__init__(</code><code class="py color1">self</code><code class="py plain">, xform_name, poem):</code></div><div class="line number6 index5 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py color1">self</code><code class="py plain">.xform_name </code><code class="py keyword">=</code> <code class="py plain">xform_name</code></div><div class="line number7 index6 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py color1">self</code><code class="py plain">.poem </code><code class="py keyword">=</code> <code class="py plain">poem</code></div><div class="line number8 index7 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py color1">self</code><code class="py plain">.deferred </code><code class="py keyword">=</code> <code class="py plain">defer.Deferred()</code></div><div class="line number9 index8 alt2">&nbsp;</div><div class="line number10 index9 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">def</code> <code class="py plain">handlePoem(</code><code class="py color1">self</code><code class="py plain">, poem):</code></div><div class="line number11 index10 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">d, </code><code class="py color1">self</code><code class="py plain">.deferred </code><code class="py keyword">=</code> <code class="py color1">self</code><code class="py plain">.deferred, </code><code class="py color1">None</code></div><div class="line number12 index11 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">d.callback(poem)</code></div><div class="line number13 index12 alt2">&nbsp;</div><div class="line number14 index13 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">def</code> <code class="py plain">clientConnectionLost(</code><code class="py color1">self</code><code class="py plain">, _, reason):</code></div><div class="line number15 index14 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">if</code> <code class="py color1">self</code><code class="py plain">.deferred </code><code class="py keyword">is</code> <code class="py keyword">not</code> <code class="py color1">None</code><code class="py plain">:</code></div><div class="line number16 index15 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">d, </code><code class="py color1">self</code><code class="py plain">.deferred </code><code class="py keyword">=</code> <code class="py color1">self</code><code class="py plain">.deferred, </code><code class="py color1">None</code></div><div class="line number17 index16 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">d.errback(reason)</code></div><div class="line number18 index17 alt1">&nbsp;</div><div class="line number19 index18 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">clientConnectionFailed </code><code class="py keyword">=</code> <code class="py plain">clientConnectionLost</code></div></div></td></tr></tbody></table></div></div>
<p>This factory is designed for clients and handles a single transformation request, storing both the transform name and the poem for use by the Protocol. The Factory creates a single Deferred which represents the result of the transformation request. Notice how the Factory handles two error cases: a failure to connect and a connection that is closed before the poem is received. Also note the <code>clientConnectionLost</code> method is called even if we receive the poem, but in that case <code>self.deferred</code> will be <code>None</code>, thanks to the <code>handlePoem</code> method.</p>
<p>This Factory class creates the Deferred that it also fires. That's a good rule to follow in Twisted programming, so let's highlight it:</p>
<p style="padding-left: 30px;">In general, an object that makes a Deferred should also be in charge of firing that Deferred.</p>
<p>This "you make it, you fire it" rule helps ensure a given deferred is only fired once and makes it easier to follow the flow of control in a Twisted program.</p>
<p>In addition to the transform Factory, there is also a <a href="http://github.com/jdavisp3/twisted-intro/blob/master/twisted-client-6/get-poetry.py#L122">Proxy</a> class which hides the details of making the TCP connection to a particular transform server:</p>
<div><div id="highlighter_385480" class="syntaxhighlighter  py"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py keyword">class</code> <code class="py plain">TransformProxy(</code><code class="py functions">object</code><code class="py plain">):</code></div><div class="line number2 index1 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py comments">"""</code></div><div class="line number3 index2 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py comments">I proxy requests to a transformation service.</code></div><div class="line number4 index3 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py comments">"""</code></div><div class="line number5 index4 alt2">&nbsp;</div><div class="line number6 index5 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">def</code> <code class="py plain">__init__(</code><code class="py color1">self</code><code class="py plain">, host, port):</code></div><div class="line number7 index6 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py color1">self</code><code class="py plain">.host </code><code class="py keyword">=</code> <code class="py plain">host</code></div><div class="line number8 index7 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py color1">self</code><code class="py plain">.port </code><code class="py keyword">=</code> <code class="py plain">port</code></div><div class="line number9 index8 alt2">&nbsp;</div><div class="line number10 index9 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">def</code> <code class="py plain">xform(</code><code class="py color1">self</code><code class="py plain">, xform_name, poem):</code></div><div class="line number11 index10 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">factory </code><code class="py keyword">=</code> <code class="py plain">TransformClientFactory(xform_name, poem)</code></div><div class="line number12 index11 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">from</code> <code class="py plain">twisted.internet </code><code class="py keyword">import</code> <code class="py plain">reactor</code></div><div class="line number13 index12 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">reactor.connectTCP(</code><code class="py color1">self</code><code class="py plain">.host, </code><code class="py color1">self</code><code class="py plain">.port, factory)</code></div><div class="line number14 index13 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">return</code> <code class="py plain">factory.deferred</code></div></div></td></tr></tbody></table></div></div>
<p>This class presents a single <code>xform()</code> interface that other code can use to request transformations. So that other code can just request a transform and get a deferred back without mucking around with hostnames and port numbers.</p>
<p>The rest of the program is unchanged except for the <a href="http://github.com/jdavisp3/twisted-intro/blob/master/twisted-client-6/get-poetry.py#L163"><code>try_to_cummingsify</code></a> callback:</p>
<div><div id="highlighter_805682" class="syntaxhighlighter  py"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py keyword">def</code> <code class="py plain">try_to_cummingsify(poem):</code></div><div class="line number2 index1 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">d </code><code class="py keyword">=</code> <code class="py plain">proxy.xform(</code><code class="py string">'cummingsify'</code><code class="py plain">, poem)</code></div><div class="line number3 index2 alt2">&nbsp;</div><div class="line number4 index3 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">def</code> <code class="py plain">fail(err):</code></div><div class="line number5 index4 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py functions">print</code> <code class="py plain">&gt;&gt;sys.stderr, </code><code class="py string">'Cummingsify failed!'</code></div><div class="line number6 index5 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">return</code> <code class="py plain">poem</code></div><div class="line number7 index6 alt2">&nbsp;</div><div class="line number8 index7 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">return</code> <code class="py plain">d.addErrback(fail)</code></div></div></td></tr></tbody></table></div></div>
<p>This callback now returns a deferred, but we didn't have to change the rest of the <code>main</code> function at all, other than to create the Proxy instance. Since <code>try_to_cummingsify</code> was part of a deferred chain (the deferred returned by <code>get_poetry</code>), it was already being used asynchronously and nothing else need change.</p>
<p>You'll note we are returning the result of <code>d.addErrback(fail)</code>. That's just a little bit of syntactic sugar. The <code>addCallback</code> and <code>addErrback</code> methods return the original deferred. We might just as well have written:</p>
<div><div id="highlighter_581457" class="syntaxhighlighter  py"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py plain">d.addErrback(fail)</code></div><div class="line number2 index1 alt1"><code class="py keyword">return</code> <code class="py plain">d</code></div></div></td></tr></tbody></table></div></div>
<p>The first version is the same thing, just shorter.</p>
<h4>Testing out the Client</h4>
<p>The new client has a slightly different syntax than the others. If you have a transformation service running on port 10001 and two poetry servers running on ports 10002 and 10003, you would run:</p>
<pre>python twisted-client-6/get-poetry.py 10001 10002 10003</pre>
<p>To download two poems and transform them both. You can start the transform server like this:</p>
<pre>python twisted-server-1/transformedpoetry.py --port 10001</pre>
<p>And the poetry servers like this:</p>
<pre>python twisted-server-1/fastpoetry.py --port 10002 poetry/fascination.txt
python twisted-server-1/fastpoetry.py --port 10003 poetry/science.txt</pre>
<p>Then you can run the poetry client as above. After that, try crashing the transform server and re-running the client with the same command.</p>
<h3>Wrapping Up</h3>
<p>In this Part we learned how deferreds can transparently handle other deferreds in a callback chain, and thus we can safely add asynchronous callbacks to an 'outer' deferred without worrying about the details. That's pretty handy since lots of our functions are going to end up being asynchronous.</p>
<p>Do we know everything there is to know about deferreds yet? Not quite! There's one more important feature to talk about, but we'll save it for <a href="http://krondo.com/wp-content/uploads/2009/08/twisted-intro.html?p=2205">Part 14</a>.</p>
<h3>Suggested Exercises</h3>
<ol>
<li>Modify the client so we can ask for a specific kind of transformation by name.</li>
<li>Modify the client so the transformation server address is an optional argument. If it's not provided, skip the transformation step.</li>
<li>The <a href="http://github.com/jdavisp3/twisted-intro/blob/master/twisted-client-6/get-poetry.py#L67"><code>PoetryClientFactory</code></a> currently violates the "you make it, you fire it" rule for deferreds. Refactor <code>get_poetry</code> and <code>PoetryClientFactory</code> to remedy that.</li>
<li>Although we didn't demonstrate it, the case where an errback returns a deferred is symmetrical. Modify the <a href="http://github.com/jdavisp3/twisted-intro/blob/master/twisted-deferred/defer-10.py#L1"><tt>twisted-deferred/defer-10.py</tt></a> example to verify it.</li>
<li>Find the place in the <a href="http://twistedmatrix.com/trac/browser/tags/releases/twisted-8.2.0/twisted/internet/defer.py#L137">Deferred</a> implementation that handles the case where a callback/errback returns another Deferred.</li>
</ol>
<!-- JOLIPRINT BUTTON BEGINS --><script type="text/javascript">
&amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;lt;!--
try{
$joliprint().set('format','json').set('callback','joliprint_getPdf').set('service','wp-plugin').set('url','http://krondo.com/?p=2159').set('title','Print with Joliprint').set('urloptions','ver=1.1.5').set( 'label', 'joliprint' ).set( 'labelposition', 'after' ).set( 'button', 'joliprint-icon' ).write();
}catch(e){

}
--&amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;gt;</script><!-- JOLIPRINT BUTTON ENDS -->		<div class="fixed"></div>
			</div>
</div>


<div id="post-2205" class="post">
	
	

	<div class="content">
		<h2>Part 14: When a Deferred Isn't</h2>
<p>This continues the introduction started <a href="http://krondo.com/wp-content/uploads/2009/08/twisted-intro.html?p=1209">here</a>. You can find an index to the entire series <a href="http://krondo.com/wp-content/uploads/2009/08/twisted-intro.html?page_id=1327">here</a>.</p>
<h3>Introduction</h3>
<p>In this part we're going to learn another aspect of the <code>Deferred</code> class. To motivate the discussion, we'll add one more server to our stable of poetry-related services. Suppose we have a large number of internal clients who want to get poetry from the same external server. But this external server is slow and already over-burdened by the insatiable demand for poetry across the Internet. We don't want to contribute to that poor server's problems by sending all our clients there too.</p>
<p>So instead we'll make a caching proxy server. When a client connects to the proxy, the proxy will either fetch the poem from the external server or return a cached copy of a previously retrieved poem. Then we can point all our clients at the proxy and our contribution to the external server's load will be negligible. We illustrate this setup in Figure 30:</p>
<div style="width: 676px" class="wp-caption aligncenter" id="attachment_2216"><a href="img/proxy1.png"><img width="666" height="434" alt="Figure 30: a caching proxy server" src="img/proxy1.png" title="Figure 30: a caching proxy server" class="size-full wp-image-2216"></a><p class="wp-caption-text">Figure 30: a caching proxy server</p></div>
<p>Consider what happens when a client connects to the proxy to get a poem. If the proxy's cache is empty, the proxy must wait (asynchronously) for the external server to respond before sending a poem back. So far so good, we already know how to handle that situation with an asynchronous function that returns a deferred. On the other hand, if there's already a poem in the cache, the proxy can send it back immediately, no need to wait at all.&nbsp; So the proxy's internal mechanism for getting a poem will sometimes be asynchronous and sometimes synchronous.</p>
<p>So what do we do if we have a function that is only asynchronous some of the time? Twisted provides a couple of options, and they both depend on a feature of the <code>Deferred</code> class we haven't used yet: you can fire a deferred <em>before</em> you return it to the caller.</p>
<p>This works because, although you cannot fire a deferred twice, you can add callbacks and errbacks to a deferred after it has fired. And when you do so, the deferred simply continues firing the chain from where it last left off. One important thing to note is an already-fired deferred may fire the new callback (or errback, depending on the state of the deferred) immediately, i.e., right when you add it.</p>
<p>Consider Figure 31, showing a deferred that has been fired:</p>
<div style="width: 281px" class="wp-caption aligncenter" id="attachment_2268"><a href="img/deferred-13.png"><img width="271" height="281" alt="Figure 31: a deferred that has been fired" src="img/deferred-13.png" title="Figure 31: a deferred that has been fired" class="size-full wp-image-2268"></a><p class="wp-caption-text">Figure 31: a deferred that has been fired</p></div>
<p>If we were to add another callback/errback pair at this point, then the deferred would immediately fire the new callback, as in Figure 32:</p>
<div style="width: 281px" class="wp-caption aligncenter" id="attachment_2269"><a href="img/deferred-14.png"><img width="271" height="357" alt="Figure 32: the same deferred with a new callback" src="img/deferred-14.png" title="Figure 32: the same deferred with a new callback" class="size-full wp-image-2269"></a><p class="wp-caption-text">Figure 32: the same deferred with a new callback</p></div>
<p>The callback (not the errback) is fired because the previous callback succeeded. If it had failed (raised an Exception or returned a Failure) then the new errback would have been called instead.</p>
<p>We can test out this new feature with the example code in <a href="http://github.com/jdavisp3/twisted-intro/blob/master/twisted-deferred/defer-11.py#L1"><tt>twisted-deferred/defer-11.py</tt></a>. Read and run that script to see how a deferred behaves when you fire it and then add callbacks. Note how in the first example each new callback is invoked immediately (you can tell from the order of the <tt>print</tt> output).</p>
<p>The second example in that script shows how we can <a href="http://twistedmatrix.com/trac/browser/tags/releases/twisted-8.2.0/twisted/internet/defer.py#L272"><code>pause()</code></a> a deferred so it doesn't fire the callbacks right away. When we are ready for the callbacks to fire, we call <a href="http://twistedmatrix.com/trac/browser/tags/releases/twisted-8.2.0/twisted/internet/defer.py#L278"><code>unpause()</code></a>. That's actually the same mechanism the deferred uses to pause itself when one of its callbacks returns another deferred. Nifty!</p>
<h3>Proxy 1.0</h3>
<p>Now let's look at the first version of the poetry proxy in <a href="http://github.com/jdavisp3/twisted-intro/blob/master/twisted-server-1/poetry-proxy.py#L1"><tt>twisted-server-1/poetry-proxy.py</tt></a>. Since the proxy acts as both a client and a server, it has two pairs of Protocol/Factory classes, one for serving up poetry, and one for getting a poem from the external server. We won't bother looking at the code for the client pair, it's the same as in previous poetry clients.</p>
<p>But before we look at the server pair, we'll look at the <a href="http://github.com/jdavisp3/twisted-intro/blob/master/twisted-server-1/poetry-proxy.py#L100"><code>ProxyService</code></a>, which the server-side protocol uses to get a poem:</p>
<div><div class="syntaxhighlighter  py" id="highlighter_255213"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div><div class="line number20 index19 alt1">20</div><div class="line number21 index20 alt2">21</div><div class="line number22 index21 alt1">22</div><div class="line number23 index22 alt2">23</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py keyword">class</code> <code class="py plain">ProxyService(</code><code class="py functions">object</code><code class="py plain">):</code></div><div class="line number2 index1 alt1">&nbsp;</div><div class="line number3 index2 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">poem </code><code class="py keyword">=</code> <code class="py color1">None</code> <code class="py comments"># the cached poem</code></div><div class="line number4 index3 alt1">&nbsp;</div><div class="line number5 index4 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">def</code> <code class="py plain">__init__(</code><code class="py color1">self</code><code class="py plain">, host, port):</code></div><div class="line number6 index5 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py color1">self</code><code class="py plain">.host </code><code class="py keyword">=</code> <code class="py plain">host</code></div><div class="line number7 index6 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py color1">self</code><code class="py plain">.port </code><code class="py keyword">=</code> <code class="py plain">port</code></div><div class="line number8 index7 alt1">&nbsp;</div><div class="line number9 index8 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">def</code> <code class="py plain">get_poem(</code><code class="py color1">self</code><code class="py plain">):</code></div><div class="line number10 index9 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">if</code> <code class="py color1">self</code><code class="py plain">.poem </code><code class="py keyword">is</code> <code class="py keyword">not</code> <code class="py color1">None</code><code class="py plain">:</code></div><div class="line number11 index10 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py functions">print</code> <code class="py string">'Using cached poem.'</code></div><div class="line number12 index11 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">return</code> <code class="py color1">self</code><code class="py plain">.poem</code></div><div class="line number13 index12 alt2">&nbsp;</div><div class="line number14 index13 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py functions">print</code> <code class="py string">'Fetching poem from server.'</code></div><div class="line number15 index14 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">factory </code><code class="py keyword">=</code> <code class="py plain">PoetryClientFactory()</code></div><div class="line number16 index15 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">factory.deferred.addCallback(</code><code class="py color1">self</code><code class="py plain">.set_poem)</code></div><div class="line number17 index16 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">from</code> <code class="py plain">twisted.internet </code><code class="py keyword">import</code> <code class="py plain">reactor</code></div><div class="line number18 index17 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">reactor.connectTCP(</code><code class="py color1">self</code><code class="py plain">.host, </code><code class="py color1">self</code><code class="py plain">.port, factory)</code></div><div class="line number19 index18 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">return</code> <code class="py plain">factory.deferred</code></div><div class="line number20 index19 alt1">&nbsp;</div><div class="line number21 index20 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">def</code> <code class="py plain">set_poem(</code><code class="py color1">self</code><code class="py plain">, poem):</code></div><div class="line number22 index21 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py color1">self</code><code class="py plain">.poem </code><code class="py keyword">=</code> <code class="py plain">poem</code></div><div class="line number23 index22 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">return</code> <code class="py plain">poem</code></div></div></td></tr></tbody></table></div></div>
<p>The key method there is <code>get_poem</code>. If there's already a poem in the cache, that method just returns the poem itself. On the other hand, if we haven't got a poem yet, we initiate a connection to the external server and return a deferred that will fire when the poem comes back. So <code>get_poem</code> is a function that is only asynchronous some of the time.</p>
<p>How do you handle a function like that? Let's look at the server-side <a href="http://github.com/jdavisp3/twisted-intro/blob/master/twisted-server-1/poetry-proxy.py#L52">protocol/factory</a> pair:</p>
<div><div class="syntaxhighlighter  py" id="highlighter_798056"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py keyword">class</code> <code class="py plain">PoetryProxyProtocol(Protocol):</code></div><div class="line number2 index1 alt1">&nbsp;</div><div class="line number3 index2 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">def</code> <code class="py plain">connectionMade(</code><code class="py color1">self</code><code class="py plain">):</code></div><div class="line number4 index3 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">d </code><code class="py keyword">=</code> <code class="py plain">maybeDeferred(</code><code class="py color1">self</code><code class="py plain">.factory.service.get_poem)</code></div><div class="line number5 index4 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">d.addCallback(</code><code class="py color1">self</code><code class="py plain">.transport.write)</code></div><div class="line number6 index5 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">d.addBoth(</code><code class="py keyword">lambda</code> <code class="py plain">r: </code><code class="py color1">self</code><code class="py plain">.transport.loseConnection())</code></div><div class="line number7 index6 alt2">&nbsp;</div><div class="line number8 index7 alt1"><code class="py keyword">class</code> <code class="py plain">PoetryProxyFactory(ServerFactory):</code></div><div class="line number9 index8 alt2">&nbsp;</div><div class="line number10 index9 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">protocol </code><code class="py keyword">=</code> <code class="py plain">PoetryProxyProtocol</code></div><div class="line number11 index10 alt2">&nbsp;</div><div class="line number12 index11 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">def</code> <code class="py plain">__init__(</code><code class="py color1">self</code><code class="py plain">, service):</code></div><div class="line number13 index12 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py color1">self</code><code class="py plain">.service </code><code class="py keyword">=</code> <code class="py plain">service</code></div></div></td></tr></tbody></table></div></div>
<p>The factory is straightforward &mdash; it's just saving a reference to the proxy service so that protocol instances can call the <code>get_poem</code> method. The protocol is where the action is. Instead of calling <code>get_poem</code> directly, the protocol uses a wrapper function from the <code>twisted.internet.defer</code> module named <a href="http://twistedmatrix.com/trac/browser/tags/releases/twisted-8.2.0/twisted/internet/defer.py#L84"><code>maybeDeferred</code></a>.</p>
<p>The <code>maybeDeferred</code> function takes a reference to another function, plus some optional arguments to call that function with (we aren't using any here). Then <code>maybeDeferred</code> will actually call that function and:</p>
<ul>
<li>If the function returns a deferred, <code>maybeDeferred</code> returns that same deferred, or</li>
<li>If the function returns a Failure, <code>maybeDeferred</code> returns a new deferred that has been fired (via <code>.errback</code>) with that Failure, or</li>
<li>If the function returns a regular value, <code>maybeDeferred</code> returns a deferred that has already been fired with that value as the result, or</li>
<li>If the function raises an exception, <code>maybeDeferred</code> returns a deferred that has already been fired (via <code>.errback()</code>) with that exception wrapped in a Failure.</li>
</ul>
<p>In other words, the return value from <code>maybeDeferred</code> is guaranteed to be a deferred, even if the function you pass in never returns a deferred at all. This allows us to safely call a synchronous function (even one that fails with an exception) and treat it like an asynchronous function returning a deferred.</p>
<p style="padding-left: 30px;">Note 1: There will still be a subtle difference, though. A deferred returned by a synchronous function has already been fired, so any callbacks or errbacks you add will run immediately, rather than in some future iteration of the reactor loop.</p>
<p style="padding-left: 30px;">Note 2: In hindsight, perhaps naming a function that always returns a deferred "maybeDeferred" was not the best choice, but there you go.</p>
<p>Once the protocol has a real deferred in hand, it can just add some callbacks that send the poem to the client and then close the connection. And that's it for our first poetry proxy!</p>
<h3>Running the Proxy</h3>
<p>To try out the proxy, start up a poetry server, like this:</p>
<pre>python twisted-server-1/fastpoetry.py --port 10001 poetry/fascination.txt</pre>
<p>And now start a proxy server like this:</p>
<pre>python twisted-server-1/poetry-proxy.py --port 10000 10001</pre>
<p>It should tell you that it's proxying poetry on port 10000 for the server on port 10001.<br>
Now you can point a client at the proxy:</p>
<pre>python twisted-client-4/get-poetry.py 10000</pre>
<p>We'll use an earlier version of the client that isn't concerned with poetry transformations. You should see the poem appear in the client window and some text in the proxy window saying it's fetching the poem from the server. Now run the client again and the proxy should confirm it is using the cached version of the poem, while the client should show the same poem as before.</p>
<h3>Proxy 2.0</h3>
<p>As we mentioned earlier, there's an alternative way to implement this scheme. This is illustrated in Poetry Proxy 2.0, located in <a href="http://github.com/jdavisp3/twisted-intro/blob/master/twisted-server-2/poetry-proxy.py#L1"><tt>twisted-server-2/poetry-proxy.py</tt></a>. Since we can fire deferreds before we return them, we can make the proxy service return an already-fired deferred when there's already a poem in the cache. Here's the new version of the <a href="http://github.com/jdavisp3/twisted-intro/blob/master/twisted-server-2/poetry-proxy.py#L108"><code>get_poem</code></a> method on the proxy service:</p>
<div><div class="syntaxhighlighter  py" id="highlighter_877856"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py keyword">def</code> <code class="py plain">get_poem(</code><code class="py color1">self</code><code class="py plain">):</code></div><div class="line number2 index1 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">if</code> <code class="py color1">self</code><code class="py plain">.poem </code><code class="py keyword">is</code> <code class="py keyword">not</code> <code class="py color1">None</code><code class="py plain">:</code></div><div class="line number3 index2 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py functions">print</code> <code class="py string">'Using cached poem.'</code></div><div class="line number4 index3 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py comments"># return an already-fired deferred</code></div><div class="line number5 index4 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">return</code> <code class="py plain">succeed(</code><code class="py color1">self</code><code class="py plain">.poem)</code></div><div class="line number6 index5 alt1">&nbsp;</div><div class="line number7 index6 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py functions">print</code> <code class="py string">'Fetching poem from server.'</code></div><div class="line number8 index7 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">factory </code><code class="py keyword">=</code> <code class="py plain">PoetryClientFactory()</code></div><div class="line number9 index8 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">factory.deferred.addCallback(</code><code class="py color1">self</code><code class="py plain">.set_poem)</code></div><div class="line number10 index9 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">from</code> <code class="py plain">twisted.internet </code><code class="py keyword">import</code> <code class="py plain">reactor</code></div><div class="line number11 index10 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">reactor.connectTCP(</code><code class="py color1">self</code><code class="py plain">.host, </code><code class="py color1">self</code><code class="py plain">.port, factory)</code></div><div class="line number12 index11 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">return</code> <code class="py plain">factory.deferred</code></div></div></td></tr></tbody></table></div></div>
<p>The <a href="http://twistedmatrix.com/trac/browser/tags/releases/twisted-8.2.0/twisted/internet/defer.py#L30"><code>defer.succeed</code></a> function is just a handy way to make an already-fired deferred given a result. Read the implementation for that function and you'll see it's simply a matter of making a new deferred and then firing it with <code>.callback()</code>. If we wanted to return an already-failed deferred we could use <a href="http://twistedmatrix.com/trac/browser/tags/releases/twisted-8.2.0/twisted/internet/defer.py#L52"><code>defer.fail</code></a> instead.</p>
<p>In this version, since <code>get_poem</code> always returns a deferred, the <a href="http://github.com/jdavisp3/twisted-intro/blob/master/twisted-server-2/poetry-proxy.py#L52">protocol class</a> no longer needs to use <code>maybeDeferred</code> (though it would still work if it did, as we learned above):</p>
<div><div class="syntaxhighlighter  py" id="highlighter_476378"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py keyword">class</code> <code class="py plain">PoetryProxyProtocol(Protocol):</code></div><div class="line number2 index1 alt1">&nbsp;</div><div class="line number3 index2 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">def</code> <code class="py plain">connectionMade(</code><code class="py color1">self</code><code class="py plain">):</code></div><div class="line number4 index3 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">d </code><code class="py keyword">=</code> <code class="py color1">self</code><code class="py plain">.factory.service.get_poem()</code></div><div class="line number5 index4 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">d.addCallback(</code><code class="py color1">self</code><code class="py plain">.transport.write)</code></div><div class="line number6 index5 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">d.addBoth(</code><code class="py keyword">lambda</code> <code class="py plain">r: </code><code class="py color1">self</code><code class="py plain">.transport.loseConnection())</code></div></div></td></tr></tbody></table></div></div>
<p>Other than these two changes, the second version of the proxy is just like the first, and you can run it in the same way we ran the original version.</p>
<h3>Summary</h3>
<p>In this Part we learned how deferreds can be fired before they are returned, and thus we can use them in synchronous (or sometimes synchronous) code. And we have two ways to do that:</p>
<ul>
<li>We can use <code>maybeDeferred</code> to handle a function that sometimes returns a deferred and other times returns a regular value (or throws an exception), or</li>
<li>We can pre-fire our own deferreds, using <code>defer.succeed</code> and <code>defer.fail</code>, so our "semi-synchronous" functions always return a deferred no matter what.</li>
</ul>
<p>Which technique we choose is really up to us. The former emphasizes the fact that our functions aren't always asynchronous while the latter makes the client code simpler. Perhaps there's not a definitive argument for choosing one over the other.</p>
<p>Both techniques are made possible because we can add callbacks and errbacks to a deferred after it has fired. And that explains the curious fact we discovered in <a href="http://krondo.com/wp-content/uploads/2009/08/twisted-intro.html?p=1825">Part 9</a> and the <a href="http://github.com/jdavisp3/twisted-intro/blob/master/twisted-deferred/defer-unhandled.py#L1"><tt>twisted-deferred/defer-unhandled.py</tt></a> example. We learned that an "unhandled error" in a deferred, in which either the last callback or errback fails, isn't reported until the deferred is garbage collected (i.e., there are no more references to it in user code). Now we know why &mdash; since we could always add another callback pair to a deferred which does handle that error, it's not until the last reference to a deferred is dropped that Twisted can say the error was not handled.</p>
<p style="padding-left: 30px;">Now that you've spent so much time exploring the <code>Deferred</code> class, which is located in the <code>twisted.internet</code> package, you may have noticed it doesn't actually have anything to do with the Internet. It's just an abstraction for managing callbacks. So what's it doing there? That is an artifact of Twisted's history. In the best of all possible worlds (where I am paid millions of dollars to play in the World Ultimate Frisbee League), the <code>defer</code> module would probably be in <code>twisted.python</code>. Of course, in that world you would probably be too busy fighting crime with your super-powers to read this introduction. I suppose <a href="http://www.youtube.com/watch?v=KIiUqfxFttM">that's life</a>.</p>
<p>So is that it for deferreds? Do we finally know all their features? For the most part, we do. But Twisted includes alternate ways of using deferreds that we haven't explored yet (we'll get there!). And in the meantime, the Twisted developers have been beavering away adding new stuff. In an upcoming release, the <code>Deferred</code> class will acquire a brand new capability. We'll introduce it in a future Part, but first we'll take a break from deferreds and look at some other aspects of Twisted, including testing in <a href="http://krondo.com/wp-content/uploads/2009/08/twisted-intro.html?p=2273">Part 15</a>.</p>
<h3>Suggested Exercises</h3>
<ol>
<li>Modify the <a href="http://github.com/jdavisp3/twisted-intro/blob/master/twisted-deferred/defer-11.py#L1"><tt>twisted-deferred/defer-11.py</tt></a> example to illustrate pre-failing deferreds using <code>.errback()</code>. Read the documentation and implementation of the <a href="http://twistedmatrix.com/trac/browser/tags/releases/twisted-8.2.0/twisted/internet/defer.py#L52"><code>defer.fail</code></a> function.</li>
<li>Modify the proxy so that a cached poem older than 2 hours is discarded, causing the next poetry request to re-request it from the server</li>
<li>The proxy is supposed to avoid contacting the server more than once, but if several client requests come in at the same time when there is no poem in the cache, the proxy will make multiple poetry requests. It's easier to see if you use a slow server to test it out.
<p>Modify the proxy service so that only one request is generated. Right now the service only has two states: either the poem is in the cache or it isn't. You will need to recognize a third state indicating a request has been made but not completed. When the <code>get_poem</code> method is called in the third state, add a new deferred to a list of 'waiters'. That new deferred will be the result of the <code>get_poem</code> method. When the poem finally comes back, fire all the waiting deferreds with the poem and transition to the cached state. On the other hand, if the poem fails, fire the <code>.errback()</code> method of all the waiters and transition to the non-cached state.</p></li>
<li>Add a transformation proxy to the proxy service. This service should work like the original transformation service, but use an external server to do the transformations.</li>
<li>Consider this hypothetical piece of code:
<div><div class="syntaxhighlighter  py" id="highlighter_108775"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py plain">d </code><code class="py keyword">=</code> <code class="py plain">some_async_function() </code><code class="py comments"># d is a Deferred</code></div><div class="line number2 index1 alt1"><code class="py plain">d.addCallback(my_callback)</code></div><div class="line number3 index2 alt2"><code class="py plain">d.addCallback(my_other_callback)</code></div><div class="line number4 index3 alt1"><code class="py plain">d.addErrback(my_errback)</code></div></div></td></tr></tbody></table></div></div>
<p>Suppose that when the deferred <code>d</code> is returned on line 1, it has not been fired. Is it possible for that deferred<br>
to fire while we are adding our callbacks and errback on lines 2-4? Why or why not?</p></li>
</ol>
<!-- JOLIPRINT BUTTON BEGINS --><script type="text/javascript">
&amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;lt;!--
try{
$joliprint().set('format','json').set('callback','joliprint_getPdf').set('service','wp-plugin').set('url','http://krondo.com/?p=2205').set('title','Print with Joliprint').set('urloptions','ver=1.1.5').set( 'label', 'joliprint' ).set( 'labelposition', 'after' ).set( 'button', 'joliprint-icon' ).write();
}catch(e){

}
--&amp;amp;amp;amp;amp;amp;amp;amp;amp;amp;gt;</script><!-- JOLIPRINT BUTTON ENDS -->		<div class="fixed"></div>
			</div>
</div>

<div class="post" id="post-2273">
	
	

	<div class="content">
		<h2>Part 15: Tested Poetry</h2>
<p>This continues the introduction started <a href="http://krondo.com/wp-content/uploads/2009/08/twisted-intro.html?p=1209">here</a>. You can find an index to the entire series <a href="http://krondo.com/wp-content/uploads/2009/08/twisted-intro.html?page_id=1327">here</a>.</p>
<h3>Introduction</h3>
<p>We've written a lot of code in our exploration of Twisted, but so far we've neglected to write something important &mdash; tests. And you may be wondering how you can test asynchronous code using a synchronous framework like the <a href="http://docs.python.org/library/unittest.html#module-unittest"><code>unittest</code></a> package that comes with Python. The short answer is you can't. As we've discovered, synchronous and asynchronous code do not mix, at least not readily.</p>
<p>Fortunately, Twisted includes its own testing framework called <a href="http://twistedmatrix.com/documents/current/core/howto/testing.html"><code>trial</code></a> that does support testing asynchronous code (and you can use it to test synchronous code, too).</p>
<p>We'll assume you are already familiar with the basic mechanics of <a href="http://docs.python.org/library/unittest.html#module-unittest"><code>unittest</code></a> and similar testing frameworks, in which you create tests by defining a class with a specific parent class (usually called something like <code>TestCase</code>), and each method of that class starting with the word "<code>test</code>" is considered a single test. The framework takes care of discovering all the tests, running them one after the other with optional&nbsp;<code>setUp</code> and <code>tearDown</code> steps, and then reporting the results.</p>
<h3>The Example</h3>
<p>You will find some example tests located in <a href="http://github.com/jdavisp3/twisted-intro/blob/master/tests/test_poetry.py#L1"><tt>tests/test_poetry.py</tt></a>. To ensure all our examples are self-contained (so you don't need to worry about <tt>PYTHONPATH</tt> settings), we have copied all the necessary code into the test module. Normally, of course, you would just import the modules you wanted to test.</p>
<p>The example is testing both the poetry client and server, by using the client to fetch a poem from a test server. To provide a poetry server for testing, we implement the <a href="http://github.com/jdavisp3/twisted-intro/blob/master/tests/test_poetry.py#L70"><code>setUp</code></a> method in our test case:</p>
<div><div id="highlighter_302459" class="syntaxhighlighter  py"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py keyword">class</code> <code class="py plain">PoetryTestCase(TestCase):</code></div><div class="line number2 index1 alt1">&nbsp;</div><div class="line number3 index2 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">def</code> <code class="py plain">setUp(</code><code class="py color1">self</code><code class="py plain">):</code></div><div class="line number4 index3 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">factory </code><code class="py keyword">=</code> <code class="py plain">PoetryServerFactory(TEST_POEM)</code></div><div class="line number5 index4 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">from</code> <code class="py plain">twisted.internet </code><code class="py keyword">import</code> <code class="py plain">reactor</code></div><div class="line number6 index5 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py color1">self</code><code class="py plain">.port </code><code class="py keyword">=</code> <code class="py plain">reactor.listenTCP(</code><code class="py value">0</code><code class="py plain">, factory, interface</code><code class="py keyword">=</code><code class="py string">"127.0.0.1"</code><code class="py plain">)</code></div><div class="line number7 index6 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py color1">self</code><code class="py plain">.portnum </code><code class="py keyword">=</code> <code class="py color1">self</code><code class="py plain">.port.getHost().port</code></div></div></td></tr></tbody></table></div></div>
<p>The <code>setUp</code> method makes a poetry server with a test poem, and listens on a random, open port. We save the port number so the actual tests can use it, if they need to. And, of course, we clean up the test server in <a href="http://github.com/jdavisp3/twisted-intro/blob/master/tests/test_poetry.py#L76"><code>tearDown</code></a> when the test is done:</p>
<div><div id="highlighter_428081" class="syntaxhighlighter  py"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py keyword">def</code> <code class="py plain">tearDown(</code><code class="py color1">self</code><code class="py plain">):</code></div><div class="line number2 index1 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">port, </code><code class="py color1">self</code><code class="py plain">.port </code><code class="py keyword">=</code> <code class="py color1">self</code><code class="py plain">.port, </code><code class="py color1">None</code></div><div class="line number3 index2 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">return</code> <code class="py plain">port.stopListening()</code></div></div></td></tr></tbody></table></div></div>
<p>That brings us to our first test, <a href="http://github.com/jdavisp3/twisted-intro/blob/master/tests/test_poetry.py#L80"><code>test_client</code></a>, where we use <code>get_poetry</code> to retrieve the poem from the test server and verify it's the poem we expected:</p>
<div><div id="highlighter_977518" class="syntaxhighlighter  py"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py keyword">def</code> <code class="py plain">test_client(</code><code class="py color1">self</code><code class="py plain">):</code></div><div class="line number2 index1 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py comments">"""The correct poem is returned by get_poetry."""</code></div><div class="line number3 index2 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">d </code><code class="py keyword">=</code> <code class="py plain">get_poetry(</code><code class="py string">'127.0.0.1'</code><code class="py plain">, </code><code class="py color1">self</code><code class="py plain">.portnum)</code></div><div class="line number4 index3 alt1">&nbsp;</div><div class="line number5 index4 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">def</code> <code class="py plain">got_poem(poem):</code></div><div class="line number6 index5 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py color1">self</code><code class="py plain">.assertEquals(poem, TEST_POEM)</code></div><div class="line number7 index6 alt2">&nbsp;</div><div class="line number8 index7 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">d.addCallback(got_poem)</code></div><div class="line number9 index8 alt2">&nbsp;</div><div class="line number10 index9 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">return</code> <code class="py plain">d</code></div></div></td></tr></tbody></table></div></div>
<p>Notice that our test function is returning a deferred. Under <tt>trial</tt>, each test method runs as a callback. That means the reactor is running and we can perform asynchronous operations as part of the test. We just need to let the framework know that our test is asynchronous and we do that in the usual Twisted way &mdash; return a deferred.</p>
<p>The <tt>trial</tt> framework will wait until the deferred fires before calling the <code>tearDown</code> method, and will fail the test if the deferred fails (i.e., if the last callback/errback pair fails). It will also fail the test if our deferred takes too long to fire, two minutes by default. And that means if the test finished, we know our deferred fired, and therefore our callback fired and ran the <code>assertEquals</code> test method.</p>
<p>Our second test, <a href="http://github.com/jdavisp3/twisted-intro/blob/master/tests/test_poetry.py#L91"><code>test_failure</code></a>, verifies that <code>get_poetry</code> fails in the appropriate way if we can't connect to the server:</p>
<div><div id="highlighter_970308" class="syntaxhighlighter  py"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py keyword">def</code> <code class="py plain">test_failure(</code><code class="py color1">self</code><code class="py plain">):</code></div><div class="line number2 index1 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py comments">"""The correct failure is returned by get_poetry when</code></div><div class="line number3 index2 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py comments">connecting to a port with no server."""</code></div><div class="line number4 index3 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">d </code><code class="py keyword">=</code> <code class="py plain">get_poetry(</code><code class="py string">'127.0.0.1'</code><code class="py plain">, </code><code class="py keyword">-</code><code class="py value">1</code><code class="py plain">)</code></div><div class="line number5 index4 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">return</code> <code class="py color1">self</code><code class="py plain">.assertFailure(d, ConnectionRefusedError)</code></div></div></td></tr></tbody></table></div></div>
<p>Here we attempt to connect to an invalid port and then use the <tt>trial</tt>-provided <code>assertFailure</code> method. This method is like the familiar <code>assertRaises</code> method but for asynchronous code. It returns a deferred that succeeds if the given deferred fails with the given exception, and fails otherwise.</p>
<p>You can run the tests yourself using the <tt>trial</tt> script like this:</p>
<pre>trial tests/test_poetry.py</pre>
<p>And you should see some output showing each test case and an <tt>OK</tt> telling you each test passed.</p>
<h3>Discussion</h3>
<p>Because <code>trial</code> is so similar to <code>unittest</code> when it comes to the basic API, it's pretty easy to get started writing tests. Just return a deferred if your test uses asynchronous code, and <code>trial</code> will take care of the rest. You can also return a deferred from the <code>setUp</code> and <code>tearDown</code> methods, if those need to be asynchronous as well.</p>
<p>Any log messages from your tests will be collected in a file inside a directory called <tt>_trial_temp</tt> that <tt>trial</tt> will create automatically if it doesn't exist. In addition to the errors printed to the screen, the log is a useful starting point when debugging failing tests.</p>
<p>Figure 33 shows a hypothetical test run in progress:<br>
</p><div id="attachment_2323" class="wp-caption aligncenter" style="width: 594px"><a href="img/test-1.png"><img width="584" height="464" src="img/test-1.png" alt="Figure 33: a trial test in progress" title="Figure 33: a trial test in progress" class="size-full wp-image-2323"></a><p class="wp-caption-text">Figure 33: a trial test in progress</p></div><p></p>
<p>If you've used similar frameworks before, this should be a familiar model, except that all the test-related methods may return deferreds.</p>
<p>The <tt>trial</tt> framework is also a good illustration of how "going asynchronous" involves changes that cascade throughout the program. In order for a test (or any function or method) to be asynchronous, it must:</p>
<ol>
<li>Not block and, usually,</li>
<li>return a deferred.</li>
</ol>
<p>But that means that whatever calls that function must be willing to accept a deferred, and also not block (and thus likely return a deferred as well). And so it goes up and up. Thus, the need for a framework like <tt>trial</tt> which can handle asynchronous tests that return deferreds.</p>
<h3>Summary</h3>
<p>That's it for our look at unit testing. If would like to see more examples of how to write unit tests for Twisted code, you need look no further than Twisted itself. The Twisted framework comes with a very large suite of unit tests, with new ones added in each release. Since these tests are scrutinized by Twisted experts during code reviews before being accepted into the codebase, they make excellent examples of how to test Twisted code the right way.</p>
<p>In <a href="http://krondo.com/wp-content/uploads/2009/08/twisted-intro.html?p=2345">Part 16</a> we will use a Twisted utility to turn our poetry server into a genuine daemon.</p>
<h3>Suggested Exercises</h3>
<ol>
<li>Change one of the tests to make it fail and run <code>trial</code> again to see the output.</li>
<li>Read the online <a href="http://twistedmatrix.com/documents/current/core/howto/testing.html">trial documentation</a>.</li>
<li>Write tests for some of the other poetry services we have created in this series.</li>
<li>Explore <a href="http://twistedmatrix.com/trac/browser/trunk/twisted/test">some of the tests</a> in Twisted.</li>
</ol>
<!-- JOLIPRINT BUTTON BEGINS --><script type="text/javascript">
&amp;amp;amp;amp;amp;amp;amp;amp;amp;lt;!--
try{
$joliprint().set('format','json').set('callback','joliprint_getPdf').set('service','wp-plugin').set('url','http://krondo.com/?p=2273').set('title','Print with Joliprint').set('urloptions','ver=1.1.5').set( 'label', 'joliprint' ).set( 'labelposition', 'after' ).set( 'button', 'joliprint-icon' ).write();
}catch(e){

}
--&amp;amp;amp;amp;amp;amp;amp;amp;amp;gt;</script><!-- JOLIPRINT BUTTON ENDS -->		<div class="fixed"></div>
			</div>
</div>


<div id="post-2345" class="post">
	
	

	<div class="content">
		<h2>Part 16: Twisted Daemonologie</h2>
<p>This continues the introduction started <a href="http://krondo.com/wp-content/uploads/2009/08/twisted-intro.html?p=1209">here</a>. You can find an index to the entire series <a href="http://krondo.com/wp-content/uploads/2009/08/twisted-intro.html?page_id=1327">here</a>.</p>
<h3>Introduction</h3>
<p>The servers we have written so far have just run in a terminal window, with output going to the screen via <code>print</code> statements. This works alright for development, but it's hardly a way to deploy services in production. A well-behaved production server ought to:</p>
<ol>
<li>Run as a <a href="http://en.wikipedia.org/wiki/Daemon_%28computer_software%29">daemon</a> process, unconnected with any terminal or user session. You don't want a service to shut down just because the administrator logs out.</li>
<li>Send debugging and error output to a set of rotated log files, or to the <a href="http://en.wikipedia.org/wiki/Syslog"><tt>syslog</tt></a> service.</li>
<li>Drop excessive privileges, e.g., switching to a lower-privileged user before running.</li>
<li>Record its <a href="http://en.wikipedia.org/wiki/Process_ID"><tt>pid</tt></a> in a file so that the administrator can easily <a href="http://en.wikipedia.org/wiki/Kill%28%29">send signals</a> to the daemon.</li>
</ol>
<p>We can get all of those features using the <tt>twistd</tt> script provided by Twisted. But first we'll have to change our code a bit.</p>
<h3>The Concepts</h3>
<p>Understanding <tt>twistd</tt> will require learning a few new concepts in Twisted, the most important being a <code>Service</code>. As usual, several of the new concepts are accompanied by new <code>Interface</code>s.</p>
<h4>IService</h4>
<p>The <a href="http://twistedmatrix.com/trac/browser/tags/releases/twisted-10.0.0/twisted/application/service.py#L87"><code>IService</code></a> interface defines a named service that can be started and stopped. What does the service do? Whatever you like &mdash; rather than define the specific function of the service, the interface requires only that it provide a small set of generic attributes and methods.</p>
<p>There are two required attributes: <code>name</code> and <code>running</code>. The <code>name</code> attribute is just a string, like <code>'fastpoetry'</code>, or <code>None</code> if you don't want to give your service a name. The <code>running</code> attribute is a Boolean value and is true if the service has been successfully started.</p>
<p>We're only going to touch on some of the methods of <code>IService</code>. We'll skip some that are obvious, and others that are more advanced and often go unused in simpler Twisted programs. The two principle methods of <code>IService</code> are <a href="http://twistedmatrix.com/trac/browser/tags/releases/twisted-10.0.0/twisted/application/service.py#L130"><code>startService</code></a> and <a href="http://twistedmatrix.com/trac/browser/tags/releases/twisted-10.0.0/twisted/application/service.py#L135"><code>stopService</code></a>:</p>
<div><div class="syntaxhighlighter  py" id="highlighter_119509"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py keyword">def</code> <code class="py plain">startService():</code></div><div class="line number2 index1 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py comments">"""</code></div><div class="line number3 index2 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py comments">Start the service.</code></div><div class="line number4 index3 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py comments">"""</code></div><div class="line number5 index4 alt2">&nbsp;</div><div class="line number6 index5 alt1"><code class="py keyword">def</code> <code class="py plain">stopService():</code></div><div class="line number7 index6 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py comments">"""</code></div><div class="line number8 index7 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py comments">Stop the service.</code></div><div class="line number9 index8 alt2">&nbsp;</div><div class="line number10 index9 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py comments">@rtype: L{Deferred}</code></div><div class="line number11 index10 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py comments">@return: a L{Deferred} which is triggered when the service has</code></div><div class="line number12 index11 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py comments">finished shutting down. If shutting down is immediate, a</code></div><div class="line number13 index12 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py comments">value can be returned (usually, C{None}).</code></div><div class="line number14 index13 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py comments">"""</code></div></div></td></tr></tbody></table></div></div>
<p>Again, what these methods actually do will depend on the service in question. For example, the <code>startService</code> method might:</p>
<ul>
<li>Load some configuration data, or</li>
<li>Initialize a database, or</li>
<li>Start listening on a port, or</li>
<li>Do nothing at all.</li>
</ul>
<p>And the <code>stopService</code> method might:</p>
<ul>
<li>Persist some state, or</li>
<li>Close open database connections, or</li>
<li>Stop listening on a port, or</li>
<li>Do nothing at all.</li>
</ul>
<p>When we write our own custom services we'll need to implement these methods appropriately. For some common behaviors, like listening on a port, Twisted provides ready-made services we can use instead.</p>
<p>Notice that <code>stopService</code> may optionally return a deferred, which is required to fire when the service has completely shut down. This allows our services to finish cleaning up after themselves before the entire application terminates. If your service shuts down immediately you can just return <code>None</code> instead of a deferred.</p>
<p>Services can be organized into collections that get started and stopped together. The last <code>IService</code> method we're going to look at, <a href="http://twistedmatrix.com/trac/browser/tags/releases/twisted-10.0.0/twisted/application/service.py#L107"><code>setServiceParent</code></a>, adds a Service to a collection:</p>
<div><div class="syntaxhighlighter  py" id="highlighter_241378"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py keyword">def</code> <code class="py plain">setServiceParent(parent):</code></div><div class="line number2 index1 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py comments">"""</code></div><div class="line number3 index2 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py comments">Set the parent of the service.</code></div><div class="line number4 index3 alt1">&nbsp;</div><div class="line number5 index4 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py comments">@type parent: L{IServiceCollection}</code></div><div class="line number6 index5 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py comments">@raise RuntimeError: Raised if the service already has a parent</code></div><div class="line number7 index6 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py comments">or if the service has a name and the parent already has a child</code></div><div class="line number8 index7 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py comments">by that name.</code></div><div class="line number9 index8 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py comments">"""</code></div></div></td></tr></tbody></table></div></div>
<p>Any service can have a parent, which means services can be organized in a hierarchy. And that brings us to the next <code>Interface</code> we're going to look at today.</p>
<h4>IServiceCollection</h4>
<p>The <a href="http://twistedmatrix.com/trac/browser/tags/releases/twisted-10.0.0/twisted/application/service.py#L203"><code>IServiceCollection</code></a> interface defines an object which can contain <code>IService</code> objects. A service collection is a just plain container class with methods to:</p>
<ul>
<li>Look up a service by name (<a href="http://twistedmatrix.com/trac/browser/tags/releases/twisted-10.0.0/twisted/application/service.py#L212"><code>getServiceNamed</code></a>)</li>
<li>Iterate over the services in the collection (<a href="http://twistedmatrix.com/trac/browser/tags/releases/twisted-10.0.0/twisted/application/service.py#L222"><code>__iter__</code></a>)</li>
<li>Add a service to the collection (<a href="http://twistedmatrix.com/trac/browser/tags/releases/twisted-10.0.0/twisted/application/service.py#L227"><code>addService</code></a>)</li>
<li>Remove a service from the collection (<a href="http://twistedmatrix.com/trac/browser/tags/releases/twisted-10.0.0/twisted/application/service.py#L236"><code>removeService</code></a>)</li>
</ul>
<p>Note that an implementation of <code>IServiceCollection</code> isn't automatically an implementation of <code>IService</code>, but there's no reason why one class can't implement both interfaces (and we'll see an example of that shortly).</p>
<h4>Application</h4>
<p>A Twisted <code>Application</code> is not defined by a separate interface. Rather, an <code>Application</code> object is required to implement both <code>IService</code> and <code>IServiceCollection</code>, as well as a few other interfaces we aren't going to cover.</p>
<p>An <code>Application</code> is the top-level service that represents your entire Twisted application. All the other services in your daemon will be children (or grandchildren, etc.) of the <code>Application</code> object.</p>
<p>It is rare to actually implement your own <code>Application</code>. Twisted provides an implementation that we'll use today.</p>
<h4>Twisted Logging</h4>
<p>Twisted includes its own logging infrastructure in the module <a href="http://twistedmatrix.com/trac/browser/tags/releases/twisted-10.0.0/twisted/python/log.py"><code>twisted.python.log</code></a>. The basic API for writing to the log is simple, so we'll just include a short example located in <tt>basic-twisted/log.py</tt>, and you can skim the Twisted module for details if you are interested.</p>
<p>We won't bother showing the API for installing logging handlers, since <code>twistd</code> will do that for us.</p>
<h3>FastPoetry 2.0</h3>
<p>Alright, let's look at some code. We've updated the fast poetry server to run with <tt>twistd</tt>. The source is located in <a href="http://github.com/jdavisp3/twisted-intro/blob/master/twisted-server-3/fastpoetry.py#L1"><tt>twisted-server-3/fastpoetry.py</tt></a>. First we have the <a href="http://github.com/jdavisp3/twisted-intro/blob/master/twisted-server-3/fastpoetry.py#L9">poetry protocol</a>:</p>
<div><div class="syntaxhighlighter  py" id="highlighter_567070"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py keyword">class</code> <code class="py plain">PoetryProtocol(Protocol):</code></div><div class="line number2 index1 alt1">&nbsp;</div><div class="line number3 index2 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">def</code> <code class="py plain">connectionMade(</code><code class="py color1">self</code><code class="py plain">):</code></div><div class="line number4 index3 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">poem </code><code class="py keyword">=</code> <code class="py color1">self</code><code class="py plain">.factory.service.poem</code></div><div class="line number5 index4 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">log.msg(</code><code class="py string">'sending %d bytes of poetry to %s'</code></div><div class="line number6 index5 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">%</code> <code class="py plain">(</code><code class="py functions">len</code><code class="py plain">(poem), </code><code class="py color1">self</code><code class="py plain">.transport.getPeer()))</code></div><div class="line number7 index6 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py color1">self</code><code class="py plain">.transport.write(poem)</code></div><div class="line number8 index7 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py color1">self</code><code class="py plain">.transport.loseConnection()</code></div></div></td></tr></tbody></table></div></div>
<p>Notice instead of using a <code>print</code> statement, we're using the <code>twisted.python.log.msg</code> function to record each new connection.<br>
Here's the <a href="http://github.com/jdavisp3/twisted-intro/blob/master/twisted-server-3/fastpoetry.py#L19">factory class</a>:</p>
<div><div class="syntaxhighlighter  py" id="highlighter_824542"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py keyword">class</code> <code class="py plain">PoetryFactory(ServerFactory):</code></div><div class="line number2 index1 alt1">&nbsp;</div><div class="line number3 index2 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">protocol </code><code class="py keyword">=</code> <code class="py plain">PoetryProtocol</code></div><div class="line number4 index3 alt1">&nbsp;</div><div class="line number5 index4 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">def</code> <code class="py plain">__init__(</code><code class="py color1">self</code><code class="py plain">, service):</code></div><div class="line number6 index5 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py color1">self</code><code class="py plain">.service </code><code class="py keyword">=</code> <code class="py plain">service</code></div></div></td></tr></tbody></table></div></div>
<p>As you can see, the poem is no longer stored on the factory, but on a service object referenced by the factory. Notice how the protocol gets the poem from the service via the factory. Finally, here's the <a href="http://github.com/jdavisp3/twisted-intro/blob/master/twisted-server-3/fastpoetry.py#L27">service class itself</a>:</p>
<div><div class="syntaxhighlighter  py" id="highlighter_103823"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py keyword">class</code> <code class="py plain">PoetryService(service.Service):</code></div><div class="line number2 index1 alt1">&nbsp;</div><div class="line number3 index2 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">def</code> <code class="py plain">__init__(</code><code class="py color1">self</code><code class="py plain">, poetry_file):</code></div><div class="line number4 index3 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py color1">self</code><code class="py plain">.poetry_file </code><code class="py keyword">=</code> <code class="py plain">poetry_file</code></div><div class="line number5 index4 alt2">&nbsp;</div><div class="line number6 index5 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">def</code> <code class="py plain">startService(</code><code class="py color1">self</code><code class="py plain">):</code></div><div class="line number7 index6 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">service.Service.startService(</code><code class="py color1">self</code><code class="py plain">)</code></div><div class="line number8 index7 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py color1">self</code><code class="py plain">.poem </code><code class="py keyword">=</code> <code class="py functions">open</code><code class="py plain">(</code><code class="py color1">self</code><code class="py plain">.poetry_file).read()</code></div><div class="line number9 index8 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">log.msg(</code><code class="py string">'loaded a poem from: %s'</code> <code class="py keyword">%</code> <code class="py plain">(</code><code class="py color1">self</code><code class="py plain">.poetry_file,))</code></div></div></td></tr></tbody></table></div></div>
<p>As with many other <code>Interface</code> classes, Twisted provides a base class we can use to make our own implementations, with helpful default behaviors. Here we use the <a href="http://twistedmatrix.com/trac/browser/tags/releases/twisted-10.0.0/twisted/application/service.py#L154"><code>twisted.application.service.Service</code></a> class to implement our <code>PoetryService</code>.</p>
<p>The base class provides default implementations of all required methods, so we only need to implement the ones with custom behavior. In this case, we just override <code>startService</code> to load the poetry file. Note we still call the base class method (which sets the <code>running</code> attribute for us).</p>
<p>Another point is worth mentioning. The <code>PoetryService</code> object doesn't know anything about the details of the <code>PoetryProtocol</code>. The service's only job is to load the poem and provide access to it for any object that might need it. In other words, the <code>PoetryService</code> is entirely concerned with the higher-level details of providing poetry, rather than the lower-level details of sending a poem down a TCP connection. So this same service could be used by another protocol, say UDP or XML-RPC. While the benefit is rather small for our simple service, you can imagine the advantage for a more realistic service implementation.</p>
<p>If this were a typical Twisted program, all the code we've looked at so far wouldn't actually be in this file. Rather, it would be in some other module(s) (perhaps <code>fastpoetry.protocol</code> and <code>fastpoetry.service</code>). But following our usual practice of making these examples self-contained, we've including everything we need in a single script.</p>
<h4>Twisted <tt>tac</tt> files</h4>
<p>The rest of the script contains what would normally be the entire content &mdash; a Twisted <tt>tac</tt> file. A <tt>tac</tt> file is a Twisted Application Configuration file that tells <code>twistd</code> how to construct an application. As a configuration file it is responsible for choosing settings (like port numbers, poetry file locations, etc.) to run the application in some particular way. In other words, a <tt>tac</tt> file represents a specific deployment of our service (serve <em>that</em> poem on <em>this</em> port) rather than a general script for starting any poetry server.</p>
<p>If we were running multiple poetry servers on the same host, we would have a <tt>tac</tt> file for each one (so you can see why <tt>tac</tt> files normally don't contain any general-purpose code). In our example, the <tt>tac</tt> file is configured to serve <tt>poetry/ecstasy.txt</tt> run on port <code>10000</code> of the loopback interface:</p>
<div><div class="syntaxhighlighter  py" id="highlighter_201481"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py comments"># configuration parameters</code></div><div class="line number2 index1 alt1"><code class="py plain">port </code><code class="py keyword">=</code> <code class="py value">10000</code></div><div class="line number3 index2 alt2"><code class="py plain">iface </code><code class="py keyword">=</code> <code class="py string">'localhost'</code></div><div class="line number4 index3 alt1"><code class="py plain">poetry_file </code><code class="py keyword">=</code> <code class="py string">'poetry/ecstasy.txt'</code></div></div></td></tr></tbody></table></div></div>
<p>Note that <tt>twistd</tt> doesn't know anything about these particular variables, we just define them here to keep all our configuration values in one place. In fact, <tt>twistd</tt> only really cares about one variable in the entire file, as we'll see shortly. Next we <a href="http://github.com/jdavisp3/twisted-intro/blob/master/twisted-server-3/fastpoetry.py#L44">begin</a> building up our application:</p>
<div><div class="syntaxhighlighter  py" id="highlighter_876212"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py comments"># this will hold the services that combine to form the poetry server</code></div><div class="line number2 index1 alt1"><code class="py plain">top_service </code><code class="py keyword">=</code> <code class="py plain">service.MultiService()</code></div></div></td></tr></tbody></table></div></div>
<p>Our poetry server is going to consist of two services, the <code>PoetryService</code> we defined above, and a Twisted built-in service that creates the listening socket our poem will be served from. Since these two services are clearly related to each other, we'll group them together using a <a href="http://twistedmatrix.com/trac/browser/tags/releases/twisted-10.0.0/twisted/application/service.py#L253"><code>MultiService</code></a>, a Twisted class which implements both <code>IService</code> and <code>IServiceCollection</code>.</p>
<p>As a service collection, the <code>MultiService</code> will group our two poetry services together. And as a service, the <code>MultiService</code> will start both child services when the <code>MultiService</code> itself is started, and stop both child services when it is stopped. Let's <a href="http://github.com/jdavisp3/twisted-intro/blob/master/twisted-server-3/fastpoetry.py#L48">add</a> the first poetry service to the collection:</p>
<div><div class="syntaxhighlighter  py" id="highlighter_500425"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py comments"># the poetry service holds the poem. it will load the poem when it is</code></div><div class="line number2 index1 alt1"><code class="py comments"># started</code></div><div class="line number3 index2 alt2"><code class="py plain">poetry_service </code><code class="py keyword">=</code> <code class="py plain">PoetryService(poetry_file)</code></div><div class="line number4 index3 alt1"><code class="py plain">poetry_service.setServiceParent(top_service)</code></div></div></td></tr></tbody></table></div></div>
<p>This is pretty simple stuff. We just create the <code>PoetryService</code> and then add it to the collection with <code>setServiceParent</code>, a method we inherited from the Twisted base class. Next we <a href="http://github.com/jdavisp3/twisted-intro/blob/master/twisted-server-3/fastpoetry.py#L53">add</a> the TCP listener:</p>
<div><div class="syntaxhighlighter  py" id="highlighter_355745"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py comments"># the tcp service connects the factory to a listening socket. it will</code></div><div class="line number2 index1 alt1"><code class="py comments"># create the listening socket when it is started</code></div><div class="line number3 index2 alt2"><code class="py plain">factory </code><code class="py keyword">=</code> <code class="py plain">PoetryFactory(poetry_service)</code></div><div class="line number4 index3 alt1"><code class="py plain">tcp_service </code><code class="py keyword">=</code> <code class="py plain">internet.TCPServer(port, factory, interface</code><code class="py keyword">=</code><code class="py plain">iface)</code></div><div class="line number5 index4 alt2"><code class="py plain">tcp_service.setServiceParent(top_service)</code></div></div></td></tr></tbody></table></div></div>
<p>Twisted provides the <code>TCPServer</code> service for creating a TCP listening socket connected to an arbitrary factory (in this case our <code>PoetryFactory</code>). We don't call <code>reactor.listenTCP</code> directly because the job of a <tt>tac</tt> file is to get our application ready to start, without actually starting it. The <code>TCPServer</code> will create the socket after it is started by <tt>twistd</tt>.</p>
<p>You might have noticed we didn't bother to give any of our services names. Naming services is not required, but only an optional feature you can use if you want to 'look up' services at runtime. Since we don't need to do that in our little application, we don't bother with it here.</p>
<p>Ok, now we've got both our services combined into a collection. Now we just make our <code>Application</code> and <a href="http://github.com/jdavisp3/twisted-intro/blob/master/twisted-server-3/fastpoetry.py#L58">add</a> our collection to it:</p>
<div><div class="syntaxhighlighter  py" id="highlighter_744399"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py comments"># this variable has to be named 'application'</code></div><div class="line number2 index1 alt1"><code class="py plain">application </code><code class="py keyword">=</code> <code class="py plain">service.Application(</code><code class="py string">"fastpoetry"</code><code class="py plain">)</code></div><div class="line number3 index2 alt2">&nbsp;</div><div class="line number4 index3 alt1"><code class="py comments"># this hooks the collection we made to the application</code></div><div class="line number5 index4 alt2"><code class="py plain">top_service.setServiceParent(application)</code></div></div></td></tr></tbody></table></div></div>
<p>The only variable in this script that <tt>twistd</tt> really cares about is the <code>application</code> variable. That is how <tt>twistd</tt> will find the application it's supposed to start (and so the variable has to be named 'application'). And when the application is started, all the services we added to it will be started as well.</p>
<p>Figure 34 shows the structure of the application we just built:</p>
<div style="width: 361px" class="wp-caption aligncenter" id="attachment_2400"><a href="img/application.png"><img width="351" height="277" alt="Figure 34: the structure of our fastpoetry application" src="img/application.png" title="Figure 34: the structure of our fastpoetry application" class="size-full wp-image-2400 "></a><p class="wp-caption-text">Figure 34: the structure of our fastpoetry application</p></div>
<h4>Running the Server</h4>
<p>Let's take our new server for a spin. As a <tt>tac</tt> file, we need to start it with <tt>twistd</tt>. Of course, it's also just a regular Python file, too. So let's run it with Python first and see what happens:</p>
<pre>python twisted-server-3/fastpoetry.py</pre>
<p>If you do this, you'll find that what happens is nothing! As we said before, the job of a <tt>tac</tt> file is to get an application ready to run, without actually running it. As a reminder of this special purpose of <tt>tac</tt> files, some people name them with a <tt>.tac</tt> extension instead of <tt>.py</tt>. But the <tt>twistd</tt> script doesn't actually care about the extension.</p>
<p>Let's run our server for real, using <tt>twistd</tt>:</p>
<pre>twistd --nodaemon --python twisted-server-3/fastpoetry.py</pre>
<p>After running that command, you should see some output like this:</p>
<pre>2010-06-23 20:57:14-0700 [-] Log opened.
2010-06-23 20:57:14-0700 [-] twistd 10.0.0 (/usr/bin/python 2.6.5) starting up.
2010-06-23 20:57:14-0700 [-] reactor class: twisted.internet.selectreactor.SelectReactor.
2010-06-23 20:57:14-0700 [-] __builtin__.PoetryFactory starting on 10000
2010-06-23 20:57:14-0700 [-] Starting factory &lt;__builtin__.PoetryFactory instance at 0x14ae8c0&gt;
2010-06-23 20:57:14-0700 [-] loaded a poem from: poetry/ecstasy.txt</pre>
<p>Here's a few things to notice:</p>
<ol>
<li>You can see the output of the Twisted logging system, including the <code>PoetryFactory</code>'s call to <code>log.msg</code>. But we didn't install a logger in our <tt>tac</tt> file, so <tt>twistd</tt> must have installed one for us.</li>
<li>You can also see our two main services, the <code>PoetryService</code> and the <code>TCPServer</code> starting up.</li>
<li>The shell prompt never came back. That means our server isn't running as a daemon. By default, <tt>twistd</tt> does run a server as a daemon process (that's the main reason <tt>twistd</tt> exists), but if you include the <tt>--nodaemon</tt> option then <tt>twistd</tt> will run your server as a regular shell process instead, and will direct the log output to standard output as well. This is useful for debugging your <tt>tac</tt> files.</li>
</ol>
<p>Now test out the server by fetching a poem, either with one of our poetry clients or just <tt>netcat</tt>:</p>
<pre>netcat localhost 10000</pre>
<p>That should fetch the poem from the server and you should see a new log line like this:</p>
<pre>2010-06-27 22:17:39-0700 [__builtin__.PoetryFactory] sending 3003 bytes of poetry to IPv4Address(TCP, '127.0.0.1', 58208)</pre>
<p>That's from the call to <code>log.msg</code> in <code>PoetryProtocol.connectionMade</code>. As you make more requests to the server, you will see additional log entries for each request.</p>
<p>Now stop the server by pressing <tt>Ctrl-C</tt>. You should see some output like this:</p>
<pre>^C2010-06-29 21:32:59-0700 [-] Received SIGINT, shutting down.
2010-06-29 21:32:59-0700 [-] (Port 10000 Closed)
2010-06-29 21:32:59-0700 [-] Stopping factory &lt;__builtin__.PoetryFactory instance at 0x28d38c0&gt;
2010-06-29 21:32:59-0700 [-] Main loop terminated.
2010-06-29 21:32:59-0700 [-] Server Shut Down.</pre>
<p>As you can see, Twisted does not simply crash, but shuts itself down cleanly and tells you about it with log messages. Notice our two main services shutting themselves down as well.</p>
<p>Ok, now start the server up once more:</p>
<pre>twistd --nodaemon --python twisted-server-3/fastpoetry.py</pre>
<p>Then open another shell and change to the <tt>twisted-intro</tt> directory. A directory listing should show a file called <tt>twistd.pid</tt>. This file is created by <tt>twistd</tt> and contains the process ID of our running server. Try executing this alternative command to shut down the server:</p>
<pre>kill `cat twistd.pid`</pre>
<p>Notice that <tt>twistd</tt> cleans up the process ID file when our server shuts down.</p>
<h4>A Real Daemon</h4>
<p>Now let's start our server as an actual daemon process, which is even simpler to do as it's <tt>twistd</tt>'s default behavior:</p>
<pre>twistd --python twisted-server-3/fastpoetry.py</pre>
<p>This time we get our shell prompt back almost immediately. And if you list the contents of your directory you will see, in addition to the <tt>twistd.pid</tt> file for the server we just ran, a <tt>twistd.log</tt> file with the log entries that were formerly displayed at the shell prompt.</p>
<p>When starting a daemon process, <tt>twistd</tt> installs a log handler that writes entries to a file instead of standard output. The default log file is <tt>twistd.log</tt>, located in the same directory where you ran <tt>twistd</tt>, but you can change that with the <tt>--logfile</tt> option if you wish. The handler that <tt>twistd</tt> installs also rotates the log whenever the size exceeds one megabyte.</p>
<p>You should be able to see the server running by listing all the processes on your system. Go ahead and test out the server by fetching another poem. You should see new entries appear in the log file for each poem you request.</p>
<p>Since the server is no longer connected to the shell (or any other process except <a href="http://en.wikipedia.org/wiki/Init"><tt>init</tt></a>), you cannot shut it down with <tt>Ctrl-C</tt>. As a true daemon process, it will continue to run even if you log out. But we can still use the <tt>twistd.pid</tt> file to stop the process:</p>
<pre>kill `cat twistd.pid`</pre>
<p>And when that happens the shutdown messages appear in the log, the <tt>twistd.pid</tt> file is removed, and our server stops running. Neato.</p>
<p>It's a good idea to check out some of the other <tt>twistd</tt> startup options. For example, you can tell <tt>twistd</tt> to switch to a different user or group account before starting the daemon (typically a way to drop privileges your server doesn't need as a security precaution). We won't bother going into those extra options, you can find them using the <tt>--help</tt> switch to <tt>twistd</tt>.</p>
<h3>The Twisted Plugin System</h3>
<p>Ok, now we can use <tt>twistd</tt> to start up our servers as genuine daemon processes. This is all very nice, and the fact that our "configuration" files are really just Python source files gives us a great deal of flexibility in how we set things up. But we don't always need that much flexibility. For our poetry servers, we typically only have a few options we might care about:</p>
<ol>
<li>The poem to serve.</li>
<li>The port to serve it from.</li>
<li>The interface to listen on.</li>
</ol>
<p>Making new <tt>tac</tt> files for simple variations on those values seems rather excessive. It would be nice if we could just specify those values as options on the <tt>twistd</tt> command line. The Twisted plugin system allows us to do just that.</p>
<p>Twisted plugins provide a way of defining named Applications, with a custom set of command-line options, that <tt>twistd</tt> can dynamically discover and run. Twisted itself comes with a set of built-in plugins. You can see them all by running <tt>twistd</tt> without any arguments. Try running it now, but outside of the <tt>twisted-intro</tt> directory. After the help section, you should see some output like this:</p>
<pre>    ...
    ftp                An FTP server.
    telnet             A simple, telnet-based remote debugging service.
    socks              A SOCKSv4 proxy service.
    ...</pre>
<p>Each line shows one of the built-in plugins that come with Twisted. And you can run any of them using <tt>twistd</tt>.<br>
Each plugin also comes with its own set of options, which you can discover using <tt>--help</tt>. Let's see what the options for the <tt>ftp</tt> plugin are:</p>
<pre>twistd ftp --help</pre>
<p>Note that you need to put the <tt>--help</tt> switch after the <tt>ftp</tt> command, since you want the options for the <tt>ftp</tt> plugin rather than for <tt>twistd</tt> itself.<br>
We can run the <tt>ftp</tt> server with <tt>twistd</tt> just like we ran our poetry server. But since it's a plugin, we just run it by name:</p>
<pre>twistd --nodaemon ftp --port 10001</pre>
<p>That command runs the <tt>ftp</tt> plugin in non-daemon mode on port 10001. Note the <tt>twistd</tt> option <tt>nodaemon</tt> comes before the plugin name, while the plugin-specific option <tt>port</tt> comes after the plugin name. As with our poetry server, you can stop that plugin with <tt>Ctrl-C</tt>.</p>
<p>Ok, let's turn our poetry server into a Twisted plugin. First we need to introduce a couple of new concepts.</p>
<h4>IPlugin</h4>
<p>Any Twisted plugin must implement the <a href="http://twistedmatrix.com/trac/browser/tags/releases/twisted-10.0.0/twisted/plugin.py#L38"><code>twisted.plugin.IPlugin</code></a> interface. If you look at the declaration of that <code>Interface</code>, you'll find it doesn't actually specify any methods. Implementing <code>IPlugin</code> is simply a way for a plugin to say "Hello, I'm a plugin!" so <tt>twistd</tt> can find it. Of course, to be of any use, it will have to implement some other interface and we'll get to that shortly.</p>
<p>But how do you know if an object actually implements an empty interface? The <code>zope.interface</code> package includes a function called <code>implements</code> that you can use to declare that a particular class implements a particular interface. We'll see an example of that in the plugin version of our poetry server.</p>
<h4>IServiceMaker</h4>
<p>In addition to <code>IPlugin</code>, our plugin will implement the <a href="http://twistedmatrix.com/trac/browser/tags/releases/twisted-10.0.0/twisted/application/service.py#L25"><code>IServiceMaker</code></a> interface. An object which implements <code>IServiceMaker</code> knows how to create an <code>IService</code> that will form the heart of a running application. <code>IServiceMaker</code> specifies three attributes and a method:</p>
<ol>
<li><code>tapname</code>: a string name for our plugin. The "tap" stands for Twisted Application Plugin. Note: an older version of Twisted also made use of pickled application files called "tapfiles", but that functionality is deprecated.</li>
<li><code>description</code>: a description of the plugin, which <tt>twistd</tt> will display as part of its help text.</li>
<li><code>options</code>: an object which describes the command-line options this plugin accepts.</li>
<li><code>makeService</code>: a method which creates a new <code>IService</code> object, given a specific set of command-line options</li>
</ol>
<p>We'll see how all this gets put together in the next version of our poetry server.</p>
<h3>Fast Poetry 3.0</h3>
<p>Now we're ready to take a look at the plugin version of Fast Poetry, located in <a href="http://github.com/jdavisp3/twisted-intro/blob/master/twisted/plugins/fastpoetry_plugin.py#L1"><tt>twisted/plugins/fastpoetry_plugin.py</tt></a>.</p>
<p>You might notice we've named these directories differently than any of the other examples. That's because <tt>twistd</tt> requires plugin files to be located in a <tt>twisted/plugins</tt> directory, located in your Python module search path. The directory doesn't have to be a package (i.e., you don't need any <tt>__init__.py</tt> files) and you can have multiple <tt>twisted/plugins</tt> directories on your path and <tt>twistd</tt> will find them all. The actual filename you use for the plugin doesn't matter either, but it's still a good idea to name it according to the application it represents, like we have done here.</p>
<p>The first part of our plugin contains the same poetry protocol, factory, and service implementations as our <tt>tac</tt> file. And as before, this code would normally be in a separate module but we've placed it in the plugin to make the example self-contained.</p>
<p>Next comes the <a href="http://github.com/jdavisp3/twisted-intro/blob/master/twisted/plugins/fastpoetry_plugin.py#L45">declaration</a> of the plugin's command-line options:</p>
<div><div class="syntaxhighlighter  py" id="highlighter_735719"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py keyword">class</code> <code class="py plain">Options(usage.Options):</code></div><div class="line number2 index1 alt1">&nbsp;</div><div class="line number3 index2 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">optParameters </code><code class="py keyword">=</code> <code class="py plain">[</code></div><div class="line number4 index3 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">[</code><code class="py string">'port'</code><code class="py plain">, </code><code class="py string">'p'</code><code class="py plain">, </code><code class="py value">10000</code><code class="py plain">, </code><code class="py string">'The port number to listen on.'</code><code class="py plain">],</code></div><div class="line number5 index4 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">[</code><code class="py string">'poem'</code><code class="py plain">, </code><code class="py color1">None</code><code class="py plain">, </code><code class="py color1">None</code><code class="py plain">, </code><code class="py string">'The file containing the poem.'</code><code class="py plain">],</code></div><div class="line number6 index5 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">[</code><code class="py string">'iface'</code><code class="py plain">, </code><code class="py color1">None</code><code class="py plain">, </code><code class="py string">'localhost'</code><code class="py plain">, </code><code class="py string">'The interface to listen on.'</code><code class="py plain">],</code></div><div class="line number7 index6 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">]</code></div></div></td></tr></tbody></table></div></div>
<p>This code specifies the plugin-specific options that a user can place after the plugin name on the <tt>twistd</tt> command line. We won't go into details here as it should be fairly clear what is going on. Now we get to the main part of our plugin, the <a href="http://github.com/jdavisp3/twisted-intro/blob/master/twisted/plugins/fastpoetry_plugin.py#L56">service maker class</a>:</p>
<div><div class="syntaxhighlighter  py" id="highlighter_151871"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div><div class="line number20 index19 alt1">20</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py keyword">class</code> <code class="py plain">PoetryServiceMaker(</code><code class="py functions">object</code><code class="py plain">):</code></div><div class="line number2 index1 alt1">&nbsp;</div><div class="line number3 index2 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">implements(service.IServiceMaker, IPlugin)</code></div><div class="line number4 index3 alt1">&nbsp;</div><div class="line number5 index4 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">tapname </code><code class="py keyword">=</code> <code class="py string">"fastpoetry"</code></div><div class="line number6 index5 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">description </code><code class="py keyword">=</code> <code class="py string">"A fast poetry service."</code></div><div class="line number7 index6 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">options </code><code class="py keyword">=</code> <code class="py plain">Options</code></div><div class="line number8 index7 alt1">&nbsp;</div><div class="line number9 index8 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">def</code> <code class="py plain">makeService(</code><code class="py color1">self</code><code class="py plain">, options):</code></div><div class="line number10 index9 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">top_service </code><code class="py keyword">=</code> <code class="py plain">service.MultiService()</code></div><div class="line number11 index10 alt2">&nbsp;</div><div class="line number12 index11 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">poetry_service </code><code class="py keyword">=</code> <code class="py plain">PoetryService(options[</code><code class="py string">'poem'</code><code class="py plain">])</code></div><div class="line number13 index12 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">poetry_service.setServiceParent(top_service)</code></div><div class="line number14 index13 alt1">&nbsp;</div><div class="line number15 index14 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">factory </code><code class="py keyword">=</code> <code class="py plain">PoetryFactory(poetry_service)</code></div><div class="line number16 index15 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">tcp_service </code><code class="py keyword">=</code> <code class="py plain">internet.TCPServer(</code><code class="py functions">int</code><code class="py plain">(options[</code><code class="py string">'port'</code><code class="py plain">]), factory,</code></div><div class="line number17 index16 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">interface</code><code class="py keyword">=</code><code class="py plain">options[</code><code class="py string">'iface'</code><code class="py plain">])</code></div><div class="line number18 index17 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">tcp_service.setServiceParent(top_service)</code></div><div class="line number19 index18 alt2">&nbsp;</div><div class="line number20 index19 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">return</code> <code class="py plain">top_service</code></div></div></td></tr></tbody></table></div></div>
<p>Here you can see how the <code>zope.interface.implements</code> function is used to declare that our class implements both <code>IServiceMaker</code> and <code>IPlugin</code>.</p>
<p>You should recognize the code in <code>makeService</code> from our earlier <tt>tac</tt> file implementation. But this time we don't need to make an <code>Application</code> object ourselves, we just create and return the top level service that our application will run and <tt>twistd</tt> will take care of the rest. Notice how we use the <code>options</code> argument to retrieve the plugin-specific command-line options given to <tt>twistd</tt>.</p>
<p>After declaring that class, there's only on thing left <a href="http://github.com/jdavisp3/twisted-intro/blob/master/twisted/plugins/fastpoetry_plugin.py#L81">to do</a>:</p>
<div><div class="syntaxhighlighter  py" id="highlighter_713482"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py plain">service_maker </code><code class="py keyword">=</code> <code class="py plain">PoetryServiceMaker()</code></div></div></td></tr></tbody></table></div></div>
<p>The <tt>twistd</tt> script will discover that instance of our plugin and use it to construct the top level service. Unlike the <tt>tac</tt> file, the variable name we choose is irrelevant.  What matters is that our object implements both <code>IPlugin</code> and <code>IServiceMaker</code>.</p>
<p>Now that we've created our plugin, let's run it. Make sure that you are in the <tt>twisted-intro</tt> directory, or that the <tt>twisted-intro</tt> directory is in your python module search path. Then try running <tt>twistd</tt> by itself. You should now see that "fastpoetry" is one of the plugins listed, along with the description text from our plugin file.</p>
<p>You will also notice that a new file called <tt>dropin.cache</tt> has appeared in the <tt>twisted/plugins</tt> directory. This file is created by <tt>twistd</tt> to speed up subsequent scans for plugins.</p>
<p>Now let's get some help on using our plugin:</p>
<pre>twistd fastpoetry --help</pre>
<p>You should see the options that are specific to the fastpoetry plugin in the help text. Finally, let's run our plugin:</p>
<pre>twistd fastpoetry --port 10000 --poem poetry/ecstasy.txt</pre>
<p>That will start a fastpoetry server running as a daemon. As before, you should see both <tt>twistd.pid</tt> and <tt>twistd.log</tt> files in the current directory. After testing out the server, you can shut it down:</p>
<pre>kill `cat twistd.pid`</pre>
<p>And that's how you make a Twisted plugin.</p>
<h3>Summary</h3>
<p>In this Part we learned about turning our Twisted servers into long-running daemons. We touched on the Twisted logging system and on how to use <tt>twistd</tt> to start a Twisted application as a daemon process, either from a <tt>tac</tt> configuration file or a Twisted plugin. In <a href="http://krondo.com/wp-content/uploads/2009/08/twisted-intro.html?p=2441">Part 17</a> we'll return to the more fundamental topic of asynchronous programming and look at another way of structuring our callbacks in Twisted.</p>
<h3>Suggested Exercises</h3>
<ol>
<li>Modify the <tt>tac</tt> file to serve a second poem on another port. Keep the services for each poem separate by using another <code>MultiService</code> object.</li>
<li>Create a new <tt>tac</tt> file that starts a poetry proxy server.</li>
<li>Modify the plugin file to accept an optional second poetry file and second port to serve it on.</li>
<li>Create a new plugin for the poetry proxy server.</li>
</ol>
<!-- JOLIPRINT BUTTON BEGINS --><script type="text/javascript">
&amp;amp;amp;amp;amp;amp;amp;amp;lt;!--
try{
$joliprint().set('format','json').set('callback','joliprint_getPdf').set('service','wp-plugin').set('url','http://krondo.com/?p=2345').set('title','Print with Joliprint').set('urloptions','ver=1.1.5').set( 'label', 'joliprint' ).set( 'labelposition', 'after' ).set( 'button', 'joliprint-icon' ).write();
}catch(e){

}
--&amp;amp;amp;amp;amp;amp;amp;amp;gt;</script><!-- JOLIPRINT BUTTON ENDS -->		<div class="fixed"></div>
			</div>
</div>


<div class="post" id="post-2441">
	
	

	<div class="content">
		<h2>Part 17: Just Another Way to Spell "Callback"</h2>
<p>This continues the introduction started <a href="http://krondo.com/wp-content/uploads/2009/08/twisted-intro.html?p=1209">here</a>. You can find an index to the entire series <a href="http://krondo.com/wp-content/uploads/2009/08/twisted-intro.html?page_id=1327">here</a>.</p>
<h3>Introduction</h3>
<p>In this Part we're going to return to the subject of callbacks. We'll introduce another technique for writing callbacks in Twisted that uses <a href="http://docs.python.org/tutorial/classes.html#generators">generators</a>. We'll show how the technique works and contrast it with using "pure" Deferreds. Finally we'll rewrite one of our poetry clients using this technique. But first let's review how generators work so we can see why they are a candidate for creating callbacks.</p>
<h4>A Brief Review of Generators</h4>
<p>As you probably know, a Python generator is a "restartable function" that you create by using the <code>yield</code> expression in the body of your function. By doing so, the function becomes a "generator function" that returns an <a href="http://docs.python.org/tutorial/classes.html#iterators">iterator</a> you can use to run the function in a series of steps. Each cycle of the iterator restarts the function, which proceeds to execute until it reaches the next <code>yield</code>.</p>
<p>Generators (and iterators) are often used to represent lazily-created sequences of values. Take a look at the example code in <a href="http://github.com/jdavisp3/twisted-intro/blob/master/inline-callbacks/gen-1.py#L1"><tt>inline-callbacks/gen-1.py</tt></a>:</p>
<div><div id="highlighter_429886" class="syntaxhighlighter  py"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py keyword">def</code> <code class="py plain">my_generator():</code></div><div class="line number2 index1 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py functions">print</code> <code class="py string">'starting up'</code></div><div class="line number3 index2 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">yield</code> <code class="py value">1</code></div><div class="line number4 index3 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py functions">print</code> <code class="py string">"workin'"</code></div><div class="line number5 index4 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">yield</code> <code class="py value">2</code></div><div class="line number6 index5 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py functions">print</code> <code class="py string">"still workin'"</code></div><div class="line number7 index6 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">yield</code> <code class="py value">3</code></div><div class="line number8 index7 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py functions">print</code> <code class="py string">'done'</code></div><div class="line number9 index8 alt2">&nbsp;</div><div class="line number10 index9 alt1"><code class="py keyword">for</code> <code class="py plain">n </code><code class="py keyword">in</code> <code class="py plain">my_generator():</code></div><div class="line number11 index10 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py functions">print</code> <code class="py plain">n</code></div></div></td></tr></tbody></table></div></div>
<p>Here we have a generator that creates the sequence 1, 2, 3. If you run the code, you will see the <code>print</code> statements in the generator interleaved with the <code>print</code> statement in the <code>for</code> loop as the loop cycles through the generator.</p>
<p>We can make this code more explicit by creating the generator ourselves (<a href="http://github.com/jdavisp3/twisted-intro/blob/master/inline-callbacks/gen-2.py#L1"><tt>inline-callbacks/gen-2.py</tt></a>):</p>
<div><div id="highlighter_89094" class="syntaxhighlighter  py"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py keyword">def</code> <code class="py plain">my_generator():</code></div><div class="line number2 index1 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py functions">print</code> <code class="py string">'starting up'</code></div><div class="line number3 index2 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">yield</code> <code class="py value">1</code></div><div class="line number4 index3 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py functions">print</code> <code class="py string">"workin'"</code></div><div class="line number5 index4 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">yield</code> <code class="py value">2</code></div><div class="line number6 index5 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py functions">print</code> <code class="py string">"still workin'"</code></div><div class="line number7 index6 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">yield</code> <code class="py value">3</code></div><div class="line number8 index7 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py functions">print</code> <code class="py string">'done'</code></div><div class="line number9 index8 alt2">&nbsp;</div><div class="line number10 index9 alt1"><code class="py plain">gen </code><code class="py keyword">=</code> <code class="py plain">my_generator()</code></div><div class="line number11 index10 alt2">&nbsp;</div><div class="line number12 index11 alt1"><code class="py keyword">while</code> <code class="py color1">True</code><code class="py plain">:</code></div><div class="line number13 index12 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">try</code><code class="py plain">:</code></div><div class="line number14 index13 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">n </code><code class="py keyword">=</code> <code class="py plain">gen.</code><code class="py functions">next</code><code class="py plain">()</code></div><div class="line number15 index14 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">except</code> <code class="py plain">StopIteration:</code></div><div class="line number16 index15 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">break</code></div><div class="line number17 index16 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">else</code><code class="py plain">:</code></div><div class="line number18 index17 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py functions">print</code> <code class="py plain">n</code></div></div></td></tr></tbody></table></div></div>
<p>Considered as a sequence, the generator is just an object for getting successive values. But we can also view things from the point of view of the generator itself:</p>
<ol>
<li>The generator function doesn't start running until "called" by the loop (using the <code>next</code> method).</li>
<li>Once the generator is running, it keeps running until it "returns" to the loop (using <code>yield</code>).</li>
<li>When the loop is running other code (like the <code>print</code> statement), the generator is not running.</li>
<li>When the generator is running, the loop is not running (it's "blocked" waiting for the generator).</li>
<li>Once a generator <code>yield</code>s control to the loop, an arbitrary amount of time may pass (and an arbitrary amount of other code may execute) until the generator runs again.</li>
</ol>
<p>This is very much like the way callbacks work in an asynchronous system. We can think of the <code>while</code> loop as the reactor, and the generator as a series of callbacks separated by <code>yield</code> statements, with the interesting fact that all the callbacks share the same local variable namespace, and the namespace persists from one callback to the next.</p>
<p>Furthermore, you can have multiple generators active at once (see the example in <a href="http://github.com/jdavisp3/twisted-intro/blob/master/inline-callbacks/gen-3.py#L1"><tt>inline-callbacks/gen-3.py</tt></a>), with their "callbacks" interleaved with each other, just as you can have independent asynchronous tasks running in a system like Twisted.</p>
<p>Something is still missing, though. Callbacks aren't just called by the reactor, they also receive information. When part of a deferred's chain, a callback either receives a result, in the form of a single Python value, or an error, in the form of a <code>Failure</code>.</p>
<p>Starting with Python 2.5, generators were extended in a way that allows you to send information to a generator when you restart it, as illustrated in <a href="http://github.com/jdavisp3/twisted-intro/blob/master/inline-callbacks/gen-4.py#L1"><tt>inline-callbacks/gen-4.py</tt></a>:</p>
<div><div id="highlighter_727635" class="syntaxhighlighter  py"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div><div class="line number20 index19 alt1">20</div><div class="line number21 index20 alt2">21</div><div class="line number22 index21 alt1">22</div><div class="line number23 index22 alt2">23</div><div class="line number24 index23 alt1">24</div><div class="line number25 index24 alt2">25</div><div class="line number26 index25 alt1">26</div><div class="line number27 index26 alt2">27</div><div class="line number28 index27 alt1">28</div><div class="line number29 index28 alt2">29</div><div class="line number30 index29 alt1">30</div><div class="line number31 index30 alt2">31</div><div class="line number32 index31 alt1">32</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py keyword">class</code> <code class="py plain">Malfunction(Exception):</code></div><div class="line number2 index1 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">pass</code></div><div class="line number3 index2 alt2">&nbsp;</div><div class="line number4 index3 alt1"><code class="py keyword">def</code> <code class="py plain">my_generator():</code></div><div class="line number5 index4 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py functions">print</code> <code class="py string">'starting up'</code></div><div class="line number6 index5 alt1">&nbsp;</div><div class="line number7 index6 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">val </code><code class="py keyword">=</code> <code class="py keyword">yield</code> <code class="py value">1</code></div><div class="line number8 index7 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py functions">print</code> <code class="py string">'got:'</code><code class="py plain">, val</code></div><div class="line number9 index8 alt2">&nbsp;</div><div class="line number10 index9 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">val </code><code class="py keyword">=</code> <code class="py keyword">yield</code> <code class="py value">2</code></div><div class="line number11 index10 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py functions">print</code> <code class="py string">'got:'</code><code class="py plain">, val</code></div><div class="line number12 index11 alt1">&nbsp;</div><div class="line number13 index12 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">try</code><code class="py plain">:</code></div><div class="line number14 index13 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">yield</code> <code class="py value">3</code></div><div class="line number15 index14 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">except</code> <code class="py plain">Malfunction:</code></div><div class="line number16 index15 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py functions">print</code> <code class="py string">'malfunction!'</code></div><div class="line number17 index16 alt2">&nbsp;</div><div class="line number18 index17 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">yield</code> <code class="py value">4</code></div><div class="line number19 index18 alt2">&nbsp;</div><div class="line number20 index19 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py functions">print</code> <code class="py string">'done'</code></div><div class="line number21 index20 alt2">&nbsp;</div><div class="line number22 index21 alt1"><code class="py plain">gen </code><code class="py keyword">=</code> <code class="py plain">my_generator()</code></div><div class="line number23 index22 alt2">&nbsp;</div><div class="line number24 index23 alt1"><code class="py functions">print</code> <code class="py plain">gen.</code><code class="py functions">next</code><code class="py plain">() </code><code class="py comments"># start the generator</code></div><div class="line number25 index24 alt2"><code class="py functions">print</code> <code class="py plain">gen.send(</code><code class="py value">10</code><code class="py plain">) </code><code class="py comments"># send the value 10</code></div><div class="line number26 index25 alt1"><code class="py functions">print</code> <code class="py plain">gen.send(</code><code class="py value">20</code><code class="py plain">) </code><code class="py comments"># send the value 20</code></div><div class="line number27 index26 alt2"><code class="py functions">print</code> <code class="py plain">gen.throw(Malfunction()) </code><code class="py comments"># raise an exception inside the generator</code></div><div class="line number28 index27 alt1">&nbsp;</div><div class="line number29 index28 alt2"><code class="py keyword">try</code><code class="py plain">:</code></div><div class="line number30 index29 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">gen.</code><code class="py functions">next</code><code class="py plain">()</code></div><div class="line number31 index30 alt2"><code class="py keyword">except</code> <code class="py plain">StopIteration:</code></div><div class="line number32 index31 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">pass</code></div></div></td></tr></tbody></table></div></div>
<p>In Python 2.5 and later versions, the <code>yield</code> statement is an expression that evaluates to a value. And the code that restarts the generator can determine that value using the <code>send</code> method instead of <code>next</code> (if you use <code>next</code> the value is <code>None</code>). What's more, you can actually raise an arbitrary exception <em>inside</em> the generator using the <code>throw</code> method. How cool is that?</p>
<h3>Inline Callbacks</h3>
<p>Given what we just reviewed about <code>send</code>ing and <code>throw</code>ing values and exceptions into a generator, we can envision a generator as a series of callbacks, like the ones in a deferred, which receive either results or failures. The callbacks are separated by <code>yield</code>s and the value of each <code>yield</code> expression is the result for the next callback (or the <code>yield</code> raises an exception and that's the failure). Figure 35 shows the correspondence:</p>
<div id="attachment_2461" class="wp-caption aligncenter" style="width: 438px"><a href="img/generator-callbacks1.png"><img width="428" height="235" class="size-full wp-image-2461" title="Figure 35: generator as a callback sequence" src="img/generator-callbacks1.png" alt="Figure 35: generator as a callback sequence"></a><p class="wp-caption-text">Figure 35: generator as a callback sequence</p></div>
<p>Now when a series of callbacks is chained together in a deferred, each callback receives the result from the one prior. That's easy enough to do with a generator &mdash; just <code>send</code> the value you got from the previous run of the generator (the value it <code>yield</code>ed) the next time you restart it. But that also seems a bit silly. Since the generator computed the value to begin with, why bother sending it back? The generator could just save the value in a variable for the next time it's needed. So what's the point?</p>
<p>Recall the fact we learned in <a href="http://krondo.com/wp-content/uploads/2009/08/twisted-intro.html?p=2159">Part 13</a>, that the callbacks in a deferred can return deferreds themselves. And when that happens, the outer deferred is paused until the inner deferred fires, and then the next callback (or errback) in the outer deferred's chain is called with the result (or failure) from the inner deferred.</p>
<p>So imagine that our generator <code>yield</code>s a deferred object instead of an ordinary Python value. The generator is now "paused", and that's automatic; generators always pause after every <code>yield</code> statement until they are explicitly restarted. So we can delay restarting the generator until the deferred fires, at which point we either <code>send</code> the value (if the deferred succeeds) or <code>throw</code> the exception (if the deferred fails). That would make our generator a genuine sequence of asynchronous callbacks and that's the idea behind the <a href="http://twistedmatrix.com/trac/browser/tags/releases/twisted-10.1.0/twisted/internet/defer.py#L973"><code>inlineCallbacks</code></a> function in <a href="http://twistedmatrix.com/trac/browser/tags/releases/twisted-10.1.0/twisted/internet/defer.py"><code>twisted.internet.defer</code></a>.</p>
<h4>inlineCallbacks</h4>
<p>Consider the example program in <a href="http://github.com/jdavisp3/twisted-intro/blob/master/inline-callbacks/inline-callbacks-1.py#L1"><tt>inline-callbacks/inline-callbacks-1.py</tt></a>:</p>
<div><div id="highlighter_643659" class="syntaxhighlighter  py"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div><div class="line number20 index19 alt1">20</div><div class="line number21 index20 alt2">21</div><div class="line number22 index21 alt1">22</div><div class="line number23 index22 alt2">23</div><div class="line number24 index23 alt1">24</div><div class="line number25 index24 alt2">25</div><div class="line number26 index25 alt1">26</div><div class="line number27 index26 alt2">27</div><div class="line number28 index27 alt1">28</div><div class="line number29 index28 alt2">29</div><div class="line number30 index29 alt1">30</div><div class="line number31 index30 alt2">31</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py keyword">from</code> <code class="py plain">twisted.internet.defer </code><code class="py keyword">import</code> <code class="py plain">inlineCallbacks, Deferred</code></div><div class="line number2 index1 alt1">&nbsp;</div><div class="line number3 index2 alt2"><code class="py decorator">@inlineCallbacks</code></div><div class="line number4 index3 alt1"><code class="py keyword">def</code> <code class="py plain">my_callbacks():</code></div><div class="line number5 index4 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">from</code> <code class="py plain">twisted.internet </code><code class="py keyword">import</code> <code class="py plain">reactor</code></div><div class="line number6 index5 alt1">&nbsp;</div><div class="line number7 index6 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py functions">print</code> <code class="py string">'first callback'</code></div><div class="line number8 index7 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">result </code><code class="py keyword">=</code> <code class="py keyword">yield</code> <code class="py value">1</code> <code class="py comments"># yielded values that aren't deferred come right back</code></div><div class="line number9 index8 alt2">&nbsp;</div><div class="line number10 index9 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py functions">print</code> <code class="py string">'second callback got'</code><code class="py plain">, result</code></div><div class="line number11 index10 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">d </code><code class="py keyword">=</code> <code class="py plain">Deferred()</code></div><div class="line number12 index11 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">reactor.callLater(</code><code class="py value">5</code><code class="py plain">, d.callback, </code><code class="py value">2</code><code class="py plain">)</code></div><div class="line number13 index12 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">result </code><code class="py keyword">=</code> <code class="py keyword">yield</code> <code class="py plain">d </code><code class="py comments"># yielded deferreds will pause the generator</code></div><div class="line number14 index13 alt1">&nbsp;</div><div class="line number15 index14 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py functions">print</code> <code class="py string">'third callback got'</code><code class="py plain">, result </code><code class="py comments"># the result of the deferred</code></div><div class="line number16 index15 alt1">&nbsp;</div><div class="line number17 index16 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">d </code><code class="py keyword">=</code> <code class="py plain">Deferred()</code></div><div class="line number18 index17 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">reactor.callLater(</code><code class="py value">5</code><code class="py plain">, d.errback, Exception(</code><code class="py value">3</code><code class="py plain">))</code></div><div class="line number19 index18 alt2">&nbsp;</div><div class="line number20 index19 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">try</code><code class="py plain">:</code></div><div class="line number21 index20 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">yield</code> <code class="py plain">d</code></div><div class="line number22 index21 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">except</code> <code class="py plain">Exception, e:</code></div><div class="line number23 index22 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">result </code><code class="py keyword">=</code> <code class="py plain">e</code></div><div class="line number24 index23 alt1">&nbsp;</div><div class="line number25 index24 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py functions">print</code> <code class="py string">'fourth callback got'</code><code class="py plain">, </code><code class="py functions">repr</code><code class="py plain">(result) </code><code class="py comments"># the exception from the deferred</code></div><div class="line number26 index25 alt1">&nbsp;</div><div class="line number27 index26 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">reactor.stop()</code></div><div class="line number28 index27 alt1">&nbsp;</div><div class="line number29 index28 alt2"><code class="py keyword">from</code> <code class="py plain">twisted.internet </code><code class="py keyword">import</code> <code class="py plain">reactor</code></div><div class="line number30 index29 alt1"><code class="py plain">reactor.callWhenRunning(my_callbacks)</code></div><div class="line number31 index30 alt2"><code class="py plain">reactor.run()</code></div></div></td></tr></tbody></table></div></div>
<p>Run the example and you will see the generator execute to the end and then stop the reactor. The example illustrates several aspects of the <code>inlineCallbacks</code> function. First, <code>inlineCallbacks</code> is a decorator and it always decorates generator functions, i.e., functions that use <code>yield</code>. The whole purpose of <code>inlineCallbacks</code> is turn a generator into a series of asynchronous callbacks according to the scheme we outlined before.</p>
<p>Second, when we invoke an <code>inlineCallbacks</code>-decorated function, we don't need to call <code>next</code> or <code>send</code> or <code>throw</code> ourselves. The decorator takes care of those details for us and ensures the generator will run to the end (assuming it doesn't raise an exception).</p>
<p>Third, if we <code>yield</code> a non-deferred value from the generator, it is immediately restarted with that same value as the result of the <code>yield</code>.</p>
<p>And finally, if we <code>yield</code> a deferred from the generator, it will not be restarted until that deferred fires. If the deferred succeeds, the result of the <code>yield</code> is just the result from the deferred. And if the deferred fails, the <code>yield</code> statement raises the exception. Note the exception is just an ordinary <code>Exception</code> object, rather than a <code>Failure</code>, and we can catch it with a <code>try</code>/<code>except</code> statement around the <code>yield</code> expression.</p>
<p>In the example we are just using <code>callLater</code> to fire the deferreds after a short period of time. While that's a handy way to put in a non-blocking delay into our callback chain, normally we would be <code>yield</code>ing a deferred returned by some other asynchronous operation (i.e., <code>get_poetry</code>) invoked from our generator.</p>
<p>Ok, now we know how an <code>inlineCallbacks</code>-decorated function runs, but what return value do you get if you actually call one? As you might have guessed, you get a deferred. Since we can't know exactly when that generator will stop running (it might <code>yield</code> one or more deferreds), the decorated function itself is asynchronous and a deferred is the appropriate return value. Note the deferred that is returned isn't one of the deferreds the generator may <code>yield</code>. Rather, it's a deferred that fires only after the generator has completely finished (or throws an exception).</p>
<p>If the generator throws an exception, the returned deferred will fire its errback chain with that exception wrapped in a <code>Failure</code>. But if we want the generator to return a normal value, we must "return" it using the <code>defer.returnValue</code> function. Like the ordinary <code>return</code> statement, it will also stop the generator (it actually raises a special exception). The <a href="http://github.com/jdavisp3/twisted-intro/blob/master/inline-callbacks/inline-callbacks-2.py#L1"><tt>inline-callbacks/inline-callbacks-2.py</tt></a> example illustrates both possibilities.</p>
<h3>Client 7.0</h3>
<p>Let's put <code>inlineCallbacks</code> to work with a new version of our poetry client. You can see the code in <a href="http://github.com/jdavisp3/twisted-intro/blob/master/twisted-client-7/get-poetry.py#L1"><tt>twisted-client-7/get-poetry.py</tt></a>. You may wish to compare it to client 6.0 in <a href="http://github.com/jdavisp3/twisted-intro/blob/master/twisted-client-6/get-poetry.py#L151"><tt>twisted-client-6/get-poetry.py</tt></a>. The relevant changes are in <a href="http://github.com/jdavisp3/twisted-intro/blob/master/twisted-client-7/get-poetry.py#L151"><code>poetry_main</code></a>:</p>
<div><div id="highlighter_187208" class="syntaxhighlighter  py"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div><div class="line number20 index19 alt1">20</div><div class="line number21 index20 alt2">21</div><div class="line number22 index21 alt1">22</div><div class="line number23 index22 alt2">23</div><div class="line number24 index23 alt1">24</div><div class="line number25 index24 alt2">25</div><div class="line number26 index25 alt1">26</div><div class="line number27 index26 alt2">27</div><div class="line number28 index27 alt1">28</div><div class="line number29 index28 alt2">29</div><div class="line number30 index29 alt1">30</div><div class="line number31 index30 alt2">31</div><div class="line number32 index31 alt1">32</div><div class="line number33 index32 alt2">33</div><div class="line number34 index33 alt1">34</div><div class="line number35 index34 alt2">35</div><div class="line number36 index35 alt1">36</div><div class="line number37 index36 alt2">37</div><div class="line number38 index37 alt1">38</div><div class="line number39 index38 alt2">39</div><div class="line number40 index39 alt1">40</div><div class="line number41 index40 alt2">41</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py keyword">def</code> <code class="py plain">poetry_main():</code></div><div class="line number2 index1 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">addresses </code><code class="py keyword">=</code> <code class="py plain">parse_args()</code></div><div class="line number3 index2 alt2">&nbsp;</div><div class="line number4 index3 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">xform_addr </code><code class="py keyword">=</code> <code class="py plain">addresses.pop(</code><code class="py value">0</code><code class="py plain">)</code></div><div class="line number5 index4 alt2">&nbsp;</div><div class="line number6 index5 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">proxy </code><code class="py keyword">=</code> <code class="py plain">TransformProxy(</code><code class="py keyword">*</code><code class="py plain">xform_addr)</code></div><div class="line number7 index6 alt2">&nbsp;</div><div class="line number8 index7 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">from</code> <code class="py plain">twisted.internet </code><code class="py keyword">import</code> <code class="py plain">reactor</code></div><div class="line number9 index8 alt2">&nbsp;</div><div class="line number10 index9 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">results </code><code class="py keyword">=</code> <code class="py plain">[]</code></div><div class="line number11 index10 alt2">&nbsp;</div><div class="line number12 index11 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py decorator">@defer</code><code class="py plain">.inlineCallbacks</code></div><div class="line number13 index12 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">def</code> <code class="py plain">get_transformed_poem(host, port):</code></div><div class="line number14 index13 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">try</code><code class="py plain">:</code></div><div class="line number15 index14 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">poem </code><code class="py keyword">=</code> <code class="py keyword">yield</code> <code class="py plain">get_poetry(host, port)</code></div><div class="line number16 index15 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">except</code> <code class="py plain">Exception, e:</code></div><div class="line number17 index16 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py functions">print</code> <code class="py plain">&gt;&gt;sys.stderr, </code><code class="py string">'The poem download failed:'</code><code class="py plain">, e</code></div><div class="line number18 index17 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">raise</code></div><div class="line number19 index18 alt2">&nbsp;</div><div class="line number20 index19 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">try</code><code class="py plain">:</code></div><div class="line number21 index20 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">poem </code><code class="py keyword">=</code> <code class="py keyword">yield</code> <code class="py plain">proxy.xform(</code><code class="py string">'cummingsify'</code><code class="py plain">, poem)</code></div><div class="line number22 index21 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">except</code> <code class="py plain">Exception:</code></div><div class="line number23 index22 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py functions">print</code> <code class="py plain">&gt;&gt;sys.stderr, </code><code class="py string">'Cummingsify failed!'</code></div><div class="line number24 index23 alt1">&nbsp;</div><div class="line number25 index24 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">defer.returnValue(poem)</code></div><div class="line number26 index25 alt1">&nbsp;</div><div class="line number27 index26 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">def</code> <code class="py plain">got_poem(poem):</code></div><div class="line number28 index27 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py functions">print</code> <code class="py plain">poem</code></div><div class="line number29 index28 alt2">&nbsp;</div><div class="line number30 index29 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">def</code> <code class="py plain">poem_done(_):</code></div><div class="line number31 index30 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">results.append(_)</code></div><div class="line number32 index31 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">if</code> <code class="py functions">len</code><code class="py plain">(results) </code><code class="py keyword">=</code><code class="py keyword">=</code> <code class="py functions">len</code><code class="py plain">(addresses):</code></div><div class="line number33 index32 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">reactor.stop()</code></div><div class="line number34 index33 alt1">&nbsp;</div><div class="line number35 index34 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">for</code> <code class="py plain">address </code><code class="py keyword">in</code> <code class="py plain">addresses:</code></div><div class="line number36 index35 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">host, port </code><code class="py keyword">=</code> <code class="py plain">address</code></div><div class="line number37 index36 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">d </code><code class="py keyword">=</code> <code class="py plain">get_transformed_poem(host, port)</code></div><div class="line number38 index37 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">d.addCallbacks(got_poem)</code></div><div class="line number39 index38 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">d.addBoth(poem_done)</code></div><div class="line number40 index39 alt1">&nbsp;</div><div class="line number41 index40 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">reactor.run()</code></div></div></td></tr></tbody></table></div></div>
<p>In our new version the <code>inlineCallbacks</code> generator function <code>get_transformed_poem</code> is responsible for both fetching the poem and then applying the transformation (via the transform service). Since both operations are asynchronous, we yield a deferred each time and then (implicitly) wait for the result. As in client 6.0, if the transformation fails we just return the original poem. Notice we can use <code>try</code>/<code>except</code> statements to handle asynchronous errors inside the generator.</p>
<p>We can test the new client out in the same way as before. First start up a transform server:</p>
<pre>python twisted-server-1/tranformedpoetry.py --port 10001</pre>
<p>Then start a couple of poetry servers:</p>
<pre>python twisted-server-1/fastpoetry.py --port 10002 poetry/fascination.txt
python twisted-server-1/fastpoetry.py --port 10003 poetry/science.txt</pre>
<p>Now you can run the new client:</p>
<pre>python twisted-client-7/get-poetry.py 10001 10002 10003</pre>
<p>Try turning off one or more of the servers to see how the client handles errors.</p>
<h3>Discussion</h3>
<p>Like the <code>Deferred</code> object, the <code>inlineCallbacks</code> function gives us a new way of organizing our asynchronous callbacks. And, as with deferreds, <code>inlineCallbacks</code> doesn't change the rules of the game. Specifically, our callbacks still run one at a time, and they are still invoked by the reactor. We can confirm that fact in our usual way by printing out a traceback from an inline callback, as in the example script <a href="http://github.com/jdavisp3/twisted-intro/blob/master/inline-callbacks/inline-callbacks-tb.py#L1"><tt>inline-callbacks/inline-callbacks-tb.py</tt></a>. Run that code and you will get a traceback with <code>reactor.run()</code> at the top, lots of helper functions in between, and our callback at the bottom.</p>
<p>We can adapt Figure 29, which explains what happens when one callback in a deferred returns another deferred, to show what happens when an <code>inlineCallbacks</code> generator <code>yield</code>s a deferred. See Figure 36:</p>
<div id="attachment_2533" class="wp-caption alignnone" style="width: 639px"><a href="img/inline-callbacks1.png"><img width="629" height="582" class="size-full wp-image-2533" title="Figure 36: flow control in an inlineCallbacks function" src="img/inline-callbacks1.png" alt="Figure 36: flow control in an inlineCallbacks function"></a><p class="wp-caption-text">Figure 36: flow control in an inlineCallbacks function</p></div>
<p>The same figure works in both cases because the idea being illustrated is the same &mdash; one asynchronous operation is waiting for another.</p>
<p>Since <code>inlineCallbacks</code> and deferreds solve many of the same problems, why choose one over the other? Here are some potential advantages of <code>inlineCallbacks</code>:</p>
<ul>
<li>Since the callbacks share a namespace, there is no need to pass extra state around.</li>
<li>The callback order is easier to see, as they just execute from top to bottom.</li>
<li>With no function declarations for individual callbacks and implicit flow-control, there is generally less typing.</li>
<li>Errors are handled with the familiar <code>try</code>/<code>except</code> statement.</li>
</ul>
<p>And here are some potential pitfalls:</p>
<ul>
<li>The callbacks inside the generator cannot be invoked individually, which could make code re-use difficult. With a deferred, the code constructing the deferred is free to add arbitrary callbacks in an arbitrary order.</li>
<li>The compact form of a generator can obscure the fact that an asynchronous callback is even involved. Despite its visually similar appearance to an ordinary sequential function, a generator behaves in a very different manner. The <code>inlineCallbacks</code> function is not a way to avoid learning the asynchronous programming model.</li>
</ul>
<p>As with any technique, practice will provide the experience necessary to make an informed choice.</p>
<h3>Summary</h3>
<p>In this Part we learned about the <code>inlineCallbacks</code> decorator and how it allows us to express a sequence of asynchronous callbacks in the form of a Python generator.</p>
<p>In <a href="http://krondo.com/wp-content/uploads/2009/08/twisted-intro.html?p=2571">Part 18</a> we will learn a technique for managing a set of "parallel" asynchronous operations.</p>
<h3>Suggested Exercises</h3>
<ol>
<li>Why is the <code>inlineCallbacks</code> function plural?</li>
<li>Study the implementation of <a href="http://twistedmatrix.com/trac/browser/tags/releases/twisted-10.1.0/twisted/internet/defer.py#973"><code>inlineCallbacks</code></a> and its helper function <a href="http://twistedmatrix.com/trac/browser/tags/releases/twisted-10.1.0/twisted/internet/defer.py#L874"><code>_inlineCallbacks</code></a>. Ponder the phrase "the devil is in the details".</li>
<li>How many callbacks are contained in a generator with <strong>N</strong> <code>yield</code> statements, assuming it has no loops or <code>if</code> statements?</li>
<li>Poetry client 7.0 might have three generators running at once. Conceptually, how many different ways might they be interleaved with one another? Considering the way they are invoked in the poetry client and the implementation of <code>inlineCallbacks</code>, how many ways do you think are actually possible?</li>
<li>Move the <code>got_poem</code> callback in client 7.0 inside the generator.</li>
<li>Then move the <code>poem_done</code> callback inside the generator. Be careful! Make sure to handle all the failure cases so the reactor gets shutdown no matter what. How does the resulting code compare to using a deferred to shutdown the reactor?</li>
<li>A generator with <code>yield</code> statements inside a <code>while</code> loop can represent a conceptually infinite sequence. What does such a generator decorated with <code>inlineCallbacks</code> represent?</li>
</ol>
<!-- JOLIPRINT BUTTON BEGINS --><script type="text/javascript">
&amp;amp;amp;amp;amp;amp;amp;lt;!--
try{
$joliprint().set('format','json').set('callback','joliprint_getPdf').set('service','wp-plugin').set('url','http://krondo.com/?p=2441').set('title','Print with Joliprint').set('urloptions','ver=1.1.5').set( 'label', 'joliprint' ).set( 'labelposition', 'after' ).set( 'button', 'joliprint-icon' ).write();
}catch(e){

}
--&amp;amp;amp;amp;amp;amp;amp;gt;</script><!-- JOLIPRINT BUTTON ENDS -->		<div class="fixed"></div>
			</div>
</div>

<div id="post-2571" class="post">
	
	

	<div class="content">
		<h2>Part 18: Deferreds En Masse</h2>
<p>This continues the introduction started <a href="http://krondo.com/wp-content/uploads/2009/08/twisted-intro.html?p=1209">here</a>. You can find an index to the entire series <a href="http://krondo.com/wp-content/uploads/2009/08/twisted-intro.html?p=1327">here</a>.</p>
<h3>Introduction</h3>
<p>In the last Part we learned a new way of structuring sequential asynchronous callbacks using a generator. Thus, including deferreds, we now have two techniques for chaining asynchronous operations together.</p>
<p>Sometimes, though, we want to run a group of asynchronous operations in "parallel". Since Twisted is single-threaded they won't really run concurrently, but the point is we want to use asynchronous I/O to work on a group of tasks as fast as possible. Our poetry clients, for example, download poems from multiple servers at the same time, rather than one server after another. That was the whole point of using Twisted for getting poetry, after all.</p>
<p>And, as a result, all our poetry clients have had to solve this problem: how do you know when all the asynchronous operations you have started are done? So far we have solved this by collecting our results into a list (like the <a href="http://github.com/jdavisp3/twisted-intro/blob/master/twisted-client-7/get-poetry.py#L160"><code>results</code></a> list in client 7.0) and checking the length of the list. We have to be careful to collect failures as well as successful results, otherwise a single failure will cause the program to run forever, thinking there's still work left to do.</p>
<p>As you might expect, Twisted includes an abstraction you can use to solve this problem and we're going to take a look at it today.</p>
<h3>The DeferredList</h3>
<p>The <a href="http://twistedmatrix.com/trac/browser/tags/releases/twisted-10.1.0/twisted/internet/defer.py#593"><code>DeferredList</code></a> class allows us to treat a list of deferred objects as a single deferred. That way we can start a bunch of asynchronous operations and get notified only when all of them have finished (regardless of whether they succeeded or failed). Let's look at some examples.</p>
<p>In <a href="http://github.com/jdavisp3/twisted-intro/blob/master/deferred-list/deferred-list-1.py#L1"><tt>deferred-list/deferred-list-1.py</tt></a> you will find this code:</p>
<div><div class="syntaxhighlighter  py" id="highlighter_305112"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py keyword">from</code> <code class="py plain">twisted.internet </code><code class="py keyword">import</code> <code class="py plain">defer</code></div><div class="line number2 index1 alt1">&nbsp;</div><div class="line number3 index2 alt2"><code class="py keyword">def</code> <code class="py plain">got_results(res):</code></div><div class="line number4 index3 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py functions">print</code> <code class="py string">'We got:'</code><code class="py plain">, res</code></div><div class="line number5 index4 alt2">&nbsp;</div><div class="line number6 index5 alt1"><code class="py functions">print</code> <code class="py string">'Empty List.'</code></div><div class="line number7 index6 alt2"><code class="py plain">d </code><code class="py keyword">=</code> <code class="py plain">defer.DeferredList([])</code></div><div class="line number8 index7 alt1"><code class="py functions">print</code> <code class="py string">'Adding Callback.'</code></div><div class="line number9 index8 alt2"><code class="py plain">d.addCallback(got_results)</code></div></div></td></tr></tbody></table></div></div>
<p>And if you run it, you will get this output:</p>
<pre>Empty List.
Adding Callback.
We got: []</pre>
<p>Some things to notice:</p>
<ul>
<li>A <code>DeferredList</code> is created from a Python <code>list</code>. In this case the list is empty, but we'll soon see that the list elements must all be <code>Deferred</code> objects.</li>
<li>A <code>DeferredList</code> is itself a deferred (it inherits from <code>Deferred</code>). That means you can add callbacks and errbacks to it just like you would a regular deferred.</li>
<li>In the example above, our callback was fired as soon as we added it, so the <code>DeferredList</code> must have fired right away. We'll discuss that more in a second.</li>
<li>The result of the deferred list was itself a list (empty).</li>
</ul>
<p>Now look at <a href="http://github.com/jdavisp3/twisted-intro/blob/master/deferred-list/deferred-list-2.py#L1"><tt>deferred-list/deferred-list-2.py</tt></a>:</p>
<div><div class="syntaxhighlighter  py" id="highlighter_882888"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py keyword">from</code> <code class="py plain">twisted.internet </code><code class="py keyword">import</code> <code class="py plain">defer</code></div><div class="line number2 index1 alt1">&nbsp;</div><div class="line number3 index2 alt2"><code class="py keyword">def</code> <code class="py plain">got_results(res):</code></div><div class="line number4 index3 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py functions">print</code> <code class="py string">'We got:'</code><code class="py plain">, res</code></div><div class="line number5 index4 alt2">&nbsp;</div><div class="line number6 index5 alt1"><code class="py functions">print</code> <code class="py string">'One Deferred.'</code></div><div class="line number7 index6 alt2"><code class="py plain">d1 </code><code class="py keyword">=</code> <code class="py plain">defer.Deferred()</code></div><div class="line number8 index7 alt1"><code class="py plain">d </code><code class="py keyword">=</code> <code class="py plain">defer.DeferredList([d1])</code></div><div class="line number9 index8 alt2"><code class="py functions">print</code> <code class="py string">'Adding Callback.'</code></div><div class="line number10 index9 alt1"><code class="py plain">d.addCallback(got_results)</code></div><div class="line number11 index10 alt2"><code class="py functions">print</code> <code class="py string">'Firing d1.'</code></div><div class="line number12 index11 alt1"><code class="py plain">d1.callback(</code><code class="py string">'d1 result'</code><code class="py plain">)</code></div></div></td></tr></tbody></table></div></div>
<p>Now we are creating our <code>DeferredList</code> with a 1-element list containing a single deferred. Here's the output we get:</p>
<pre>One Deferred.
Adding Callback.
Firing d1.
We got: [(True, 'd1 result')]</pre>
<p>More things to notice:</p>
<ul>
<li>This time the <code>DeferredList</code> didn't fire its callback until we fired the deferred in the list.</li>
<li>The result is still a list, but now it has one element.</li>
<li>The element is a tuple whose second value is the result of the deferred in the list.</li>
</ul>
<p>Let's try putting two deferreds in the list (<a href="http://github.com/jdavisp3/twisted-intro/blob/master/deferred-list/deferred-list-1.py#L3"><tt>deferred-list/deferred-list-3.py</tt></a>):</p>
<div><div class="syntaxhighlighter  py" id="highlighter_274935"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py keyword">from</code> <code class="py plain">twisted.internet </code><code class="py keyword">import</code> <code class="py plain">defer</code></div><div class="line number2 index1 alt1">&nbsp;</div><div class="line number3 index2 alt2"><code class="py keyword">def</code> <code class="py plain">got_results(res):</code></div><div class="line number4 index3 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py functions">print</code> <code class="py string">'We got:'</code><code class="py plain">, res</code></div><div class="line number5 index4 alt2">&nbsp;</div><div class="line number6 index5 alt1"><code class="py functions">print</code> <code class="py string">'Two Deferreds.'</code></div><div class="line number7 index6 alt2"><code class="py plain">d1 </code><code class="py keyword">=</code> <code class="py plain">defer.Deferred()</code></div><div class="line number8 index7 alt1"><code class="py plain">d2 </code><code class="py keyword">=</code> <code class="py plain">defer.Deferred()</code></div><div class="line number9 index8 alt2"><code class="py plain">d </code><code class="py keyword">=</code> <code class="py plain">defer.DeferredList([d1, d2])</code></div><div class="line number10 index9 alt1"><code class="py functions">print</code> <code class="py string">'Adding Callback.'</code></div><div class="line number11 index10 alt2"><code class="py plain">d.addCallback(got_results)</code></div><div class="line number12 index11 alt1"><code class="py functions">print</code> <code class="py string">'Firing d1.'</code></div><div class="line number13 index12 alt2"><code class="py plain">d1.callback(</code><code class="py string">'d1 result'</code><code class="py plain">)</code></div><div class="line number14 index13 alt1"><code class="py functions">print</code> <code class="py string">'Firing d2.'</code></div><div class="line number15 index14 alt2"><code class="py plain">d2.callback(</code><code class="py string">'d2 result'</code><code class="py plain">)</code></div></div></td></tr></tbody></table></div></div>
<p>And here's the output:</p>
<pre>Two Deferreds.
Adding Callback.
Firing d1.
Firing d2.
We got: [(True, 'd1 result'), (True, 'd2 result')]</pre>
<p>At this point it's pretty clear the result of a <code>DeferredList</code>, at least for the way we've been using it, is a list with the same number of elements as the list of deferreds we passed to the constructor. And the elements of that result list contain the results of the original deferreds, at least if the deferreds succeed. That means the <code>DeferredList</code> itself doesn't fire until all the deferreds in the original list have fired. And a <code>DeferredList</code> created with an empty list fires right away since there aren't any deferreds to wait for.</p>
<p>What about the order of the results in the final list? Consider <a href="http://github.com/jdavisp3/twisted-intro/blob/master/deferred-list/deferred-list-4.py#L1"><tt>deferred-list/deferred-list-4.py</tt></a>:</p>
<div><div class="syntaxhighlighter  py" id="highlighter_573831"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py keyword">from</code> <code class="py plain">twisted.internet </code><code class="py keyword">import</code> <code class="py plain">defer</code></div><div class="line number2 index1 alt1">&nbsp;</div><div class="line number3 index2 alt2"><code class="py keyword">def</code> <code class="py plain">got_results(res):</code></div><div class="line number4 index3 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py functions">print</code> <code class="py string">'We got:'</code><code class="py plain">, res</code></div><div class="line number5 index4 alt2">&nbsp;</div><div class="line number6 index5 alt1"><code class="py functions">print</code> <code class="py string">'Two Deferreds.'</code></div><div class="line number7 index6 alt2"><code class="py plain">d1 </code><code class="py keyword">=</code> <code class="py plain">defer.Deferred()</code></div><div class="line number8 index7 alt1"><code class="py plain">d2 </code><code class="py keyword">=</code> <code class="py plain">defer.Deferred()</code></div><div class="line number9 index8 alt2"><code class="py plain">d </code><code class="py keyword">=</code> <code class="py plain">defer.DeferredList([d1, d2])</code></div><div class="line number10 index9 alt1"><code class="py functions">print</code> <code class="py string">'Adding Callback.'</code></div><div class="line number11 index10 alt2"><code class="py plain">d.addCallback(got_results)</code></div><div class="line number12 index11 alt1"><code class="py functions">print</code> <code class="py string">'Firing d2.'</code></div><div class="line number13 index12 alt2"><code class="py plain">d2.callback(</code><code class="py string">'d2 result'</code><code class="py plain">)</code></div><div class="line number14 index13 alt1"><code class="py functions">print</code> <code class="py string">'Firing d1.'</code></div><div class="line number15 index14 alt2"><code class="py plain">d1.callback(</code><code class="py string">'d1 result'</code><code class="py plain">)</code></div></div></td></tr></tbody></table></div></div>
<p>Now we are firing <code>d2</code> first and then <code>d1</code>. Note the deferred list is still constructed with <code>d1</code> and <code>d2</code> in their original order. Here's the output:</p>
<pre>Two Deferreds.
Adding Callback.
Firing d2.
Firing d1.
We got: [(True, 'd1 result'), (True, 'd2 result')]</pre>
<p>The output list has the results in the same order as the original list of deferreds, not the order those deferreds happened to fire in. Which is very nice, because we can easily associate each individual result with the operation that generated it (for example, which poem came from which server).</p>
<p>Alright, what happens if one or more of the deferreds in the list fails? And what are those <code>True</code> values doing there? Let's try the example in <a href="http://github.com/jdavisp3/twisted-intro/blob/master/deferred-list/deferred-list-5.py#L1"><tt>deferred-list/deferred-list-5.py</tt></a>:</p>
<div><div class="syntaxhighlighter  py" id="highlighter_751819"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py keyword">from</code> <code class="py plain">twisted.internet </code><code class="py keyword">import</code> <code class="py plain">defer</code></div><div class="line number2 index1 alt1">&nbsp;</div><div class="line number3 index2 alt2"><code class="py keyword">def</code> <code class="py plain">got_results(res):</code></div><div class="line number4 index3 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py functions">print</code> <code class="py string">'We got:'</code><code class="py plain">, res</code></div><div class="line number5 index4 alt2">&nbsp;</div><div class="line number6 index5 alt1"><code class="py plain">d1 </code><code class="py keyword">=</code> <code class="py plain">defer.Deferred()</code></div><div class="line number7 index6 alt2"><code class="py plain">d2 </code><code class="py keyword">=</code> <code class="py plain">defer.Deferred()</code></div><div class="line number8 index7 alt1"><code class="py plain">d </code><code class="py keyword">=</code> <code class="py plain">defer.DeferredList([d1, d2], consumeErrors</code><code class="py keyword">=</code><code class="py color1">True</code><code class="py plain">)</code></div><div class="line number9 index8 alt2"><code class="py plain">d.addCallback(got_results)</code></div><div class="line number10 index9 alt1"><code class="py functions">print</code> <code class="py string">'Firing d1.'</code></div><div class="line number11 index10 alt2"><code class="py plain">d1.callback(</code><code class="py string">'d1 result'</code><code class="py plain">)</code></div><div class="line number12 index11 alt1"><code class="py functions">print</code> <code class="py string">'Firing d2 with errback.'</code></div><div class="line number13 index12 alt2"><code class="py plain">d2.errback(Exception(</code><code class="py string">'d2 failure'</code><code class="py plain">))</code></div></div></td></tr></tbody></table></div></div>
<p>Now we are firing <code>d1</code> with a normal result and <code>d2</code> with an error. Ignore the <code>consumerErrors</code> option for now, we'll get back to it. Here's the output:</p>
<pre>Firing d1.
Firing d2 with errback.
We got: [(True, 'd1 result'), (False, &lt;twisted.python.failure.Failure &lt;type 'exceptions.Exception'&gt;&gt;)]</pre>
<p>Now the tuple corresponding to <code>d2</code> has a <code>Failure</code> in slot two, and <code>False</code> in slot one. At this point it should be pretty clear how a <code>DeferredList</code> works (but see the Discussion below):</p>
<ul>
<li>A <code>DeferredList</code> is constructed with a list of deferred objects.</li>
<li>A <code>DeferredList</code> is itself a deferred whose result is a list of the same length as the list of deferreds.</li>
<li>The <code>DeferredList</code> fires after all the deferreds in the original list have fired.</li>
<li>Each element of the result list corresponds to the deferred in the same position as the original list. If that deferred succeeded, the element is <code>(True, result)</code> and if the deferred failed, the element is <code>(False, failure)</code>.</li>
<li>A <code>DeferredList</code> never fails, since the result of each individual deferred is collected into the list no matter what (but again, see the Discussion below).</li>
</ul>
<p>Now let's talk about that <code>consumeErrors</code> option we passed to the <code>DeferredList</code>. If we run the same code but without passing the option (<a href="http://github.com/jdavisp3/twisted-intro/blob/master/deferred-list/deferred-list-6.py#L1"><tt>deferred-list/deferred-list-6.py</tt></a>), we get this output:</p>
<pre>Firing d1.
Firing d2 with errback.
We got: [(True, 'd1 result'), (False, &gt;twisted.python.failure.Failure &gt;type 'exceptions.Exception'&lt;&lt;)]
Unhandled error in Deferred:
Traceback (most recent call last):
Failure: exceptions.Exception: d2 failure</pre>
<p>If you recall, the "Unhandled error in Deferred" message is generated when a deferred is garbage collected and the last callback in that deferred failed. The message is telling us we haven't caught all the potential asynchronous failures in our program. So where is it coming from in our example? It's clearly not coming from the <code>DeferredList</code>, since that succeeds. So it must be coming from <code>d2</code>.</p>
<p>A <code>DeferredList</code> needs to know when each deferred it is monitoring fires. And the <code>DeferredList</code> does that in the usual way &mdash; by adding a callback and errback to each deferred. And by default, the callback (and errback) return the original result (or failure) after putting it in the final list. And since returning the original failure from the errback triggers the next errback, <code>d2</code> remains in the failed state after it fires.</p>
<p>But if we pass <code>consumeErrors=True</code> to the <code>DeferredList</code>, the errback added by the <code>DeferredList</code> to each deferred will instead return <code>None</code>, thus "consuming" the error and eliminating the warning message. We could also handle the error by adding our own errback to <code>d2</code>, as in <a href="http://github.com/jdavisp3/twisted-intro/blob/master/deferred-list/deferred-list-7.py#L1"><tt>deferred-list/deferred-list-7.py</tt></a>.</p>
<h3>Client 8.0</h3>
<p>Version 8.0 of our Get Poetry Now! client uses a <code>DeferredList</code> to find out when all the poetry has finished (or failed). You can find the new client in <a href="http://github.com/jdavisp3/twisted-intro/blob/master/twisted-client-8/get-poetry.py#L1"><tt>twisted-client-8/get-poetry.py</tt></a>. Once again the only change is in <a href="http://github.com/jdavisp3/twisted-intro/blob/master/twisted-client-8/get-poetry.py#L151"><code>poetry_main</code></a>. Let's look at the important changes:</p>
<div><div class="syntaxhighlighter  py" id="highlighter_271636"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py plain">...</code></div><div class="line number2 index1 alt1"><code class="py plain">ds </code><code class="py keyword">=</code> <code class="py plain">[]</code></div><div class="line number3 index2 alt2">&nbsp;</div><div class="line number4 index3 alt1"><code class="py keyword">for</code> <code class="py plain">(host, port) </code><code class="py keyword">in</code> <code class="py plain">addresses:</code></div><div class="line number5 index4 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">d </code><code class="py keyword">=</code> <code class="py plain">get_transformed_poem(host, port)</code></div><div class="line number6 index5 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">d.addCallbacks(got_poem)</code></div><div class="line number7 index6 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">ds.append(d)</code></div><div class="line number8 index7 alt1">&nbsp;</div><div class="line number9 index8 alt2"><code class="py plain">dlist </code><code class="py keyword">=</code> <code class="py plain">defer.DeferredList(ds, consumeErrors</code><code class="py keyword">=</code><code class="py color1">True</code><code class="py plain">)</code></div><div class="line number10 index9 alt1"><code class="py plain">dlist.addCallback(</code><code class="py keyword">lambda</code> <code class="py plain">res : reactor.stop())</code></div></div></td></tr></tbody></table></div></div>
<p>You may wish to compare it to the same section of <a href="http://github.com/jdavisp3/twisted-intro/blob/master/twisted-client-7/get-poetry.py#L180"><code>client 7.0</code></a>.</p>
<p>In client 8.0, we don't need the <code>poem_done</code> callback or the <code>results</code> list. Instead, we put each deferred we get back from <code>get_transformed_poem</code> into a list (<code>ds</code>) and then create a <code>DeferredList</code>. Since the <code>DeferredList</code> won't fire until all the poems have finished or failed, we just add a callback to the <code>DeferredList</code> to shutdown the reactor. In this case, we aren't using the result from the <code>DeferredList</code>, we just need to know when everything is finished. And that's it!</p>
<h3>Discussion</h3>
<p>We can visualize how a <code>DeferredList</code> works in Figure 37:<br>
</p><div style="width: 615px" class="wp-caption alignnone" id="attachment_2590"><a href="img/deferred-list.png"><img width="605" height="340" class="size-full wp-image-2590" title="Figure 37: the result of a DeferredList" alt="Figure 37: the result of a DeferredList" src="img/deferred-list.png"></a><p class="wp-caption-text">Figure 37: the result of a DeferredList</p></div><p></p>
<p>Pretty simple, really. There are a couple options to <code>DeferredList</code> we haven't covered, and which change the behavior from what we have described above. We will leave them for you to explore in the Exercises below.</p>
<p>In the <a href="http://krondo.com/wp-content/uploads/2009/08/twisted-intro.html?p=2601">next Part</a> we will cover one more feature of the <code>Deferred</code> class, a feature recently introduced in Twisted 10.1.0.</p>
<h3>Suggested Exercises</h3>
<ol>
<li>Read the <a href="http://twistedmatrix.com/trac/browser/tags/releases/twisted-10.1.0/twisted/internet/defer.py#5933">source code</a> for the <code>DeferredList</code>.</li>
<li>Modify the examples in <tt>deferred-list</tt> to experiment with the optional constructor arguments <code>fireOnOneCallback</code> and <code>fireOnOneErrback</code>. Come up with scenarios where you would use one or the other (or both).</li>
<li>Can you create a <code>DeferredList</code> using a list of <code>DeferredList</code>s? If so, what would the result look like?</li>
<li>Modify client 8.0 so that it doesn't print out anything until all the poems have finished downloading. This time you will use the result from the <code>DeferredList</code>.</li>
<li>Define the semantics of a <code>DeferredDict</code> and then implement it.</li>
</ol>
<!-- JOLIPRINT BUTTON BEGINS --><script type="text/javascript">
&amp;amp;amp;amp;amp;amp;lt;!--
try{
$joliprint().set('format','json').set('callback','joliprint_getPdf').set('service','wp-plugin').set('url','http://krondo.com/?p=2571').set('title','Print with Joliprint').set('urloptions','ver=1.1.5').set( 'label', 'joliprint' ).set( 'labelposition', 'after' ).set( 'button', 'joliprint-icon' ).write();
}catch(e){

}
--&amp;amp;amp;amp;amp;amp;gt;</script><!-- JOLIPRINT BUTTON ENDS -->		<div class="fixed"></div>
			</div>
</div>

<div class="post" id="post-2601">
	
	

	<div class="content">
		<h2>Part 19: I Thought I Wanted It But I Changed My Mind</h2>
<p>This continues the introduction started <a href="http://krondo.com/wp-content/uploads/2009/08/twisted-intro.html?p=1209">here</a>. You can find an index to the entire series <a href="http://krondo.com/wp-content/uploads/2009/08/twisted-intro.html?p=1327">here</a>.</p>
<h3>Introduction</h3>
<p>Twisted is an ongoing project and the Twisted developers regularly add new features and extend old ones. With the release of Twisted 10.1.0, the developers added a new capability &mdash; cancellation &mdash; to the <code>Deferred</code> class which we're going to investigate today.</p>
<p>Asynchronous programming decouples requests from responses and thus raises a new possibility: between asking for the result and getting it back you might decide you don't want it anymore. Consider the poetry proxy server from <a href="http://krondo.com/wp-content/uploads/2009/08/twisted-intro.html?p=2205">Part 14</a>. Here's how the proxy worked, at least for the first request of a poem:</p>
<ol>
<li>A request for a poem comes in.</li>
<li>The proxy contacts the real server to get the poem.</li>
<li>Once the poem is complete, send it to the original client.</li>
</ol>
<p>Which is all well and good, but what if the client hangs up before getting the poem? Maybe they requested the complete text of <a href="http://www.online-literature.com/milton/paradiselost/">Paradise Lost</a> and then decided they really wanted a haiku by <a href="http://www.toyomasu.com/haiku/#kojo">Kojo</a>. Now our proxy is stuck with downloading the first one and that slow server is going to take a while. Better to close the connection and let the slow server go back to sleep.</p>
<p>Recall <a href="http://krondo.com/?p=1825#figure15">Figure 15</a>, a diagram that shows the conceptual flow of control in a synchronous program. In that figure we see function calls going down, and exceptions going back up. If we wanted to cancel a synchronous function call (and this is just hypothetical) the flow control would go in the same direction as the function call, from high-level code to low-level code as in Figure 38:</p>
<div id="attachment_2614" class="wp-caption alignnone" style="width: 386px"><a href="img/sync-cancel.png"><img width="376" height="257" class="size-full wp-image-2614" title="Figure 38: synchronous program flow, with hypothetical cancellation" src="img/sync-cancel.png" alt="Figure 38: synchronous program flow, with hypothetical cancellation"></a><p class="wp-caption-text">Figure 38: synchronous program flow, with hypothetical cancellation</p></div>
<p>Of course, in a synchronous program that isn't possible because the high-level code doesn't even resume running until the low-level operation is finished, at which point there is nothing to cancel. But in an asynchronous program the high-level code gets control of the program before the low-level code is done, which at least raises the possibility of canceling the low-level request before it finishes.</p>
<p>In a Twisted program, the lower-level request is embodied by a <code>Deferred</code> object, which you can think of as a "handle" on the outstanding asynchronous operation. The normal flow of information in a deferred is downward, from low-level code to high-level code, which matches the flow of return information in a synchronous program. Starting in Twisted 10.1.0, high-level code can send information back the other direction &mdash; it can tell the low-level code it doesn't want the result anymore. See Figure 39:</p>
<div id="attachment_2621" class="wp-caption alignnone" style="width: 406px"><a href="img/deferred-cancel.png"><img width="396" height="242" class="size-full wp-image-2621" title="Figure 39: Information flow in a deferred, including cancellation" src="img/deferred-cancel.png" alt="Figure 39: Information flow in a deferred, including cancellation"></a><p class="wp-caption-text">Figure 39: Information flow in a deferred, including cancellation</p></div>
<h3>Canceling Deferreds</h3>
<p>Let's take a look at a few sample programs to see how canceling deferreds actually works. Note, to run the examples and other code in this Part you will need a <a href="http://twistedmatrix.com/trac/wiki/Downloads">version</a> of Twisted 10.1.0 or later. Consider <a href="http://github.com/jdavisp3/twisted-intro/blob/master/deferred-cancel/defer-cancel-1.py#L1"><tt>deferred-cancel/defer-cancel-1.py</tt></a>:</p>
<div><div id="highlighter_915395" class="syntaxhighlighter  py"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py keyword">from</code> <code class="py plain">twisted.internet </code><code class="py keyword">import</code> <code class="py plain">defer</code></div><div class="line number2 index1 alt1">&nbsp;</div><div class="line number3 index2 alt2"><code class="py keyword">def</code> <code class="py plain">callback(res):</code></div><div class="line number4 index3 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py functions">print</code> <code class="py string">'callback got:'</code><code class="py plain">, res</code></div><div class="line number5 index4 alt2">&nbsp;</div><div class="line number6 index5 alt1"><code class="py plain">d </code><code class="py keyword">=</code> <code class="py plain">defer.Deferred()</code></div><div class="line number7 index6 alt2"><code class="py plain">d.addCallback(callback)</code></div><div class="line number8 index7 alt1"><code class="py plain">d.cancel()</code></div><div class="line number9 index8 alt2"><code class="py functions">print</code> <code class="py string">'done'</code></div></div></td></tr></tbody></table></div></div>
<p>With the new cancellation feature, the <code>Deferred</code> class got a new method called <code>cancel</code>. The example code makes a new deferred, adds a callback, and then cancels the deferred without firing it. Here's the output:</p>
<pre>done
Unhandled error in Deferred:
Traceback (most recent call last):
Failure: twisted.internet.defer.CancelledError:</pre>
<p>Ok, so canceling a deferred appears to cause the errback chain to run, and our regular callback is never called at all. Also notice the error is a <code>twisted.internet.defer.CancelledError</code>, a custom Exception that means the deferred was canceled (but keep reading!). Let's try adding an errback in <a href="http://github.com/jdavisp3/twisted-intro/blob/master/deferred-cancel/defer-cancel-2.py#L1"><tt>deferred-cancel/defer-cancel-2.py</tt></a>:</p>
<div><div id="highlighter_119927" class="syntaxhighlighter  py"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py keyword">from</code> <code class="py plain">twisted.internet </code><code class="py keyword">import</code> <code class="py plain">defer</code></div><div class="line number2 index1 alt1">&nbsp;</div><div class="line number3 index2 alt2"><code class="py keyword">def</code> <code class="py plain">callback(res):</code></div><div class="line number4 index3 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py functions">print</code> <code class="py string">'callback got:'</code><code class="py plain">, res</code></div><div class="line number5 index4 alt2">&nbsp;</div><div class="line number6 index5 alt1"><code class="py keyword">def</code> <code class="py plain">errback(err):</code></div><div class="line number7 index6 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py functions">print</code> <code class="py string">'errback got:'</code><code class="py plain">, err</code></div><div class="line number8 index7 alt1">&nbsp;</div><div class="line number9 index8 alt2"><code class="py plain">d </code><code class="py keyword">=</code> <code class="py plain">defer.Deferred()</code></div><div class="line number10 index9 alt1"><code class="py plain">d.addCallbacks(callback, errback)</code></div><div class="line number11 index10 alt2"><code class="py plain">d.cancel()</code></div><div class="line number12 index11 alt1"><code class="py functions">print</code> <code class="py string">'done'</code></div></div></td></tr></tbody></table></div></div>
<p>Now we get this output:</p>
<pre>errback got: [Failure instance: Traceback (failure with no frames): &lt;class 'twisted.internet.defer.CancelledError'&gt;:
]
done</pre>
<p>So we can 'catch' the errback from a cancel just like any other deferred failure.</p>
<p>Ok, let's try firing the deferred and then canceling it, as in <a href="http://github.com/jdavisp3/twisted-intro/blob/master/deferred-cancel/defer-cancel-3.py#L1"><tt>deferred-cancel/defer-cancel-3.py</tt></a>:</p>
<div><div id="highlighter_341830" class="syntaxhighlighter  py"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py keyword">from</code> <code class="py plain">twisted.internet </code><code class="py keyword">import</code> <code class="py plain">defer</code></div><div class="line number2 index1 alt1">&nbsp;</div><div class="line number3 index2 alt2"><code class="py keyword">def</code> <code class="py plain">callback(res):</code></div><div class="line number4 index3 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py functions">print</code> <code class="py string">'callback got:'</code><code class="py plain">, res</code></div><div class="line number5 index4 alt2">&nbsp;</div><div class="line number6 index5 alt1"><code class="py keyword">def</code> <code class="py plain">errback(err):</code></div><div class="line number7 index6 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py functions">print</code> <code class="py string">'errback got:'</code><code class="py plain">, err</code></div><div class="line number8 index7 alt1">&nbsp;</div><div class="line number9 index8 alt2"><code class="py plain">d </code><code class="py keyword">=</code> <code class="py plain">defer.Deferred()</code></div><div class="line number10 index9 alt1"><code class="py plain">d.addCallbacks(callback, errback)</code></div><div class="line number11 index10 alt2"><code class="py plain">d.callback(</code><code class="py string">'result'</code><code class="py plain">)</code></div><div class="line number12 index11 alt1"><code class="py plain">d.cancel()</code></div><div class="line number13 index12 alt2"><code class="py functions">print</code> <code class="py string">'done'</code></div></div></td></tr></tbody></table></div></div>
<p>Here we fire the deferred normally with the <code>callback</code> method and then cancel it. Here's the output:</p>
<pre>callback got: result
done</pre>
<p>Our callback was invoked (just as we would expect) and then the program finished normally, as if <code>cancel</code> was never called at all. So it seems canceling a deferred has no effect if it has already fired (but keep reading!).</p>
<p>What if we fire the deferred <em>after</em> we cancel it, as in <a href="http://github.com/jdavisp3/twisted-intro/blob/master/deferred-cancel/defer-cancel-4.py#L1"><tt>deferred-cancel/defer-cancel-4.py</tt></a>?</p>
<div><div id="highlighter_36438" class="syntaxhighlighter  py"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py keyword">from</code> <code class="py plain">twisted.internet </code><code class="py keyword">import</code> <code class="py plain">defer</code></div><div class="line number2 index1 alt1">&nbsp;</div><div class="line number3 index2 alt2"><code class="py keyword">def</code> <code class="py plain">callback(res):</code></div><div class="line number4 index3 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py functions">print</code> <code class="py string">'callback got:'</code><code class="py plain">, res</code></div><div class="line number5 index4 alt2">&nbsp;</div><div class="line number6 index5 alt1"><code class="py keyword">def</code> <code class="py plain">errback(err):</code></div><div class="line number7 index6 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py functions">print</code> <code class="py string">'errback got:'</code><code class="py plain">, err</code></div><div class="line number8 index7 alt1">&nbsp;</div><div class="line number9 index8 alt2"><code class="py plain">d </code><code class="py keyword">=</code> <code class="py plain">defer.Deferred()</code></div><div class="line number10 index9 alt1"><code class="py plain">d.addCallbacks(callback, errback)</code></div><div class="line number11 index10 alt2"><code class="py plain">d.cancel()</code></div><div class="line number12 index11 alt1"><code class="py plain">d.callback(</code><code class="py string">'result'</code><code class="py plain">)</code></div><div class="line number13 index12 alt2"><code class="py functions">print</code> <code class="py string">'done'</code></div></div></td></tr></tbody></table></div></div>
<p>In that case we get this output:</p>
<pre>errback got: [Failure instance: Traceback (failure with no frames): &lt;class 'twisted.internet.defer.CancelledError'&gt;:
]
done</pre>
<p>Interesting! That's the same output as the second example, where we never fired the deferred at all. So if the deferred has been canceled, firing the deferred normally has no effect. But why doesn't <code>d.callback('result')</code> raise an error, since you're not supposed to be able to fire a deferred more than once, and the errback chain has clearly run?</p>
<p>Consider Figure 39 again. Firing a deferred with a result or failure is the job of lower-level code, while canceling a deferred is an action taken by higher-level code. Firing the deferred means "Here's your result", while canceling a deferred means "I don't want it any more". And remember that canceling is a new feature, so most existing Twisted code is not written to handle cancel operations. But the Twisted developers have made it possible for us to cancel any deferred we want to, even if the code we got the deferred from was written before Twisted 10.1.0.</p>
<p>To make that possible, the <code>cancel</code> method actually does two things:</p>
<ol>
<li>Tell the <code>Deferred</code> object <em>itself</em> that you don't want the result if it hasn't shown up yet (i.e, the deferred hasn't been fired), and thus to ignore any subsequent invocation of <code>callback</code> or <code>errback</code>.</li>
<li>And, <em>optionally</em>, tell the lower-level code that is producing the result to take whatever steps are required to cancel the operation.</li>
</ol>
<p>Since older Twisted code is going to go ahead and fire that canceled deferred anyway, step #1 ensures our program won't blow up if we cancel a deferred we got from an older library.</p>
<p>This means we are always free to cancel a deferred, and we'll be sure not to get the result if it hasn't arrived (even if it arrives later). But canceling the deferred might not actually cancel the asynchronous operation. Aborting an asynchronous operation requires a context-specific action. You might need to close a network connection, roll back a database transaction, kill a sub-process, et cetera. And since a deferred is just a general-purpose callback organizer, how is it supposed to know what specific action to take when you cancel it? Or, alternatively, how could it forward the cancel request to the lower-level code that created and returned the deferred in the first place? Say it with me now:</p>
<blockquote><p>I know, with a callback!</p></blockquote>
<h3>Canceling Deferreds, Really</h3>
<p>Alright, take a look at <a href="http://github.com/jdavisp3/twisted-intro/blob/master/deferred-cancel/defer-cancel-5.py#L1"><tt>deferred-cancel/defer-cancel-5.py</tt></a>:</p>
<div><div id="highlighter_637207" class="syntaxhighlighter  py"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py keyword">from</code> <code class="py plain">twisted.internet </code><code class="py keyword">import</code> <code class="py plain">defer</code></div><div class="line number2 index1 alt1">&nbsp;</div><div class="line number3 index2 alt2"><code class="py keyword">def</code> <code class="py plain">canceller(d):</code></div><div class="line number4 index3 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py functions">print</code> <code class="py string">"I need to cancel this deferred:"</code><code class="py plain">, d</code></div><div class="line number5 index4 alt2">&nbsp;</div><div class="line number6 index5 alt1"><code class="py keyword">def</code> <code class="py plain">callback(res):</code></div><div class="line number7 index6 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py functions">print</code> <code class="py string">'callback got:'</code><code class="py plain">, res</code></div><div class="line number8 index7 alt1">&nbsp;</div><div class="line number9 index8 alt2"><code class="py keyword">def</code> <code class="py plain">errback(err):</code></div><div class="line number10 index9 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py functions">print</code> <code class="py string">'errback got:'</code><code class="py plain">, err</code></div><div class="line number11 index10 alt2">&nbsp;</div><div class="line number12 index11 alt1"><code class="py plain">d </code><code class="py keyword">=</code> <code class="py plain">defer.Deferred(canceller) </code><code class="py comments"># created by lower-level code</code></div><div class="line number13 index12 alt2"><code class="py plain">d.addCallbacks(callback, errback) </code><code class="py comments"># added by higher-level code</code></div><div class="line number14 index13 alt1"><code class="py plain">d.cancel()</code></div><div class="line number15 index14 alt2"><code class="py functions">print</code> <code class="py string">'done'</code></div></div></td></tr></tbody></table></div></div>
<p>This code is basically like the second example, except there is a third callback (<code>canceller</code>) that's passed to the <code>Deferred</code> when we create it, rather than added afterwards. This callback is in charge of performing the context-specific actions required to abort the asynchronous operation (only if the deferred is actually canceled, of course). The <code>canceller</code> callback is necessarily part of the lower-level code that returns the deferred, not the higher-level code that receives the deferred and adds its own callbacks and errbacks.</p>
<p>Running the example produces this output:</p>
<pre>I need to cancel this deferred: &lt;Deferred at 0xb7669d2cL&gt;
errback got: [Failure instance: Traceback (failure with no frames): &lt;class 'twisted.internet.defer.CancelledError'&gt;:
]
done</pre>
<p>As you can see, the <code>canceller</code> callback is given the deferred whose result we no longer want. That's where we would take whatever action we need to in order to abort the asynchronous operation. Notice that <code>canceller</code> is invoked before the errback chain fires. In fact, we may choose to fire the deferred ourselves at this point with any result or error of our choice (and thus preempting the <code>CancelledError</code> failure). Both possibilities are illustrated in <a href="http://github.com/jdavisp3/twisted-intro/blob/master/deferred-cancel/defer-cancel-6.py#L1"><tt>deferred-cancel/defer-cancel-6.py</tt></a> and <a href="http://github.com/jdavisp3/twisted-intro/blob/master/deferred-cancel/defer-cancel-7.py#L1"><tt>deferred-cancel/defer-cancel-7.py</tt></a>.</p>
<p>Let's do one more simple test before we fire up the reactor. We'll create a deferred with a <code>canceller</code> callback, fire it normally, and then cancel it. You can see the code in <a href="http://github.com/jdavisp3/twisted-intro/blob/master/deferred-cancel/defer-cancel-8.py#L1"><tt>deferred-cancel/defer-cancel-8.py</tt></a>. By examining the output of that script, you can see that canceling a deferred after it has been fired does <em>not</em> invoke the <code>canceller</code> callback. And that's as we would expect since there's nothing to cancel.</p>
<p>The examples we've looked at so far haven't had any actual asynchronous operations. Let's make a simple program that invokes one asynchronous operation, then we'll figure out how to make that operation cancellable. Consider the code in <a href="http://github.com/jdavisp3/twisted-intro/blob/master/deferred-cancel/defer-cancel-9.py#L1"><tt>deferred-cancel/defer-cancel-9.py</tt></a>:</p>
<div><div id="highlighter_851011" class="syntaxhighlighter  py"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div><div class="line number20 index19 alt1">20</div><div class="line number21 index20 alt2">21</div><div class="line number22 index21 alt1">22</div><div class="line number23 index22 alt2">23</div><div class="line number24 index23 alt1">24</div><div class="line number25 index24 alt2">25</div><div class="line number26 index25 alt1">26</div><div class="line number27 index26 alt2">27</div><div class="line number28 index27 alt1">28</div><div class="line number29 index28 alt2">29</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py keyword">from</code> <code class="py plain">twisted.internet.defer </code><code class="py keyword">import</code> <code class="py plain">Deferred</code></div><div class="line number2 index1 alt1">&nbsp;</div><div class="line number3 index2 alt2"><code class="py keyword">def</code> <code class="py plain">send_poem(d):</code></div><div class="line number4 index3 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py functions">print</code> <code class="py string">'Sending poem'</code></div><div class="line number5 index4 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">d.callback(</code><code class="py string">'Once upon a midnight dreary'</code><code class="py plain">)</code></div><div class="line number6 index5 alt1">&nbsp;</div><div class="line number7 index6 alt2"><code class="py keyword">def</code> <code class="py plain">get_poem():</code></div><div class="line number8 index7 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py comments">"""Return a poem 5 seconds later."""</code></div><div class="line number9 index8 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">from</code> <code class="py plain">twisted.internet </code><code class="py keyword">import</code> <code class="py plain">reactor</code></div><div class="line number10 index9 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">d </code><code class="py keyword">=</code> <code class="py plain">Deferred()</code></div><div class="line number11 index10 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">reactor.callLater(</code><code class="py value">5</code><code class="py plain">, send_poem, d)</code></div><div class="line number12 index11 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">return</code> <code class="py plain">d</code></div><div class="line number13 index12 alt2">&nbsp;</div><div class="line number14 index13 alt1"><code class="py keyword">def</code> <code class="py plain">got_poem(poem):</code></div><div class="line number15 index14 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py functions">print</code> <code class="py string">'I got a poem:'</code><code class="py plain">, poem</code></div><div class="line number16 index15 alt1">&nbsp;</div><div class="line number17 index16 alt2"><code class="py keyword">def</code> <code class="py plain">poem_error(err):</code></div><div class="line number18 index17 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py functions">print</code> <code class="py string">'get_poem failed:'</code><code class="py plain">, err</code></div><div class="line number19 index18 alt2">&nbsp;</div><div class="line number20 index19 alt1"><code class="py keyword">def</code> <code class="py plain">main():</code></div><div class="line number21 index20 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">from</code> <code class="py plain">twisted.internet </code><code class="py keyword">import</code> <code class="py plain">reactor</code></div><div class="line number22 index21 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">reactor.callLater(</code><code class="py value">10</code><code class="py plain">, reactor.stop) </code><code class="py comments"># stop the reactor in 10 seconds</code></div><div class="line number23 index22 alt2">&nbsp;</div><div class="line number24 index23 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">d </code><code class="py keyword">=</code> <code class="py plain">get_poem()</code></div><div class="line number25 index24 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">d.addCallbacks(got_poem, poem_error)</code></div><div class="line number26 index25 alt1">&nbsp;</div><div class="line number27 index26 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">reactor.run()</code></div><div class="line number28 index27 alt1">&nbsp;</div><div class="line number29 index28 alt2"><code class="py plain">main()</code></div></div></td></tr></tbody></table></div></div>
<p>This example includes a <code>get_poem</code> function that uses the reactor's <code>callLater</code> method to asynchronously return a poem five seconds after <code>get_poem</code> is called. The <code>main</code> function calls <code>get_poem</code>, adds a callback/errback pair, and then starts up the reactor. We also arrange (again using <code>callLater</code>) to stop the reactor in ten seconds. Normally we would do this by attaching a callback to the deferred, but you'll see why we do it this way shortly.</p>
<p>Running the example produces this output (after the appropriate delay):</p>
<pre>Sending poem
I got a poem: Once upon a midnight dreary</pre>
<p>And after ten seconds our little program comes to a stop. Now let's try canceling that deferred before the poem is sent. We'll just add this bit of code to cancel the deferred after two seconds (well before the five second delay on the poem itself):</p>
<pre>    reactor.callLater(2, d.cancel) # cancel after 2 seconds</pre>
<p>The complete program is in <a href="http://github.com/jdavisp3/twisted-intro/blob/master/deferred-cancel/defer-cancel-10.py#L1"><tt>deferred-cancel/defer-cancel-10.py</tt></a>, which produces the following output:</p>
<pre>get_poem failed: [Failure instance: Traceback (failure with no frames): &lt;class 'twisted.internet.defer.CancelledError'&gt;:
]
Sending poem
</pre>
<p>This example clearly illustrates that canceling a deferred does not necessarily cancel the underlying asynchronous request. After two seconds we see the output from our errback, printing out the <code>CancelledError</code> as we would expect. But then after five seconds will still see the output from <code>send_poem</code> (but the callback on the deferred doesn't fire).</p>
<p>At this point we're just in the same situation as <a href="http://github.com/jdavisp3/twisted-intro/blob/master/deferred-cancel/defer-cancel-4.py#L1"><tt>deferred-cancel/defer-cancel-4.py</tt></a>. "Canceling" the deferred causes the eventual result to be ignored, but doesn't abort the operation in any real sense. As we learned above, to make a truly cancelable deferred we must add a <code>cancel</code> callback when the deferred is created.</p>
<p>What does this new callback need to do? Take a look at the <a href="http://twistedmatrix.com/trac/browser/tags/releases/twisted-10.1.0/twisted/internet/interfaces.py#L556">documentation</a> for the <code>callLater</code> method. The return value of <code>callLater</code> is another object, implementing <code>IDelayedCall</code>, with a <code>cancel</code> method we can use to prevent the delayed call from being executed.</p>
<p>That's pretty simple, and the updated code is in <a href="http://github.com/jdavisp3/twisted-intro/blob/master/deferred-cancel/defer-cancel-11.py#L1"><tt>deferred-cancel/defer-cancel-11.py</tt></a>. The relevant changes are all in the <code>get_poem</code> function:</p>
<div><div id="highlighter_971783" class="syntaxhighlighter  py"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py keyword">def</code> <code class="py plain">get_poem():</code></div><div class="line number2 index1 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py comments">"""Return a poem 5 seconds later."""</code></div><div class="line number3 index2 alt2">&nbsp;</div><div class="line number4 index3 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">def</code> <code class="py plain">canceler(d):</code></div><div class="line number5 index4 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py comments"># They don't want the poem anymore, so cancel the delayed call</code></div><div class="line number6 index5 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">delayed_call.cancel()</code></div><div class="line number7 index6 alt2">&nbsp;</div><div class="line number8 index7 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py comments"># At this point we have three choices:</code></div><div class="line number9 index8 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py comments">#&nbsp;&nbsp; 1. Do nothing, and the deferred will fire the errback</code></div><div class="line number10 index9 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py comments">#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; chain with CancelledError.</code></div><div class="line number11 index10 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py comments">#&nbsp;&nbsp; 2. Fire the errback chain with a different error.</code></div><div class="line number12 index11 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py comments">#&nbsp;&nbsp; 3. Fire the callback chain with an alternative result.</code></div><div class="line number13 index12 alt2">&nbsp;</div><div class="line number14 index13 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">d </code><code class="py keyword">=</code> <code class="py plain">Deferred(canceler)</code></div><div class="line number15 index14 alt2">&nbsp;</div><div class="line number16 index15 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">from</code> <code class="py plain">twisted.internet </code><code class="py keyword">import</code> <code class="py plain">reactor</code></div><div class="line number17 index16 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">delayed_call </code><code class="py keyword">=</code> <code class="py plain">reactor.callLater(</code><code class="py value">5</code><code class="py plain">, send_poem, d)</code></div><div class="line number18 index17 alt1">&nbsp;</div><div class="line number19 index18 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">return</code> <code class="py plain">d</code></div></div></td></tr></tbody></table></div></div>
<p>In this new version, we save the return value from <code>callLater</code> so we can use it in our cancel callback. The only thing our callback needs to do is invoke <code>delayed_call.cancel()</code>. But as we discussed above, we could also choose to fire the deferred ourselves. The latest version of our example produces this output:</p>
<pre>get_poem failed: [Failure instance: Traceback (failure with no frames): &lt;class 'twisted.internet.defer.CancelledError'&gt;:
]</pre>
<p>As you can see, the deferred is canceled and the asynchronous operation has truly been aborted (i.e., we don't see the <code>print</code> output from <code>send_poem</code>).</p>
<h3>Poetry Proxy 3.0</h3>
<p>As we discussed in the Introduction, the poetry proxy server is a good candidate for implementing cancellation, as it allows us to abort the poem download if it turns out that nobody wants it (i.e., the client closes the connection before we send the poem). Version 3.0 of the proxy, located in <a href="http://github.com/jdavisp3/twisted-intro/blob/master/twisted-server-4/poetry-proxy.py#L1"><tt>twisted-server-4/poetry-proxy.py</tt></a>, implements deferred cancellation. The first change is in the <a href="http://github.com/jdavisp3/twisted-intro/blob/master/twisted-server-4/poetry-proxy.py#L52"><code>PoetryProxyProtocol</code></a>:</p>
<div><div id="highlighter_314813" class="syntaxhighlighter  py"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py keyword">class</code> <code class="py plain">PoetryProxyProtocol(Protocol):</code></div><div class="line number2 index1 alt1">&nbsp;</div><div class="line number3 index2 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">def</code> <code class="py plain">connectionMade(</code><code class="py color1">self</code><code class="py plain">):</code></div><div class="line number4 index3 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py color1">self</code><code class="py plain">.deferred </code><code class="py keyword">=</code> <code class="py color1">self</code><code class="py plain">.factory.service.get_poem()</code></div><div class="line number5 index4 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py color1">self</code><code class="py plain">.deferred.addCallback(</code><code class="py color1">self</code><code class="py plain">.transport.write)</code></div><div class="line number6 index5 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py color1">self</code><code class="py plain">.deferred.addBoth(</code><code class="py keyword">lambda</code> <code class="py plain">r: </code><code class="py color1">self</code><code class="py plain">.transport.loseConnection())</code></div><div class="line number7 index6 alt2">&nbsp;</div><div class="line number8 index7 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">def</code> <code class="py plain">connectionLost(</code><code class="py color1">self</code><code class="py plain">, reason):</code></div><div class="line number9 index8 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">if</code> <code class="py color1">self</code><code class="py plain">.deferred </code><code class="py keyword">is</code> <code class="py keyword">not</code> <code class="py color1">None</code><code class="py plain">:</code></div><div class="line number10 index9 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">deferred, </code><code class="py color1">self</code><code class="py plain">.deferred </code><code class="py keyword">=</code> <code class="py color1">self</code><code class="py plain">.deferred, </code><code class="py color1">None</code></div><div class="line number11 index10 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">deferred.cancel() </code><code class="py comments"># cancel the deferred if it hasn't fired</code></div></div></td></tr></tbody></table></div></div>
<p>You might compare it to the <a href="http://github.com/jdavisp3/twisted-intro/blob/master/twisted-server-2/poetry-proxy.py#L52">older version</a>. The two main changes are:</p>
<ol>
<li>Save the deferred we get from <code>get_poem</code> so we can cancel later if we need to.</li>
<li>Cancel the deferred when the connection is closed. Note this also cancels the deferred after we actually get the poem, but as we discovered in the examples, canceling a deferred that has already fired has no effect.</li>
</ol>
<p>Now we need to make sure that canceling the deferred actually aborts the poem download. For that we need to change the <a href="http://github.com/jdavisp3/twisted-intro/blob/master/twisted-server-4/poetry-proxy.py#L105"><code>ProxyService</code></a>:</p>
<div><div id="highlighter_771172" class="syntaxhighlighter  py"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div><div class="line number20 index19 alt1">20</div><div class="line number21 index20 alt2">21</div><div class="line number22 index21 alt1">22</div><div class="line number23 index22 alt2">23</div><div class="line number24 index23 alt1">24</div><div class="line number25 index24 alt2">25</div><div class="line number26 index25 alt1">26</div><div class="line number27 index26 alt2">27</div><div class="line number28 index27 alt1">28</div><div class="line number29 index28 alt2">29</div><div class="line number30 index29 alt1">30</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py keyword">class</code> <code class="py plain">ProxyService(</code><code class="py functions">object</code><code class="py plain">):</code></div><div class="line number2 index1 alt1">&nbsp;</div><div class="line number3 index2 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">poem </code><code class="py keyword">=</code> <code class="py color1">None</code> <code class="py comments"># the cached poem</code></div><div class="line number4 index3 alt1">&nbsp;</div><div class="line number5 index4 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">def</code> <code class="py plain">__init__(</code><code class="py color1">self</code><code class="py plain">, host, port):</code></div><div class="line number6 index5 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py color1">self</code><code class="py plain">.host </code><code class="py keyword">=</code> <code class="py plain">host</code></div><div class="line number7 index6 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py color1">self</code><code class="py plain">.port </code><code class="py keyword">=</code> <code class="py plain">port</code></div><div class="line number8 index7 alt1">&nbsp;</div><div class="line number9 index8 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">def</code> <code class="py plain">get_poem(</code><code class="py color1">self</code><code class="py plain">):</code></div><div class="line number10 index9 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">if</code> <code class="py color1">self</code><code class="py plain">.poem </code><code class="py keyword">is</code> <code class="py keyword">not</code> <code class="py color1">None</code><code class="py plain">:</code></div><div class="line number11 index10 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py functions">print</code> <code class="py string">'Using cached poem.'</code></div><div class="line number12 index11 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py comments"># return an already-fired deferred</code></div><div class="line number13 index12 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">return</code> <code class="py plain">succeed(</code><code class="py color1">self</code><code class="py plain">.poem)</code></div><div class="line number14 index13 alt1">&nbsp;</div><div class="line number15 index14 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">def</code> <code class="py plain">canceler(d):</code></div><div class="line number16 index15 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py functions">print</code> <code class="py string">'Canceling poem download.'</code></div><div class="line number17 index16 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">factory.deferred </code><code class="py keyword">=</code> <code class="py color1">None</code></div><div class="line number18 index17 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">connector.disconnect()</code></div><div class="line number19 index18 alt2">&nbsp;</div><div class="line number20 index19 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py functions">print</code> <code class="py string">'Fetching poem from server.'</code></div><div class="line number21 index20 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">deferred </code><code class="py keyword">=</code> <code class="py plain">Deferred(canceler)</code></div><div class="line number22 index21 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">deferred.addCallback(</code><code class="py color1">self</code><code class="py plain">.set_poem)</code></div><div class="line number23 index22 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">factory </code><code class="py keyword">=</code> <code class="py plain">PoetryClientFactory(deferred)</code></div><div class="line number24 index23 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">from</code> <code class="py plain">twisted.internet </code><code class="py keyword">import</code> <code class="py plain">reactor</code></div><div class="line number25 index24 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">connector </code><code class="py keyword">=</code> <code class="py plain">reactor.connectTCP(</code><code class="py color1">self</code><code class="py plain">.host, </code><code class="py color1">self</code><code class="py plain">.port, factory)</code></div><div class="line number26 index25 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">return</code> <code class="py plain">factory.deferred</code></div><div class="line number27 index26 alt2">&nbsp;</div><div class="line number28 index27 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">def</code> <code class="py plain">set_poem(</code><code class="py color1">self</code><code class="py plain">, poem):</code></div><div class="line number29 index28 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py color1">self</code><code class="py plain">.poem </code><code class="py keyword">=</code> <code class="py plain">poem</code></div><div class="line number30 index29 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">return</code> <code class="py plain">poem</code></div></div></td></tr></tbody></table></div></div>
<p>Again, you may wish to compare this with the <a href="http://github.com/jdavisp3/twisted-intro/blob/master/twisted-server-2/poetry-proxy.py#100">older version</a>. This class has a few more changes:</p>
<ol>
<li>We save the return value from <code>reactor.connectTCP</code>, an <a href="http://twistedmatrix.com/trac/browser/tags/releases/twisted-10.1.0/twisted/internet/interfaces.py#L24">IConnector</a> object. We can use the <code>disconnect</code> method on that object to close the connection.</li>
<li>We create the deferred with a <code>canceler</code> callback. That callback is a closure which uses the <code>connector</code> to close the connection. But first it sets the <code>factory.deferred</code> attribute to <code>None</code>. Otherwise, the factory might fire the deferred with a "connection closed" errback before the deferred itself fires with a <code>CancelledError</code>. Since this deferred was canceled, having the deferred fire with <code>CancelledError</code> seems more explicit.</li>
</ol>
<p>You might also notice we now create the deferred in the <code>ProxyService</code> instead of the <code>PoetryClientFactory</code>. Since the canceler callback needs to access the <code>IConnector</code> object, the <code>ProxyService</code> ends up being the most convenient place to create the deferred.</p>
<p>And, as in one of our earlier examples, our <code>canceler</code> callback is implemented as a closure. Closures seem to be very useful when implementing cancel callbacks!</p>
<p>Let's try out our new proxy. First start up a <em>slow</em> server. It needs to be slow so we actually have time to cancel:</p>
<pre>python blocking-server/slowpoetry.py --port 10001 poetry/fascination.txt</pre>
<p>Now we can start up our proxy (remember you need Twisted 10.1.0):</p>
<pre>python twisted-server-4/poetry-proxy.py --port 10000 10001</pre>
<p>Now we can start downloading a poem from the proxy using any client, or even just <tt>curl</tt>:</p>
<pre>curl localhost:10000</pre>
<p>After a few seconds, press <tt>Ctrl-C</tt> to stop the client, or the <tt>curl</tt> process. In the terminal running the proxy you should<br>
see this output:</p>
<pre>Fetching poem from server.
Canceling poem download.</pre>
<p>And you should see the slow server has stopped printing output for each bit of poem it sends, since our proxy hung up. You can start and stop the client multiple times to verify each download is canceled each time. But if you let the poem run to completion, then the proxy caches the poem and sends it immediately after that.</p>
<h3>One More Wrinkle</h3>
<p>We said several times above that canceling an already-fired deferred has no effect. Well, that's not quite true. In <a href="http://krondo.com/wp-content/uploads/2009/08/twisted-intro.html?p=2159">Part 13</a> we learned that the callbacks and errbacks attached to a deferred may return deferreds themselves. And in that case, the original (outer) deferred pauses the execution of its callback chains and waits for the inner deferred to fire (see <a href="http://krondo.com/wp-content/uploads/2009/08/twisted-intro.html?p=2159#figure28">Figure 28</a>).</p>
<p>Thus, even though a deferred has fired the higher-level code that made the asynchronous request may not have received the result yet, because the callback chain is paused waiting for an inner deferred to finish. So what happens if the higher-level code cancels that outer deferred? In that case the outer deferred does not cancel itself (it has already fired after all); instead, the outer deferred cancels the inner deferred.</p>
<p>So when you cancel a deferred, you might not be canceling the main asynchronous operation, but rather some other asynchronous operation triggered as a result of the first. Whew!</p>
<p>We can illustrate this with one more example. Consider the code in <a href="http://github.com/jdavisp3/twisted-intro/blob/master/deferred-cancel/defer-cancel-12.py#L1"><tt>deferred-cancel/defer-cancel-12.py</tt></a>:</p>
<div><div id="highlighter_760170" class="syntaxhighlighter  py"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div><div class="line number20 index19 alt1">20</div><div class="line number21 index20 alt2">21</div><div class="line number22 index21 alt1">22</div><div class="line number23 index22 alt2">23</div><div class="line number24 index23 alt1">24</div><div class="line number25 index24 alt2">25</div><div class="line number26 index25 alt1">26</div><div class="line number27 index26 alt2">27</div><div class="line number28 index27 alt1">28</div><div class="line number29 index28 alt2">29</div><div class="line number30 index29 alt1">30</div><div class="line number31 index30 alt2">31</div><div class="line number32 index31 alt1">32</div><div class="line number33 index32 alt2">33</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py keyword">from</code> <code class="py plain">twisted.internet </code><code class="py keyword">import</code> <code class="py plain">defer</code></div><div class="line number2 index1 alt1">&nbsp;</div><div class="line number3 index2 alt2"><code class="py keyword">def</code> <code class="py plain">cancel_outer(d):</code></div><div class="line number4 index3 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py functions">print</code> <code class="py string">"outer cancel callback."</code></div><div class="line number5 index4 alt2">&nbsp;</div><div class="line number6 index5 alt1"><code class="py keyword">def</code> <code class="py plain">cancel_inner(d):</code></div><div class="line number7 index6 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py functions">print</code> <code class="py string">"inner cancel callback."</code></div><div class="line number8 index7 alt1">&nbsp;</div><div class="line number9 index8 alt2"><code class="py keyword">def</code> <code class="py plain">first_outer_callback(res):</code></div><div class="line number10 index9 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py functions">print</code> <code class="py string">'first outer callback, returning inner deferred'</code></div><div class="line number11 index10 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py keyword">return</code> <code class="py plain">inner_d</code></div><div class="line number12 index11 alt1">&nbsp;</div><div class="line number13 index12 alt2"><code class="py keyword">def</code> <code class="py plain">second_outer_callback(res):</code></div><div class="line number14 index13 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py functions">print</code> <code class="py string">'second outer callback got:'</code><code class="py plain">, res</code></div><div class="line number15 index14 alt2">&nbsp;</div><div class="line number16 index15 alt1"><code class="py keyword">def</code> <code class="py plain">outer_errback(err):</code></div><div class="line number17 index16 alt2"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py functions">print</code> <code class="py string">'outer errback got:'</code><code class="py plain">, err</code></div><div class="line number18 index17 alt1">&nbsp;</div><div class="line number19 index18 alt2"><code class="py plain">outer_d </code><code class="py keyword">=</code> <code class="py plain">defer.Deferred(cancel_outer)</code></div><div class="line number20 index19 alt1"><code class="py plain">inner_d </code><code class="py keyword">=</code> <code class="py plain">defer.Deferred(cancel_inner)</code></div><div class="line number21 index20 alt2">&nbsp;</div><div class="line number22 index21 alt1"><code class="py plain">outer_d.addCallback(first_outer_callback)</code></div><div class="line number23 index22 alt2"><code class="py plain">outer_d.addCallbacks(second_outer_callback, outer_errback)</code></div><div class="line number24 index23 alt1">&nbsp;</div><div class="line number25 index24 alt2"><code class="py plain">outer_d.callback(</code><code class="py string">'result'</code><code class="py plain">)</code></div><div class="line number26 index25 alt1">&nbsp;</div><div class="line number27 index26 alt2"><code class="py comments"># at this point the outer deferred has fired, but is paused</code></div><div class="line number28 index27 alt1"><code class="py comments"># on the inner deferred.</code></div><div class="line number29 index28 alt2">&nbsp;</div><div class="line number30 index29 alt1"><code class="py functions">print</code> <code class="py string">'canceling outer deferred.'</code></div><div class="line number31 index30 alt2"><code class="py plain">outer_d.cancel()</code></div><div class="line number32 index31 alt1">&nbsp;</div><div class="line number33 index32 alt2"><code class="py functions">print</code> <code class="py string">'done'</code></div></div></td></tr></tbody></table></div></div>
<p>In this example we create two deferreds, the outer and the inner, and have one of the outer callbacks return the inner deferred. First we fire the outer deferred, and then we cancel it. The example produces this output:</p>
<pre>first outer callback, returning inner deferred
canceling outer deferred.
inner cancel callback.
outer errback got: [Failure instance: Traceback (failure with no frames): &lt;class 'twisted.internet.defer.CancelledError'&gt;:
]
done</pre>
<p>As you can see, canceling the outer deferred does not cause the outer cancel callback to fire. Instead, it cancels the inner deferred so the inner cancel callback fires, and then outer errback receives the <code>CancelledError</code> (from the inner deferred).</p>
<p>You may wish to stare at that code a while, and try out variations to see how they affect the outcome.</p>
<h3>Discussion</h3>
<p>Canceling a deferred can be a very useful operation, allowing our programs to avoid work they no longer need to do. And as we have seen, it can be a little bit tricky, too.</p>
<p>One very important fact to keep in mind is that canceling a deferred doesn't necessarily cancel the underlying asynchronous operation. In fact, as of this writing, most deferreds won't really "cancel", since most Twisted code was written prior to Twisted 10.1.0 and hasn't been updated. This includes many of the APIs in Twisted itself! Check the documentation and/or the source code to find out whether canceling the deferred will truly cancel the request, or simply ignore it.</p>
<p>And the second important fact is that simply returning a deferred from your asynchronous APIs will not necessarily make them cancelable in the complete sense of the word. If you want to implement canceling in your own programs, you should study the Twisted source code to find more examples. Cancellation is a brand new feature so the patterns and best practices are still being worked out.</p>
<h3>Looking Ahead</h3>
<p>At this point we've learned just about everything about Deferreds and the core concepts behind Twisted. Which means there's not much more to introduce, as the rest of Twisted consists mainly of specific applications, like web programming or asynchronous database access. So in the <a href="http://krondo.com/wp-content/uploads/2009/08/twisted-intro.html?p=2692">next</a> couple of Parts we're going to take a little detour and look at two other systems that use asynchronous I/O to see how some of their ideas relate to the ideas in Twisted. Then, in the final Part, we will wrap up and suggest ways to continue your Twisted education.</p>
<h3>Suggested Exercises</h3>
<ol>
<li>Did you know you can spell canceled with one or two els? <a href="http://mw4.m-w.com/dictionary/canceled">It's true</a>. It all depends on what sort of mood you're in.</li>
<li>Peruse the source code of the <a href="http://twistedmatrix.com/trac/browser/tags/releases/twisted-10.1.0/twisted/internet/defer.py#L167"><code>Deferred</code></a> class, paying special attention to the implementation of cancellation.</li>
<li>Search the Twisted 10.10 <a href="http://twistedmatrix.com/trac/browser/tags/releases/twisted-10.1.0/">source code</a> for examples of deferreds with cancel callbacks. Study their implementation.</li>
<li>Make the deferred returned by the <code>get_poetry</code> method of one of our poetry clients cancelable.</li>
<li>Make a reactor-based example that illustrates canceling an outer deferred which is paused on an inner deferred. If you use <code>callLater</code> you will need to choose the delays carefully to ensure the outer deferred is canceled at the right moment.</li>
<li>Find an asynchronous API in Twisted that doesn't support a true cancel and implement cancellation for it. <a href="http://twistedmatrix.com/trac/wiki/BasicGuideToContributingCode">Submit a patch</a> to the Twisted project. Don't forget unit tests!</li>
</ol>
<!-- JOLIPRINT BUTTON BEGINS --><script type="text/javascript">
&amp;amp;amp;amp;amp;lt;!--
try{
$joliprint().set('format','json').set('callback','joliprint_getPdf').set('service','wp-plugin').set('url','http://krondo.com/?p=2601').set('title','Print with Joliprint').set('urloptions','ver=1.1.5').set( 'label', 'joliprint' ).set( 'labelposition', 'after' ).set( 'button', 'joliprint-icon' ).write();
}catch(e){

}
--&amp;amp;amp;amp;amp;gt;</script><!-- JOLIPRINT BUTTON ENDS -->		<div class="fixed"></div>
			</div>
</div>

<div id="post-2692" class="post">
	
	

	<div class="content">
		<h2>Part 20: Wheels within Wheels: Twisted and Erlang</h2>
<p>This continues the introduction started <a href="http://krondo.com/wp-content/uploads/2009/08/twisted-intro.html?p=1209">here</a>. You can find an index to the entire series <a href="http://krondo.com/wp-content/uploads/2009/08/twisted-intro.html?p=1327">here</a>.</p>
<h3>Introduction</h3>
<p>One fact we've uncovered in this series is that mixing synchronous "plain Python" code with asynchronous Twisted code is not a straightforward task, since blocking for an indeterminate amount of time in a Twisted program will eliminate many of the benefits you are trying to achieve using the asynchronous model.</p>
<p>If this is your first introduction to asynchronous programming it may seem as if the knowledge you have gained is of somewhat limited applicability. You can use these new techniques inside of Twisted, but not in the much larger world of general Python code. And when working with Twisted, you are generally limited to libraries written specifically for use as part of a Twisted program, at least if you want to call them directly from the thread running the reactor.</p>
<p>But asynchronous programming techniques have been around for quite some time and are hardly confined to Twisted. There are in fact a startling number of asynchronous programming frameworks in Python alone. A bit of <a href="http://www.google.com/search?q=python+async+frameworks">searching around</a> will probably yield a couple dozen of them. They differ from Twisted in their details, but the basic ideas (asynchronous I/O, processing data in small chunks across multiple data streams) are the same. So if you need, or choose, to use an alternative framework you will already have a head start having learned Twisted.</p>
<p>And moving outside of Python, there are plenty of other languages and systems that are either based around, or make use of, the asynchronous programming model. Your knowledge of Twisted will continue to serve you as you explore the wider areas of this subject.</p>
<p>In this Part we're going to take a very brief look at <a href="http://erlang.org">Erlang</a>, a programming language and runtime system that makes extensive use of asynchronous programming concepts, but does so in a unique way. Please note this is not meant as a general introduction to Erlang. Rather, it is a short exploration of some of the ideas embedded in Erlang and how they connect with the ideas in Twisted. The basic theme is the knowledge you have gained learning Twisted can be applied when learning other technologies.</p>
<h3>Callbacks Reimagined</h3>
<p>Consider <a href="http://krondo.com/wp-content/uploads/2009/08/twisted-intro.html?p=1333#figure6">Figure 6</a>, a graphical representation of a callback. The principle callback in <a href="http://github.com/jdavisp3/twisted-intro/blob/master/twisted-client-3/get-poetry.py#L1">Poetry Client 3.0</a>, introduced in <a href="http://krondo.com/wp-content/uploads/2009/08/twisted-intro.html?p=1595">Part 6</a>, and all subsequent poetry clients is the <a href="http://github.com/jdavisp3/twisted-intro/blob/master/twisted-client-3/get-poetry.py#L56"><code>dataReceived</code></a> method. That callback is invoked each time we get a bit more poetry from one of the poetry servers we have connected to.</p>
<p>Let's say our client is downloading three poems from three different servers. Looking at things from the point of view of the reactor (and that's the viewpoint we've emphasized the most in this series), we've got a single big loop which makes one or more callbacks each time it goes around. See Figure 40:</p>
<div style="width: 213px" class="wp-caption alignnone" id="attachment_2706"><a href="img/reactor-2.png"><img width="203" height="286" alt="Figure 40: callbacks from the reactor viewpoint" src="img/reactor-2.png" title="Figure 40: callbacks from the reactor viewpoint" class="size-full wp-image-2706"></a><p class="wp-caption-text">Figure 40: callbacks from the reactor viewpoint</p></div>
<p>This figure shows the reactor happily spinning around, calling <code>dataReceived</code> as the poetry comes in. Each invocation of <code>dataReceived</code> is applied to one particular instance of our <code>PoetryProtocol</code> class. And we know there are three instances because we are downloading three poems (and so there must be three connections).</p>
<p>Let's think about this picture from the point of view of <em>one</em> of those Protocol instances. Remember each Protocol is only concerned with a single connection (and thus a single poem). That instance "sees" a stream of method calls, each one bearing the next piece of the poem, like this:</p>
<div><div class="syntaxhighlighter  py" id="highlighter_70268"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py plain">dataReceived(</code><code class="py color1">self</code><code class="py plain">, </code><code class="py string">"When I have fears"</code><code class="py plain">)</code></div><div class="line number2 index1 alt1"><code class="py plain">dataReceived(</code><code class="py color1">self</code><code class="py plain">, </code><code class="py string">" that I may cease to be"</code><code class="py plain">)</code></div><div class="line number3 index2 alt2"><code class="py plain">dataReceived(</code><code class="py color1">self</code><code class="py plain">, </code><code class="py string">"Before my pen has glea"</code><code class="py plain">)</code></div><div class="line number4 index3 alt1"><code class="py plain">dataReceived(</code><code class="py color1">self</code><code class="py plain">, </code><code class="py string">"n'd my teeming brain"</code><code class="py plain">)</code></div><div class="line number5 index4 alt2"><code class="py plain">...</code></div></div></td></tr></tbody></table></div></div>
<p>While this isn't strictly speaking an actual Python loop, we can conceptualize it as one:</p>
<div><div class="syntaxhighlighter  py" id="highlighter_108075"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="py keyword">for</code> <code class="py plain">data </code><code class="py keyword">in</code> <code class="py plain">poetry_stream(): </code><code class="py comments"># pseudo-code</code></div><div class="line number2 index1 alt1"><code class="py spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="py plain">dataReceived(data)</code></div></div></td></tr></tbody></table></div></div>
<p>We can envision this "callback loop" in Figure 41:</p>
<div style="width: 202px" class="wp-caption alignnone" id="attachment_2718"><a href="img/callback-loop.png"><img width="192" height="168" alt="Figure 41: A virtual callback loop" src="img/callback-loop.png" title="Figure 41: A virtual callback loop" class="size-full wp-image-2718"></a><p class="wp-caption-text">Figure 41: A virtual callback loop</p></div>
<p>Again, this is not a <code>for</code> loop or a <code>while</code> loop. The only significant Python loop in our poetry clients is the reactor. But we can think of each Protocol as a virtual loop that ticks around once each time some poetry for that particular poem comes in. With that in mind we can re-imagine the entire client in Figure 42:</p>
<div style="width: 217px" class="wp-caption alignnone" id="attachment_2723"><a href="img/reactor-3.png"><img width="207" height="260" alt="Figure 42: the reactor spinning some virtual loops" src="img/reactor-3.png" title="Figure 42: the reactor spinning some virtual loops" class="size-full wp-image-2723"></a><p class="wp-caption-text">Figure 42: the reactor spinning some virtual loops</p></div>
<p>In this figure we have one big loop, the reactor, and three virtual loops, the individual poetry protocol instances. The big loop spins around and, in so doing, causes the virtual loops to tick over as well, like a set of interlocking gears.</p>
<h3>Enter Erlang</h3>
<p><a href="http://erlang.org">Erlang</a>, like Python, is a general purpose dynamically typed programming language originally created in the 80's.  Unlike Python, Erlang is functional rather than object-oriented, and has a syntax reminiscent of <a href="http://en.wikipedia.org/wiki/Prolog">Prolog</a>, the language in which Erlang was originally implemented. Erlang was designed for building highly reliable distributed telephony systems, and thus Erlang contains extensive networking support.</p>
<p>One of Erlang's most distinctive features is a concurrency model involving lightweight processes. An Erlang process is neither an operating system process nor an operating system thread. Rather, it is an independently running function inside the Erlang runtime with its own stack. Erlang processes are not lightweight threads because Erlang processes cannot share state (and most data types are immutable anyway, Erlang being a functional programming language). An Erlang process can interact with other Erlang processes only by sending messages, and messages are always, at least conceptually, copied and never shared.</p>
<p>So an Erlang program might look like Figure 43:</p>
<div style="width: 213px" class="wp-caption alignnone" id="attachment_2735"><a href="img/erlang-11.png"><img width="203" height="290" alt="Figure 43: An Erlang program with three processes" src="img/erlang-11.png" title="Figure 43: An Erlang program with three processes" class="size-full wp-image-2735"></a><p class="wp-caption-text">Figure 43: An Erlang program with three processes</p></div>
<p>In this figure the individual processes have become "real", since processes are first-class constructs in Erlang, just like objects are in Python. And the runtime has become "virtual", not because it isn't there, but because it's not necessarily a simple loop. The Erlang runtime may be multi-threaded and, as it has to implement a full-blown programming language, it's in charge of a lot more than handling asynchronous I/O. Furthermore, a language runtime is not so much an extra construct, like the reactor in Twisted, as the medium in which the Erlang processes and code execute.</p>
<p>So an even better picture of an Erlang program might be Figure 44:</p>
<div style="width: 343px" class="wp-caption alignnone" id="attachment_2738"><a href="img/erlang-2.png"><img width="333" height="239" alt="Figure 44: An Erlang program with several processes" src="img/erlang-2.png" title="Figure 44: An Erlang program with several processes" class="size-full wp-image-2738"></a><p class="wp-caption-text">Figure 44: An Erlang program with several processes</p></div>
<p>Of course, the Erlang runtime does have to use asynchronous I/O and one or more select loops, because Erlang allows you to create <em>lots</em> of processes. Large Erlang programs can start tens or hundreds of thousands of Erlang processes, so allocating an actual OS thread to each one is simply out of the question. If Erlang is going to allow multiple processes to perform I/O, and still allow other processes to run even if that I/O blocks, then asynchronous I/O will have to be involved.</p>
<p>Note that our picture of an Erlang program has each process running "under its own power", rather than being spun around by callbacks. And that is very much the case. With the job of the reactor subsumed into the fabric of the Erlang runtime, the callback no longer has a central role to play. What would, in Twisted, be solved by using a callback would, in Erlang, be solved by sending an asynchronous message from one Erlang process to another.</p>
<h3>An Erlang Poetry Client</h3>
<p>Let's look at an Erlang poetry client. We're going to jump straight to a working version instead of building up slowly like we did with Twisted. Again, this isn't meant as a complete Erlang introduction. But if it piques your interest, we suggest some more in-depth reading at the end of this Part.</p>
<p>The Erlang client is listed in <a href="http://github.com/jdavisp3/twisted-intro/blob/master/erlang-client-1/get-poetry#L1"><tt>erlang-client-1/get-poetry</tt></a>. In order to run it you will, of course, need <a href="http://erlang.org">Erlang</a> installed. Here's the code for the <a href="http://github.com/jdavisp3/twisted-intro/blob/master/erlang-client-1/get-poetry#L96"><code>main</code></a> function, which serves a similar purpose as the main functions in our Python clients:</p>
<div><div class="syntaxhighlighter  erl" id="highlighter_948416"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="erl plain">main([]) -&gt;</code></div><div class="line number2 index1 alt1"><code class="erl spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="erl plain">usage();</code></div><div class="line number3 index2 alt2">&nbsp;</div><div class="line number4 index3 alt1"><code class="erl plain">main(</code><code class="erl constants">Args</code><code class="erl plain">) -&gt;</code></div><div class="line number5 index4 alt2"><code class="erl spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="erl constants">Addresses</code> <code class="erl plain">= parse_args(</code><code class="erl constants">Args</code><code class="erl plain">),</code></div><div class="line number6 index5 alt1"><code class="erl spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="erl constants">Main</code> <code class="erl plain">= self(),</code></div><div class="line number7 index6 alt2"><code class="erl spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="erl plain">[</code><code class="erl functions">erlang:spawn_monitor</code><code class="erl plain">(</code><code class="erl keyword">fun</code> <code class="erl plain">() -&gt; get_poetry(</code><code class="erl constants">TaskNum</code><code class="erl plain">, </code><code class="erl constants">Addr</code><code class="erl plain">, </code><code class="erl constants">Main</code><code class="erl plain">) </code><code class="erl keyword">end</code><code class="erl plain">)</code></div><div class="line number8 index7 alt1"><code class="erl spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="erl plain">|| {</code><code class="erl constants">TaskNum</code><code class="erl plain">, </code><code class="erl constants">Addr</code><code class="erl plain">} &lt;- enumerate(</code><code class="erl constants">Addresses</code><code class="erl plain">)],</code></div><div class="line number9 index8 alt2"><code class="erl spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="erl plain">collect_poems(length(</code><code class="erl constants">Addresses</code><code class="erl plain">), []).</code></div></div></td></tr></tbody></table></div></div>
<p>If you've never seen Prolog or a similar language before then Erlang syntax is going to seem a little odd. But some people say that about Python, too. The main function is defined by two separate clauses, separated by a semicolon. Erlang chooses which clause to run by matching the arguments, so the first clause only runs if we execute the client without providing any command line arguments, and it just prints out a help message. The second clause is where all the action is.</p>
<p>Individual statements in an Erlang function are separated by commas, and all functions end with a period. Let's take each line in the second clause one at a time. The first line is just parsing the command line arguments and binding them to a variable (all variables in Erlang must be capitalized). The second line is using the Erlang <code>self</code> function to get the process ID of the currently running Erlang process (not OS process). Since this is the main function you can kind of think of it as the equivalent of the <code>__main__</code> module in Python. The third line is the most interesting:</p>
<div><div class="syntaxhighlighter  erl" id="highlighter_850278"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="erl plain">[</code><code class="erl functions">erlang:spawn_monitor</code><code class="erl plain">(</code><code class="erl keyword">fun</code> <code class="erl plain">() -&gt; get_poetry(</code><code class="erl constants">TaskNum</code><code class="erl plain">, </code><code class="erl constants">Addr</code><code class="erl plain">, </code><code class="erl constants">Main</code><code class="erl plain">) </code><code class="erl keyword">end</code><code class="erl plain">)</code></div><div class="line number2 index1 alt1"><code class="erl spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="erl plain">|| {</code><code class="erl constants">TaskNum</code><code class="erl plain">, </code><code class="erl constants">Addr</code><code class="erl plain">} &lt;- enumerate(</code><code class="erl constants">Addresses</code><code class="erl plain">)],</code></div></div></td></tr></tbody></table></div></div>
<p>This statement is an Erlang list comprehension, with a syntax similar to that in Python. It is spawning new Erlang processes, one for each poetry server we need to contact. And each process will run the same function (<code>get_poetry</code>) but with different arguments specific to that server. We also pass the PID of the main process so the new processes can send the poetry back (you generally need the PID of a process to send a message to it).</p>
<p>The last statement in <code>main</code> calls the <code>collect_poems</code> function which waits for the poetry to come back and for the <code>get_poetry</code> processes to finish. We'll look at the other functions in a bit, but first you might compare this Erlang<br>
<a href="http://github.com/jdavisp3/twisted-intro/blob/master/erlang-client-1/get-poetry#L96"><code>main</code></a> function to the <a href="http://github.com/jdavisp3/twisted-intro/blob/master/twisted-client-4/get-poetry.py#L96">equivalent main</a> in one of our Twisted clients.</p>
<p>Now let's look at the Erlang <code>get_poetry</code> function. There are actually two functions in our script called <code>get_poetry</code>. In Erlang, a function is identified by both name and arity, so our script contains two separate functions, <code>get_poetry/3</code> and <code>get_poetry/4</code> which accept three and four arguments respectively. Here's <a href="http://github.com/jdavisp3/twisted-intro/blob/master/erlang-client-1/get-poetry#L79"><code>get_poetry/3</code></a>, which is spawned by <code>main</code>:</p>
<div><div class="syntaxhighlighter  erl" id="highlighter_37416"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="erl plain">get_poetry(</code><code class="erl constants">Tasknum</code><code class="erl plain">, </code><code class="erl constants">Addr</code><code class="erl plain">, </code><code class="erl constants">Main</code><code class="erl plain">) -&gt;</code></div><div class="line number2 index1 alt1"><code class="erl spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="erl plain">{</code><code class="erl constants">Host</code><code class="erl plain">, </code><code class="erl constants">Port</code><code class="erl plain">} = </code><code class="erl constants">Addr</code><code class="erl plain">,</code></div><div class="line number3 index2 alt2"><code class="erl spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="erl plain">{ok, </code><code class="erl constants">Socket</code><code class="erl plain">} = </code><code class="erl functions">gen_tcp:connect</code><code class="erl plain">(</code><code class="erl constants">Host</code><code class="erl plain">, </code><code class="erl constants">Port</code><code class="erl plain">,</code></div><div class="line number4 index3 alt1"><code class="erl spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="erl plain">[binary, {active, false}, {packet, 0}]),</code></div><div class="line number5 index4 alt2"><code class="erl spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="erl plain">get_poetry(</code><code class="erl constants">Tasknum</code><code class="erl plain">, </code><code class="erl constants">Socket</code><code class="erl plain">, </code><code class="erl constants">Main</code><code class="erl plain">, []).</code></div></div></td></tr></tbody></table></div></div>
<p>This function first makes a TCP connection, just like the Twisted client <code>get_poetry</code>. But then, instead of returning, it proceeds to use that TCP connection by calling <a href="http://github.com/jdavisp3/twisted-intro/blob/master/erlang-client-1/get-poetry#L85"><code>get_poetry/4</code></a>, listed below:</p>
<div><div class="syntaxhighlighter  erl" id="highlighter_963086"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="erl plain">get_poetry(</code><code class="erl constants">Tasknum</code><code class="erl plain">, </code><code class="erl constants">Socket</code><code class="erl plain">, </code><code class="erl constants">Main</code><code class="erl plain">, </code><code class="erl constants">Packets</code><code class="erl plain">) -&gt;</code></div><div class="line number2 index1 alt1"><code class="erl spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="erl keyword">case</code> <code class="erl functions">gen_tcp:recv</code><code class="erl plain">(</code><code class="erl constants">Socket</code><code class="erl plain">, 0) </code><code class="erl keyword">of</code></div><div class="line number3 index2 alt2"><code class="erl spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="erl plain">{ok, </code><code class="erl constants">Packet</code><code class="erl plain">} -&gt;</code></div><div class="line number4 index3 alt1"><code class="erl spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="erl functions">io:format</code><code class="erl plain">(</code><code class="erl string">"Task ~w: got ~w bytes of poetry from ~s\n"</code><code class="erl plain">,</code></div><div class="line number5 index4 alt2"><code class="erl spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="erl plain">[</code><code class="erl constants">Tasknum</code><code class="erl plain">, size(</code><code class="erl constants">Packet</code><code class="erl plain">), peername(</code><code class="erl constants">Socket</code><code class="erl plain">)]),</code></div><div class="line number6 index5 alt1"><code class="erl spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="erl plain">get_poetry(</code><code class="erl constants">Tasknum</code><code class="erl plain">, </code><code class="erl constants">Socket</code><code class="erl plain">, </code><code class="erl constants">Main</code><code class="erl plain">, [</code><code class="erl constants">Packet</code><code class="erl plain">|</code><code class="erl constants">Packets</code><code class="erl plain">]);</code></div><div class="line number7 index6 alt2"><code class="erl spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="erl plain">{error, _} -&gt;</code></div><div class="line number8 index7 alt1"><code class="erl spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="erl constants">Main</code> <code class="erl plain">! {poem, list_to_binary(</code><code class="erl functions">lists:reverse</code><code class="erl plain">(</code><code class="erl constants">Packets</code><code class="erl plain">))}</code></div><div class="line number9 index8 alt2"><code class="erl spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="erl keyword">end</code><code class="erl plain">.</code></div></div></td></tr></tbody></table></div></div>
<p>This Erlang function is doing the work of the <code>PoetryProtocol</code> from our Twisted client, except it does so using blocking function calls. The <code>gen_tcp:recv</code> function waits until some data arrives on the socket (or the socket is closed), however long that might be. But a "blocking" function in Erlang only blocks the process running the function, not the entire Erlang runtime. That TCP socket isn't really a blocking socket (you can't make a true blocking socket in pure Erlang code). For each of those Erlang sockets there is, somewhere inside the Erlang runtime, a "real" TCP socket set to non-blocking mode and used as part of a select loop.</p>
<p>But the Erlang process doesn't have to know about any of that. It just waits for some data to arrive and, if it blocks, some other Erlang process can run instead. And even if a process never blocks, the Erlang runtime is free to switch execution from that process to another at any time. In other words, Erlang has a non-cooperative concurrency model.</p>
<p>Notice that <code>get_poetry/4</code>, after receiving a bit of poem, proceeds by recursively calling itself. To an imperative language programmer this might seem like a recipe for running out of memory, but the Erlang compiler can optimize "tail" calls (function calls that are the last statement in a function) into loops. And this highlights another curious parallel between the Erlang and Twisted clients. In the Twisted client, the "virtual" loops are created by the reactor calling the same function (<code>dataReceived</code>) over and over again. And in the Erlang client, the "real" processes running (<code>get_poetry/4</code>) form loops by calling <em>themselves</em> over and over again via <a href="http://stackoverflow.com/questions/310974/what-is-tail-call-optimization">tail-call optimization</a>. How about that.</p>
<p>If the connection is closed, the last thing <code>get_poetry</code> does is send the poem to the main process. That also ends the process that <code>get_poetry</code> is running, as there is nothing left for it to do.</p>
<p>The remaining key function in our Erlang client is <a href="http://github.com/jdavisp3/twisted-intro/blob/master/erlang-client-1/get-poetry#L58"><code>collect_poems</code></a>:</p>
<div><div class="syntaxhighlighter  erl" id="highlighter_619059"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="erl plain">collect_poems(0, </code><code class="erl constants">Poems</code><code class="erl plain">) -&gt;</code></div><div class="line number2 index1 alt1"><code class="erl spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="erl plain">[</code><code class="erl functions">io:format</code><code class="erl plain">(</code><code class="erl string">"~s\n"</code><code class="erl plain">, [P]) || P &lt;- </code><code class="erl constants">Poems</code><code class="erl plain">];</code></div><div class="line number3 index2 alt2"><code class="erl plain">collect_poems(N, </code><code class="erl constants">Poems</code><code class="erl plain">) -&gt;</code></div><div class="line number4 index3 alt1"><code class="erl spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="erl keyword">receive</code></div><div class="line number5 index4 alt2"><code class="erl spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="erl plain">{</code><code class="erl string">'DOWN'</code><code class="erl plain">, _, _, _, _} -&gt;</code></div><div class="line number6 index5 alt1"><code class="erl spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="erl plain">collect_poems(N-1, </code><code class="erl constants">Poems</code><code class="erl plain">);</code></div><div class="line number7 index6 alt2"><code class="erl spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="erl plain">{poem, </code><code class="erl constants">Poem</code><code class="erl plain">} -&gt;</code></div><div class="line number8 index7 alt1"><code class="erl spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="erl plain">collect_poems(N, [</code><code class="erl constants">Poem</code><code class="erl plain">|</code><code class="erl constants">Poems</code><code class="erl plain">])</code></div><div class="line number9 index8 alt2"><code class="erl spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="erl keyword">end</code><code class="erl plain">.</code></div></div></td></tr></tbody></table></div></div>
<p>This function is run by the main process and, like <code>get_poetry</code>, it recursively loops on itself. It also blocks. The <code>receive</code> statement tells the process to wait for a message to arrive that matches one of the given patterns, and<br>
then extract the message from its "mailbox".</p>
<p>The <code>collect_poems</code> function waits for two kinds of messages: poems and "DOWN" notifications. The latter is a message sent to the main process when one of the <code>get_poetry</code> processes dies for any reason (this is the <code>monitor</code> part of <code>spawn_monitor</code>). By counting <code>DOWN</code> messages, we know when all the poetry has finished. The former is a message from one of the <code>get_poetry</code> processes containing one complete poem.</p>
<p>Ok, let's take the Erlang client out for a spin. First start up three slow poetry servers:</p>
<pre>python blocking-server/slowpoetry.py --port 10001 poetry/fascination.txt
python blocking-server/slowpoetry.py --port 10002 poetry/science.txt
python blocking-server/slowpoetry.py --port 10003 poetry/ecstasy.txt --num-bytes 30</pre>
<p>Now we can run the Erlang client, which has a similar command-line syntax as the Python clients. If you are on a Linux or other UNIX-like system, then you should be able to run the client directly (assuming you have Erlang installed and available in your <tt>PATH</tt>). On Windows you will probably need to run the <tt>escript</tt> program, with the path to the Erlang client as the first argument (with the remaining arguments for the Erlang client itself).</p>
<pre>./erlang-client-1/get-poetry 10001 10002 10003</pre>
<p>After that you should see output like this:</p>
<pre>Task 3: got 30 bytes of poetry from 127:0:0:1:10003
Task 2: got 10 bytes of poetry from 127:0:0:1:10002
Task 1: got 10 bytes of poetry from 127:0:0:1:10001
...</pre>
<p>This is just like one of our earlier Python clients where we print a message for each little bit of poetry we get. When all the poems have finished the client should print out the complete text of each one. Notice the client is switching back and forth between all the servers depending on which one has some poetry to send.</p>
<p>Figure 45 shows the process structure of our Erlang client:</p>
<div style="width: 284px" class="wp-caption alignnone" id="attachment_2768"><a href="img/erlang-3.png"><img width="274" height="236" alt="Figure 45: Erlang poetry client" src="img/erlang-3.png" title="Figure 45: Erlang poetry client" class="size-full wp-image-2768"></a><p class="wp-caption-text">Figure 45: Erlang poetry client</p></div>
<p>This figure shows three <code>get_poetry</code> processes (one per server) and one main process. You can also see the messages that flow from the poetry processes to main process.</p>
<p>So what happens if one of those servers is down? Let's try it:</p>
<pre>./erlang-client-1/get-poetry 10001 10005</pre>
<p>The above command contains one active port (assuming you left all the earlier poetry servers running) and one inactive port (assuming you aren't running any server on port 10005). And we get some output like this:</p>
<pre>Task 1: got 10 bytes of poetry from 127:0:0:1:10001

=ERROR REPORT==== 25-Sep-2010::21:02:10 ===
Error in process &lt;0.33.0&gt; with exit value: {{badmatch,{error,econnrefused}},[{erl_eval,expr,3}]}

Task 1: got 10 bytes of poetry from 127:0:0:1:10001
Task 1: got 10 bytes of poetry from 127:0:0:1:10001
...</pre>
<p>And eventually the client finishes downloading the poem from the active server, prints out the poem, and exits. So how did the <code>main</code> function know that both processes were done? That error message is the clue. The error happens when <code>get_poetry</code> tries to connect to the server and gets a connection refused error instead of the expected value (<code>{ok, Socket}</code>). The resulting exception is called <tt>badmatch</tt> because Erlang "assignment" statements are really pattern-matching operations.</p>
<p>An unhandled exception in an Erlang process causes the process to "crash", which means the process stops running and all of its resources are garbage collected. But the <code>main</code> process, which is monitoring all of the <code>get_poetry</code> processes, will receive a <code>DOWN</code> message when any of those processes stops running for any reason. And thus our client exits when it should instead of running forever.</p>
<h3>Discussion</h3>
<p>Let's take stock of some of the parallels between the Twisted and Erlang clients:</p>
<ol>
<li>Both clients connect (or try to connect) to all the poetry servers at once.</li>
<li>Both clients receive data from the servers as soon as it comes in, regardless of which server delivers the data.</li>
<li>Both clients process the poetry in little bits, and thus have to save the portion of the poems received thus far.</li>
<li>Both clients create an "object" (either a Python object or an Erlang process) to handle all the work for one particular server.</li>
<li>Both clients have to carefully determine when all the poetry has finished, regardless of whether a particular download succeeded or failed.</li>
</ol>
<p>And finally, the <code>main</code> functions in both clients asynchronously receive poems and "task done" notifications. In the Twisted client this information is delivered via a <code>Deferred</code> while the Erlang client receives inter-process messages.</p>
<p>Notice how similar both clients are, in both their overall strategy and the structure of their code. The mechanics are a bit different, with objects, deferreds, and callbacks on the one hand and processes and messages on the other. But the high-level mental models of both clients are quite similar, and it's pretty easy to move from one to the other once you are familiar with both.</p>
<p>Even the reactor pattern reappears in the Erlang client in miniaturized form. Each Erlang process in our poetry client eventually turns into a recursive loop that:</p>
<ol>
<li>Waits for something to happen (a bit of poetry comes in, a poem is delivered, another process finishes), and</li>
<li>Takes some appropriate action.</li>
</ol>
<p>You can think of an Erlang program as a big collection of little reactors, each spinning around and occasionally sending a message to another little reactor (which will process that message as just another event).</p>
<p>And if you delve deeper into Erlang you will find callbacks making an appearance. The Erlang <a href="http://www.erlang.org/doc/man/gen_server.html"><code>gen_server</code></a> process is a generic reactor loop that you "instantiate" by providing a fixed set of callback functions, a pattern repeated elsewhere in the Erlang system.</p>
<p>So if, having learned Twisted, you ever decide to give Erlang a try I think you will find yourself in familiar mental territory.</p>
<h3>Further Reading</h3>
<p>In this Part we've focused on the similarities between Twisted and Erlang, but there are of course many differences. One particularly unique feature of Erlang is its approach to error handling. A large Erlang program is structured as a tree of processes, with "supervisors" in the higher branches and "workers" in the leaves. And if a worker process crashes, a supervisor process will notice and take some action (typically restarting the failed worker).</p>
<p>If you are interested in learning more Erlang then you are in luck. Several Erlang books have either been published recently, or will be published shortly:</p>
<ul>
<li><a href="http://www.amazon.com/exec/obidos/ASIN/193435600X/krondonet-20">Programming Erlang</a> &mdash; written by one of Erlang's inventors. A great introduction to the language.</li>
<li><a href="http://www.amazon.com/exec/obidos/ASIN/0596518188/krondonet-20">Erlang Programming</a> &mdash; this complements the Armstrong book and goes into more detail in several key areas.</li>
<li><a href="http://www.amazon.com/exec/obidos/ASIN/1933988789/krondonet-20">Erlang and OTP in Action</a> &mdash; this hasn't been published yet, but I am eagerly awaiting my copy. Neither of the first two books really addresses OTP, the Erlang framework for building large apps. Full disclosure: two of the authors are friends of mine.</li>
</ul>
<p>Well that's it for Erlang. In the <a href="http://krondo.com/wp-content/uploads/2009/08/twisted-intro.html?p=2814">next Part</a> we will look at Haskell, another functional language with a very different feel from either Python or Erlang. Nevertheless, we shall endeavor to find some common ground.</p>
<h3>Suggested Exercises for the Highly Motivated</h3>
<ol>
<li>Go through the Erlang and Python clients and identify where they are similar and where they differ. How do they each handle errors (like a failure to connect to a poetry server)?</li>
<li>Simplify the Erlang client so it no longer prints out each bit of poetry that comes in (so you don't need to keep track of task numbers either).</li>
<li>Modify the Erlang client to measure the time it takes to download each poem.</li>
<li>Modify the Erlang client to print out the poems in the same order as they were given on the command line.</li>
<li>Modify the Erlang client to print out a more readable error message when we can't connect to a poetry server.</li>
<li>Write Erlang versions of the poetry servers we made with Twisted.</li>
</ol>
<!-- JOLIPRINT BUTTON BEGINS --><script type="text/javascript">
&amp;amp;amp;amp;lt;!--
try{
$joliprint().set('format','json').set('callback','joliprint_getPdf').set('service','wp-plugin').set('url','http://krondo.com/?p=2692').set('title','Print with Joliprint').set('urloptions','ver=1.1.5').set( 'label', 'joliprint' ).set( 'labelposition', 'after' ).set( 'button', 'joliprint-icon' ).write();
}catch(e){

}
--&amp;amp;amp;amp;gt;</script><!-- JOLIPRINT BUTTON ENDS -->		<div class="fixed"></div>
			</div>
</div>
	

<div class="post" id="post-2814">
	
	

	<div class="content">
		<h2>Part 21: Lazy is as Lazy Doesn't: Twisted and Haskell</h2>
<p>This continues the introduction started <a href="http://krondo.com/wp-content/uploads/2009/08/twisted-intro.html?p=1209">here</a>. You can find an index to the entire series <a href="http://krondo.com/wp-content/uploads/2009/08/twisted-intro.html?p=1327">here</a>.</p>
<h3>Introduction</h3>
<p>In the last Part we compared Twisted with <a href="http://erlang.org">Erlang</a>, giving most of our attention to some ideas they have in common. And that ended up being pretty simple, as asynchronous I/O and reactive programming are key components of the Erlang runtime and process model.</p>
<p>Today we are going to range further afield and look at <a href="http://haskell.org">Haskell</a>, another functional language that is nevertheless quite different from Erlang (and, of course, Python). There won't be as many parallels, but we will nevertheless find some asynchronous I/O hiding under the covers.</p>
<h3>Functional with a Capital F</h3>
<p>Although Erlang is also a functional language, its main focus is a reliable concurrency model. Haskell, on the other hand, is functional through and through, making unabashed use of concepts from <a href="http://en.wikipedia.org/wiki/Category_theory">category theory</a> like <a href="http://en.wikipedia.org/wiki/Functor">functors</a> and <a href="http://en.wikipedia.org/wiki/Monad_%28category_theory%29">monads</a>.</p>
<p>Don't worry, we're not going into any of that here (as if we could). Instead we'll focus on one of Haskell's more traditionally functional features: laziness. Like many functional languages (but unlike Erlang), Haskell supports <a href="http://en.wikipedia.org/wiki/Lazy_evaluation">lazy evaluation</a>. In a lazily evaluated language the text of a program doesn't so much describe how to compute something as what to compute. The details of actually performing the computation are generally left to the compiler and runtime system.</p>
<p>And, more to the point, as a lazily-evaluated computation proceeds the runtime may evaluate expressions only partially (lazily) instead of all at once. In general, the runtime will evaluate only as much of an expression as is needed to make progress on the current computation.</p>
<p>Here is a simple Haskell statement applying <code>head</code>, a function that retrieves the first element of a list, to the list <code>[1,2,3]</code> (Haskell and Python share some of their list syntax):</p>
<pre>  head [1,2,3]
</pre>
<p>If you install the <a href="http://www.haskell.org/ghc/">GHC</a> Haskell runtime, you can try this out yourself:</p>
<pre>[~] ghci
GHCi, version 6.12.1: http://www.haskell.org/ghc/  : ? for help
Loading package ghc-prim ... linking ... done.
Loading package integer-gmp ... linking ... done.
Loading package base ... linking ... done.
Prelude&gt; head [1,2,3]
1
Prelude&gt;
</pre>
<p>The result is the number 1, as expected.</p>
<p>The Haskell list syntax includes the handy ability to define a list from its first couple of elements. For example, the list <code>[2,4 ..]</code> is the sequence of even numbers starting with 2. Where does it end? Well, it doesn't. The Haskell list [2,4 ..] and others like it represent (conceptually) infinite lists. You can see this if you try to evaluate one at the interactive Haskell prompt, which will attempt to print out the result of your expression:</p>
<pre>Prelude&gt; [2,4 ..]
[2,4,6,8,10,12,14,16,18,20,22,24,26,28,30,32,34,36,38,40,42,44,46,48,50,52,54,56,58,60,62,64,66,68,70,72,74,76,78,80,82,84,86,88,90,92,94,96,98,100,102,104,106,108,110,112,114,116,118,120,122,124,126,128,130,132,134,136,138,140,142,144,146,
...
</pre>
<p>You'll have to press <tt>Ctrl-C</tt> to stop that computation as it will never actually terminate. But because of lazy evaluation, it is possible to use these infinite lists in Haskell with no trouble:</p>
<pre>Prelude&gt; head [2,4 ..]
2
Prelude&gt; head (tail [2,4 ..])
4
Prelude&gt; head (tail (tail [2,4 ..]))
6
</pre>
<p>Here we are accessing the first, second, and third elements of this infinite list respectively, with no infinite loop anywhere in sight. This is the essence of lazy evaluation. Instead of first evaluating the entire list (which would cause an infinite loop) and then giving that list to the <code>head</code> function, the Haskell runtime only constructs as much of the list as it needs for <code>head</code> to finish its work. The rest of the list is never constructed at all, because it is not needed to proceed with the computation.</p>
<p>When we bring the <code>tail</code> function into play, Haskell is forced to construct the list further, but again only as much as it needs to evaluate the next step of the computation. And once the computation is done, the (unfinished) list can be discarded.</p>
<p>Here's some Haskell code that partially consumes three different infinite lists:</p>
<pre>Prelude&gt; let x = [1..]
Prelude&gt; let y = [2,4 ..]
Prelude&gt; let z = [3,6 ..]
Prelude&gt; head (tail (tail (zip3 x y z)))
(3,6,9)
</pre>
<p>Here we zip all the lists together, then grab the head of the tail of the tail. Once again, Haskell has no trouble with this and only constructs as much of each list as it needs to finish evaluating our code. We can visualize the Haskell runtime "consuming" these infinite lists in Figure 46:</p>
<div id="attachment_2846" class="wp-caption aligncenter" style="width: 477px"><a href="img/haskell.png"><img width="467" height="177" class="size-full wp-image-2846" title="Figure 46: Haskell consuming some infinite lists" src="img/haskell.png" alt="Figure 46: Haskell consuming some infinite lists"></a><p class="wp-caption-text">Figure 46: Haskell consuming some infinite lists</p></div>
<p>Although we've drawn the Haskell runtime as a simple loop, it might be implemented with multiple threads (and probably is if you are using the GHC version of Haskell). But the main point to notice is how this figure looks like a reactor loop consuming bits of data as they come in on network sockets.</p>
<p>You can think of asynchronous I/O and the reactor pattern as a very limited form of lazy evaluation. The asynchronous I/O motto is: "Only process as much data as you have". And the lazy evaluation motto is: "Only process as much data as you need". Furthermore, a lazily-evaluated language applies that motto almost everywhere, not just in the limited scope of I/O.</p>
<p>But the point is that, for a lazily-evaluated language, making use of asynchronous I/O is no big deal. The compiler and runtime are already designed to process data structures bit by bit, so lazily processing the incoming chunks of an I/O stream is just par for the course. And thus the Haskell runtime, like the Erlang runtime, simply incorporates asynchronous I/O as part of its socket abstractions. And we can show that by implementing a poetry client in Haskell.</p>
<h3>Haskell Poetry</h3>
<p>Our first Haskell poetry client is located in <a href="https://github.com/jdavisp3/twisted-intro/blob/master/haskell-client-1/get-poetry.hs"><tt>haskell-client-1/get-poetry.hs</tt></a>. As with Erlang, we're going to jump straight to a finished client, and then suggest further reading if you'd like to learn more.</p>
<p>Haskell also supports light-weight threads or processes, though they aren't as central to Haskell as they are to Erlang, and our Haskell client creates one process for each poem we want to download. The key function there is <a href="https://github.com/jdavisp3/twisted-intro/blob/master/haskell-client-1/get-poetry.hs#L64"><code>runTask</code></a> which connects to a socket and starts the <a href="https://github.com/jdavisp3/twisted-intro/blob/master/haskell-client-1/get-poetry.hs#L48"><code>getPoetry</code></a> function in a light-weight thread.</p>
<p>You'll notice a lot of type declarations in this code. Haskell, unlike Python or Erlang, is statically typed. We don't declare types for each and every variable because Haskell will automatically infer types not explicitly declared (or report an error if it can't). A number of the functions include the <code>IO</code> type (technically a monad) because Haskell requires us to cleanly separate code with side-effects (i.e., code that performs I/O) from pure functions.</p>
<p>The <code>getPoetry</code> function includes this line:</p>
<pre>poem &lt;- hGetContents h
</pre>
<p>which appears to be reading the entire poem from the handle (i.e., the TCP socket) at once. But Haskell, as usual, is lazy. And the Haskell runtime includes one or more actual threads which perform asynchronous I/O in a <code>select</code> loop, thus preserving the possibilities for lazy evaluation of I/O streams.</p>
<p>Just to illustrate that asynchronous I/O is really going on, we have included a "callback" function, <a href="https://github.com/jdavisp3/twisted-intro/blob/master/haskell-client-1/get-poetry.hs#L60"><code>gotLine</code></a>, that prints out some task information for each line in the poem. But it's not really a callback function at all, and the program would use asynchronous I/O whether we included it or not. Even calling it "gotLine" reflects an imperative-language mindset that is out of place in a Haskell program. No matter, we'll clean it up in a bit, but let's take our first Haskell client out for a spin. Start up some slow poetry servers:</p>
<pre>python blocking-server/slowpoetry.py --port 10001 poetry/fascination.txt
python blocking-server/slowpoetry.py --port 10002 poetry/science.txt
python blocking-server/slowpoetry.py --port 10003 poetry/ecstasy.txt --num-bytes 30</pre>
<p>Now compile the Haskell client:</p>
<pre>cd haskell-client-1/
ghc --make get-poetry.hs
</pre>
<p>This will create a binary called <code>get-poetry</code>. Finally, run the client against our servers:</p>
<pre>./get-poetry 10001 10002 1000</pre>
<p>And you should see some output like this:</p>
<pre>Task 3: got 12 bytes of poetry from localhost:10003
Task 3: got 1 bytes of poetry from localhost:10003
Task 3: got 30 bytes of poetry from localhost:10003
Task 2: got 20 bytes of poetry from localhost:10002
Task 3: got 44 bytes of poetry from localhost:10003
Task 2: got 1 bytes of poetry from localhost:10002
Task 3: got 29 bytes of poetry from localhost:10003
Task 1: got 36 bytes of poetry from localhost:10001
Task 1: got 1 bytes of poetry from localhost:10001
...</pre>
<p>The output is slightly different than previous asynchronous clients because we are printing one line for each line of poetry instead of each arbitrary chunk of data. But, as you can see, the client is clearly processing data from all the servers together, instead of one after the other. You'll also notice that the client prints out the first poem as soon as it's finished, without waiting for the others, which continue on at their own pace.</p>
<p>Alright, let's clean the remaining bits of imperative cruft from our client and present a version which just grabs the poetry without bothering with task numbers. You can find it in <a href="https://github.com/jdavisp3/twisted-intro/blob/master/haskell-client-2/get-poetry.hs"><tt>haskell-client-2/get-poetry.hs</tt></a>. Notice that it's much shorter and, for each server, just connects to the socket, grabs all the data, and sends it back.</p>
<p>Ok, let's compile a new client:</p>
<pre>cd haskell-client-2/
ghc --make get-poetry.hs
</pre>
<p>And run it against the same set of poetry servers:</p>
<pre>./get-poetry 10001 10002 10003</pre>
<p>And you should see the text of each poem appear, eventually, on the screen.</p>
<p>You will notice from the server output that each server is sending data to the client simultaneously. What's more, the client prints out each line of the first poem as soon as possible, without waiting for the rest of the poem, even while it's working on the other two. And then it quickly prints out the second poem, which it has been accumulating all along.</p>
<p>And all of that happens without us having to do much of anything. There are no callbacks, no messages being passed back and forth, just a concise description of what we want the program to do, and very little in the way of how it should go about doing it. The rest is taken care of by the Haskell compiler and runtime. Nifty.</p>
<h3>Discussion and Further Reading</h3>
<p>In moving from Twisted to Erlang to Haskell we can see a parallel movement, from the foreground to the background, of the ideas behind asynchronous programming. In Twisted, asynchronous programming is the central motivating idea behind Twisted's existence. And Twisted's implementation as a framework separate from Python (and Python's lack of core asynchronous abstractions like lightweight threads) keeps the asynchronous model front and center when you write programs using Twisted.</p>
<p>In Erlang, asynchronicity is still very visible to the programmer, but the details are now part of the fabric of the language and runtime system, enabling an abstraction in which asynchronous messages are exchanged between synchronous processes.</p>
<p>And finally, in Haskell, asynchronous I/O is just another technique inside the runtime, largely unseen by the programmer, for providing the lazy evaluation that is one of Haskell's central ideas.</p>
<p>We don't have any profound insight into this situation, we're just pointing out the many and interesting places where the asynchronous model shows up, and the many different ways it can be expressed.</p>
<p>And if any of this has piqued your interest in Haskell, then we can recommend <a href="http://www.amazon.com/exec/obidos/ASIN/0596514980/krondonet-20">Real World Haskell</a> to continue your studies. The book is a model of what a good language introduction should be. And while I haven't read it, I've heard good things about <a href="http://learnyouahaskell.com/">Learn You a Haskell</a>.</p>
<p>This brings us to the end of our tour of asynchronous systems outside of Twisted, and the penultimate part in our series. In <a href="http://krondo.com/wp-content/uploads/2009/08/twisted-intro.html?p=2874">Part 22</a> we will conclude, and suggest ways to learn more about Twisted.</p>
<h3>Suggested Exercises for the Startlingly Motivated</h3>
<ol>
<li>Compare the Twisted, Erlang, and Haskell clients with each other.</li>
<li>Modify the Haskell clients to handle failures to connect to a poetry server so they download all the poetry they can and output reasonable error messages for the poems they can't.</li>
<li>Write Haskell versions of the poetry servers we made with Twisted.</li>
</ol>
<!-- JOLIPRINT BUTTON BEGINS --><script type="text/javascript">
&amp;amp;amp;lt;!--
try{
$joliprint().set('format','json').set('callback','joliprint_getPdf').set('service','wp-plugin').set('url','http://krondo.com/?p=2814').set('title','Print with Joliprint').set('urloptions','ver=1.1.5').set( 'label', 'joliprint' ).set( 'labelposition', 'after' ).set( 'button', 'joliprint-icon' ).write();
}catch(e){

}
--&amp;amp;amp;gt;</script><!-- JOLIPRINT BUTTON ENDS -->		<div class="fixed"></div>
			</div>
</div>


<div id="post-2874" class="post">
	
	

	<div class="content">
		<h2>Part 22: The End</h2>
<p>This concludes the introduction started <a href="http://krondo.com/wp-content/uploads/2009/08/twisted-intro.html?p=1209">here</a>. You can find an index to the entire series <a href="http://krondo.com/wp-content/uploads/2009/08/twisted-intro.html?p=1327">here</a>.</p>
<h3>All Done</h3>
<p>Whew! Thank you for sticking with me. When I started this series I didn't realize it was going to be this long, or take this much time to make. But I have enjoyed creating it and hope you have enjoyed reading it.</p>
<p>Now that I have finished, I will look into the possibility of generating a PDF format. No promises, though.</p>
<p>I would like to conclude with a few suggestions on how to continue your Twisted education.</p>
<h3>Further Reading</h3>
<p>First, I would recommend reading the Twisted <a href="http://twistedmatrix.com/trac/wiki/Documentation">online documentation</a>. Although it is much-maligned, I think it's better than it is often given credit for.</p>
<p>If you want to use Twisted for web programming, then Jean-Paul Calderone has a well-regarded series called "<a href="http://jcalderone.livejournal.com/50562.html">Twisted Web in 60 Seconds</a>". I suspect it will take a little longer than that to read, though.</p>
<p>There is also a <a href="http://www.amazon.com/gp/product/0596100329?ie=UTF8&amp;tag=jpcalsjou-20&amp;linkCode=as2&amp;camp=1789&amp;creative=9325&amp;creativeASIN=0596100329">Twisted Book</a>, which I can't say much about as I haven't read it.</p>
<p>But more important than any of those, I think, is to read the <a href="http://twistedmatrix.com/trac/browser/trunk">Twisted source code</a>. Since that code is written by people who know Twisted very well, it is an excellent source of examples for how do to things the "Twisted Way".</p>
<h3>Suggested Exercises</h3>
<ol>
<li>Port a synchronous program you wrote to Twisted.</li>
<li>Write a new Twisted program from scratch.</li>
<li>Pick a bug from the Twisted <a href="http://twistedmatrix.com/trac/report">bug database</a> and fix it. Submit a patch to the Twisted developers. Don't forget to read about the <a href="http://twistedmatrix.com/trac/wiki/ContributingToTwistedLabs">process</a> for making your contribution.</li>
</ol>
<h3>The End, Really</h3>
<p>Happy Hacking!<br>
</p><div style="width: 475px" class="wp-caption aligncenter" id="attachment_2890"><a href="img/theend1.png"><img width="465" height="284" class="size-full wp-image-2890" title="Figure 47: The End" alt="Figure 47: The End" src="img/theend1.png"></a><p class="wp-caption-text">Figure 47: The End</p></div><p></p>
<!-- JOLIPRINT BUTTON BEGINS --><script type="text/javascript">
&amp;amp;lt;!--
try{
$joliprint().set('format','json').set('callback','joliprint_getPdf').set('service','wp-plugin').set('url','http://krondo.com/?p=2874').set('title','Print with Joliprint').set('urloptions','ver=1.1.5').set( 'label', 'joliprint' ).set( 'labelposition', 'after' ).set( 'button', 'joliprint-icon' ).write();
}catch(e){

}
--&amp;amp;gt;</script><!-- JOLIPRINT BUTTON ENDS -->		<div class="fixed"></div>
			</div>
</div>

</div>
	<!-- main END -->

		
<!-- sidebar START -->

<!-- sidebar END -->

	<div class="fixed"></div>

	<!-- footer START -->
	
	<!-- footer END -->

</div>
<!-- content END -->

		</div><!-- container -->
	</div><!-- wrap -->


	
<!-- START: Syntax Highlighter ComPress -->

<!-- END: Syntax Highlighter ComPress -->

	


	

	
	


</body></html>
